"use strict";(self.webpackChunkangular_17_test=self.webpackChunkangular_17_test||[]).push([[5884],{11462:(st,J,v)=>{v.d(J,{I:()=>F,v:()=>A});var z=v(55117);function F(M,u,d=0){const r=(0,z.uZ)(M,0,D);for(let n=0;n<4;n++)u[d+n]=Math.floor(256*L(r*k[n]))}function A(M,u=0){let d=0;for(let r=0;r<4;r++)d+=M[u+r]*Q[r];return d}const k=[1,256,65536,16777216],Q=[1/256,1/65536,1/16777216,1/4294967296],D=A(new Uint8ClampedArray([255,255,255,255]));function L(M){return M-Math.floor(M)}},40485:(st,J,v)=>{v.d(J,{Z:()=>L});var A,M,z=v(14007),F=v(51479);(M=A||(A={}))[M.varint=0]="varint",M[M.fixed64=1]="fixed64",M[M.delimited=2]="delimited",M[M.fixed32=5]="fixed32",M[M.unknown=99]="unknown";const k=4294967296,Q=new TextDecoder("utf-8"),D=(0,z.Z)("safari")||(0,z.Z)("ios")?6:(0,z.Z)("ff")?12:32;class L{constructor(u,d,r=0,n=(u?u.byteLength:0)){this._tag=0,this._dataType=A.unknown,this._init(u,d,r,n)}_init(u,d,r,n){this._data=u,this._dataView=d,this._pos=r,this._end=n}asUnsafe(){return this}clone(){return new L(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(u){this._pos=u}nextTag(u){for(;;){if(this._pos===this._end)return!1;const d=this._decodeVarint();if(this._tag=d>>3,this._dataType=7&d,!u||u===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const u=this._decodeVarint();return this._tag=u>>3,this._dataType=7&u,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let u=4294967295;return u=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128?u:(u=(u|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128?u:(u=(u|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128?u:(u=(u|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128?u:(u=(u|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128?u:void 0))))}getUInt64(){return this._decodeVarint()}getSInt32(){const u=this.getUInt32();if(void 0!==u)return u>>>1^-(1&u)|0}getSInt64(){return this._decodeSVarint()}getBool(){const u=0!==this._data[this._pos];return this._skip(1),u}getEnum(){return this._decodeVarint()}getFixed64(){const u=this._dataView,d=this._pos,r=u.getUint32(d,!0)+u.getUint32(d+4,!0)*k;return this._skip(8),r}getSFixed64(){const u=this._dataView,d=this._pos,r=u.getUint32(d,!0)+u.getInt32(d+4,!0)*k;return this._skip(8),r}getDouble(){const u=this._dataView.getFloat64(this._pos,!0);return this._skip(8),u}getFixed32(){const u=this._dataView.getUint32(this._pos,!0);return this._skip(4),u}getSFixed32(){const u=this._dataView.getInt32(this._pos,!0);return this._skip(4),u}getFloat(){const u=this._dataView.getFloat32(this._pos,!0);return this._skip(4),u}getString(){const u=this._getLength(),d=this._pos,r=this._toString(this._data,d,d+u);return this._skip(u),r}getBytes(){const u=this._getLength(),d=this._pos,r=this._toBytes(this._data,d,d+u);return this._skip(u),r}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(u,d,r,n){const _=this.getMessage(),f=u(_,d,r,n);return _.release(),f}processMessage(u){const d=this.getMessage(),r=u(d);return d.release(),r}getMessage(){const u=this._getLength(),d=L.pool.acquire();return d._init(this._data,this._dataView,this._pos,this._pos+u),this._skip(u),d}release(){L.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case A.varint:this._decodeVarint();break;case A.fixed64:this._skip(8);break;case A.delimited:this._skip(this._getLength());break;case A.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(u){this._skip(u)}_skip(u){if(this._pos+u>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=u}_decodeVarint(){const u=this._data;let d=this._pos,r=0,n=0;if(this._end-d>=10)do{if(n=u[d++],r|=127&n,0==(128&n)||(n=u[d++],r|=(127&n)<<7,0==(128&n))||(n=u[d++],r|=(127&n)<<14,0==(128&n))||(n=u[d++],r|=(127&n)<<21,0==(128&n))||(n=u[d++],r+=268435456*(127&n),0==(128&n))||(n=u[d++],r+=34359738368*(127&n),0==(128&n))||(n=u[d++],r+=4398046511104*(127&n),0==(128&n))||(n=u[d++],r+=562949953421312*(127&n),0==(128&n))||(n=u[d++],r+=72057594037927940*(127&n),0==(128&n))||(n=u[d++],r+=0x8000000000000000*(127&n),0==(128&n)))break;throw new Error("Varint too long!")}while(0);else{let _=1;for(;d!==this._end&&(n=u[d],0!=(128&n));)++d,r+=(127&n)*_,_*=128;if(d===this._end)throw new Error("Varint overrun!");++d,r+=n*_}return this._pos=d,r}_decodeSVarint(){const u=this._data;let d,r=0,n=0;const _=1&u[this._pos];if(n=u[this._pos++],r|=127&n,0==(128&n)||(n=u[this._pos++],r|=(127&n)<<7,0==(128&n))||(n=u[this._pos++],r|=(127&n)<<14,0==(128&n))||(n=u[this._pos++],r|=(127&n)<<21,0==(128&n))||(n=u[this._pos++],r+=268435456*(127&n),0==(128&n))||(n=u[this._pos++],r+=34359738368*(127&n),0==(128&n))||(n=u[this._pos++],r+=4398046511104*(127&n),0==(128&n)))return _?-(r+1)/2:r/2;if(d=BigInt(r),n=u[this._pos++],d+=0x2000000000000n*BigInt(127&n),0==(128&n)||(n=u[this._pos++],d+=0x100000000000000n*BigInt(127&n),0==(128&n))||(n=u[this._pos++],d+=0x8000000000000000n*BigInt(127&n),0==(128&n)))return Number(_?-(d+1n)/2n:d/2n);throw new Error("Varint too long!")}_getLength(){if(this._dataType!==A.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(u,d,r){if((r=Math.min(this._end,r))-d>D){const f=u.subarray(d,r);return Q.decode(f)}let n="",_="";for(let f=d;f<r;++f){const x=u[f];128&x?_+="%"+x.toString(16):(n+=decodeURIComponent(_)+String.fromCharCode(x),_="")}return _.length&&(n+=decodeURIComponent(_)),n}_toBytes(u,d,r){return r=Math.min(this._end,r),new Uint8Array(u.buffer,d,r-d)}}L.pool=new F.Z(L,void 0,M=>{M._data=null,M._dataView=null})},80247:(st,J,v)=>{var F,A,d;v.d(J,{E9:()=>k,I6:()=>L,Vl:()=>F,bN:()=>D}),(d=F||(F={}))[d.Unknown=0]="Unknown",d[d.Point=1]="Point",d[d.LineString=2]="LineString",d[d.Polygon=3]="Polygon";class k{constructor(r,n){this.x=r,this.y=n}clone(){return new k(this.x,this.y)}equals(r,n){return r===this.x&&n===this.y}isEqual(r){return r.x===this.x&&r.y===this.y}setCoords(r,n){this.x=r,this.y=n}normalize(){const r=this.x,n=this.y,_=Math.sqrt(r*r+n*n);this.x/=_,this.y/=_}rightPerpendicular(){const r=this.x;this.x=this.y,this.y=-r}move(r,n){this.x+=r,this.y+=n}assign(r){this.x=r.x,this.y=r.y}assignAdd(r,n){this.x=r.x+n.x,this.y=r.y+n.y}assignSub(r,n){this.x=r.x-n.x,this.y=r.y-n.y}rotate(r,n){const _=this.x,f=this.y;this.x=_*r-f*n,this.y=_*n+f*r}scale(r){this.x*=r,this.y*=r}length(){const r=this.x,n=this.y;return Math.sqrt(r*r+n*n)}static distance(r,n){const _=n.x-r.x,f=n.y-r.y;return Math.sqrt(_*_+f*f)}static add(r,n){return new k(r.x+n.x,r.y+n.y)}static sub(r,n){return new k(r.x-n.x,r.y-n.y)}}class Q{constructor(r,n,_){this.ratio=r,this.x=n,this.y=_}}class D{constructor(r,n,_,f=8,x=8){this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=f,this._pixelMargin=x,this._tileSize=512*f,this._dz=r,this._yPos=n,this._xPos=_}setPixelMargin(r){r!==this._pixelMargin&&(this._pixelMargin=r,this.setExtent(this._extent))}setExtent(r){this._extent=r,this._finalRatio=this._tileSize/r*(1<<this._dz);let n=this._pixelRatio*this._pixelMargin;n/=this._finalRatio;const _=r>>this._dz;n>_&&(n=_),this._margin=n,this._xmin=_*this._xPos-n,this._ymin=_*this._yPos-n,this._xmax=this._xmin+_+2*n,this._ymax=this._ymin+_+2*n}reset(r){this._type=r,this._lines=[],this._starts=[],this._line=null,this._start=0}moveTo(r,n){this._pushLine(),this._prevIsIn=this._isIn(r,n),this._moveTo(r,n,this._prevIsIn),this._prevPt=new k(r,n),this._firstPt=new k(r,n),this._dist=0}lineTo(r,n){const _=this._isIn(r,n),f=new k(r,n),x=k.distance(this._prevPt,f);let w,I,T,b,K,G,B,H;if(_)this._prevIsIn?this._lineTo(r,n,!0):(w=this._prevPt,I=f,T=this._intersect(I,w),this._start=this._dist+x*(1-this._r),this._lineTo(T.x,T.y,!0),this._lineTo(I.x,I.y,!0));else if(this._prevIsIn)I=this._prevPt,w=f,T=this._intersect(I,w),this._lineTo(T.x,T.y,!0),this._lineTo(w.x,w.y,!1);else{const C=this._prevPt,U=f;if(C.x<=this._xmin&&U.x<=this._xmin||C.x>=this._xmax&&U.x>=this._xmax||C.y<=this._ymin&&U.y<=this._ymin||C.y>=this._ymax&&U.y>=this._ymax)this._lineTo(U.x,U.y,!1);else{const V=[];if((C.x<this._xmin&&U.x>this._xmin||C.x>this._xmin&&U.x<this._xmin)&&(b=(this._xmin-C.x)/(U.x-C.x),H=C.y+b*(U.y-C.y),H<=this._ymin?G=!1:H>=this._ymax?G=!0:V.push(new Q(b,this._xmin,H))),(C.x<this._xmax&&U.x>this._xmax||C.x>this._xmax&&U.x<this._xmax)&&(b=(this._xmax-C.x)/(U.x-C.x),H=C.y+b*(U.y-C.y),H<=this._ymin?G=!1:H>=this._ymax?G=!0:V.push(new Q(b,this._xmax,H))),(C.y<this._ymin&&U.y>this._ymin||C.y>this._ymin&&U.y<this._ymin)&&(b=(this._ymin-C.y)/(U.y-C.y),B=C.x+b*(U.x-C.x),B<=this._xmin?K=!1:B>=this._xmax?K=!0:V.push(new Q(b,B,this._ymin))),(C.y<this._ymax&&U.y>this._ymax||C.y>this._ymax&&U.y<this._ymax)&&(b=(this._ymax-C.y)/(U.y-C.y),B=C.x+b*(U.x-C.x),B<=this._xmin?K=!1:B>=this._xmax?K=!0:V.push(new Q(b,B,this._ymax))),0===V.length)this._lineTo(K?this._xmax:this._xmin,G?this._ymax:this._ymin,!0);else if(V.length>1&&V[0].ratio>V[1].ratio)this._start=this._dist+x*V[1].ratio,this._lineTo(V[1].x,V[1].y,!0),this._lineTo(V[0].x,V[0].y,!0);else{this._start=this._dist+x*V[0].ratio;for(let N=0;N<V.length;N++)this._lineTo(V[N].x,V[N].y,!0)}this._lineTo(U.x,U.y,!1)}}this._dist+=x,this._prevIsIn=_,this._prevPt=f}close(){if(this._line.length>2){const r=this._firstPt,n=this._prevPt;r.x===n.x&&r.y===n.y||this.lineTo(r.x,r.y);const _=this._line;let f=_.length;for(;f>=4&&(_[0].x===_[1].x&&_[0].x===_[f-2].x||_[0].y===_[1].y&&_[0].y===_[f-2].y);)_.pop(),_[0].x=_[f-2].x,_[0].y=_[f-2].y,--f}}result(r=!0){return this._pushLine(),0===this._lines.length?null:(this._type===F.Polygon&&r&&M.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)}resultWithStarts(){if(this._type!==F.LineString)throw new Error("Only valid for lines");this._pushLine();const r=this._lines,n=r.length;if(0===n)return null;const _=[];for(let f=0;f<n;f++)_.push({line:r[f],start:this._starts[f]||0});return _}_isIn(r,n){return r>=this._xmin&&r<=this._xmax&&n>=this._ymin&&n<=this._ymax}_intersect(r,n){let _,f,x;if(n.x>=this._xmin&&n.x<=this._xmax)f=n.y<=this._ymin?this._ymin:this._ymax,x=(f-r.y)/(n.y-r.y),_=r.x+x*(n.x-r.x);else if(n.y>=this._ymin&&n.y<=this._ymax)_=n.x<=this._xmin?this._xmin:this._xmax,x=(_-r.x)/(n.x-r.x),f=r.y+x*(n.y-r.y);else{f=n.y<=this._ymin?this._ymin:this._ymax,_=n.x<=this._xmin?this._xmin:this._xmax;const w=(_-r.x)/(n.x-r.x),I=(f-r.y)/(n.y-r.y);w<I?(x=w,f=r.y+w*(n.y-r.y)):(x=I,_=r.x+I*(n.x-r.x))}return this._r=x,new k(_,f)}_pushLine(){this._line&&(this._type===F.Point?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===F.LineString?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===F.Polygon&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0}_moveTo(r,n,_){this._type!==F.Polygon?_&&(r=Math.round((r-(this._xmin+this._margin))*this._finalRatio),n=Math.round((n-(this._ymin+this._margin))*this._finalRatio),this._line.push(new k(r,n))):(_||(r<this._xmin&&(r=this._xmin),r>this._xmax&&(r=this._xmax),n<this._ymin&&(n=this._ymin),n>this._ymax&&(n=this._ymax)),r=Math.round((r-(this._xmin+this._margin))*this._finalRatio),n=Math.round((n-(this._ymin+this._margin))*this._finalRatio),this._line.push(new k(r,n)),this._isH=!1,this._isV=!1)}_lineTo(r,n,_){let f,x;if(this._type!==F.Polygon)if(_){if(r=Math.round((r-(this._xmin+this._margin))*this._finalRatio),n=Math.round((n-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(f=this._line[this._line.length-1],f.equals(r,n)))return;this._line.push(new k(r,n))}else this._line&&this._line.length>0&&this._pushLine();else if(_||(r<this._xmin&&(r=this._xmin),r>this._xmax&&(r=this._xmax),n<this._ymin&&(n=this._ymin),n>this._ymax&&(n=this._ymax)),r=Math.round((r-(this._xmin+this._margin))*this._finalRatio),n=Math.round((n-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){f=this._line[this._line.length-1];const w=f.x===r,I=f.y===n;if(w&&I)return;this._isH&&w||this._isV&&I?(f.x=r,f.y=n,x=this._line[this._line.length-2],x.x===r&&x.y===n?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(x=this._line[this._line.length-2],this._isH=x.x===r,this._isV=x.y===n)):(this._isH=x.x===r,this._isV=x.y===n)):(this._line.push(new k(r,n)),this._isH=w,this._isV=I)}else this._line.push(new k(r,n))}}class L{setExtent(r){this._ratio=4096===r?1:4096/r}get validateTessellation(){return this._ratio<1}reset(r){this._lines=[],this._line=null}moveTo(r,n){this._line&&this._lines.push(this._line),this._line=[];const _=this._ratio;this._line.push(new k(r*_,n*_))}lineTo(r,n){const _=this._ratio;this._line.push(new k(r*_,n*_))}close(){const r=this._line;r&&!r[0].isEqual(r[r.length-1])&&r.push(r[0])}result(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines}}!function(d){d[d.sideLeft=0]="sideLeft",d[d.sideRight=1]="sideRight",d[d.sideTop=2]="sideTop",d[d.sideBottom=3]="sideBottom"}(A||(A={}));class M{static simplify(r,n,_){if(!_)return;const f=-n,x=r+n,w=-n,I=r+n,T=[],b=[],K=_.length;for(let B=0;B<K;++B){const H=_[B];if(!H||H.length<2)continue;let C,U=H[0];const V=H.length;for(let N=1;N<V;++N)C=H[N],U.x===C.x&&(U.x<=f&&(U.y>C.y?(T.push(B),T.push(N),T.push(A.sideLeft),T.push(-1)):(b.push(B),b.push(N),b.push(A.sideLeft),b.push(-1))),U.x>=x&&(U.y<C.y?(T.push(B),T.push(N),T.push(A.sideRight),T.push(-1)):(b.push(B),b.push(N),b.push(A.sideRight),b.push(-1)))),U.y===C.y&&(U.y<=w&&(U.x<C.x?(T.push(B),T.push(N),T.push(A.sideTop),T.push(-1)):(b.push(B),b.push(N),b.push(A.sideTop),b.push(-1))),U.y>=I&&(U.x>C.x?(T.push(B),T.push(N),T.push(A.sideBottom),T.push(-1)):(b.push(B),b.push(N),b.push(A.sideBottom),b.push(-1)))),U=C}if(0===T.length||0===b.length)return;M.fillParent(_,b,T),M.fillParent(_,T,b);const G=[];M.calcDeltas(G,b,T),M.calcDeltas(G,T,b),M.addDeltas(G,_)}static fillParent(r,n,_){const f=_.length,x=n.length;for(let w=0;w<x;w+=4){const I=n[w],T=n[w+1],b=n[w+2],K=r[I][T-1],G=r[I][T];let B=8092,H=-1;for(let C=0;C<f;C+=4){if(_[C+2]!==b)continue;const U=_[C],V=_[C+1],N=r[U][V-1],it=r[U][V];switch(b){case A.sideLeft:case A.sideRight:if(u(K.y,N.y,it.y)&&u(G.y,N.y,it.y)){const rt=Math.abs(it.y-N.y);rt<B&&(B=rt,H=C)}break;case A.sideTop:case A.sideBottom:if(u(K.x,N.x,it.x)&&u(G.x,N.x,it.x)){const rt=Math.abs(it.x-N.x);rt<B&&(B=rt,H=C)}}}n[w+3]=H}}static calcDeltas(r,n,_){const f=n.length;for(let x=0;x<f;x+=4){const I=M.calcDelta(x,n,_,[]);r.push(n[x]),r.push(n[x+1]),r.push(n[x+2]),r.push(I)}}static calcDelta(r,n,_,f){const x=n[r+3];if(-1===x)return 0;const w=f.length;return w>1&&f[w-2]===x?0:(f.push(x),M.calcDelta(x,_,n,f)+1)}static addDeltas(r,n){const _=r.length;let f=0;for(let x=0;x<_;x+=4){const w=r[x+3];w>f&&(f=w)}for(let x=0;x<_;x+=4){const w=n[r[x]],I=r[x+1],T=f-r[x+3];switch(r[x+2]){case A.sideLeft:w[I-1].x-=T,w[I].x-=T,1===I&&(w[w.length-1].x-=T),I===w.length-1&&(w[0].x-=T);break;case A.sideRight:w[I-1].x+=T,w[I].x+=T,1===I&&(w[w.length-1].x+=T),I===w.length-1&&(w[0].x+=T);break;case A.sideTop:w[I-1].y-=T,w[I].y-=T,1===I&&(w[w.length-1].y-=T),I===w.length-1&&(w[0].y-=T);break;case A.sideBottom:w[I-1].y+=T,w[I].y+=T,1===I&&(w[w.length-1].y+=T),I===w.length-1&&(w[0].y+=T)}}}}const u=(d,r,n)=>d>=r&&d<=n||d>=n&&d<=r},52793:(st,J,v)=>{v.d(J,{Y:()=>k,m:()=>Q});var z=v(11462),F=v(55117);const A=D=>"vertical"===D||"horizontal"===D||"cross"===D||"esriSFSCross"===D||"esriSFSVertical"===D||"esriSFSHorizontal"===D;function k(D,L,M){const u=(0,F.fp)(Math.ceil(M)),d=A(L)?8*u:16*u,r=2*u;D.width=d,D.height=d;const n=D.getContext("2d");n.strokeStyle="#FFFFFF",n.lineWidth=u,n.beginPath(),"vertical"!==L&&"cross"!==L&&"esriSFSCross"!==L&&"esriSFSVertical"!==L||(n.moveTo(d/2,-r),n.lineTo(d/2,d+r)),"horizontal"!==L&&"cross"!==L&&"esriSFSCross"!==L&&"esriSFSHorizontal"!==L||(n.moveTo(-r,d/2),n.lineTo(d+r,d/2)),"forward-diagonal"!==L&&"diagonal-cross"!==L&&"esriSFSDiagonalCross"!==L&&"esriSFSForwardDiagonal"!==L||(n.moveTo(-r,-r),n.lineTo(d+r,d+r),n.moveTo(d-r,-r),n.lineTo(d+r,r),n.moveTo(-r,d-r),n.lineTo(r,d+r)),"backward-diagonal"!==L&&"diagonal-cross"!==L&&"esriSFSBackwardDiagonal"!==L&&"esriSFSDiagonalCross"!==L||(n.moveTo(d+r,-r),n.lineTo(-r,d+r),n.moveTo(r,-r),n.lineTo(-r,r),n.moveTo(d+r,d-r),n.lineTo(d-r,d+r)),n.stroke();const _=n.getImageData(0,0,D.width,D.height),f=new Uint8Array(_.data);let x;for(let w=0;w<f.length;w+=4)x=f[w+3]/255,f[w]=f[w]*x,f[w+1]=f[w+1]*x,f[w+2]=f[w+2]*x;return[f,D.width,D.height]}function Q(D,L){const M="Butt"===L,u="Square"===L,d=!M&&!u;D.length%2==1&&(D=[...D,...D]);const r=15.5;let _=0;for(const H of D)_+=H;const f=Math.round(_*r),x=new Float32Array(31*f),w=7.75;let I=0,T=0,b=.5,K=!0;for(const H of D){for(I=T,T+=H*r;b<=T;){let C=.5;for(;C<31;){const U=(C-.5)*f+b-.5,V=d?(C-r)*(C-r):Math.abs(C-r);x[U]=K?M?Math.max(Math.max(I+w-b,V),Math.max(b-T+w,V)):V:d?Math.min((b-I)*(b-I)+V,(b-T)*(b-T)+V):u?Math.min(Math.max(b-I,V),Math.max(T-b,V)):Math.min(Math.max(b-I+w,V),Math.max(T+w-b,V)),C++}b++}K=!K}const G=x.length,B=new Uint8Array(4*G);for(let H=0;H<G;++H){const C=(d?Math.sqrt(x[H]):x[H])/r;(0,z.I)(C,B,4*H)}return[B,f,31]}},26128:(st,J,v)=>{v.d(J,{DQ:()=>M,FM:()=>z,Or:()=>u,RD:()=>F,k3:()=>r,nF:()=>D,sX:()=>_,yF:()=>A});const z=Number.POSITIVE_INFINITY,F=Math.PI,A=2*F,k=128/F,D=F/180,L=1/Math.LN2;function M(x,w){return(x%=w)>=0?x:x+w}function u(x){return M(x*k,256)}function r(x){return Math.log(x)*L}function _(x,w,I){return x*(1-I)+w*I}},46117:(st,J,v)=>{v.d(J,{Z:()=>z});class z{constructor(A=0,k=0,Q=0,D=0){this.x=A,this.y=k,this.width=Q,this.height=D}get isEmpty(){return this.width<=0||this.height<=0}union(A){this.x=Math.min(this.x,A.x),this.y=Math.min(this.y,A.y),this.width=Math.max(this.width,A.width),this.height=Math.max(this.height,A.height)}}},75747:(st,J,v)=>{v.d(J,{Z:()=>L});var z=v(14007),F=v(43101),A=v(92311),k=v(58960),Q=v(46356);const D=(M,u)=>M.key.level-u.key.level!=0?M.key.level-u.key.level:M.key.row-u.key.row!=0?M.key.row-u.key.row:M.key.col-u.key.col;class L extends A.Z{constructor(u){super(),this._tileInfoView=u}renderChildren(u){this.sortChildren(D),this.setStencilReference(u),super.renderChildren(u)}createRenderParams(u){const{state:d}=u,r=super.createRenderParams(u);return r.requiredLevel=this._tileInfoView.getClosestInfoForScale(d.scale).level,r.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(d.scale),r}prepareRenderPasses(u){const d=super.prepareRenderPasses(u);return d.push(u.registerRenderPass({name:"stencil",brushes:[Q.Z],drawPhase:F.jx.DEBUG|F.jx.MAP|F.jx.HIGHLIGHT,target:()=>this.getStencilTarget()})),(0,z.Z)("esri-tiles-debug")&&d.push(u.registerRenderPass({name:"tileInfo",brushes:[k.Z],drawPhase:F.jx.DEBUG,target:()=>this.children})),d}getStencilTarget(){return this.children}setStencilReference(u){let d=1;for(const r of this.children)r.stencilRef=d++}}},13305:(st,J,v)=>{v.d(J,{I:()=>k});var z=v(51006),F=v(64456),A=v(54529);class k extends F.s{constructor(D,L,M,u,d,r,n=d,_=r){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new A.Z(D),this.resolution=L,this.x=M,this.y=u,this.width=d,this.height=r,this.rangeX=n,this.rangeY=_}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(D){const L=this.resolution/(D.resolution*D.pixelRatio),M=this.transforms.tileMat3,[u,d]=D.toScreenNoRotation([0,0],[this.x,this.y]);(0,z.s)(M,this.width/this.rangeX*L,0,0,0,this.height/this.rangeY*L,0,u,d,1),(0,z.m)(this.transforms.dvs,D.displayViewMat3,M)}}},16673:(st,J,v)=>{v.r(J),v.d(J,{default:()=>de});var z=v(15861),F=v(50484),A=v(35458),k=v(34222),Q=v(4703),D=v(51172),L=v(79412),M=v(80543),d=(v(1535),v(10141)),r=v(657),n=v(45425),_=v(33721),f=v(17866),x=v(6785),w=v(36885),I=v(46117);class T{constructor(t,s){this._width=0,this._height=0,this._free=[],this._width=t,this._height=s,this._free.push(new I.Z(0,0,t,s))}get width(){return this._width}get height(){return this._height}allocate(t,s){if(t>this._width||s>this._height)return new I.Z;let e=null,i=-1;for(let o=0;o<this._free.length;++o){const a=this._free[o];t<=a.width&&s<=a.height&&(null===e||a.y<=e.y&&a.x<=e.x)&&(e=a,i=o)}return null===e?new I.Z:(this._free.splice(i,1),e.width<e.height?(e.width>t&&this._free.push(new I.Z(e.x+t,e.y,e.width-t,s)),e.height>s&&this._free.push(new I.Z(e.x,e.y+s,e.width,e.height-s))):(e.width>t&&this._free.push(new I.Z(e.x+t,e.y,e.width-t,e.height)),e.height>s&&this._free.push(new I.Z(e.x,e.y+s,t,e.height-s))),new I.Z(e.x,e.y,t,s))}release(t){for(let s=0;s<this._free.length;++s){const e=this._free[s];if(e.y===t.y&&e.height===t.height&&e.x+e.width===t.x)e.width+=t.width;else if(e.x===t.x&&e.width===t.width&&e.y+e.height===t.y)e.height+=t.height;else if(t.y===e.y&&t.height===e.height&&t.x+t.width===e.x)e.x=t.x,e.width+=t.width;else{if(t.x!==e.x||t.width!==e.width||t.y+t.height!==e.y)continue;e.y=t.y,e.height+=t.height}this._free.splice(s,1),this.release(t)}this._free.push(t)}}var b=v(39237),K=v(17091),G=v(22784);class B{constructor(t,s,e){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=s,this._glyphSource=e,this._binPack=new T(t-4,s-4),this._glyphData.push(new Uint8Array(t*s)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(t,s){const e=[],i=this._glyphSource,o=new Set;for(const c of s){const y=Math.floor(.00390625*c);o.add(y)}const l=[];return o.forEach(c=>{const y=t+c;if(this._rangePromises.has(y))l.push(this._rangePromises.get(y));else{const g=i.getRange(t,c).then(()=>{this._rangePromises.delete(y)},()=>{this._rangePromises.delete(y)});this._rangePromises.set(y,g),l.push(g)}}),Promise.all(l).then(()=>{let c=this._glyphIndex[t];c||(c={},this._glyphIndex[t]=c);for(const y of s){const g=c[y];if(g){e[y]={sdf:!0,rect:g.rect,metrics:g.metrics,page:g.page,code:y};continue}const S=i.getGlyph(t,y);if(!S?.metrics)continue;const m=S.metrics;let p;if(0===m.width)p=new I.Z(0,0,0,0);else{const R=m.width+6,E=m.height+6;let O=R%4?4-R%4:4,Z=E%4?4-E%4:4;1===O&&(O=5),1===Z&&(Z=5),p=this._binPack.allocate(R+O,E+Z),p.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new T(this.width-4,this.height-4),p=this._binPack.allocate(R+O,E+Z));const j=this._glyphData[this._currentPage],q=S.bitmap;let tt,Y;if(q)for(let X=0;X<E;X++){tt=R*X,Y=this.width*(p.y+X+1)+p.x;for(let ot=0;ot<R;ot++)j[Y+ot+1]=q.at(tt+ot)}}c[y]={rect:p,metrics:m,tileIDs:null,page:this._currentPage},e[y]={sdf:!0,rect:p,metrics:m,page:this._currentPage,code:y},this._dirties[this._currentPage]=!0}return e})}removeGlyphs(t){for(const s in this._glyphIndex){const e=this._glyphIndex[s];if(!e)continue;let i;for(const o in e)if(i=e[o],i.tileIDs.delete(t),0===i.tileIDs.size){const a=this._glyphData[i.page],l=i.rect;let c,y;for(let g=0;g<l.height;g++)for(c=this.width*(l.y+g)+l.x,y=0;y<l.width;y++)a[c+y]=0;delete e[o],this._dirties[i.page]=!0}}}bind(t,s,e,i=0){if(!this._textures[e]){const a=new G.X;a.pixelFormat=b.VI.ALPHA,a.wrapMode=b.e8.CLAMP_TO_EDGE,a.width=this.width,a.height=this.height,this._textures[e]=new K.x(t,a,new Uint8Array(this.width*this.height))}const o=this._textures[e];o.setSamplingMode(s),this._dirties[e]&&o.setData(this._glyphData[e]),t.bindTexture(o,i),this._dirties[e]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0}}var H=v(66476),C=v(40485);class U{constructor(t){if(this._metrics=[],!t)return void(this._allBitmaps=null);const s=new Map;let e=0;for(;t.next();)switch(t.tag()){case 1:{const a=t.getMessage();for(;a.next();)switch(a.tag()){case 3:{const l=a.getMessage();let c,y,g,S,m,p,P;for(;l.next();)switch(l.tag()){case 1:c=l.getUInt32();break;case 2:y=l.getBytes();break;case 3:g=l.getUInt32();break;case 4:S=l.getUInt32();break;case 5:m=l.getSInt32();break;case 6:p=l.getSInt32();break;case 7:P=l.getUInt32();break;default:l.skip()}if(l.release(),c){const R=y?.length??0;this._metrics[c]={width:g,height:S,left:m,top:p,advance:P,startOffset:e,length:R},s.set(c,y),e+=R}break}default:a.skip()}a.release();break}default:t.skip()}const i=new Uint8Array(e),o=this._metrics;for(const[a,l]of s){const{startOffset:c,length:y}=o[a];if(l)for(let g=0;g<y;++g)i[c+g]=l[g]}this._allBitmaps=i}getMetrics(t){return this._metrics[t]}getBitmap(t){if(!this._allBitmaps)return;const s=this._metrics[t];if(void 0===s)return;const{startOffset:e,length:i}=s;return 0!==i?new it(this._allBitmaps,e,i):void 0}}class V{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(t){return this._ranges[t]}addRange(t,s){this._ranges[t]=s}}class N{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,s){const e=this._getFontStack(t);if(e.getRange(s))return Promise.resolve();const i=256*s,o=i+255;if(this._baseURL){const a=this._baseURL.replace("{fontstack}",t).replace("{range}",i+"-"+o);return(0,H.Z)(a,{responseType:"array-buffer"}).then(l=>{e.addRange(s,new U(new C.Z(new Uint8Array(l.data),new DataView(l.data))))}).catch(()=>{e.addRange(s,new U)})}return e.addRange(s,new U),Promise.resolve()}getGlyph(t,s){const e=this._getFontStack(t);if(!e)return;const i=Math.floor(s/256),o=e.getRange(i);return o?{metrics:o.getMetrics(s),bitmap:o.getBitmap(s)}:void 0}_getFontStack(t){let s=this._glyphInfo[t];return s||(s=this._glyphInfo[t]=new V),s}}class it{constructor(t,s,e){this._array=t,this._start=s,this.length=e}at(t){return 0<=t&&t<this.length?this._array[this._start+t]:void 0}}var rt=v(52793);class ct{constructor(t,s,e=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(t<=0||s<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=s,e>0&&(this._maxItemSize=e),this._binPack=new T(t-4,s-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const t of this._textures)t&&t.dispose();this._textures.length=0}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new T(this._pageWidth-4,this._pageHeight-4);const s=Math.floor(this._pageWidth),e=Math.floor(this._pageHeight),i=new Uint32Array(s*e);this._mosaicsData[0]=i,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=t}getSpriteItem(t,s=!1){let e,i,o=this._mosaicRects[t];if(o)return o;if(!this._sprites||"loaded"!==this._sprites.loadStatus||(t&&t.startsWith("dasharray-")?([e,i]=this._rasterizeDash(t),s=!0):e=this._sprites.getSpriteInfo(t),!e?.width||!e.height||e.width<0||e.height<0))return null;const a=e.width,l=e.height,[c,y,g]=this._allocateImage(a,l);return c.width<=0?null:(this._copy(c,e,y,g,s,i),o={rect:c,width:a,height:l,sdf:e.sdf,simplePattern:!1,pixelRatio:e.pixelRatio,page:y},this._mosaicRects[t]=o,o)}getSpriteItems(t){const s={};for(const e of t)s[e.name]=this.getSpriteItem(e.name,e.repeat);return s}getMosaicItemPosition(t,s){const e=this.getSpriteItem(t,s),i=e&&e.rect;return i?(i.width=e.width,i.height=e.height,{tl:[i.x+2,i.y+2],br:[i.x+2+e.width,i.y+2+e.height],page:e.page}):null}bind(t,s,e=0,i=0){if(e>=this._size.length||e>=this._mosaicsData.length)return;if(!this._textures[e]){const a=new G.X;a.wrapMode=b.e8.CLAMP_TO_EDGE,a.width=this._size[e][0],a.height=this._size[e][1],this._textures[e]=new K.x(t,a,new Uint8Array(this._mosaicsData[e].buffer))}const o=this._textures[e];o.setSamplingMode(s),this._dirties[e]&&o.setData(new Uint8Array(this._mosaicsData[e].buffer)),t.bindTexture(o,i),this._dirties[e]=!1}static _copyBits(t,s,e,i,o,a,l,c,y,g,S){let m=i*s+e,p=c*a+l;if(S){p-=a;for(let P=-1;P<=g;P++,m=((P+g)%g+i)*s+e,p+=a)for(let R=-1;R<=y;R++)o[p+R]=t[m+(R+y)%y]}else for(let P=0;P<g;P++){for(let R=0;R<y;R++)o[p+R]=t[m+R];m+=s,p+=a}}_copy(t,s,e,i,o,a){if(!this._sprites||"loaded"!==this._sprites.loadStatus||e>=this._mosaicsData.length)return;const l=new Uint32Array(a?a.buffer:this._sprites.image.buffer),c=this._mosaicsData[e];c&&l||console.error("Source or target images are uninitialized!"),ct._copyBits(l,a?s.width:this._sprites.width,s.x,s.y,c,i[0],t.x+2,t.y+2,s.width,s.height,o),this._dirties[e]=!0}_allocateImage(t,s){t+=2,s+=2;const e=Math.max(t,s);if(this._maxItemSize&&this._maxItemSize<e){const l=new I.Z(0,0,t,s);return this._mosaicsData.push(new Uint32Array(t*s)),this._dirties.push(!0),this._size.push([t,s]),this._textures.push(void 0),[l,this._mosaicsData.length-1,[t,s]]}let i=t%4?4-t%4:4,o=s%4?4-s%4:4;1===i&&(i=5),1===o&&(o=5);const a=this._binPack.allocate(t+i,s+o);return a.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new T(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,s)):[a,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(t){const e=t.match(/\[(.*?)\]/);if(!e)return null;const i=e[1].split(",").map(Number),o=t.slice(t.lastIndexOf("-")+1),[a,l,c]=(0,rt.m)(i,o);return[{x:0,y:0,width:l,height:c,sdf:!0,pixelRatio:1},new Uint8Array(a.buffer)]}}var et=v(54529);class Dt{constructor(t,s,e){this._layer=t,this._styleRepository=s,this.devicePixelRatio=e,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=(0,D.IM)(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then(()=>this._spriteMosaic)}get glyphMosaic(){return this._glyphMosaic}start(t){var s=this;return(0,z.Z)(function*(){s._requestSprite(t);const e=s._layer.currentStyleInfo.glyphsUrl,i=new N(e?(0,x.fl)(e,{...s._layer.customParameters,token:s._layer.apiKey}):null);s._glyphMosaic=new B(1024,1024,i),s._broadcastPromise=(0,w.bA)("WorkerTileHandler",{client:s,schedule:t.schedule,signal:t.signal}).then(o=>{if(s._layer&&(s._connection?.close(),s._connection=o,s._layer&&!s._connection.closed)){const a=o.broadcast("setStyle",s._layer.currentStyleInfo.style,t);Promise.all(a).catch(l=>(0,L.H9)(l))}})})()}_requestSprite(t){this._spriteSourceAbortController?.abort();const s=new AbortController;this._spriteSourceAbortController=s;const e=t?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,e&&(this._inputSignalEventListener=function Mt(h){return()=>h.abort()}(s),e.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:i}=s,o={...t,signal:i};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,o),this._spriteSourcePromise.then(a=>{(0,L.r9)(i),this._spriteMosaic=new ct(1024,1024,250),this._spriteMosaic.setSpriteSource(a)})}updateStyle(t){var s=this;return(0,z.Z)(function*(){return yield s._broadcastPromise,s._broadcastPromise=Promise.all(s._connection.broadcast("updateStyle",t)),s._broadcastPromise})()}setSpriteSource(t){const s=new ct(1024,1024,250);return s.setSpriteSource(t),this._spriteMosaic=s,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,s}setStyle(t,s){var e=this;return(0,z.Z)(function*(){yield e._broadcastPromise,e._styleRepository=t,e._requestSprite();const i=new N(e._layer.currentStyleInfo.glyphsUrl?(0,x.fl)(e._layer.currentStyleInfo.glyphsUrl,{...e._layer.customParameters,token:e._layer.apiKey}):null);return e._glyphMosaic=new B(1024,1024,i),e._broadcastPromise=Promise.all(e._connection.broadcast("setStyle",s)),e._broadcastPromise})()}fetchTileData(t,s){return this._getRefKeys(t,s).then(e=>{const i=this._layer.sourceNameToSource,o=[];for(const a in i)o.push(a);return this._getSourcesData(o,e,s)})}parseTileData(t,s){const e=t&&t.data;if(!e)return Promise.resolve(null);const{sourceName2DataAndRefKey:i,transferList:o}=e;return 0===Object.keys(i).length?Promise.resolve(null):this._broadcastPromise.then(()=>this._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:i,styleLayerUIDs:t.styleLayerUIDs},{...s,transferList:o}))}getSprites(t){var s=this;return(0,z.Z)(function*(){return yield s._spriteSourcePromise,s._spriteMosaic.getSpriteItems(t)})()}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}_getTilePayload(t,s,e){var i=this;return(0,z.Z)(function*(){const o=et.Z.pool.acquire(t.id),a=i._layer.sourceNameToSource[s],{level:l,row:c,col:y}=o;et.Z.pool.release(o);try{return{protobuff:yield a.requestTile(l,c,y,e),sourceName:s}}catch(g){if((0,L.D_)(g))throw g;return{protobuff:null,sourceName:s}}})()}_getRefKeys(t,s){const e=this._layer.sourceNameToSource,i=new Array;for(const o in e){const a=e[o].getRefKey(t,s);i.push(a)}return Promise.allSettled(i)}_getSourcesData(t,s,e){const i=[];for(let o=0;o<s.length;o++){const a=s[o],l="fulfilled"===a.status?a.value:null;if(null==l||null==t[o])i.push(null);else{const c=this._getTilePayload(l,t[o],e);i.push(c)}}return Promise.allSettled(i).then(o=>{const a={},l=[];for(let c=0;c<o.length;c++){const y=o[c],g="fulfilled"===y.status?y.value:null,S=g?.protobuff;if(!g||!S?.byteLength)continue;const m=s[c],p="fulfilled"===m.status?m.value:null;p&&(a[g.sourceName]={refKey:p.id,protobuff:S},l.push(S))}return{sourceName2DataAndRefKey:a,transferList:l}})}}var Pt=v(52540),pt=v(22879);const At=(h,t)=>h+1/(1<<2*t);class Ut{constructor(t,s){this._tiles=new Map,this._tileCache=new Pt.z(40,e=>e.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=s}destroy(){for(const[t,s]of this._tiles)s.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(t){this._updateCacheSize(t);const s=this.tileInfoView,e=s.getTileCoverage(t.state,0,!0,"smallest");if(!e)return!0;const{spans:i,lodInfo:o}=e,{level:a}=o,l=this._tiles,c=new Set,y=new Set;for(const{row:S,colFrom:m,colTo:p}of i)for(let P=m;P<=p;P++){const R=et.Z.getId(a,S,o.normalizeCol(P),o.getWorldForColumn(P)),E=this._getOrAcquireTile(R);c.add(R),E.processed()?this._addToContainer(E):y.add(new et.Z(R))}for(const[S,m]of l)m.isCoverage=c.has(S);for(const S of y)this._findPlaceholdersForMissingTiles(S,c);let g=!1;for(const[S,m]of l)m.neededForCoverage=c.has(S),m.neededForCoverage||m.isHoldingForFade&&s.intersects(e,m.key)&&c.add(S),m.isFading&&(g=!0);for(const[S,m]of this._tiles)c.has(S)||this._releaseTile(S);return pt.Z.pool.release(e),!g}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(t,s){const e=[];for(const[o,a]of this._tiles)this._addPlaceholderChild(e,a,t,s);const i=e.reduce(At,0);Math.abs(1-i)<1e-6||this._addPlaceholderParent(t.id,s)}_addPlaceholderChild(t,s,e,i){s.key.level<=e.level||!s.hasData()||function Ot(h,t){const s=t.level-h.level;return h.row===t.row>>s&&h.col===t.col>>s&&h.world===t.world}(e,s.key)&&(this._addToContainer(s),i.add(s.id),t.push(s.key.level-e.level))}_addPlaceholderParent(t,s){const e=this._tiles;let i=t;for(;;){if(i=Et(i),!i||s.has(i))return;const o=e.get(i);if(o&&o.hasData())return this._addToContainer(o),void s.add(o.id)}}_getOrAcquireTile(t){let s=this._tiles.get(t);return s||(s=this._tileCache.pop(t),s||(s=this.acquireTile(new et.Z(t))),this._tiles.set(t,s),s)}_releaseTile(t){const s=this._tiles.get(t);this.releaseTile(s),this._removeFromContainer(s),this._tiles.delete(t),s.hasData()?this._tileCache.put(t,s,1):s.dispose()}_addToContainer(t){let s;const e=[],i=this._container;if(i.contains(t))return;const o=this._visibleTiles;for(const[a,l]of o)this._canConnectDirectly(t,l)&&e.push(l),null==s&&this._canConnectDirectly(l,t)&&(s=l);if(null!=s){for(const a of e)s.childrenTiles.delete(a),t.childrenTiles.add(a),a.parentTile=t;s.childrenTiles.add(t),t.parentTile=s}else for(const a of e)t.childrenTiles.add(a),a.parentTile=t;o.set(t.id,t),i.addChild(t)}_removeFromContainer(t){if(this._visibleTiles.delete(t.id),this._container.removeChild(t),null!=t.parentTile){t.parentTile.childrenTiles.delete(t);for(const s of t.childrenTiles)null!=t.parentTile&&t.parentTile.childrenTiles.add(s)}for(const s of t.childrenTiles)s.parentTile=t.parentTile;t.parentTile=null,t.childrenTiles.clear()}_canConnectDirectly(t,s){const e=t.key;let{level:i,row:o,col:a,world:l}=s.key;const c=this._visibleTiles;for(;i>0;){if(i--,o>>=1,a>>=1,e.level===i&&e.row===o&&e.col===a&&e.world===l)return!0;if(c.has(`${i}/${o}/${a}/${l}`))return!1}return!1}_updateCacheSize(t){const s=t.state.size;if(s[0]===this._viewSize[0]&&s[1]===this._viewSize[1])return;const e=Math.ceil(s[0]/512)+1,i=Math.ceil(s[1]/512)+1;this._viewSize[0]=s[0],this._viewSize[1]=s[1],this._tileCache.maxSize=5*e*i}}function Et(h){const[t,s,e,i]=h.split("/"),o=parseInt(t,10);return 0===o?null:`${o-1}/${parseInt(s,10)>>1}/${parseInt(e,10)>>1}/${parseInt(i,10)}`}v(14007);var ut=v(51006),at=v(71602),mt=v(40271);class kt{constructor(t){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t}}class Vt{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function xt(h,t,s,e,i,o){const a=s-i;if(a>=0)return(t>>a)+(e-(o<<a))*(h>>a);const l=-a;return t-(o-(e<<l))*(h>>l)<<l}class wt{constructor(t,s,e){this._rows=Math.ceil(s/e),this._columns=Math.ceil(t/e),this._cellSize=e,this.cells=new Array(this._rows);for(let i=0;i<this._rows;i++){this.cells[i]=new Array(this._columns);for(let o=0;o<this._columns;o++)this.cells[i][o]=[]}}getCell(t,s){const e=Math.min(Math.max(Math.floor(s/this._cellSize),0),this._rows-1),i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[e]&&this.cells[e][i]||null}getCellSpan(t,s,e,i){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function zt(h,t,s,e,i){const o=h.layerData.get(i);if(o.type===f.al.SYMBOL){for(const a of e){const l=a.unique;let c;if(a.selectedForRendering){const y=l.parts[0],g=y.startOpacity,S=y.targetOpacity;h.allSymbolsFadingOut=h.allSymbolsFadingOut&&0===S;const m=s?Math.floor(127*g)|S<<7:S?255:0;c=m<<24|m<<16|m<<8|m}else c=0;for(const[y,g]of a.iconVertexRanges)for(let S=y;S<y+g;S+=4)o.iconOpacity[S/4]=c;if(a.selectedForRendering){const y=l.parts[1],g=y.startOpacity,S=y.targetOpacity;h.allSymbolsFadingOut=h.allSymbolsFadingOut&&0===S;const m=s?Math.floor(127*g)|S<<7:S?255:0;c=m<<24|m<<16|m<<8|m}else c=0;for(const[y,g]of a.textVertexRanges)for(let S=y;S<y+g;S+=4)o.textOpacity[S/4]=c}o.lastOpacityUpdate=t,o.opacityChanged=!0}}var $=v(39853),lt=v(46682);class dt{constructor(t,s){this.layerUIDs=[],this.isDestroyed=!1,this._data=t;let e=1;const i=new Uint32Array(t);this.layerUIDs=[];const o=i[e++];for(let a=0;a<o;a++)this.layerUIDs[a]=i[e++];this.bufferDataOffset=e,s&&(this.layer=s.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(t){null!=this._data&&(this.doPrepareForRendering(t,this._data,this.bufferDataOffset),this._data=null)}}class Ht extends dt{constructor(t,s){super(t,s),this.type=f.al.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const e=new Uint32Array(t);let i=this.bufferDataOffset;this.lineIndexStart=e[i++],this.lineIndexCount=e[i++];const o=e[i++];if(o>0){this.patternMap=new Map;for(let a=0;a<o;a++){const l=e[i++],c=e[i++],y=e[i++];this.patternMap.set(l,[c,y])}}this.bufferDataOffset=i}get memoryUsed(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=(0,D.M2)(this.vao)}doPrepareForRendering(t,s,e){const i=new Uint32Array(s),o=new Int32Array(i.buffer),a=i[e++],l=$.f.createVertex(t,b.l1.STATIC_DRAW,new Int32Array(o.buffer,4*e,a));e+=a;const c=i[e++],y=$.f.createIndex(t,b.l1.STATIC_DRAW,new Uint32Array(i.buffer,4*e,c));e+=c;const g=this.layer.lineMaterial;this.vao=new lt.U(t,g.getAttributeLocations(),g.getLayoutInfo(),{geometry:l},y)}}class Nt extends dt{constructor(t,s){super(t,s),this.type=f.al.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const e=new Uint32Array(t);let i=this.bufferDataOffset;this.fillIndexStart=e[i++],this.fillIndexCount=e[i++],this.outlineIndexStart=e[i++],this.outlineIndexCount=e[i++];const o=e[i++];if(o>0){this.patternMap=new Map;for(let a=0;a<o;a++){const l=e[i++],c=e[i++],y=e[i++];this.patternMap.set(l,[c,y])}}this.bufferDataOffset=i}get memoryUsed(){return(this.data?.byteLength??0)+(this.fillVAO?.usedMemory??0)+(this.outlineVAO?.usedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=(0,D.M2)(this.fillVAO),this.outlineVAO=(0,D.M2)(this.outlineVAO)}doPrepareForRendering(t,s,e){const i=new Uint32Array(s),o=new Int32Array(i.buffer),a=i[e++],l=$.f.createVertex(t,b.l1.STATIC_DRAW,new Int32Array(o.buffer,4*e,a));e+=a;const c=i[e++],y=$.f.createIndex(t,b.l1.STATIC_DRAW,new Uint32Array(i.buffer,4*e,c));e+=c;const g=i[e++],S=$.f.createVertex(t,b.l1.STATIC_DRAW,new Int32Array(o.buffer,4*e,g));e+=g;const m=i[e++],p=$.f.createIndex(t,b.l1.STATIC_DRAW,new Uint32Array(i.buffer,4*e,m));e+=m;const P=this.layer,R=P.fillMaterial,E=P.outlineMaterial;this.fillVAO=new lt.U(t,R.getAttributeLocations(),R.getLayoutInfo(),{geometry:l},y),this.outlineVAO=new lt.U(t,E.getAttributeLocations(),E.getLayoutInfo(),{geometry:S},p)}}class Wt extends dt{constructor(t,s,e){super(t,s),this.type=f.al.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const i=new Uint32Array(t),o=new Int32Array(t),a=new Float32Array(t);let l=this.bufferDataOffset;this.isIconSDF=!!i[l++];const c=i[l++];for(let m=0;m<c;m++){const p=i[l++],P=i[l++],R=i[l++];this.iconPerPageElementsMap.set(p,[P,R])}const y=i[l++];for(let m=0;m<y;m++){const p=i[l++],P=i[l++],R=i[l++];this.glyphPerPageElementsMap.set(p,[P,R])}const g=i[l++],S=i[l++];this.iconOpacity=new Int32Array(g),this.textOpacity=new Int32Array(S),l=function Ft(h,t,s,e,i,o){const a=t[e++];for(let l=0;l<a;l++){const c=new kt(o);c.xTile=t[e++],c.yTile=t[e++],c.hash=t[e++],c.priority=t[e++];const y=t[e++];for(let m=0;m<y;m++){const p=t[e++],P=t[e++],R=t[e++],E=t[e++],O=!!t[e++],Z=t[e++],j=s[e++],q=s[e++],tt=t[e++],Y=t[e++];c.colliders.push({xTile:p,yTile:P,dxPixels:R,dyPixels:E,hard:O,partIndex:Z,width:tt,height:Y,minLod:j,maxLod:q})}const g=h[e++];for(let m=0;m<g;m++)c.textVertexRanges.push([h[e++],h[e++]]);const S=h[e++];for(let m=0;m<S;m++)c.iconVertexRanges.push([h[e++],h[e++]]);i.push(c)}return e}(i,o,a,l,this.symbols,e),this.bufferDataOffset=l}get memoryUsed(){return(this.data?.byteLength??0)+(this.iconVAO?.usedMemory??0)+(this.textVAO?.usedMemory??0)+(0,mt.Xw)(this.iconOpacity)+(0,mt.Xw)(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[s,e]of this.iconPerPageElementsMap)t+=e[1];for(const[s,e]of this.glyphPerPageElementsMap)t+=e[1];return t/3}doDestroy(){this.iconVAO=(0,D.M2)(this.iconVAO),this.textVAO=(0,D.M2)(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,s=this.iconVAO.vertexBuffers.opacity;t.length>0&&t.byteLength===s.byteLength&&s.setSubData(t,0,0,t.length);const e=this.textOpacity,i=this.textVAO.vertexBuffers.opacity;e.length>0&&e.byteLength===i.byteLength&&i.setSubData(e,0,0,e.length)}doPrepareForRendering(t,s,e){const i=new Uint32Array(s),o=new Int32Array(i.buffer),a=i[e++],l=$.f.createVertex(t,b.l1.STATIC_DRAW,new Int32Array(o.buffer,4*e,a));e+=a;const c=i[e++],y=$.f.createIndex(t,b.l1.STATIC_DRAW,new Uint32Array(i.buffer,4*e,c));e+=c;const g=i[e++],S=$.f.createVertex(t,b.l1.STATIC_DRAW,new Int32Array(o.buffer,4*e,g));e+=g;const m=i[e++],p=$.f.createIndex(t,b.l1.STATIC_DRAW,new Uint32Array(i.buffer,4*e,m));e+=m;const P=$.f.createVertex(t,b.l1.STATIC_DRAW,this.iconOpacity.buffer),R=$.f.createVertex(t,b.l1.STATIC_DRAW,this.textOpacity.buffer),E=this.layer,O=E.iconMaterial,Z=E.textMaterial;this.iconVAO=new lt.U(t,O.getAttributeLocations(),O.getLayoutInfo(),{geometry:l,opacity:P},y),this.textVAO=new lt.U(t,Z.getAttributeLocations(),Z.getLayoutInfo(),{geometry:S,opacity:R},p)}}class Zt extends dt{constructor(t,s){super(t,s),this.type=f.al.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const e=new Uint32Array(t);let i=this.bufferDataOffset;this.circleIndexStart=e[i++],this.circleIndexCount=e[i++],this.bufferDataOffset=i}get memoryUsed(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=(0,D.M2)(this.vao)}doPrepareForRendering(t,s,e){const i=new Uint32Array(s),o=new Int32Array(i.buffer),a=i[e++],l=$.f.createVertex(t,b.l1.STATIC_DRAW,new Int32Array(o.buffer,4*e,a));e+=a;const c=i[e++],y=$.f.createIndex(t,b.l1.STATIC_DRAW,new Uint32Array(i.buffer,4*e,c));e+=c;const g=this.layer.circleMaterial;this.vao=new lt.U(t,g.getAttributeLocations(),g.getLayoutInfo(),{geometry:l},y)}}var ht=v(9655),bt=v(13305);class ft extends bt.I{constructor(t,s,e,i,o,a,l,c=null){super(t,s,e,i,o,a,4096,4096),this.styleRepository=l,this._memCache=c,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<ht.v7}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<ht.v7)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(t){let s=!1;for(const e of t){const i=this.layerData.get(e);i&&(this._memoryUsedByLayerData-=i.memoryUsed,i.type===f.al.SYMBOL&&this.symbols.delete(e)&&(s=!0),i.destroy(),this.layerData.delete(e))}this._memCache?.updateSize(this.key.id,this,this._memoryUsedByLayerData),s&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}dispose(){"unloaded"!==this.status&&(St.delete(this),ft._destroyRenderBuckets(this.layerData),this.layerData=null,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsed(){return this._memoryUsedByLayerData+256}changeDataImpl(t){let s=!1;if(t){const{bucketsWithData:e,emptyBuckets:i}=t,o=this._createRenderBuckets(e);if(i&&i.byteLength>0){const a=new Uint32Array(i);for(const l of a)this._deleteLayerData(l)}for(const[a,l]of o)this._deleteLayerData(a),l.type===f.al.SYMBOL&&(this.symbols.set(a,l.symbols),s=!0),this._memoryUsedByLayerData+=l.memoryUsed,this.layerData.set(a,l);this._memCache?.updateSize(this.key.id,this,this.memoryUsed)}this._hasSymbolBuckets=!1;for(const[e,i]of this.layerData)i.type===f.al.SYMBOL&&(this._hasSymbolBuckets=!0);s&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(s){s.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t){super.setTransform(t);const s=this.resolution/(t.resolution*t.pixelRatio),e=this.width/this.rangeX*s,i=this.height/this.rangeY*s,o=[0,0];t.toScreen(o,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;(0,ut.g)(a),(0,ut.h)(a,a,o),(0,ut.r)(a,a,Math.PI*t.rotation/180),(0,ut.c)(a,a,[e,i,1])}_createTransforms(){return{dvs:(0,at.c)(),tileMat3:(0,at.c)(),tileUnitsToPixels:(0,at.c)()}}static _destroyRenderBuckets(t){if(!t)return;const s=new Set;for(const e of t.values())s.has(e)||(e.destroy(),s.add(e));t.clear()}_createRenderBuckets(t){const s=new Map,e=new Map;for(const i of t){const o=this._deserializeBucket(i,e);for(const a of o.layerUIDs)s.set(a,o)}return s}_deserializeBucket(t,s){let e=s.get(t);if(e)return e;switch(new Uint32Array(t)[0]){case f.al.FILL:e=new Nt(t,this.styleRepository);break;case f.al.LINE:e=new Ht(t,this.styleRepository);break;case f.al.SYMBOL:e=new Wt(t,this.styleRepository,this);break;case f.al.CIRCLE:e=new Zt(t,this.styleRepository)}return s.set(t,e),e}_deleteLayerData(t){if(!this.layerData.has(t))return;const s=this.layerData.get(t);this._memoryUsedByLayerData-=s.memoryUsed,s.destroy(),this.layerData.delete(t)}}const St=new Map;var jt=v(45974),W=v(59078);function Qt(h,t,s,e,i,o){const{iconRotationAlignment:a,textRotationAlignment:l,iconTranslate:c,iconTranslateAnchor:y,textTranslate:g,textTranslateAnchor:S}=e;let m=0;for(const p of h.colliders){const[P,R]=0===p.partIndex?c:g,E=0===p.partIndex?y:S,O=p.minLod<=o&&o<=p.maxLod;m+=O?0:1,p.enabled=O,p.xScreen=p.xTile*i[0]+p.yTile*i[3]+i[6],p.yScreen=p.xTile*i[1]+p.yTile*i[4]+i[7],E===W.fD.MAP?(p.xScreen+=s*P-t*R,p.yScreen+=t*P+s*R):(p.xScreen+=P,p.yScreen+=R),W.aF.VIEWPORT===(0===p.partIndex?a:l)?(p.dxScreen=p.dxPixels,p.dyScreen=p.dyPixels):(p.dxScreen=s*(p.dxPixels+p.width/2)-t*(p.dyPixels+p.height/2)-p.width/2,p.dyScreen=t*(p.dxPixels+p.width/2)+s*(p.dyPixels+p.height/2)-p.height/2)}h.colliders.length>0&&m===h.colliders.length&&(h.unique.show=!1)}class Gt{constructor(t,s,e,i,o,a){this._symbols=t,this._styleRepository=i,this._zoom=o,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new wt(s,e,ht.cn),this._si=Math.sin(Math.PI*a/180),this._co=Math.cos(Math.PI*a/180);for(const l of t)for(const c of l.symbols)this._allNeededMatrices.has(c.tile)||this._allNeededMatrices.set(c.tile,(0,at.a)(c.tile.transforms.tileUnitsToPixels))}work(t){const s=this._gridIndex;function e(o){const a=o.xScreen+o.dxScreen,l=o.yScreen+o.dyScreen,c=a+o.width,y=l+o.height,[g,S,m,p]=s.getCellSpan(a,l,c,y);for(let P=S;P<=p;P++)for(let R=g;R<=m;R++){const E=s.cells[P][R];for(const O of E){const Z=O.xScreen+O.dxScreen,j=O.yScreen+O.dyScreen;if(!(c<Z||a>Z+O.width||y<j||l>j+O.height))return!0}}return!1}const i=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const o=this._symbols[this._currentLayerCursor],a=this._getProperties(o.styleLayerUID);for(;this._currentSymbolCursor<o.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-i>t)return!1;const l=o.symbols[this._currentSymbolCursor];if(!l.unique.show)continue;Qt(l,this._si,this._co,a,this._allNeededMatrices.get(l.tile),this._zoom);const c=l.unique;if(!c.show)continue;const{iconAllowOverlap:y,iconIgnorePlacement:g,textAllowOverlap:S,textIgnorePlacement:m}=a;for(const p of l.colliders){if(!p.enabled)continue;const P=c.parts[p.partIndex];P.show&&!(p.partIndex?S:y)&&e(p)&&(p.hard?c.show=!1:P.show=!1)}if(c.show)for(const p of l.colliders){if(!p.enabled||(p.partIndex?m:g)||!c.parts[p.partIndex].show)continue;const P=p.xScreen+p.dxScreen,R=p.yScreen+p.dyScreen,E=P+p.width,O=R+p.height,[Z,j,q,tt]=this._gridIndex.getCellSpan(P,R,E,O);for(let Y=j;Y<=tt;Y++)for(let X=Z;X<=q;X++)this._gridIndex.cells[Y][X].push(p)}}}return!0}_getProperties(t){const s=this._styleProps.get(t);if(s)return s;const e=this._zoom,i=this._styleRepository.getStyleLayerByUID(t),o=i.getLayoutValue("symbol-placement",e)!==W.R.POINT;let a=i.getLayoutValue("icon-rotation-alignment",e);a===W.aF.AUTO&&(a=o?W.aF.MAP:W.aF.VIEWPORT);let l=i.getLayoutValue("text-rotation-alignment",e);l===W.aF.AUTO&&(l=o?W.aF.MAP:W.aF.VIEWPORT);const c=i.getPaintValue("icon-translate",e),y=i.getPaintValue("icon-translate-anchor",e),g=i.getPaintValue("text-translate",e),S=i.getPaintValue("text-translate-anchor",e),m={iconAllowOverlap:i.getLayoutValue("icon-allow-overlap",e),iconIgnorePlacement:i.getLayoutValue("icon-ignore-placement",e),textAllowOverlap:i.getLayoutValue("text-allow-overlap",e),textIgnorePlacement:i.getLayoutValue("text-ignore-placement",e),iconRotationAlignment:a,textRotationAlignment:l,iconTranslateAnchor:y,iconTranslate:c,textTranslateAnchor:S,textTranslate:g};return this._styleProps.set(t,m),m}}function Jt(h,t){if(h.priority-t.priority)return h.priority-t.priority;const s=h.tile.key,e=t.tile.key;return s.world-e.world?s.world-e.world:s.level-e.level?s.level-e.level:s.row-e.row?s.row-e.row:s.col-e.col?s.col-e.col:h.xTile-t.xTile?h.xTile-t.xTile:h.yTile-t.yTile}class qt{get running(){return this._running}constructor(t,s,e,i,o,a){this._visibleTiles=t,this._symbolRepository=s,this._createCollisionJob=e,this._assignTileSymbolsOpacity=i,this._symbolLayerSorter=o,this._isLayerVisible=a,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(t,s){this._screenWidth===t&&this._screenHeight===s||this.restart(),this._screenWidth=t,this._screenHeight=s}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(t){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const s=performance.now();if(!this._selectionJob.work(t)||(this._selectionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s)))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const s=performance.now();if(!this._collisionJob.work(t)||(this._collisionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s)))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const s=performance.now();if(!this._opacityJob.work(t)||(this._opacityJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s)))))return!1}return this._running=!1,!0}_createSelectionJob(){const t=this._symbolRepository.uniqueSymbols;for(let c=0;c<t.length;c++){const y=t[c];for(let g=0;g<y.uniqueSymbols.length;g++){const S=y.uniqueSymbols[g];for(const m of S.tileSymbols)m.selectedForRendering=!1}}const s=[];let e=0,i=0;const o=this._isLayerVisible,l=this._symbolLayerSorter;return{work:function a(c){let y;const g=performance.now();for(;i<t.length;i++,e=0){const S=t[i],m=S.styleLayerUID;if(!o(m)){s[i]||(s[i]={styleLayerUID:m,symbols:[]});continue}s[i]=s[i]||{styleLayerUID:m,symbols:[]};const p=s[i];for(;e<S.uniqueSymbols.length;e++){if(y=S.uniqueSymbols[e],e%100==99&&performance.now()-g>c)return!1;let P=null,R=!1,E=!1;for(const O of y.tileSymbols)if(!E||!R){const Z=O.tile;(!P||Z.isCoverage||Z.neededForCoverage&&!R)&&(P=O,(Z.neededForCoverage||Z.isCoverage)&&(E=!0),Z.isCoverage&&(R=!0))}if(P.selectedForRendering=!0,E){p.symbols.push(P),y.show=!0;for(const O of y.parts)O.show=!0}else y.show=!1}}for(const S of s)S.symbols.sort(Jt);return!0},get sortedSymbols(){return s.sort(l)}}}_createOpacityJob(){const t=this._assignTileSymbolsOpacity,s=this._visibleTiles;let e=0;function i(o,a){const l=o.symbols;for(const[c,y]of l)Kt(y,a);t(o,a);for(const c of o.childrenTiles)i(c,a)}return{work(o){const a=performance.now();for(;e<s.length;e++){if(performance.now()-a>o)return!1;const l=s[e];null==l.parentTile&&i(l,performance.now())}return!0}}}}function Kt(h,t){for(const s of h){const e=s.unique;for(const i of e.parts)i.startOpacity+=(t-i.startTime)/ht.v7*(i.targetOpacity>.5?1:-1),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=e.show&&i.show?1:0}}class te{constructor(t,s,e){this.tileCoordRange=t,this._visibleTiles=s,this._createUnique=e,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}add(t,s){this._uniqueSymbolLayerArray=null;let e=this._tiles.get(t.id);e||(e={symbols:new Map},this._tiles.set(t.id,e));const i=new Map;if(s)for(const l of s)e.symbols.has(l)&&(i.set(l,e.symbols.get(l)),e.symbols.delete(l));else for(const[l,c]of t.layerData)e.symbols.has(l)&&(i.set(l,e.symbols.get(l)),e.symbols.delete(l));this._removeSymbols(i);const o=t.symbols,a=new Map;for(const[l,c]of o){let y=c.length;if(y>=32){let g=this.tileCoordRange;do{g/=2,y/=4}while(y>8&&g>64);const S=new wt(this.tileCoordRange,this.tileCoordRange,g);a.set(l,{flat:c,index:S}),e.symbols.set(l,{flat:c,index:S});for(const m of c)S.getCell(m.xTile,m.yTile).push(m)}else a.set(l,{flat:c}),e.symbols.set(l,{flat:c})}this._addSymbols(t.key,o)}deleteStyleLayers(t){this._uniqueSymbolLayerArray=null;for(const[s,e]of this._tiles){const i=new Map;for(const o of t)e.symbols.has(o)&&(i.set(o,e.symbols.get(o)),e.symbols.delete(o));this._removeSymbols(i),0===e.symbols.size&&this._tiles.delete(s)}}removeTile(t){this._uniqueSymbolLayerArray=null;const s=this._tiles.get(t.id);if(!s)return;const e=new Map;for(const[i,o]of t.symbols)s.symbols.has(i)&&(e.set(i,s.symbols.get(i)),s.symbols.delete(i));this._removeSymbols(e),0===s.symbols.size&&this._tiles.delete(t.id)}_removeSymbols(t){for(const[s,{flat:e}]of t)for(const i of e){const o=i.unique,a=o.tileSymbols,l=a.length-1;for(let c=0;c<l;c++)if(a[c]===i){a[c]=a[l];break}if(a.length=l,0===l){const c=this._uniqueSymbolsReferences.get(s);c.delete(o),0===c.size&&this._uniqueSymbolsReferences.delete(s)}i.unique=null}}_addSymbols(t,s){if(0===s.size)return;const e=this._visibleTiles;for(const i of e)i.parentTile||i.key.world!==t.world||i.key.level===t.level&&!i.key.equals(t)||this._matchSymbols(i,t,s);for(const[i,o]of s)for(const a of o)if(null==a.unique){const l=this._createUnique();a.unique=l,l.tileSymbols.push(a);let c=this._uniqueSymbolsReferences.get(i);c||(c=new Set,this._uniqueSymbolsReferences.set(i,c)),c.add(l)}}_matchSymbols(t,s,e){if(t.key.level>s.level){const o=t.key.level-s.level;if(t.key.row>>o!==s.row||t.key.col>>o!==s.col)return}if(s.level>t.key.level){const o=s.level-t.key.level;if(s.row>>o!==t.key.row||s.col>>o!==t.key.col)return}if(s.equals(t.key)){for(const o of t.childrenTiles)this._matchSymbols(o,s,e);return}const i=new Map;for(const[o,a]of e){const l=[];for(const S of a){const m=xt(this.tileCoordRange,S.xTile,s.level,s.col,t.key.level,t.key.col),p=xt(this.tileCoordRange,S.yTile,s.level,s.row,t.key.level,t.key.row);m>=0&&m<this.tileCoordRange&&p>=0&&p<this.tileCoordRange&&l.push({symbol:S,xTransformed:m,yTransformed:p})}const c=[],y=t.key.level<s.level?1:1<<t.key.level-s.level,g=this._tiles.get(t.id).symbols.get(o);if(g){const S=g.flat;for(const m of l){let p,P=!1;const R=m.xTransformed,E=m.yTransformed;p=null!=g.index?g.index.getCell(R,E):S;const O=m.symbol,Z=O.hash;for(const j of p)if(Z===j.hash&&Math.abs(R-j.xTile)<=y&&Math.abs(E-j.yTile)<=y){const q=j.unique;O.unique=q,q.tileSymbols.push(O),P=!0;break}P||c.push(O)}}c.length>0&&i.set(o,c)}for(const o of t.childrenTiles)this._matchSymbols(o,s,i)}_createUniqueSymbolLayerArray(){const t=this._uniqueSymbolsReferences,s=new Array(t.size);let e,i=0;for(const[o,a]of t){const l=new Array(a.size);e=0;for(const c of a)l[e++]=c;s[i]={styleLayerUID:o,uniqueSymbols:l},i++}return s}}class se{constructor(t,s){this.styleRepository=t,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._fading=(0,jt.t)(!1),this._symbolRepository=new te(4096,s,()=>new Vt),this._symbolDeclutterer=new qt(s,this._symbolRepository,(e,i,o)=>new Gt(e,i,o,this.styleRepository,this._zoom,this._viewState.rotation),(e,i)=>{e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=i,function Bt(h,t,s){for(const[e,i]of h.symbols)zt(h,t,s,i,e)}(e,i,!0),e.decluttered=!0,e.requestRender()},(e,i)=>this.styleRepository.getStyleLayerByUID(e.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(i.styleLayerUID).z,e=>{const i=this.styleRepository.getStyleLayerByUID(e);if(this._zoom+1e-6<i.minzoom||this._zoom-1e-6>=i.maxzoom)return!1;const o=i.getLayoutProperty("visibility");return!o||o.getValue()!==W.EE.NONE})}get fading(){return this._fading.value}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",()=>{this._symbolRepository.add(t),this.restartDeclutter()})),this._symbolRepository.add(t),this.restartDeclutter()}removeTile(t){const s=this._tileToHandle.get(t);s&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),s.remove(),this._tileToHandle.delete(t))}update(t,s){return this._zoom=t,this._viewState={scale:s.scale,rotation:s.rotation,center:[s.center[0],s.center[1]],size:[s.size[0],s.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(t=>t.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(ht.JM),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){null!=this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},1.5*ht.v7)}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}}var nt=v(43101);class ie extends bt.I{_createTransforms(){return{dvs:(0,at.c)(),tileMat3:(0,at.c)()}}}var re=v(75747);const _t=1e-6;function Tt(h,t){if(h){const s=h.getLayoutProperty("visibility");if(!s||s.getValue()!==W.EE.NONE&&(void 0===h.minzoom||h.minzoom<t+_t)&&(void 0===h.maxzoom||h.maxzoom>=t-_t))return!0}return!1}class ne extends re.Z{constructor(t){super(t),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}get fading(){return this._symbolFader?.fading??!1}setStyleResources(t,s,e){this._spriteMosaic=t,this._glyphMosaic=s,this._styleRepository=e,null==this._symbolFader&&(this._symbolFader=new se(this._styleRepository,this.children)),this._symbolFader.styleRepository=e}setSpriteMosaic(t){this._spriteMosaic?.dispose(),this._spriteMosaic=t}deleteStyleLayers(t){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(t)}hitTest(t){var s=this;return(0,z.Z)(function*(){const e=(0,L.hh)();return s._pointToCallbacks.set(t,e),s.requestRender(),e.promise})()}createRenderParams(t){return{...super.createRenderParams(t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(t){!this.visible||t.drawPhase!==nt.jx.MAP&&t.drawPhase!==nt.jx.DEBUG||void 0===this._spriteMosaic||super.doRender(t)}addChild(t){return super.addChild(t),null!=this._symbolFader?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t}removeChild(t){return null!=this._symbolFader&&this._symbolFader.removeTile(t),this.requestRender(),super.removeChild(t)}renderChildren(t){const{drawPhase:s}=t;if(s!==nt.jx.DEBUG){if(this._doRender(t),this._pointToCallbacks.size>0){t.drawPhase=nt.jx.HITTEST;const e=t.painter.effects.hittestVTL;e.bind(t),this._doRender(t),e.draw(t,this._pointToCallbacks),e.unbind(t),t.drawPhase=s}}else super.renderChildren(t)}removeAllChildren(){for(let t=0;t<this.children.length;t++){const s=this.children[t];null!=this._symbolFader&&this._symbolFader.removeTile(s),s.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(t=>t.neededForCoverage&&t.hasData())}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(t){const{context:s}=t,e=this._styleRepository;if(!e)return;const i=e.layers;let o=!0;t.drawPhase===nt.jx.HITTEST&&(o=!1),e.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,e.backgroundBucketIds)),super.renderChildren(t),t.drawPhase===nt.jx.MAP&&this._fade(t.displayLevel,t.state);const a=this.children.filter(l=>l.visible&&l.hasData());if(!a||0===a.length)return s.bindVAO(),s.setStencilTestEnabled(!0),void s.setBlendingEnabled(!0);for(const l of a)l.triangleCount=0;s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(b.xS.KEEP,b.xS.KEEP,b.xS.REPLACE),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(b.wb.LEQUAL),s.setClearDepth(1),s.clear(s.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let l=i.length-1;l>=0;l--)this._renderStyleLayer(i[l],t,a);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(o),s.setBlendFunctionSeparate(b.zi.ONE,b.zi.ONE_MINUS_SRC_ALPHA,b.zi.ONE,b.zi.ONE_MINUS_SRC_ALPHA),t.renderPass="translucent";for(let l=0;l<i.length;l++)this._renderStyleLayer(i[l],t,a);s.bindVAO(),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!0)}_fade(t,s){null!=this._symbolFader&&(this._symbolFader.update(t,s)||this.requestRender())}_renderStyleLayer(t,s,e){const{painter:i,renderPass:o}=s;if(void 0===t)return;const a=t.getLayoutProperty("visibility");if(a&&a.getValue()===W.EE.NONE)return;let l;switch(t.type){case W.fR.BACKGROUND:return;case W.fR.FILL:if("opaque"!==o&&"translucent"!==s.renderPass)return;l="vtlFill";break;case W.fR.LINE:if("translucent"!==o)return;l="vtlLine";break;case W.fR.CIRCLE:if("translucent"!==o)return;l="vtlCircle";break;case W.fR.SYMBOL:if("translucent"!==o)return;l="vtlSymbol"}if(e=e.filter(t.type===W.fR.SYMBOL?y=>y.decluttered:y=>y.neededForCoverage),"vtlSymbol"!==l){const y=s.displayLevel;if(0===e.length||void 0!==t.minzoom&&t.minzoom>=y+_t||void 0!==t.maxzoom&&t.maxzoom<y-_t)return}const c=t.uid;s.styleLayerUID=c,s.styleLayer=t;for(const y of e)if(y.layerData.has(c)){i.renderObjects(s,e,l);break}}_renderBackgroundLayers(t,s){const{context:e,displayLevel:i,painter:o,state:a}=t,l=this._styleRepository;let c=!1;for(const j of s)if(l.getLayerById(j).type===W.fR.BACKGROUND&&Tt(l.getLayerById(j),i)){c=!0;break}if(!c)return;const y=this._tileInfoView.getTileCoverage(t.state,0,!0,"smallest"),{spans:g,lodInfo:S}=y,{level:m}=S,p=(0,n.Ue)(),P=[];if(this._renderPasses){const j=this._renderPasses[0];null!=this._clippingInfos&&(j.brushes[0].prepareState(t),j.brushes[0].drawMany(t,this._clippingInfos))}const R=this._backgroundTiles;let E,O=0;for(const{row:j,colFrom:q,colTo:tt}of g)for(let Y=q;Y<=tt;Y++){if(O<R.length)E=R[O],E.key.set(m,j,S.normalizeCol(Y),S.getWorldForColumn(Y)),this._tileInfoView.getTileBounds(p,E.key,!1),E.x=p[0],E.y=p[3],E.resolution=this._tileInfoView.getTileResolution(m);else{const X=new et.Z(m,j,S.normalizeCol(Y),S.getWorldForColumn(Y)),ot=this._tileInfoView.getTileBounds((0,n.Ue)(),X),_e=this._tileInfoView.getTileResolution(m);E=new ie(X,_e,ot[0],ot[3],512,512,4096,4096),R.push(E)}E.setTransform(a),P.push(E),O++}e.setStencilWriteMask(0),e.setColorMask(!0,!0,!0,!0),e.setStencilOp(b.xS.KEEP,b.xS.KEEP,b.xS.REPLACE),e.setStencilFunction(b.wb.EQUAL,0,255);let Z=!0;t.drawPhase===nt.jx.HITTEST&&(Z=!1),e.setStencilTestEnabled(Z);for(const j of s){const q=l.getLayerById(j);q.type===W.fR.BACKGROUND&&Tt(q,i)&&(t.styleLayerUID=q.uid,t.styleLayer=q,o.renderObjects(t,P,"vtlBackground"))}pt.Z.pool.release(y)}}var It=v(14433),oe=v(93509),ae=v(30220),le=v(6777);class he extends le.Z{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(t){const s=et.Z.pool.acquire(t),e=0===s.level?null:et.Z.getId(s.level-1,s.row>>1,s.col>>1,s.world);return et.Z.pool.release(s),e}getTileCoverage(t,s,e=!0,i){const o=super.getTileCoverage(t,s,e,i);if(!o)return o;const a=1<<o.lodInfo.level;return o.spans=o.spans.filter(l=>l.row>=0&&l.row<a),o}scaleToLevel(t){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[t])return this._levelByScale[t];{const s=this._fullCacheLodInfos;if(t>s[0].scale)return s[0].level;let e,i;for(let o=0;o<s.length-1;o++)if(i=s[o+1],t>i.scale)return e=s[o],e.level+(e.scale-t)/(e.scale-i.scale);return s[s.length-1].level}}_initializeFullCacheLODs(t){let s;s=0===t[0].level?t.map(e=>({level:e.level,resolution:e.resolution,scale:e.scale})):ae.Z.create({size:this.tileInfo.size[0],spatialReference:this.tileInfo.spatialReference}).lods.map(o=>({level:o.level,resolution:o.resolution,scale:o.scale}));for(let e=0;e<s.length;e++)this._levelByScale[s[e].scale]=s[e].level;this._fullCacheLodInfos=s}}var Ct=v(87766),ce=v(50145);let yt=class extends((0,oe.y)(ce.Z)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1}get fading(){return this._vectorTileContainer?.fading??!1}hitTest(h,t){var s=this;return(0,z.Z)(function*(){if(!s._tileHandlerPromise)return null;yield s._tileHandlerPromise;const e=yield s._vectorTileContainer.hitTest(t);if(!e||0===e.length)return null;const i=e[0]-1,o=s._styleRepository,a=o.getStyleLayerByUID(i);if(!a)return null;const l=o.getStyleLayerIndex(a.id);return[{type:"graphic",mapPoint:h,layer:s.layer,graphic:new A.Z({attributes:{layerId:l,layerName:a.id,layerUID:i},layer:s.layer,sourceLayer:s.layer})}]})()}update(h){if(this._tileHandlerPromise&&this._isTileHandlerReady)return h.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=h.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=h.state,this._parseQueue.state=h.state,this._tileManager.update(h)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:h}=this.layer.currentStyleInfo;this._styleRepository=new It.Z(h),this._tileInfoView=new he(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new ne(this._tileInfoView),this._tileHandler=new Dt(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",t=>{if(t.isDataDriven)this._styleChanges.push({type:f.Fr.PAINTER_CHANGED,data:t}),this.requestUpdate();else{const s=this._styleRepository,e=s.getLayerById(t.layer);if(!e)return;const i=e.type===W.fR.SYMBOL;s.setPaintProperties(t.layer,t.paint),i&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender()}}),this.layer.on("layout-change",t=>{const s=this._styleRepository,e=s.getLayerById(t.layer);if(!e)return;const i=(0,r.Hg)(e.layout,t.layout);if(null!=i){if((0,r.uD)(i,"visibility")&&1===function ue(h){if(null==h)return 0;switch(h.type){case"partial":return Object.keys(h.diff).length;case"complete":return Math.max(Object.keys(h.oldValue).length,Object.keys(h.newValue).length);case"collection":return Object.keys(h.added).length+Object.keys(h.changed).length+Object.keys(h.removed).length}}(i))return s.setLayoutProperties(t.layer,t.layout),e.type===W.fR.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:f.Fr.LAYOUT_CHANGED,data:t}),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",t=>{const s=this._styleRepository,e=s.getLayerById(t.layer);e&&(s.setStyleLayerVisibility(t.layer,t.visibility),e.type===W.fR.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender())}),this.layer.on("style-layer-change",t=>{this._styleChanges.push({type:f.Fr.LAYER_CHANGED,data:t}),this.requestUpdate()}),this.layer.on("delete-style-layer",t=>{this._styleChanges.push({type:f.Fr.LAYER_REMOVED,data:t}),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",t=>{this._styleChanges.push({type:f.Fr.SPRITES_CHANGED,data:t});const s=this._styleRepository.layers;for(const e of s)switch(e.type){case W.fR.SYMBOL:e.getLayoutProperty("icon-image")&&this._styleChanges.push({type:f.Fr.LAYOUT_CHANGED,data:{layer:e.id,layout:e.layout}});break;case W.fR.LINE:e.getPaintProperty("line-pattern")&&this._styleChanges.push({type:f.Fr.PAINTER_CHANGED,data:{layer:e.id,paint:e.paint,isDataDriven:e.isPainterDataDriven()}});break;case W.fR.FILL:e.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:f.Fr.PAINTER_CHANGED,data:{layer:e.id,paint:e.paint,isDataDriven:e.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=(0,D.SC)(this._vectorTileContainer),this._tileHandler=(0,D.SC)(this._tileHandler)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(h){return(0,_.fS)(this.layer.tileInfo?.spatialReference,h)}canResume(){let h=super.canResume();const{currentStyleInfo:t}=this.layer;if(h&&t?.layerDefinition){const s=this.view.scale,{minScale:e,maxScale:i}=t.layerDefinition;t?.layerDefinition&&(e&&e<s&&(h=!1),i&&i>s&&(h=!1))}return h}isUpdating(){return this.fading}acquireTile(h){const t=this._createVectorTile(h);return this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then(s=>this._parseQueue.push({key:t.key,data:s})).then(s=>{t.once("attach",()=>this.requestUpdate()),t.setData(s),this.requestUpdate()}).catch(s=>{(0,L.D_)(s)||Q.Z.getLogger(this).error(s)})),t}releaseTile(h){const t=h.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new Ut({acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const h=new AbortController,t=this._tileHandler.start({signal:h.signal}).then(()=>{this._fetchQueue=new Ct.Z({tileInfoView:this._tileInfoView,process:(s,e)=>this._getTileData(s,e),concurrency:15}),this._parseQueue=new Ct.Z({tileInfoView:this._tileInfoView,process:(s,e)=>this._parseTileData(s,e),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(s=>{this._vectorTileContainer.setStyleResources(s,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()}),this._tileHandlerAbortController=h,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const h=this._tileHandlerAbortController;h&&h.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=(0,D.SC)(this._fetchQueue),this._parseQueue=(0,D.SC)(this._parseQueue),this._tileManager=(0,D.SC)(this._tileManager),this._vectorTileContainer.removeAllChildren()}_getTileData(h,t){var s=this;return(0,z.Z)(function*(){return s._tileHandler.fetchTileData(h,t)})()}_parseTileData(h,t){var s=this;return(0,z.Z)(function*(){return s._tileHandler.parseTileData(h,t)})()}_applyStyleChanges(){var h=this;return(0,z.Z)(function*(){h._isTileHandlerReady=!1,h._fetchQueue.pause(),h._parseQueue.pause(),h._fetchQueue.clear(),h._parseQueue.clear(),h._tileManager.clearCache();const t=h._styleChanges;try{yield h._tileHandler.updateStyle(t)}catch(a){Q.Z.getLogger(h).error("error applying vector-tiles style update",a.message),h._fetchQueue.resume(),h._parseQueue.resume(),h._isTileHandlerReady=!0}const s=h._styleRepository,e=new Set;t.forEach(a=>{if(a.type!==f.Fr.LAYER_REMOVED)return;const c=s.getLayerById(a.data.layer);c&&e.add(c.uid)});const i=new Set;t.forEach(a=>{let l;switch(a.type){case f.Fr.PAINTER_CHANGED:s.setPaintProperties(a.data.layer,a.data.paint),l=a.data.layer;break;case f.Fr.LAYOUT_CHANGED:s.setLayoutProperties(a.data.layer,a.data.layout),l=a.data.layer;break;case f.Fr.LAYER_REMOVED:return void s.deleteStyleLayer(a.data.layer);case f.Fr.LAYER_CHANGED:s.setStyleLayer(a.data.layer,a.data.index),l=a.data.layer.id;break;case f.Fr.SPRITES_CHANGED:h._vectorTileContainer.setSpriteMosaic(h._tileHandler.setSpriteSource(a.data.spriteSource))}if(l){const c=s.getLayerById(l);c&&i.add(c.uid)}});const o=h._vectorTileContainer.children;if(e.size>0){const a=Array.from(e);h._vectorTileContainer.deleteStyleLayers(a);for(const l of o)l.deleteLayerData(a)}if(h._fetchQueue.resume(),h._parseQueue.resume(),i.size>0){const a=Array.from(i),l=[];for(const c of o){const y=h._updatingHandles.addPromise(h._fetchQueue.push(c.key).then(g=>h._parseQueue.push({key:c.key,data:g,styleLayerUIDs:a})).then(g=>c.setData(g)));l.push(y)}yield Promise.all(l)}h._styleChanges=[],h._isTileHandlerReady=!0,h.requestUpdate()})()}_loadStyle(){var h=this;return(0,z.Z)(function*(){const{style:t}=h.layer.currentStyleInfo,s=(0,k.d9)(t);h._isTileHandlerReady=!1,h._fetchQueue.pause(),h._parseQueue.pause(),h._fetchQueue.clear(),h._parseQueue.clear(),h._styleRepository=new It.Z(s),h._vectorTileContainer.destroy(),h._tileManager.clear(),h._tileHandlerAbortController.abort(),h._tileHandlerAbortController=new AbortController;const{signal:e}=h._tileHandlerAbortController;try{h._tileHandlerPromise=h._tileHandler.setStyle(h._styleRepository,s),yield h._tileHandlerPromise}catch(o){if(!(0,L.D_)(o))throw o}if(e.aborted)return h._fetchQueue.resume(),h._parseQueue.resume(),h._isTileHandlerReady=!0,void h.requestUpdate();const i=yield h._tileHandler.spriteMosaic;h._vectorTileContainer.setStyleResources(i,h._tileHandler.glyphMosaic,h._styleRepository),h._fetchQueue.resume(),h._parseQueue.resume(),h._isTileHandlerReady=!0,h.requestUpdate()})()}_createVectorTile(h){const t=this._tileInfoView.getTileBounds((0,n.Ue)(),h),s=this._tileInfoView.getTileResolution(h.level);return new ft(h,s,t[0],t[3],512,512,this._styleRepository)}};(0,F._)([(0,M.Cb)()],yt.prototype,"_isTileHandlerReady",void 0),yt=(0,F._)([(0,d.j)("esri.views.2d.layers.VectorTileLayerView2D")],yt);const de=yt}}]);