"use strict";(self.webpackChunkangular_17_test=self.webpackChunkangular_17_test||[]).push([[8818],{93530:(oe,C,e)=>{function R(){return[1,0,0,0,1,0,0,0,1]}function A(v,S,N,K,X,J,$,w,U){return[v,S,N,K,X,J,$,w,U]}function j(v,S){return new Float64Array(v,S,9)}e.d(C,{a:()=>R,c:()=>j,f:()=>A}),Object.freeze(Object.defineProperty({__proto__:null,clone:function T(v){return[v[0],v[1],v[2],v[3],v[4],v[5],v[6],v[7],v[8]]},create:R,createView:j,fromValues:A},Symbol.toStringTag,{value:"Module"}))},28818:(oe,C,e)=>{e.r(C),e.d(C,{default:()=>Je});var R=e(15861),T=e(50484),U=(e(2189),e(35458),e(36699),e(15212),e(53722),e(82752),e(28999),e(38748),e(50923),e(42212),e(91963),e(4703)),de=(e(71950),e(83944)),ve=(e(14007),e(8611)),me=e(79412),c=e(77675),b=e(80543),fe=(e(1535),e(57678),e(10141)),ce=e(45425),ue=e(5825),ye=e(26230),q=e(46687),ge=e(57964),pe=(e(66679),e(6210),e(11931),e(66476),e(6785),e(54786),e(64456)),P=(e(84892),e(88278),e(55117)),k=e(99273),Re=(e(2902),e(43101)),B=(e(15585),e(48243),e(32196),e(36895),e(39237)),_=(e(35208),e(94544),e(99657),e(65311),e(10827),e(56035),e(53730),e(31894),e(18121),e(39853)),ee=(e(83018),e(3380),e(17091)),Te=e(46682),xe=(e(55898),e(40176),e(71960),e(82906),e(10264),e(59078),e(7077)),Ve=(e(17866),e(38550),e(59319),e(61362),e(68359),e(23783),e(56064),e(8735),e(7081),e(89877),e(53299),e(11462),e(63298),e(90771),e(47403),e(68994),e(78857),e(4460),e(10842),e(49602),e(44526),e(33520)),Me=e(93566),Ee=(e(46266),e(37636),e(6016),e(6777),e(54529),e(87766)),Ce=e(40394),Se=e(90984),te=e(51172),Ue=e(12933),Pe=e(93530),Ge=e(46033),De=e(51675),H=e(11196),Le=e(23306),Oe=e(22784);const x=(0,Pe.a)(),Ae={none:H.of.None,loop:H.of.Loop,oscillate:H.of.Oscillate};class Be extends pe.s{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.perspectiveTransform=(0,De.a)(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push((0,c.YP)(()=>this.elementView.element.opacity,s=>this.opacity=s,c.nn),(0,c.YP)(()=>[this.elementView.coords],()=>{this.requestRender()},c.nn),(0,c.YP)(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._playHandle?.remove(),this.texture=(0,te.M2)(this.texture),this.requestRender()},c.nn),(0,c.gx)(()=>this.elementView.element.loaded,()=>{const s=this.elementView.element;this.ready(),"video"===s.type&&null!=s.content&&this._handles.push((0,Se.on)(s.content,"play",()=>this.requestRender()))},c.nn)),t.element.load().catch(s=>{U.Z.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new ge.Z("element-load-error","Element cannot be displayed",{element:t,error:s}))})}destroy(){this._playHandle?.remove(),this._handles.forEach(t=>t.remove()),this.texture=(0,te.M2)(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:s}=t,r=this.elementView.element.content;if(null!=r){const i=r instanceof HTMLImageElement,l=r instanceof HTMLVideoElement,a=i?r.naturalWidth:l?r.videoWidth:r.width,o=i?r.naturalHeight:l?r.videoHeight:r.height;if(this._updatePerspectiveTransform(a,o),this.texture)l&&!r.paused&&(this.texture.setData(r),this.requestRender(),(s.type===k.zO.WEBGL2||(0,P.wt)(a)&&(0,P.wt)(o))&&this.texture.generateMipmap());else{const m=new Oe.X;if(m.wrapMode=B.e8.CLAMP_TO_EDGE,m.preMultiplyAlpha=!0,m.width=a,m.height=o,"getFrame"in r){const d=h=>{this.texture?this.texture.setData(h):this.texture=new ee.x(s,m,h),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=(0,Le.hY)(r,function je(n){return n?{...n,playAnimation:n.playing,repeatType:n.repeatType?Ae[n.repeatType]:void 0}:{}}(this.elementView.element.animationOptions),null,d))}else this.texture=new ee.x(s,m,r);(s.type===k.zO.WEBGL2||(0,P.wt)(a)&&(0,P.wt)(o))&&this.texture.generateMipmap(),l&&!r.paused&&this.requestRender()}}super.beforeRender(t)}_createTransforms(){return null}updateDrawCoords(t,s){const r=this.elementView.coords;if(null==r)return;const[i,l,a,o]=r.rings[0],m=this._vertices,{x:d,y:h}=t,y=0!==s;m.set(y?[l[0]-d,l[1]-h,i[0]-d,i[1]-h,a[0]-d,a[1]-h,o[0]-d,o[1]-h,o[0]-d,o[1]-h,l[0]+s-d,l[1]-h,l[0]+s-d,l[1]-h,i[0]+s-d,i[1]-h,a[0]+s-d,a[1]-h,o[0]+s-d,o[1]-h]:[l[0]-d,l[1]-h,i[0]-d,i[1]-h,a[0]-d,a[1]-h,o[0]-d,o[1]-h]),this.isWrapAround=y}getVAO(t,s,r){if(null==this.elementView.coords)return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=_.f.createVertex(t,B.l1.DYNAMIC_DRAW,i);const l=_.f.createVertex(t,B.l1.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new Te.U(t,r,s,{geometry:this._geometryVbo,tex:l})}return this._vao}_updatePerspectiveTransform(t,s){const r=this._vertices;(0,Ue.E)(x,[0,0,t,0,0,s,t,s],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),(0,Ge.s)(this.perspectiveTransform,x[6]/x[8]*t,x[7]/x[8]*s)}}var He=e(55768),V=e(51006),We=e(71602),Ie=e(33721),ze=e(31898),Ze=e(88098),Qe=e(92311);class Fe extends Qe.Z{constructor(){super(...arguments),this._localOrigin=(0,He.vW)(0,0),this._viewStateId=-1,this._dvsMat3=(0,We.c)()}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const s of this.children)s.beforeRender(t)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"overlay",brushes:[Ze.U.overlay],target:()=>this.children,drawPhase:Re.jx.MAP});return[...super.prepareRenderPasses(t),s]}_updateMatrices(t){const{state:s}=t,{id:r,size:i,pixelRatio:l,resolution:a,rotation:o,viewpoint:m,displayMat3:d}=s;if(this._viewStateId===r)return;const h=Math.PI/180*o,y=l*i[0],p=l*i[1],{x:W,y:G}=m.targetGeometry,I=(0,Me.or)(W,s.spatialReference);this._localOrigin.x=I,this._localOrigin.y=G;const z=a*y,D=a*p,f=(0,V.g)(this._dvsMat3);(0,V.m)(f,f,d),(0,V.h)(f,f,(0,xe.f)(y/2,p/2)),(0,V.c)(f,f,(0,Ve.f)(y/z,-p/D,1)),(0,V.r)(f,f,-h),this._viewStateId=r}_updateOverlays(t,s){const{state:r}=t,{rotation:i,spatialReference:l,worldScreenWidth:a,size:o,viewpoint:m}=r,d=this._localOrigin;let h=0;const y=(0,Ie.C5)(l);if(y&&l.isWrappable){const p=o[0],W=o[1],G=180/Math.PI*i,I=Math.abs(Math.cos(G)),z=Math.abs(Math.sin(G)),D=Math.round(p*I+W*z),[f,Z]=y.valid,g=(0,ze.ut)(l),{x:ne,y:$e}=m.targetGeometry,Q=[0,0];r.toScreen(Q,[ne,$e]);const L=[0,0];let F;F=D>a?.5*a:.5*D;const re=Math.floor((ne+.5*g)/g),be=f+re*g,qe=Z+re*g,Y=[Q[0]+F,0];r.toMap(L,Y),L[0]>qe&&(h=g),Y[0]=Q[0]-F,r.toMap(L,Y),L[0]<be&&(h=-g);for(const O of s){const ie=O.elementView.bounds;if(null==ie)continue;const[ae,,le]=ie;O.updateDrawCoords(d,ae<f&&le>f?g:le>Z&&ae<Z?-g:h)}}else for(const p of s)p.updateDrawCoords(d,h)}}var Ye=e(93509),Ne=e(50145),Ke=e(26894);let M=class extends((0,Ye.y)(Ne.Z)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new de.Z}attach(){this.addAttachHandles([(0,c.on)(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(n=>this._updateTile(n)),this.requestUpdate()}),(0,c.on)(()=>this.layer.effectiveSource,"change",({element:n})=>this._elementUpdateHandler(n))]),this._overlayContainer=new Fe,this.container.addChild(this._overlayContainer),this._fetchQueue=new Ee.Z({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(n,t)=>this._queryElements(n,t)}),this._tileStrategy=new Ce.Z({cachePolicy:"purge",resampling:!0,acquireTile:n=>this._acquireTile(n),releaseTile:n=>this._releaseTile(n),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(n){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(n){this._tileStrategy.update(n),this._debugGraphicsView?.update(n)}hitTest(n,t){var s=this;return(0,R.Z)(function*(){const r=[],i=n.normalize(),l=[i.x,i.y];for(const{projectedElement:{normalizedCoords:a,element:o}}of s._elementReferences.values())null!=a&&(0,ue.wP)(a.rings,l)&&r.push({type:"media",element:o,layer:s.layer,mapPoint:n,sourcePoint:o.toSource(n)});return r.reverse()})()}canResume(){return null!=this.layer.source&&super.canResume()}doRefresh(){var n=this;return(0,R.Z)(function*(){n._fetchQueue.reset(),n._tileStrategy.refresh(t=>n._updateTile(t))})()}_acquireTile(n){const t=new Xe(n.clone());return this._updateTile(t),t}_updateTile(n){this._updatingHandles.addPromise(this._fetchQueue.push(n.key).then(t=>{const[s,r]=n.setElements(t);this._referenceElements(n,s),this._dereferenceElements(n,r),this.requestUpdate()},t=>{(0,me.D_)(t)||U.Z.getLogger(this).error(t)}))}_releaseTile(n){this._fetchQueue.abort(n.key.id),n.elements&&this._dereferenceElements(n,n.elements),this.requestUpdate()}_queryElements(n,t){var s=this;return(0,R.Z)(function*(){const r=s.layer.effectiveSource;if(null==r)return[];s.view.featuresTilingScheme.getTileBounds(u,n,!0);const i=new Ke.Z({xmin:u[0],ymin:u[1],xmax:u[2],ymax:u[3],spatialReference:s.view.spatialReference});return r.queryElements(i,t)})()}_referenceElements(n,t){if(null!=this.layer.source)for(const s of t)this._referenceElement(n,s)}_referenceElement(n,t){(0,ve.s1)(this._elementReferences,t.uid,()=>{const s=new q.L({element:t,spatialReference:this.view.spatialReference}),r=new Be(s);return this._overlayContainer.addChild(r),this.elements.add(t),{tiles:new Set,projectedElement:s,overlay:r,debugGraphic:null}}).tiles.add(n)}_dereferenceElements(n,t){for(const s of t)this._dereferenceElement(n,s)}_dereferenceElement(n,t){const s=this._elementReferences.get(t.uid);s.tiles.delete(n),s.tiles.size||(this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(s.debugGraphic))}_elementUpdateHandler(n){let t=this._elementReferences.get(n.uid);if(t){const r=t.projectedElement.normalizedCoords;if(null==r)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(n.uid),this.elements.remove(n),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);const i=[],l=[];for(const a of this._tileStrategy.tiles){const o=se(this.view.featuresTilingScheme,a,r);t.tiles.has(a)?o||l.push(a):o&&i.push(a)}for(const a of i)this._referenceElement(a,n);for(const a of l)this._dereferenceElement(a,n);return t=this._elementReferences.get(n.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const s=new q.L({element:n,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=s)for(const r of this._tileStrategy.tiles)se(this.view.featuresTilingScheme,r,s)&&this._referenceElement(r,n)}};(0,T._)([(0,b.Cb)()],M.prototype,"layer",void 0),(0,T._)([(0,b.Cb)({readOnly:!0})],M.prototype,"elements",void 0),M=(0,T._)([(0,fe.j)("esri.views.2d.layers.MediaLayerView2D")],M);const u=(0,ce.Ue)(),E={xmin:0,ymin:0,xmax:0,ymax:0};function se(n,t,s){return n.getTileBounds(u,t.key,!0),E.xmin=u[0],E.ymin=u[1],E.xmax=u[2],E.ymax=u[3],(0,ye.Nl)(E,s)}class Xe{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){const s=[],r=new Set(this.elements);this.elements=t;for(const i of t)r.has(i)?r.delete(i):s.push(i);return this.isReady=!0,[s,Array.from(r)]}destroy(){}}const Je=M}}]);