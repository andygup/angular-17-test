"use strict";(self.webpackChunkangular_17_test=self.webpackChunkangular_17_test||[]).push([[1997],{90295:(Q,L,a)=>{a.d(L,{Z:()=>u});class u{constructor(b){this.size=0,this._start=0,this.maxSize=b,this._buffer=new Array(b)}get entries(){return this._buffer}enqueue(b){if(this.size===this.maxSize){const h=this._buffer[this._start];return this._buffer[this._start]=b,this._start=(this._start+1)%this.maxSize,h}return this._buffer[(this._start+this.size++)%this.maxSize]=b,null}dequeue(){if(0===this.size)return null;const b=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,b}peek(){return 0===this.size?null:this._buffer[this._start]}find(b){if(0===this.size)return null;for(const h of this._buffer)if(null!=h&&b(h))return h;return null}clear(b){let h=this.dequeue();for(;null!=h;)b&&b(h),h=this.dequeue()}}},1865:(Q,L,a)=>{function u(h){const E=h.layer;return"floorInfo"in E&&E.floorInfo?.floorField&&"floors"in h.view?b(h.view.floors,E.floorInfo.floorField):null}function c(h,E){return"floorInfo"in E&&E.floorInfo?.floorField?b(h,E.floorInfo.floorField):null}function b(h,E){if(!h?.length)return null;const P=h.filter(_=>""!==_).map(_=>`'${_}'`);return P.push("''"),`${E} IN (${P.join(",")}) OR ${E} IS NULL`}a.d(L,{c:()=>u,f:()=>c})},6118:(Q,L,a)=>{a.d(L,{JZ:()=>O,RL:()=>V,eY:()=>H});var u=a(15861),c=a(79412),b=a(51006),h=a(71602),E=a(7077),P=a(64456),_=a(98634),I=a(99273),p=a(39237),S=a(17091),x=a(22784);function O(R){return R&&"render"in R}function V(R){const l=document.createElement("canvas");return l.width=R.width,l.height=R.height,R.render(l.getContext("2d")),l}class H extends P.s{constructor(l=null,d=!1){super(),this.blendFunction="standard",this._sourceWidth=0,this._sourceHeight=0,this._textureInvalidated=!1,this._texture=null,this.stencilRef=0,this.coordScale=[1,1],this._height=void 0,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._width=void 0,this.x=0,this.y=0,this.immutable=d,this.source=l,this.requestRender=this.requestRender.bind(this)}destroy(){this._texture&&(this._texture.dispose(),this._texture=null),null!=this._uploadStatus&&(this._uploadStatus.controller.abort(),this._uploadStatus=null)}get isSourceScaled(){return this.width!==this._sourceWidth||this.height!==this._sourceHeight}get height(){return void 0!==this._height?this._height:this._sourceHeight}set height(l){this._height=l}get source(){return this._source}set source(l){null==l&&null==this._source||(this._source=l,this.invalidateTexture(),this.requestRender())}get width(){return void 0!==this._width?this._width:this._sourceWidth}set width(l){this._width=l}beforeRender(l){super.beforeRender(l),this.updateTexture(l)}setSourceAsync(l,d){var f=this;return(0,u.Z)(function*(){null!=f._uploadStatus&&f._uploadStatus.controller.abort();const T=new AbortController,B=(0,c.hh)();return(0,c.$F)(d,()=>T.abort()),(0,c.$F)(T,M=>B.reject(M)),f._uploadStatus={controller:T,resolver:B},f.source=l,B.promise})()}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this._source instanceof HTMLImageElement?(this._sourceHeight=this._source.naturalHeight,this._sourceWidth=this._source.naturalWidth):this._source&&(this._sourceHeight=this._source.height,this._sourceWidth=this._source.width))}updateTransitionProperties(l,d){l>=64&&(this.fadeTransitionEnabled=!1,this.inFadeTransition=!1),super.updateTransitionProperties(l,d)}setTransform(l){const d=(0,b.g)(this.transforms.dvs),[f,T]=l.toScreenNoRotation([0,0],[this.x,this.y]),B=this.resolution/this.pixelRatio/l.resolution,M=B*this.width,F=B*this.height,A=Math.PI*this.rotation/180;(0,b.h)(d,d,(0,E.f)(f,T)),(0,b.h)(d,d,(0,E.f)(M/2,F/2)),(0,b.r)(d,d,-A),(0,b.h)(d,d,(0,E.f)(-M/2,-F/2)),(0,b.l)(d,d,(0,E.f)(M,F)),(0,b.m)(this.transforms.dvs,l.displayViewMat3,d)}setSamplingProfile(l){this._texture&&(l.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(l.samplingMode))}bind(l,d){this._texture&&l.bindTexture(this._texture,d)}updateTexture({context:l,painter:d}){var f=this;return(0,u.Z)(function*(){if(!f._textureInvalidated)return;if(f._textureInvalidated=!1,f._texture||(f._texture=f._createTexture(l)),!f.source)return void f._texture.setData(null);f._texture.resize(f._sourceWidth,f._sourceHeight);const T=function k(R){return O(R)?R instanceof _.Z?R.getRenderedRasterPixels()?.renderedRasterPixels:V(R):R}(f.source);try{if(null!=f._uploadStatus){const{controller:B,resolver:M}=f._uploadStatus,F={signal:B.signal},{width:A,height:N}=f,q=f._texture;yield d.textureUploadManager.enqueueTextureUpdate({data:T,texture:q,width:A,height:N},F),M.resolve(),f._uploadStatus=null}else f._texture.setData(T);f.ready()}catch(B){(0,c.H9)(B)}})()}onDetach(){this.destroy()}_createTransforms(){return{dvs:(0,h.c)()}}_createTexture(l){const d=this.immutable&&l.type===I.zO.WEBGL2,f=new x.X;return f.internalFormat=d?p.lP.RGBA8:p.VI.RGBA,f.wrapMode=p.e8.CLAMP_TO_EDGE,f.isImmutable=d,f.width=this._sourceWidth,f.height=this._sourceHeight,new S.x(l,f)}}},35244:(Q,L,a)=>{a.d(L,{s:()=>p});var u=a(45425),c=a(71602),b=a(6118),h=a(13305);class E extends h.I{constructor(x,O,V,k,H,R,l=null){super(x,O,V,k,H,R),this.bitmap=new b.eY(l),this.bitmap.coordScale=[H,R],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy()}beforeRender(x){this.bitmap.beforeRender(x),super.beforeRender(x)}afterRender(x){this.bitmap.afterRender(x),super.afterRender(x)}set stencilRef(x){this.bitmap.stencilRef=x}get stencilRef(){return this.bitmap.stencilRef}_createTransforms(){return{dvs:(0,c.c)(),tileMat3:(0,c.c)()}}setTransform(x){super.setTransform(x),this.bitmap.transforms.dvs=this.transforms.dvs}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap&&(this.bitmap.stage=null)}}var P=a(88098),_=a(43101),I=a(75747);class p extends I.Z{get requiresDedicatedFBO(){return this.children.some(x=>"additive"===x.bitmap.blendFunction)}createTile(x){const O=this._tileInfoView.getTileBounds((0,u.Ue)(),x),V=this._tileInfoView.getTileResolution(x.level),[k,H]=this._tileInfoView.tileInfo.size;return new E(x,V,O[0],O[3],k,H)}prepareRenderPasses(x){const O=x.registerRenderPass({name:"bitmap (tile)",brushes:[P.U.bitmap],target:()=>this.children.map(V=>V.bitmap),drawPhase:_.jx.MAP});return[...super.prepareRenderPasses(x),O]}doRender(x){this.visible&&x.drawPhase===_.jx.MAP&&super.doRender(x)}}},57487:(Q,L,a)=>{a.d(L,{T:()=>H});var u=a(15861),c=a(79412),b=a(65430),h=a(78857),E=a(75747),P=a(55768),_=a(49602),I=a(44526),p=a(32196),S=a(56035),x=a(86171),O=a(19903);function V(R,l){const d=l.length;if(R<l[0].value||1===d)return l[0].size;for(let f=1;f<d;f++)if(R<l[f].value)return l[f-1].size+(R-l[f-1].value)/(l[f].value-l[f-1].value)*(l[f].size-l[f-1].size);return l[d-1].size}class k{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=S.v}getSizeVVFieldStops(l){const d=this._vvSizeFieldStops;if(d)switch(d.type){case"static":return d;case"level-dependent":return d.levels[l]??(()=>{let f=1/0,T=0;for(const A in d.levels){const N=parseFloat(A),q=Math.abs(l-N);q<f&&(f=q,T=N)}if(f===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const B=2**((l-T)/2),M=d.levels[T],F=new Float32Array(M.values);return F[2]*=B,F[3]*=B,{sizes:M.sizes,values:F}})();default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(l){null!=this._vvInfo&&this._updateVisualVariables(this._vvInfo.vvRanges,l)}setInfo(l,d,f){this._updateEffects(f),this._vvInfo=d,this._technique=(0,x.EJ)(l),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,l)}getVariation(){return{...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:(0,O.hc)("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(l){this.outsideLabelsVisible=null!=l&&l.excludedLabelsVisible}_updateVisualVariables(l,d){const f=this._vvMaterialParameters;if(f.vvOpacityEnabled=!1,f.vvSizeEnabled=!1,f.vvColorEnabled=!1,f.vvRotationEnabled=!1,!l)return;const T=l.size;if(T){if(f.vvSizeEnabled=!0,T.minMaxValue){const A=T.minMaxValue;let N,q;if((0,p.$K)(A.minSize)&&(0,p.$K)(A.maxSize))if((0,p.hj)(A.minSize)&&(0,p.hj)(A.maxSize))N=(0,P.F2)(A.minSize),q=(0,P.F2)(A.maxSize);else{const Y=d.scale;N=(0,P.F2)(V(Y,A.minSize.stops)),q=(0,P.F2)(V(Y,A.maxSize.stops))}this.vvSizeMinMaxValue.set([A.minDataValue,A.maxDataValue,N,q])}if(T.scaleStops&&(this.vvSizeScaleStopsValue=(0,P.F2)(V(d.scale,T.scaleStops.stops))),T.unitValue){const A=(0,_.c9)(d.spatialReference)/I.a[T.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=A/d.resolution}T.fieldStops&&(this._vvSizeFieldStops=T.fieldStops)}const B=l.color;B&&(f.vvColorEnabled=!0,this.vvColorValues.set(B.values),this.vvColors.set(B.colors));const M=l.opacity;M&&(f.vvOpacityEnabled=!0,this.vvOpacityValues.set(M.values),this.vvOpacities.set(M.opacities));const F=l.rotation;F&&(f.vvRotationEnabled=!0,f.vvRotationType=F.type)}}class H extends E.Z{constructor(l){super(l),this._rendererInfo=new k,this._materialItemsRequestQueue=new b.Z,this.attributeView=new h.H(()=>this.onAttributeStoreUpdate())}destroy(){this.children.forEach(l=>l.destroy()),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(l,d,f){this._rendererInfo.setInfo(l,d,f),this.requestRender()}getMaterialItems(l,d){var f=this;return(0,u.Z)(function*(){if(!l||0===l.length)return[];const T=(0,c.hh)();return f._materialItemsRequestQueue.push({items:l,abortOptions:d,resolver:T}),f.requestRender(),T.promise})()}doRender(l){if(l.context.capabilities.enable("textureFloat"),l.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let d=this._materialItemsRequestQueue.pop();for(;d;)this._processMaterialItemRequest(l,d),d=this._materialItemsRequestQueue.pop()}super.doRender(l)}renderChildren(l){for(const d of this.children)d.commit(l);this._rendererInfo.update(l.state),super.renderChildren(l)}createRenderParams(l){const d=super.createRenderParams(l);return d.rendererInfo=this._rendererInfo,d.attributeView=this.attributeView,d}onAttributeStoreUpdate(){}_processMaterialItemRequest(l,{items:d,abortOptions:f,resolver:T}){const{painter:B,pixelRatio:M}=l,F=d.map(A=>B.textureManager.rasterizeItem(A.symbol,M,A.glyphIds,f));Promise.all(F).then(A=>{if(!this.stage)return void T.reject();const N=A.map((q,Y)=>({id:d[Y].id,mosaicItem:q}));T.resolve(N)},T.reject)}}},98634:(Q,L,a)=>{a.d(L,{Z:()=>u});class u{constructor(b,h,E){this.pixelBlock=b,this.extent=h,this.originalPixelBlock=E}get width(){return null!=this.pixelBlock?this.pixelBlock.width:0}get height(){return null!=this.pixelBlock?this.pixelBlock.height:0}render(b){const h=this.pixelBlock;if(null==h)return;const E=this.filter({extent:this.extent,pixelBlock:this.originalPixelBlock??h});if(null==E.pixelBlock)return;E.pixelBlock.maskIsAlpha&&(E.pixelBlock.premultiplyAlpha=!0);const P=E.pixelBlock.getAsRGBA(),_=b.createImageData(E.pixelBlock.width,E.pixelBlock.height);_.data.set(P),b.putImageData(_,0,0)}getRenderedRasterPixels(){const b=this.filter({extent:this.extent,pixelBlock:this.pixelBlock});return null==b.pixelBlock?null:(b.pixelBlock.maskIsAlpha&&(b.pixelBlock.premultiplyAlpha=!0),{width:b.pixelBlock.width,height:b.pixelBlock.height,renderedRasterPixels:new Uint8Array(b.pixelBlock.getAsRGBA().buffer)})}}},2902:(Q,L,a)=>{a.d(L,{Q:()=>_,g:()=>E});var u=a(14007),c=a(51172),b=a(28798);const h=(0,u.Z)("esri-2d-log-allocations");class E{constructor(p,S){this._array=p,this._pool=S}get array(){return this._array}get length(){return this._array.length}static create(p,S){const x=S.acquire(p);return new E(x,S)}expand(p){const S=this._pool.acquire(p);S.set(this._array),this._pool.release(this._array),this._array=S}destroy(){this._pool.release(this._array)}set(p,S){this._array.set(p._array,S)}slice(){const p=this._pool.acquire(this._array.byteLength);return p.set(this._array),new E(p,this._pool)}}class P{constructor(){this._data=new ArrayBuffer(P.BYTE_LENGTH),this._freeList=new b.m({start:0,end:this._data.byteLength})}static get BYTE_LENGTH(){return 64e6}get buffer(){return this._data}allocate(p){const S=this._freeList.firstFit(p);return null==S?null:new Uint32Array(this._data,S,p/Uint32Array.BYTES_PER_ELEMENT)}free(p){this._freeList.free(p.byteOffset,p.byteLength)}}class _{constructor(){this._bytesAllocated=0,this._pages=[],this._pagesByBuffer=new Map,this._addPage()}destroy(){this._pages=[],this._pagesByBuffer=null}get _bytesTotal(){return this._pages.length*P.BYTE_LENGTH}acquire(p){if(this._bytesAllocated+=p,h&&console.log(`Allocating ${p}, (${this._bytesAllocated} / ${this._bytesTotal})`),p>P.BYTE_LENGTH)return new Uint32Array(p/Uint32Array.BYTES_PER_ELEMENT);for(const x of this._pages){const O=x.allocate(p);if(null!=O)return O}const S=this._addPage().allocate(p);return(0,c.O3)(S,"Expected to allocate page"),S}release(p){this._bytesAllocated-=p.byteLength,h&&console.log(`Freeing ${p.byteLength}, (${this._bytesAllocated} / ${this._bytesTotal})`);const S=this._pagesByBuffer.get(p.buffer);S&&S.free(p)}_addPage(){const p=new P;return this._pages.push(p),this._pagesByBuffer.set(p.buffer,p),p}}},75747:(Q,L,a)=>{a.d(L,{Z:()=>_});var u=a(14007),c=a(43101),b=a(92311),h=a(58960),E=a(46356);const P=(I,p)=>I.key.level-p.key.level!=0?I.key.level-p.key.level:I.key.row-p.key.row!=0?I.key.row-p.key.row:I.key.col-p.key.col;class _ extends b.Z{constructor(p){super(),this._tileInfoView=p}renderChildren(p){this.sortChildren(P),this.setStencilReference(p),super.renderChildren(p)}createRenderParams(p){const{state:S}=p,x=super.createRenderParams(p);return x.requiredLevel=this._tileInfoView.getClosestInfoForScale(S.scale).level,x.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(S.scale),x}prepareRenderPasses(p){const S=super.prepareRenderPasses(p);return S.push(p.registerRenderPass({name:"stencil",brushes:[E.Z],drawPhase:c.jx.DEBUG|c.jx.MAP|c.jx.HIGHLIGHT,target:()=>this.getStencilTarget()})),(0,u.Z)("esri-tiles-debug")&&S.push(p.registerRenderPass({name:"tileInfo",brushes:[h.Z],drawPhase:c.jx.DEBUG,target:()=>this.children})),S}getStencilTarget(){return this.children}setStencilReference(p){let S=1;for(const x of this.children)x.stencilRef=S++}}},71997:(Q,L,a)=>{a.r(L),a.d(L,{default:()=>qt});var u=a(15861),c=a(50484),b=a(35458),h=a(80543),P=(a(1535),a(57678)),_=a(14007),I=a(10141);let p=class extends b.Z{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;const e=this.sourceLayer?.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};(0,c._)([(0,h.Cb)({type:Boolean})],p.prototype,"isAggregate",void 0),p=(0,c._)([(0,I.j)("esri.AggregateGraphic")],p);const S=p;a(2189);var O=a(83944),V=a(57964),k=a(1258),H=a(34222),R=a(4703),l=a(51172),d=a(79412),f=a(77675),T=a(55768),B=a(73514),M=a(54786);let F=class extends B.Z{constructor(t){super(t),this._filter=null,this.duration=(0,_.Z)("mapview-transitions-duration"),this._excludedEffectView=new M.AM(t),this._includedEffectView=new M.AM(t)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(t){this._get("featureEffect")!==t&&this._transitionTo(t)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(t){this._set("scale",t),this._excludedEffectView.scale=t,this._includedEffectView.scale=t}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(t,e){this._set("scale",e),this.transitioning?(this._includedEffectView.transitionStep(t,e),this._excludedEffectView.transitionStep(t,e),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=e,this._includedEffectView.scale=e)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(t){const e=this._get("featureEffect"),r=t,i=r?.includedEffect,s=r?.excludedEffect,n=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=i,this._excludedEffectView.effect=s,this._set("featureEffect",r),this._filter=r?.filter||e?.filter||null,n||this.endTransitions()}};(0,c._)([(0,h.Cb)()],F.prototype,"_filter",void 0),(0,c._)([(0,h.Cb)()],F.prototype,"_excludedEffectView",void 0),(0,c._)([(0,h.Cb)()],F.prototype,"_includedEffectView",void 0),(0,c._)([(0,h.Cb)()],F.prototype,"duration",void 0),(0,c._)([(0,h.Cb)()],F.prototype,"excludedEffects",null),(0,c._)([(0,h.Cb)()],F.prototype,"featureEffect",null),(0,c._)([(0,h.Cb)()],F.prototype,"filter",null),(0,c._)([(0,h.Cb)()],F.prototype,"hasEffects",null),(0,c._)([(0,h.Cb)()],F.prototype,"includedEffects",null),(0,c._)([(0,h.Cb)({value:0})],F.prototype,"scale",null),(0,c._)([(0,h.Cb)()],F.prototype,"transitioning",null),F=(0,c._)([(0,I.j)("esri.layers.effects.FeatureEffectView")],F);const A=F;var N=a(74321),q=a(85971),Y=a(62185),ce=a(93792),Ze=a(43814);let re=class extends ce.Z{constructor(){super(...arguments),this.features=[]}readFeatures(t,e){const r=Ze.Z.fromJSON(e.spatialReference),i=[];for(let s=0;s<t.length;s++){const n=t[s],o=S.fromJSON(n),g=n.geometry?.spatialReference;null==o.geometry||g||(o.geometry.spatialReference=r);const y=n.aggregateGeometries,m=o.aggregateGeometries;if(y&&null!=m)for(const v in m){const U=m[v],C=y[v],w=C?.spatialReference;null==U||w||(U.spatialReference=r)}i.push(o)}return i}};(0,c._)([(0,h.Cb)({type:[S],json:{write:!0}})],re.prototype,"features",void 0),(0,c._)([(0,Y.r)("features")],re.prototype,"readFeatures",null),re=(0,c._)([(0,I.j)("esri.rest.support.AggregateFeatureSet")],re);const De=re;var ae=a(91866),ze=a(99657),ke=a(93509),qe=a(1667),ve=a(96043),je=a(35244);let X=class extends B.Z{constructor(t){super(t),this.tiles=new Map}destroy(){this.tiles.clear(),this.layer=this.layerView=this.tileInfoView=this.tiles=null}get updating(){return this.isUpdating()}acquireTile(t){const e=this.createTile(t);return e.once("isReady",()=>this.notifyChange("updating")),this.tiles.set(t.id,e),this.notifyChange("updating"),e}forceAttributeTextureUpload(){}forEachTile(t){this.tiles.forEach(t)}releaseTile(t){this.tiles.delete(t.key.id),this.notifyChange("updating"),this.disposeTile(t)}isUpdating(){let t=!0;this.tiles.forEach(r=>{t=t&&r.isReady});const e=!t;if((0,_.Z)("esri-2d-log-updating")){let r="";this.tiles.forEach(i=>{r+=`-> ${i.key.id}: isReady: ${i.isReady} status: ${i.updateStatus}\n`,t=t&&i.isReady}),console.log(`Updating BaseTileRenderer ${e}\n${r}`)}return e}setHighlight(){}invalidateLabels(){}requestUpdate(){this.layerView.requestUpdate()}};(0,c._)([(0,h.Cb)()],X.prototype,"layer",void 0),(0,c._)([(0,h.Cb)()],X.prototype,"layerView",void 0),(0,c._)([(0,h.Cb)()],X.prototype,"tileInfoView",void 0),(0,c._)([(0,h.Cb)()],X.prototype,"updating",null),X=(0,c._)([(0,I.j)("esri.views.2d.layers.features.tileRenderers.BaseTileRenderer")],X);const be=X;class Ne{constructor(){this.gradient=null,this.height=512,this.intensities=null,this.width=512}render(e){(0,ve.hy)(e,512,this.intensities,this.gradient,this.minDensity,this.maxDensity)}}let fe=class extends be{constructor(t){super(t),this._intensityInfo={minDensity:0,maxDensity:0},this.type="heatmap",this.featuresView={attributeView:{initialize:()=>{},requestUpdate:()=>{}},requestRender:()=>{}},this._container=new je.s(t.tileInfoView)}createTile(t){const e=this._container.createTile(t);return this.tileInfoView.getTileCoords(e.bitmap,t),e.bitmap.resolution=this.tileInfoView.getTileResolution(t),e}onConfigUpdate(){const t=this.layer.renderer;if("heatmap"===t.type){const{minDensity:e,maxDensity:r,colorStops:i}=t;this._intensityInfo.minDensity=e,this._intensityInfo.maxDensity=r,this._gradient=(0,ve.uI)(i),this.tiles.forEach(s=>{const n=s.bitmap.source;n&&(n.minDensity=e,n.maxDensity=r,n.gradient=this._gradient,s.bitmap.invalidateTexture(),s.bitmap.requestRender())})}}hitTest(){return Promise.resolve([])}install(t){t.addChild(this._container)}uninstall(t){this._container.removeAllChildren(),t.removeChild(this._container)}disposeTile(t){this._container.removeChild(t),t.destroy()}supportsRenderer(t){return t&&"heatmap"===t.type}onTileData(t){const e=this.tiles.get(t.tileKey);if(!e)return;const r=t.intensityInfo,{minDensity:i,maxDensity:s}=this._intensityInfo,n=e.bitmap.source||new Ne;n.intensities=r?.matrix||null,n.minDensity=i,n.maxDensity=s,n.gradient=this._gradient,e.bitmap.source=n,this._container.addChild(e),this._container.requestRender(),this.requestUpdate()}onTileError(t){console.error(t)}lockGPUUploads(){}unlockGPUUploads(){}fetchResource(t,e){return console.error(t),Promise.reject()}};fe=(0,c._)([(0,I.j)("esri.views.2d.layers.features.tileRenderers.HeatmapTileRenderer")],fe);var He=a(45425),xe=a(90295),Ge=a(89921),oe=a(43101),Re=a(32196),$e=a(43011);const pe=4294967296;class le{constructor(e){this._savedCursor=null,this._savedOffset=null,this._head=e,this._cursor=e}static from(e){const r=ue.from(new Float32Array(e));return new le(r)}get id(){return this._cursor.id}get baseZoom(){return this._cursor.baseZoom}get anchorX(){return this._cursor.anchorX}get anchorY(){return this._cursor.anchorY}get directionX(){return this._cursor.directionX}get directionY(){return this._cursor.directionY}get size(){return this._cursor.size}get materialKey(){return this._cursor.materialKey}get boundsCount(){return this._cursor.boundsCount}computedMinZoom(){return this._cursor.computedMinZoom()}setComputedMinZoom(e){return this._cursor.setComputedMinZoom(e)}boundsComputedAnchorX(e){return this._cursor.boundsComputedAnchorX(e)}boundsComputedAnchorY(e){return this._cursor.boundsComputedAnchorY(e)}setBoundsComputedAnchorX(e,r){return this._cursor.setBoundsComputedAnchorX(e,r)}setBoundsComputedAnchorY(e,r){return this._cursor.setBoundsComputedAnchorY(e,r)}boundsX(e){return this._cursor.boundsX(e)}boundsY(e){return this._cursor.boundsY(e)}boundsWidth(e){return this._cursor.boundsWidth(e)}boundsHeight(e){return this._cursor.boundsHeight(e)}link(e){if(null!=e._head)return this._cursor.link(e._head)}getCursor(){return this.copy()}copy(){const e=new le(this._head?.copy());if(!e._head)return e;let r=e._head,i=e._head._link;for(;i;)r._link=i.copy(),r=i,i=r._link;return e}peekId(){return this._cursor.peekId()??this._cursor._link.peekId()}nextId(){const e=this.id;for(;e===this.id;)if(!this.next())return!1;return!0}save(){this._savedCursor=this._cursor,this._savedOffset=this._cursor._offset}restore(){this._savedCursor&&(this._cursor=this._savedCursor),null!=this._savedOffset&&(this._cursor._offset=this._savedOffset)}next(){if(!this._cursor)return!1;if(!this._cursor.next()){if(!this._cursor._link)return!1;this._cursor=this._cursor._link,this._cursor._offset=0}return!0}lookup(e){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(e);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}delete(e){let r=this._head,i=null;for(;r;){if(r.delete(e))return r.isEmpty()&&null!=i&&(i._link=r._link),!0;i=r,r=r._link}return!1}}class ue{constructor(e){this._offset=-1,this._link=null,this._count=0,this._deletedCount=0,this._offsets={instance:null},this._buffer=e}static from(e){return new ue(new Float32Array(e))}isEmpty(){return this._deletedCount===this.count}get count(){return this._count||(this._count=this._computeCount()),this._count}get id(){return this._buffer[this._offset]}set id(e){this._buffer[this._offset]=e}get baseZoom(){return this._buffer[this._offset+1]}get anchorX(){return this._buffer[this._offset+2]}get anchorY(){return this._buffer[this._offset+3]}get directionX(){return this._buffer[this._offset+4]}get directionY(){return this._buffer[this._offset+5]}get size(){return this._buffer[this._offset+6]}get materialKey(){return this._buffer[this._offset+7]}computedMinZoom(){return this._buffer[this._offset+8]}setComputedMinZoom(e){this._buffer[this._offset+8]=e}get boundsCount(){return this._buffer[this._offset+9]}boundsComputedAnchorX(e){return this._buffer[this._offset+10+6*e]}boundsComputedAnchorY(e){return this._buffer[this._offset+10+6*e+1]}setBoundsComputedAnchorX(e,r){this._buffer[this._offset+10+6*e]=r}setBoundsComputedAnchorY(e,r){this._buffer[this._offset+10+6*e+1]=r}boundsX(e){return this._buffer[this._offset+10+6*e+2]}boundsY(e){return this._buffer[this._offset+10+6*e+3]}boundsWidth(e){return this._buffer[this._offset+10+6*e+4]}boundsHeight(e){return this._buffer[this._offset+10+6*e+5]}link(e){let r=this;for(;r._link;)r=r._link;r._link=e}getCursor(){return this.copy()}copy(){const e=new ue(this._buffer);return e._link=this._link,e._offset=this._offset,e._deletedCount=this._deletedCount,e._offsets=this._offsets,e._count=this._count,e}peekId(){const e=this._offset+10+6*this.boundsCount+0;return e>=this._buffer.length?0:this._buffer[e]}next(){let e=0;for(;this._offset<this._buffer.length&&e++<100&&(-1===this._offset?this._offset=0:this._offset+=10+6*this.boundsCount,this.id===pe););return this.id!==pe&&this._offset<this._buffer.length}delete(e){const r=this._offset,i=this.lookup(e);if(i)for(this.id=4294967295,++this._deletedCount;this.next()&&this.id===e;)this.id=4294967295,++this._deletedCount;return this._offset=r,i}lookup(e){const r=this._offset;if(null==this._offsets.instance){this._offsets.instance=new Map;const i=this.copy();i._offset=-1;let s=0;for(;i.next();)i.id!==s&&(this._offsets.instance.set(i.id,i._offset),s=i.id)}return!!this._offsets.instance.has(e)&&(this._offset=this._offsets.instance.get(e),this.id!==pe||(this._offset=r,!1))}_computeCount(){const e=this._offset;let r=0;for(this._offset=-1;this.next();)r++;return this._offset=e,r}}var Qe=a(47543),We=a(2902),Ke=a(28798),ye=a(39853),Ee=a(39237);class Ce{constructor(e,r,i,s){const n=We.g.create(r*i*Uint32Array.BYTES_PER_ELEMENT,s);this.size=r,this.strideInt=i,this.bufferType=e,this.dirty={start:1/0,end:0},this._gpu=null,this._cpu=n,this.clear()}get elementSize(){return this._cpu.length/this.strideInt}get invalidated(){return this.bufferSize>0&&!this._gpu}get invalidatedComputeBuffer(){return this.bufferSize>0&&!this._gpuComputeTriangles}invalidate(){this._invalidateTriangleBuffer(),this._gpu?.dispose(),this._gpu=null}_invalidateTriangleBuffer(){this._gpuComputeTriangles?.dispose(),this._gpuComputeTriangles=null}destroy(){this._gpu?.dispose(),this._gpuComputeTriangles?.dispose(),this._cpu?.destroy(),this._cpu2?.destroy()}clear(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new Ke.m({start:0,end:this._cpu.length/this.strideInt}),this.fillPointer=0}ensure(e){if(!(this.maxAvailableSpace()>=e)&&e*this.strideInt>this._cpu.length-this.fillPointer){this.invalidate();const r=this._cpu.length/this.strideInt,i=Math.round(1.25*(r+e));this._cpu.expand(i*this.strideInt*Uint32Array.BYTES_PER_ELEMENT),this.freeList.free(r,i-r)}}set(e,r){this._cpu.array[e]!==r&&(this._cpu.array[e]=r,this.dirty.start=Math.min(e,this.dirty.start),this.dirty.end=Math.max(e,this.dirty.end))}getGPUBuffer(e,r=!1){if(!this.bufferSize)return null;if(r){if("index"!==this.bufferType)throw new Error("Tired to get triangle buffer, but target is not an index buffer");return null==this._gpuComputeTriangles&&(this._gpuComputeTriangles=this._createComputeBuffer(e)),this._gpuComputeTriangles}return null==this._gpu&&(this._gpu=this._createBuffer(e)),this._gpu}getCPUBuffer(){if(!this._cpu2){const e=this._cpu.slice();this._cpu2=e}return this._cpu2.length!==this._cpu.length&&this._cpu2.expand(this._cpu.length*this._cpu.array.BYTES_PER_ELEMENT),this._cpu2.set(this._cpu),this._cpu2}get bufferSize(){return this._cpu.length/this.strideInt}maxAvailableSpace(){return this.freeList.maxAvailableSpace()}insert(e,r,i,s){const n=i*this.strideInt;if(!n)return 0;const o=r*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,g=new Uint32Array(e,o,n),y=this.freeList.firstFit(i);(0,l.O3)(y,"First fit region must be defined");const m=y*this.strideInt,v=n,U=m/this.strideInt-r;if(0!==s)for(let C=0;C<g.length;C++)g[C]+=s;return this._cpu.array.set(g,m),this.dirty.start=Math.min(this.dirty.start,m),this.dirty.end=Math.max(this.dirty.end,m+v),this.fillPointer=Math.max(this.fillPointer,m+v),U}free(e,r,i){const s=e*this.strideInt,n=(e+r)*this.strideInt;if(!0===i)for(let o=e;o!==e+r;o++)this._cpu.array[o*this.strideInt]=2147450879;this.dirty.start=Math.min(this.dirty.start,s),this.dirty.end=Math.max(this.dirty.end,n),this.freeList.free(e,r)}upload(){if(this.dirty.end){if(this._invalidateTriangleBuffer(),null==this._gpu)return this.dirty.start=1/0,void(this.dirty.end=0);this._gpu.setSubData(this._cpu.array,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}}_createBuffer(e){const r=Ee.l1.DYNAMIC_DRAW;return"index"===this.bufferType?ye.f.createIndex(e,r,this._cpu.array):ye.f.createVertex(e,r,this._cpu.array)}_createComputeBuffer(e){const r=Ee.l1.DYNAMIC_DRAW,i=new Uint32Array(this.fillPointer/3);for(let s=0;s<this.fillPointer;s+=3)i[s/3]=this._cpu.array[s];return ye.f.createIndex(e,r,i)}}var we=a(49748),Xe=a(46682);class rt{constructor(e,r){this._vaos=new Map,this._indicesInvalid=!1,this.geometryType=e,this._stage=r}destroy(){for(const[e,r]of this._vaos)r?.disposeVAOOnly();this._indexBuffer=(0,l.SC)(this._indexBuffer),this._vertexBuffer=(0,l.SC)(this._vertexBuffer)}get records(){return this._records}insert(e,r,i){if(!e.records.byteLength)return;const s=e.stride;if(this._vertexBuffer&&this._indexBuffer){const o=e.vertices.byteLength/s;this._indexBuffer.ensure(e.indices.byteLength/4),this._vertexBuffer.ensure(o);const{vertices:g,indices:y}=e,m=we.$.from(e.records),v=this._vertexBuffer.insert(g,0,g.byteLength/s,0),U=this._indexBuffer.insert(y,0,y.byteLength/4,v);if(m.forEach(C=>{C.indexFrom+=U,C.vertexFrom+=v}),this._records.link(m),r)this._indicesInvalid=!0;else if(this._displayList){const C=m.getCursor();for(;C.next();)this._displayList.addRecord(C)}}else{const n=e.indices.byteLength/4,o=e.vertices.byteLength/s,g=s/Uint32Array.BYTES_PER_ELEMENT,y=this._stage.bufferPool;this._records=we.$.from(e.records),this._indexBuffer=new Ce("index",n,1,y),this._vertexBuffer=new Ce("vertex",o,g,y),this._indexBuffer.insert(e.indices,0,e.indices.byteLength/4,0),this._vertexBuffer.insert(e.vertices,0,e.vertices.byteLength/s,0),r&&(this._indicesInvalid=!0)}}remove(e){if(null!=this._records)for(const r of e){const i=this._records.getCursor();if(!i.lookup(r))continue;const s=i.indexFrom,n=i.vertexFrom;let o=i.indexCount,g=i.vertexCount;for(;i.next()&&i.id===r;)o+=i.indexCount,g+=i.vertexCount;this._indexBuffer.free(s,o),this._vertexBuffer.free(n,g,!0),this._records.delete(r)}}getVAO(e,r,i,s){if(!this._vertexBuffer||!this._indexBuffer||null==this._records||!this._vertexBuffer.bufferSize)return null;const n=s?1:0;let o=this._vaos.get(n);(this._vertexBuffer.invalidated||this._indexBuffer.invalidated||s&&this._indexBuffer.invalidatedComputeBuffer)&&(o?.disposeVAOOnly(),o=null),this._vertexBuffer.upload(),this._indexBuffer.upload();const g=this._indexBuffer.getGPUBuffer(e,1===n),y=this._vertexBuffer.getGPUBuffer(e);return o||(o=new Xe.U(e,i,r,{geometry:y},g),this._vaos.set(n,o)),o}forEachCommand(e){if(null!=this._records){if(this._sortIndices(this._records),!this._displayList){const r=this._cursorIndexOrder;this._displayList=Qe.S.from(this,this.geometryType,this._records.getCursor(),r)}this._displayList.forEach(e)}}_sortIndices(e){const r=!!this._indexBuffer.bufferSize;if(!this._indicesInvalid)return;this._indicesInvalid=!1;let i=0;const s=e.getCursor(),n=[],o=[],g=[];for(;s.next();)o.push(s.index),g.push(s.sortKey),n.push(s.id);o.sort((v,U)=>{const C=g[U],w=g[v];return w===C?n[U]-n[v]:C-w});const y=e.getCursor(),m=r?this._indexBuffer.getCPUBuffer():this._vertexBuffer.getCPUBuffer();for(const v of o){if(!y.seekIndex(v))throw new Error("Expected to find index");if(r){const{indexFrom:U,indexCount:C}=y;y.indexFrom=i;for(let w=0;w<C;w++)this._indexBuffer.set(i++,m.array[U+w])}else{const{vertexFrom:U,vertexCount:C}=y,w=this._vertexBuffer.strideInt,j=U*w,G=j+C*w;y.vertexFrom=i/w;for(let ee=j;ee<G;ee++)this._vertexBuffer.set(i++,m.array[ee])}}this._cursorIndexOrder=o,this._displayList=null}}let nt=0;class at extends $e.o{constructor(e,r,i,s,n,o){super(e,r,i,s),this.instanceId=nt++,this.patchCount=0,this._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1},this._patches=new xe.Z(100),this._bufferPatches=new xe.Z(100),this._lastCommitTime=0,this.transforms.labelMat2d=(0,Ge.c)(),this._store=n,this._requestLabelUpdate=o}destroy(){super.destroy(),this._renderState.current.geometry.forEach(e=>e.destroy()),null!=this._renderState.next&&this._renderState.next.geometry.forEach(e=>e.destroy()),this._renderState.current=null,this._renderState.next=null}get labelMetrics(){return this._renderState.current.metrics}get hasData(){return!!this._renderState.current.geometry.size}get updateStatus(){return`renderState:${!!this._renderState.current}, ${!!this._renderState.next}, hasData:${this.hasData}, queue:${this._patches.size}`}getGeometry(e){return this._renderState.current.geometry.get(e)}patch(e,r){this.patchCount++,e.clear&&this._patches.size>=50&&this._dropPatches();const i=e;r&&i.addOrUpdate&&this.key.id!==i.addOrUpdate.tileKeyOrigin?this._bufferPatches.enqueue(i):(i.sort=i.sort&&!r,this._patches.enqueue(i)),this.requestRender()}commit(e){if(this._lastCommitTime!==e.time){this._lastCommitTime=e.time;for(let r=0;r<4;r++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}}lock(){this._renderState.locked=!0}unlock(){this._renderState.locked=!1,this._flushUpdates(),this._swap()}_swapRenderStates(){if(this._renderState.next){if(this._renderState.locked)return this._renderState.swap=!0,void this.requestRender();this._renderState.swap=!0,this._swap()}}_swap(){this._renderState.swap&&(this._renderState.swap=!1,null!=this._renderState.next&&(this._renderState.current.geometry.forEach(e=>e.destroy()),this._renderState.current=this._renderState.next,this._renderState.next=null,this._requestLabelUpdate()))}_flushUpdates(){let e=this._patches.maxSize;for(;this._patches.size&&e--;)this._updateMesh(),this._swap()}_updateBufferMesh(){const e=this._bufferPatches.peek();if(null==e||!e.clear||null===this._renderState.next)for(;this._bufferPatches.size;){const r=this._bufferPatches.dequeue();null!=r&&this._patchBuffer(r)}}_updateMesh(){const e=this._patches.dequeue();if(null!=e){if((0,_.Z)("esri-2d-update-debug")){const r=e,i=r.addOrUpdate?.tileKeyOrigin,s=this.key.id===i?"SELF":i;let n="";for(let o=0;o<5;o++)n+=r.addOrUpdate?.data[o]?.records?.byteLength?1:0;console.debug(this.key.id,"FeatureTile:patch",`[clear: ${r.clear} origin: ${s}, end:${r.end} data:${n}]`)}!0===e.clear&&(null!=this._renderState.next&&(this._renderState.next.geometry.forEach(r=>r.destroy()),this._renderState.next=null),this._renderState.next={geometry:new Map,metrics:null},(0,_.Z)("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Creating new renderState")),this.requestRender(),this._patch(e),e.end&&((0,_.Z)("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Encountered end message"),this.ready(),this._swapRenderStates())}}_patch(e){(0,Re.Z_)(r=>{this._remove(r,e.remove),this._insert(r,e,!1)})}_patchBuffer(e){(0,Re.Z_)(r=>{this._insert(r,e,!0)})}_insert(e,r,i){try{const s=this._renderState.next??this._renderState.current,n=r.addOrUpdate?.data[e],o=s.geometry;if(null==n)return;o.has(e)||((0,_.Z)("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Creating geometry buffer ${e}`),o.set(e,new rt(e,this.stage))),(0,_.Z)("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Inserting into ${e}, version=${r.addOrUpdate?.version} stride=${n.stride}`),o.get(e).insert(n,r.sort,i),e===oe.LW.LABEL&&this._insertLabelMetrics(r.type,n.metrics,r.clear)}catch{}}_insertLabelMetrics(e,r,i){const s=this._renderState.next??this._renderState.current;if(null==r)return;const n=le.from(r);if(null!=s.metrics){if("update"===e){const o=n.getCursor();for(;o.next();)s.metrics.delete(o.id)}s.metrics.link(n)}else s.metrics=n}_remove(e,r){const i=(this._renderState.next??this._renderState.current).geometry.get(e);r&&r.length&&i&&(i.remove(r),this._removeLabelMetrics(r))}_removeLabelMetrics(e){const{metrics:r}=this._renderState.next??this._renderState.current;if(null!=r&&e.length)for(const i of e)for(;r.delete(i););}_dropPatches(){const e=new Array;let r=!1;for(;this._patches.size;){const i=this._patches.dequeue();if(null==i)break;if(i.clear){if(r)break;r=!0}e.push(i)}this._patches.clear(),e.forEach(i=>this._patches.enqueue(i))}}var Te=a(29024),ot=a(94286),Z=a(88098),lt=a(57487);const ut=(0,_.Z)("featurelayer-order-by-server-enabled");class ht extends lt.T{constructor(e,r,i,s){super(e),this._hitTestsRequests=[],this._layer=i,this._layerView=r,this._onUpdate=s}renderChildren(e){this.attributeView.update(),this.hasAnimation&&e.painter.effects.integrate.draw(e,e.attributeView),super.renderChildren(e)}hasEmptyAttributeView(){return this.attributeView.isEmpty()}isUpdating(){return this.attributeView.isUpdating()}hitTest(e){let r=this._hitTestsRequests.find(({x:s,y:n})=>s===e.x&&n===e.y);const i=(0,d.hh)();return r?r.resolvers.push(i):(r={x:e.x,y:e.y,resolvers:[i]},this._hitTestsRequests.push(r)),this.requestRender(),i.promise}onTileData(e,r){const i=ut&&"orderBy"in this._layer&&this._layer.orderBy;e.patch(r,!!i&&this._layerView.orderByFields===(i&&i?.length&&!i[0].valueExpression&&i[0].field)),this.contains(e)||this.addChild(e),this.requestRender()}onTileError(e){this.contains(e)||this.addChild(e)}updateTransitionProperties(e,r){super.updateTransitionProperties(e,r),this._layerView.featureEffectView.transitionStep(e,r),this._layerView.featureEffectView.transitioning&&this.requestRender()}doRender(e){const{minScale:r,maxScale:i}=this._layer.effectiveScaleRange,s=e.state.scale;s<=(r||1/0)&&s>=i&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}onAttributeStoreUpdate(){this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._onUpdate()}get hasAnimation(){return this.hasLabels}setStencilReference(e){const{rendererSchema:r}=e.rendererInfo;if("dot-density"===r?.type&&r?.dotSize>1||"heatmap"===r?.type)for(const s of this.children)s.stencilRef=s.key.level+1;else super.setStencilReference(e)}get hasHighlight(){return this._layerView.hasHighlight()}get hasLabels(){if("sublayers"in this._layer)return this._layer.sublayers.some(i=>!!i.labelingInfo?.length&&i.labelsVisible);const e=this._layer.featureReduction,r=e&&"labelingInfo"in e&&e.labelsVisible&&e.labelingInfo&&e.labelingInfo.length;return this._layer.labelingInfo?.length&&this._layer.labelsVisible||!!r}prepareRenderPasses(e){const r=super.prepareRenderPasses(e),i=e.registerRenderPass({name:"label",brushes:[Z.U.label],target:()=>this.hasLabels?this.children:null,drawPhase:oe.jx.LABEL|oe.jx.LABEL_ALPHA});if((0,_.Z)("featurelayer-force-marker-text-draw-order")){const n=e.registerRenderPass({name:"geometry",brushes:[Z.U.fill,Z.U.dotDensity,Z.U.line,Z.U.heatmap,Z.U.pieChart],target:()=>this.children,forceDrawByDisplayOrder:!0,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:e.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:e.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:e.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]});r.push(n)}else{const n=e.registerRenderPass({name:"geometry",brushes:[Z.U.fill,Z.U.dotDensity,Z.U.line,Z.U.marker,Z.U.heatmap,Z.U.pieChart,Z.U.text],target:()=>this.children,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:e.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:e.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:e.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]});r.push(n)}const s=e.registerRenderPass({name:"highlight",brushes:[Z.U.fill,Z.U.dotDensity,Z.U.line,Z.U.marker,Z.U.pieChart,Z.U.text],target:()=>this.children,drawPhase:oe.jx.HIGHLIGHT,enableDefaultDraw:()=>!1,effects:[{apply:e.effects.highlight,enable:()=>!!this._layerView.hasHighlight()}]});return r.push(s),r.push(i),r}}let _e=class extends be{constructor(){super(...arguments),this.type="symbol"}install(t){const r=new ht(this.tileInfoView,this.layerView,this.layer,()=>this.notifyChange("updating"));this.featuresView=r,t.addChild(r)}uninstall(t){t.removeChild(this.featuresView),this.featuresView=(0,l.SC)(this.featuresView)}fetchResource(t,e){const{url:r}=t,i=this.featuresView.stage;try{return i.resourceManager.fetchResource(r,{signal:e.signal})}catch(s){return(0,d.D_)(s)?Promise.resolve({width:0,height:0}):Promise.reject(s)}}isUpdating(){const t=super.isUpdating(),e=!this.featuresView||this.featuresView.isUpdating(),r=this.featuresView?.hasEmptyAttributeView(),i=t||e||t&&r;return(0,_.Z)("esri-2d-log-updating")&&console.log(`Updating SymbolTileRenderer ${i}\n  -> updatingTiles ${t}\n  -> hasFeaturesView ${!!this.featuresView}\n  -> updatingFeaturesView ${e}`),i}hitTest(t){return this.featuresView.hitTest(t)}supportsRenderer(t){return null!=t&&["simple","class-breaks","unique-value","dot-density","dictionary","heatmap","pie-chart"].includes(t.type)}onConfigUpdate(t){let e=null;if(t&&"visualVariables"in t){const r=((0,Te.aR)(t).visualVariables||[]).map(i=>{const s=i.clone();return"normalizationField"in i&&(s.normalizationField=null),i.valueExpression&&"$view.scale"!==i.valueExpression&&(s.valueExpression=null,s.field="nop"),s});e=(0,ot.I)(r)}this.featuresView.setRendererInfo(t,e,this.layerView.featureEffect)}onTileData(t){const e=this.tiles.get(t.tileKey);e&&t.data&&this.featuresView.onTileData(e,t.data),this.layerView.view.labelManager.requestUpdate()}onTileError(t){const e=this.tiles.get(t.tileKey);e&&this.featuresView.onTileError(e)}forceAttributeTextureUpload(){this.featuresView.attributeView.forceTextureUpload()}lockGPUUploads(){this.featuresView.attributeView.lockTextureUpload(),this.tiles.forEach(t=>t.lock())}unlockGPUUploads(){this.featuresView.attributeView.unlockTextureUpload(),this.tiles.forEach(t=>t.unlock())}getMaterialItems(t){var e=this;return(0,u.Z)(function*(){return e.featuresView.getMaterialItems(t)})()}invalidateLabels(){this.featuresView.hasLabels&&this.layerView.view.labelManager.requestUpdate()}createTile(t){const e=this.tileInfoView.getTileBounds((0,He.Ue)(),t),i=this.tileInfoView.getTileResolution(t.level);return new at(t,i,e[0],e[3],this.featuresView.attributeView,()=>this.layerView.view.labelManager.requestUpdate())}disposeTile(t){this.featuresView.removeChild(t),t.destroy(),this.layerView.view.labelManager.requestUpdate()}};_e=(0,c._)([(0,I.j)("esri.views.2d.layers.features.tileRenderers.SymbolTileRenderer")],_e);var ie=a(7351),ct=a(89178);function ge(t){return t.some(e=>e.globalId)}function se(t){return t.filter(e=>!e.error).map(e=>e.objectId??e.globalId).filter(e=>null!=e)}function Ue(t,e){const r=new Set(t);for(const i of e.values())r.add(i);return r}function Fe(t,e){const r=new Set(t);for(const i of e.values())r.delete(i);return r}let ne=class extends B.Z{constructor(t){super(t),this._hasGlobalIds=!1,this._notifyUpdating=()=>{this.notifyChange("updating")}}normalizeCtorArgs(t){return this._queueProcessor=new ct.e({concurrency:1,process:t.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(t){const e=this._queueProcessor,r=e.last();switch(t.type){case"update":case"refresh":if(r?.type===t.type)return;e.push(t).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":{const i="processed-edit"===r?.type?r:null;i&&e.popLast();const s=this._mergeEdits(i,t);for(const n of s)n&&e.push(n).then(this._notifyUpdating,this._notifyUpdating);break}}this.notifyChange("updating")}_mergeEdits(t,e){const{addedFeatures:r,deletedFeatures:i,updatedFeatures:s}=e.edits;if(this._hasGlobalIds=this._hasGlobalIds||ge(r)||ge(s)||ge(i),this._hasGlobalIds)return[t,{type:"processed-edit",edits:{addOrModified:[...r,...s],removed:i}}];const n=new Set(se(t?.edits.addOrModified??[])),o=new Set(se(t?.edits.removed??[])),g=new Set([...se(r),...se(s)]),y=new Set(se(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(Ue(Fe(n,y),g)).map(m=>({objectId:m})),removed:Array.from(Ue(Fe(o,g),y)).map(m=>({objectId:m}))}}]}};(0,c._)([(0,h.Cb)({readOnly:!0})],ne.prototype,"updating",null),(0,c._)([(0,h.Cb)()],ne.prototype,"process",void 0),ne=(0,c._)([(0,I.j)("esri.views.2d.layers.support.FeatureCommandQueue")],ne);const ft=ne;var pt=a(47868),yt=a(36885);let te=class extends pt.D{constructor(t){super(t),this._startupResolver=(0,d.hh)(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(t){this.client.tileRenderer=t}get closed(){return this._connection.closed}startup(t,e,r,i){var s=this;return(0,u.Z)(function*(){yield s.when();const n=s._controller.signal,o=function _t(t){return Array.isArray(t)}(r.source)?{transferList:r.source,signal:n}:void 0,g={service:r,config:e,tileInfo:t.tileInfo.toJSON(),tiles:i};yield s._connection.invoke("startup",g,o),s._startupResolver.resolve(),s._set("isReady",!0)})()}updateTiles(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,d.R8)(e._connection.invoke("updateTiles",t))})()}update(t){var e=this;return(0,u.Z)(function*(){const r={config:t};return yield e._startupResolver.promise,e._connection.invoke("update",r)})()}applyUpdate(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("applyUpdate",t)})()}setHighlight(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,d.R8)(e._connection.invoke("controller.setHighlight",t))})()}stop(){var t=this;return(0,u.Z)(function*(){if(yield t._startupResolver.promise,!t.closed)return(0,d.R8)(t._connection.invoke("stop"))})()}refresh(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,d.R8)(e._connection.invoke("controller.refresh",t))})()}querySummaryStatistics(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:e},r)})()}queryAggregateSummaryStatistics(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateSummaryStatistics",{query:t.toJSON(),params:e},r)})()}queryUniqueValues(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:e},r)})()}queryAggregateUniqueValues(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateUniqueValues",{query:t.toJSON(),params:e},r)})()}queryClassBreaks(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:e},r)})()}queryAggregateClassBreaks(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateClassBreaks",{query:t.toJSON(),params:e},r)})()}queryHistogram(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryHistogram",{query:t.toJSON(),params:e},r)})()}queryAggregateHistogram(t,e,r){var i=this;return(0,u.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateHistogram",{query:t.toJSON(),params:e},r)})()}queryFeatures(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatures",t?.toJSON(),e)})()}queryVisibleFeatures(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryVisibleFeatures",t?.toJSON(),e)})()}queryObjectIds(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryObjectIds",t?.toJSON(),e)})()}queryFeatureCount(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatureCount",t?.toJSON(),e)})()}queryExtent(t,e){var r=this;return(0,u.Z)(function*(){return r._connection.invoke("controller.queryExtent",t.toJSON(),e)})()}queryLatestObservations(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryLatestObservations",t.toJSON(),e)})()}queryStatistics(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.queryStatistics",t)})()}queryAggregates(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregates",t?.toJSON(),e)})()}queryAggregateCount(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateCount",t?.toJSON(),e)})()}queryAggregateIds(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateIds",t?.toJSON(),e)})()}getObjectId(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getObjectId",t)})()}getDisplayId(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getDisplayId",t)})()}getFeatures(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getFeatures",t)})()}getAggregates(){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getAggregates")})()}getAggregateValueRanges(){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getAggregateValueRanges")})()}mapValidDisplayIds(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.mapValidDisplayIds",t)})()}onEdits(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,d.R8)(e._connection.invoke("controller.onEdits",t))})()}enableEvent(t,e){var r=this;return(0,u.Z)(function*(){return yield r._startupResolver.promise,(0,d.R8)(r._connection.invoke("controller.enableEvent",{name:t,value:e}))})()}pauseStream(){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,d.R8)(t._connection.invoke("controller.pauseStream"))})()}resumeStream(){var t=this;return(0,u.Z)(function*(){return yield t._startupResolver.promise,(0,d.R8)(t._connection.invoke("controller.resumeStream"))})()}sendMessageToSocket(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,d.R8)(e._connection.invoke("controller.sendMessageToSocket",t))})()}sendMessageToClient(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,d.R8)(e._connection.invoke("controller.sendMessageToClient",t))})()}updateCustomParameters(t){var e=this;return(0,u.Z)(function*(){return yield e._startupResolver.promise,(0,d.R8)(e._connection.invoke("controller.updateCustomParameters",t))})()}_startWorker(t){var e=this;return(0,u.Z)(function*(){try{e._connection=yield(0,yt.bA)("Pipeline",{client:e.client,strategy:"dedicated",signal:t})}catch(r){(0,d.H9)(r)}})()}};(0,c._)([(0,h.Cb)()],te.prototype,"isReady",void 0),(0,c._)([(0,h.Cb)({constructOnly:!0})],te.prototype,"client",void 0),(0,c._)([(0,h.Cb)()],te.prototype,"tileRenderer",null),te=(0,c._)([(0,I.j)("esri.views.2d.layers.support.FeatureLayerProxy")],te);const gt=te;var Ve=a(55117),mt=a(44526),J=a(50532);const vt=Math.PI;function Pe(t,e){switch(e.transformationType){case J.hL.Additive:return function bt(t,e){return t+($(e.minSize,t)||e.minDataValue)}(t,e);case J.hL.Constant:return function xt(t,e){const r=t.stops;let i=r?.length&&r[0].size;return null==i&&(i=t.minSize),$(i,e)}(e,t);case J.hL.ClampedLinear:return function Rt(t,e){const r=e.minDataValue,i=e.maxDataValue,s=(t-r)/(i-r),n=$(e.minSize,t),o=$(e.maxSize,t);return t<=r?n:t>=i?o:n+s*(o-n)}(t,e);case J.hL.Proportional:return function Et(t,e){const r=t/e.minDataValue,i=$(e.minSize,t),s=$(e.maxSize,t);let n=null;return n=r*i,(0,Ve.uZ)(n,i,s)}(t,e);case J.hL.Stops:return function St(t,e){const[r,i,s]=function wt(t,e){if(!e)return;let r=0,i=e.length-1;return e.some((s,n)=>t<s?(i=n,!0):(r=n,!1)),[r,i,(t-e[r])/(e[i]-e[r])]}(t,e.cache.ipData);if(r===i)return $(e.stops[r].size,t);{const n=$(e.stops[r].size,t);return n+($(e.stops[i].size,t)-n)*s}}(t,e);case J.hL.RealWorldSize:return function Ct(t,e){const r=mt.a[e.valueUnit],i=$(e.minSize,t),s=$(e.maxSize,t),{valueRepresentation:n}=e;let o=null;return o="area"===n?2*Math.sqrt(t/vt)/r:"radius"===n||"distance"===n?2*t/r:t/r,(0,Ve.uZ)(o,i,s)}(t,e);case J.hL.Identity:return t;case J.hL.Unknown:return null}}function $(t,e){return"number"==typeof t?t:Pe(e,t)}var It=a(22879),Ae=a(54529);class Ut{constructor(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}destroy(){}clear(){this._tiles.forEach(e=>this._releaseTile(e))}tileKeys(){const e=[];return this._tiles.forEach((r,i)=>e.push(i)),e}update(e){const r=this.tileInfoView.getTileCoverage(e.state,this.buffer,!0,"closest"),{spans:i,lodInfo:s}=r,{level:n}=s,o=[],g=[],y=new Set,m=new Set;for(const{row:v,colFrom:U,colTo:C}of i)for(let w=U;w<=C;w++){const j=Ae.Z.getId(n,v,s.normalizeCol(w),s.getWorldForColumn(w)),G=this._getOrAcquireTile(o,j);y.add(j),G.isReady?G.visible=!0:m.add(G.key)}return m.forEach(v=>this._addPlaceholders(y,v)),this._tiles.forEach(v=>{y.has(v.key.id)||(g.push(v.key.id),this._releaseTile(v))}),It.Z.pool.release(r),{hasMissingTiles:m.size>0,added:o,removed:g}}_getOrAcquireTile(e,r){if(!this._tiles.has(r)){const i=this.acquireTile(new Ae.Z(r));e.push(r),this._tiles.set(r,i),i.visible=!1}return this._tiles.get(r)}_getTile(e){return this._tiles.get(e)}_releaseTile(e){this._tiles.delete(e.key.id),this.releaseTile(e)}_addPlaceholders(e,r){const i=this._addPlaceholderChildren(e,r);Math.abs(1-i)<1e-6||this._addPlaceholderParent(e,r)||(this._getTile(r.id).visible=!0)}_addPlaceholderChildren(e,r){let i=0;return this._tiles.forEach(s=>{i+=this._addPlaceholderChild(e,s,r)}),i}_addPlaceholderChild(e,r,i){return r.key.level<=i.level||!r.hasData||!i.contains(r.key)?0:(r.visible=!0,e.add(r.key.id),1/(1<<2*(r.key.level-i.level)))}_addPlaceholderParent(e,r){let i=r.getParentKey(),s=0,n=null;for(;null!=i;){if(e.has(i.id))return!0;const o=this._getTile(i.id);if(o?.isReady){for(const g of e){const y=this._getTile(g);y&&i.contains(y.key)&&(y.visible=!1)}return o.visible=!0,e.add(o.key.id),!0}o?.hasData&&o.patchCount>s&&(s=o.patchCount,n=o),i=i.getParentKey()}return!!n&&(n.visible=!0,e.add(n.key.id),!0)}}var Ft=a(8966),Vt=a(27173),D=a(85295),Oe=a(1865),Pt=a(4978),he=a(96696);const Be="esri.views.layers.FeatureLayerView",me=R.Z.getLogger(Be),At=t=>{let e=class extends t{constructor(...r){super(...r),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([(0,f.YP)(()=>{const r=this.layer;return[r?.elevationInfo?.featureExpressionInfo,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),f.tX),(0,f.on)(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),(0,f.on)(()=>{const r=this.layer;return r&&"sublayers"in r?r.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:r,layer:{fieldsIndex:i},requiredFields:s}=this;return(0,D.Q0)(i,"outFields"in r&&r.outFields?[...(0,D.Lk)(i,r.outFields),...s]:s)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){me.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(r){throw new Error("missing implementation")}createQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},i=null!=this.filter?this.filter.createQuery(r):new ae.Z(r);if("feature"===this.layer.type){const s=(0,Oe.c)(this);null!=s&&(i.where=i.where?`(${i.where}) AND (${s})`:s)}return null!=this.timeExtent&&(i.timeExtent=null!=i.timeExtent?i.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),i}createAggregateQuery(){return new ae.Z({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryFeatures(r,i){throw new Error("missing implementation")}queryObjectIds(r,i){throw new Error("missing implementation")}queryFeatureCount(r,i){throw new Error("missing implementation")}queryExtent(r,i){throw new Error("missing implementation")}fetchPopupFeatures(r,i){var s=this;return(0,u.Z)(function*(){const n=s.validateFetchPopupFeatures(i);if(n)throw n;return s.fetchClientPopupFeatures(i)})()}_loadArcadeModules(r){return r.expressionInfos?.length||Array.isArray(r.content)&&r.content.some(i=>"expression"===i.type)?(0,Pt.LC)():Promise.resolve()}_handleRequiredFieldsChange(){const r=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",r),r.then(()=>{this._updatingRequiredFieldsPromise===r&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var r=this;return(0,u.Z)(function*(){if(!r.layer||!r.view)return;const i="3d"===r.view.type,{layer:s,layer:{fieldsIndex:n,objectIdField:o}}=r,g="renderer"in s&&s.renderer,y="orderBy"in s&&s.orderBy,m="featureReduction"in s?s.featureReduction:null,v=new Set,U=yield Promise.allSettled([g?g.collectRequiredFields(v,n):null,(0,D.Mu)(v,s),i?(0,D.vl)(v,s):null,null!=r.filter?(0,D.Ll)(v,s,r.filter):null,null!=r.featureEffect?(0,D.Ll)(v,s,r.featureEffect.filter):null,m?(0,D.ZV)(v,s,m):null,y?(0,D.Qj)(v,s,y):null]);if("timeInfo"in s&&s.timeInfo&&r.timeExtent&&(0,D.gd)(v,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"feature"===s.type&&(s.floorInfo&&(0,D.gd)(v,s.fieldsIndex,[s.floorInfo.floorField]),i&&null!=s.infoFor3D&&(null==s.globalIdField&&me.error("globalIdField missing on 3DObjectFeatureLayer"),(0,D.gd)(v,s.fieldsIndex,[s.globalIdField]))),"subtype-group"===s.type){(0,D.AB)(v,n,s.subtypeField);const w=s.sublayers.map(j=>Promise.all([j.renderer?.collectRequiredFields(v,n),(0,D.Mu)(v,j)]));yield Promise.allSettled(w)}for(const w of U)"rejected"===w.status&&me.error(w.reason);(0,D.AB)(v,n,o),i&&"displayField"in s&&s.displayField&&(0,D.AB)(v,n,s.displayField);const C=Array.from(v).sort();r._set("requiredFields",C)})()}validateFetchPopupFeatures(r){if(null==r)return null;for(const i of r.clientGraphics??[]){const s=i.layer;if("popupEnabled"in s&&!s.popupEnabled)return new V.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(i.isAggregate){const n="featureReduction"in s?s.featureReduction:null;if(!(n&&"popupTemplate"in n&&n.popupEnabled&&n.popupTemplate))return new V.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!(0,he.V5)(s,r))return new V.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}fetchClientPopupFeatures(r){var i=this;return(0,u.Z)(function*(){const s=null!=r?r.clientGraphics:null;if(!s||0===s.length)return[];const n=new Array(s.length),o=new Map,g=yield i.createPopupQuery(r);for(let y=0;y<s.length;y++){const m=s[y];if(m.isAggregate){n[y]=m;continue}const v=m.layer;if(!("popupEnabled"in v))continue;const U=(0,D.Lk)(i.layer.fieldsIndex,g.outFields),C=(0,he.V5)(v,r);if(null==C)continue;const w=yield i._loadArcadeModules(C);w&&w.arcadeUtils.hasGeometryOperations(C)||!(0,D.R9)(U,m)?o.set(m.getObjectId(),{graphic:m,index:y}):n[y]=m}if("stream"===i.layer.type||0===o.size)return n.filter(Boolean);g.objectIds=Array.from(o.keys());try{const y=yield i.layer.queryFeatures(g);for(const m of y.features){const{graphic:{geometry:v},index:U}=o.get(m.getObjectId());m.geometry||=v,n[U]=m}}catch{}return n.filter(Boolean)})()}createPopupQuery(r){var i=this;return(0,u.Z)(function*(){const s=i.layer.createQuery(),n=new Set;let o=!1;const g=r?.clientGraphics?r.clientGraphics.map(y=>y.layer):[i.layer];for(const y of g){if(!("popupEnabled"in y))continue;const m=(0,he.V5)(y,r);if(null==m)continue;const v=yield i._loadArcadeModules(m),U=v&&v.arcadeUtils.hasGeometryOperations(m);o=!("point"!==i.layer.geometryType&&!U);const C=yield(0,he.e7)(i.layer,m);for(const w of C)n.add(w)}if(s.returnGeometry=o,s.returnZ=o,s.returnM=o,s.outFields=Array.from(n),s.outSpatialReference=i.view.spatialReference,"feature"===i.layer.type){const y=(0,Oe.c)(i);null!=y&&(s.where=s.where?`(${s.where}) AND (${y})`:y)}return s})()}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}};return(0,c._)([(0,h.Cb)()],e.prototype,"_updatingRequiredFieldsPromise",void 0),(0,c._)([(0,h.Cb)({readOnly:!0})],e.prototype,"availableFields",null),(0,c._)([(0,h.Cb)({readOnly:!0})],e.prototype,"dataUpdating",void 0),(0,c._)([(0,h.Cb)({type:Vt.Z})],e.prototype,"featureEffect",null),(0,c._)([(0,h.Cb)({type:N.Z})],e.prototype,"filter",void 0),(0,c._)([(0,h.Cb)(Ft.qG)],e.prototype,"timeExtent",void 0),(0,c._)([(0,h.Cb)()],e.prototype,"layer",void 0),(0,c._)([(0,h.Cb)({type:Number})],e.prototype,"maximumNumberOfFeatures",null),(0,c._)([(0,h.Cb)({readOnly:!0,type:Boolean})],e.prototype,"maximumNumberOfFeaturesExceeded",null),(0,c._)([(0,h.Cb)({readOnly:!0})],e.prototype,"requiredFields",void 0),(0,c._)([(0,h.Cb)()],e.prototype,"suspended",void 0),(0,c._)([(0,h.Cb)()],e.prototype,"view",void 0),e=(0,c._)([(0,I.j)(Be)],e),e};var Ot=a(50145),Bt=a(32126),Lt=a(19903),Mt=a(26894);function Le(t){return t&&"openPorts"in t}function Dt(t){return e=>(0,T.F2)(Pe(e,t))}const Me="esri.views.2d.layers.FeatureLayerView2D";let z=class extends(At((0,Bt.Z)((0,ke.y)(Ot.Z)))){constructor(){var t;super(...arguments),t=this,this._pipelineIsUpdating=!0,this._commandsQueue=new ft({process:e=>{switch(e.type){case"processed-edit":return this._doEdit(e);case"refresh":return this._doRefresh(e.dataChanged);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._updateHighlight=(0,d.Ds)((0,u.Z)(function*(){return t._proxy.setHighlight(Array.from(t._highlightIds.keys()))})),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.featureEffectView=new A,this._lastDefinitionExpression=null}destroy(){this._updateClusterSizeTask?.remove(),this._proxy?.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.addHandles([this.on("valueRangesChanged",t=>{this._set("_aggregateValueRanges",t.valueRanges)}),(0,f.YP)(()=>this.featureEffect,t=>{this.featureEffectView.featureEffect=t},f.tX)],"constructor"),this.featureEffectView.endTransitions()}_initProxy(){var t=this;return(0,u.Z)(function*(){const e=t.layer;if("isTable"in e&&e.isTable)throw new V.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t.layer});if(("feature"===e.type||"subtype-group"===e.type)&&!(0,q.S1)(e)?.operations.supportsQuery)throw new V.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});t._proxy&&t._proxy.destroy();const r=t._createClientOptions();return t._set("_proxy",new gt({client:r})),t._proxy.when()})()}_initServiceOptions(){var t=this;return(0,u.Z)(function*(){return t._set("_serviceOptions",yield t._createServiceOptions()),t._serviceOptions})()}get _effectiveFeatureReduction(){if(!("featureReduction"in this.layer))return null;const t=this.layer.featureReduction;return t&&(!("maxScale"in t)||!t.maxScale||t.maxScale<this.view.scale)?t:null}get orderByFields(){return"stream"!==this._serviceOptions?.type?this._serviceOptions?.orderByFields:void 0}get labelsVisible(){return!this.suspended&&("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]).some(e=>e.labelingInfo&&e.labelsVisible)}get labelingCollisionInfos(){const{tileRenderer:t,layer:e}=this;if(null==t)return null;const i=e.geometryType,s=!function Zt(t){for(const e of t){const r="featureReduction"in e&&e.featureReduction&&"labelingInfo"in e.featureReduction?e.featureReduction:void 0,i=[...e.labelingInfo||[],...r?.labelingInfo||[]];if(e.labelsVisible&&i.length&&i.some(s=>"none"===s.deconflictionStrategy))return!0}return!1}("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]),n={};if("subtype-group"!==e.type){if("heatmap"===t?.type)return null;const o=function zt(t){const e=null!=t&&"visualVariables"in t&&t.visualVariables;if(!e)return null;for(const r of e)if("size"===r.type)return Dt(r);return null}(e.renderer);n[0]=o}return[{tileRenderer:t,vvEvaluators:n,deconflictionEnabled:s,geometryType:i,visible:!this.suspended}]}get queryMode(){return this._serviceOptions?.type}get renderingConfigHash(){if(!this.layer)return null;const t=this.availableFields,e=this.layer,r=this.view.floors,{definitionExpression:i}=e,s="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,n="renderer"in e&&e.renderer,o="gdbVersion"in e?e.gdbVersion:void 0,g="historicMoment"in e?e.historicMoment?.getTime():void 0,{timeExtent:y}=this,m="customParameters"in e?JSON.stringify(e.customParameters):void 0,v="apiKey"in e?e.apiKey:void 0,U="stream"===e.type?`${JSON.stringify(e.geometryDefinition)}${e.definitionExpression}`:null,C=JSON.stringify(this.clips),w=this._effectiveFeatureReduction?.toJSON(),j="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),G="sublayers"in this.layer&&this.layer.sublayers.items.reduce((de,K)=>de+`${K.visible?1:0}.${JSON.stringify(K.renderer)}.${K.labelsVisible}\n.${JSON.stringify(K.labelingInfo)}`,"");return JSON.stringify({orderBy:j,sublayerHash:G,subtypeCode:"subtypeCode"in this.layer&&this.layer.subtypeCode,filterHash:null!=this.filter&&this.filter.toJSON(),effectHash:null!=this.featureEffect&&this.featureEffect.toJSON(),streamFilter:U,gdbVersion:o,definitionExpression:i,historicMoment:g,availableFields:t,renderer:n,labelingInfo:s,timeExtent:y,floors:r,clipsHash:C,featureReduction:w,customParameters:m,apiKey:v,timeZone:this.view.timeZone})}highlight(t){let e;t instanceof b.Z?e=[t.getObjectId()]:"number"==typeof t||"string"==typeof t?e=[t]:O.Z.isCollection(t)&&t.length>0?e=t.map(i=>i?.getObjectId()).toArray():Array.isArray(t)&&t.length>0&&(e="number"==typeof t[0]||"string"==typeof t[0]?t:t.map(i=>i?.getObjectId()));const r=e?.filter(P.pC);return r?.length?(this._addHighlight(r),(0,k.kB)(()=>this._removeHighlight(r))):(0,k.kB)()}hasHighlight(){return!!this._highlightIds.size}hitTest(t,e){var r=this;return(0,u.Z)(function*(){if(!r.tileRenderer)return null;const i=yield r.tileRenderer.hitTest(e);if(0===i.length)return null;(0,_.Z)("featurelayer-force-marker-text-draw-order")&&i.sort((o,g)=>o-g);const{features:s,aggregates:n}=yield r._proxy.getFeatures(i);return[...n.map(o=>r._createGraphicHit(t,S.fromJSON(o))),...s.map(o=>r._createGraphicHit(t,b.Z.fromJSON(o)))]})()}queryStatistics(){return this._proxy.queryStatistics()}querySummaryStatistics(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.querySummaryStatistics(i._cleanUpQuery(t),s,r)})()}queryAggregateSummaryStatistics(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryAggregateSummaryStatistics(i._cleanUpAggregateQuery(t),s,r)})()}queryUniqueValues(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryUniqueValues(i._cleanUpQuery(t),s,r)})()}queryAggregateUniqueValues(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryAggregateUniqueValues(i._cleanUpAggregateQuery(t),s,r)})()}queryClassBreaks(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryClassBreaks(i._cleanUpQuery(t),s,r)})()}queryAggregateClassBreaks(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryAggregateClassBreaks(i._cleanUpAggregateQuery(t),s,r)})()}queryHistogram(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryHistogram(i._cleanUpQuery(t),s,r)})()}queryAggregateHistogram(t,e,r){var i=this;return(0,u.Z)(function*(){const s={...e,scale:i.view.scale};return i._proxy.queryAggregateHistogram(i._cleanUpAggregateQuery(t),s,r)})()}queryFeatures(t,e){return this.queryFeaturesJSON(t,e).then(r=>{const i=ce.Z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryVisibleFeatures(t,e){return this._proxy.queryVisibleFeatures(this._cleanUpQuery(t),e).then(r=>{const i=ce.Z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryAggregates(t,e){var r=this;return(0,u.Z)(function*(){const i=yield r._proxy.queryAggregates(r._cleanUpAggregateQuery(t),e),s=De.fromJSON(i);return s.features.forEach(n=>r._setLayersForFeature(n)),s})()}queryAggregateIds(t,e){return this._proxy.queryAggregateIds(this._cleanUpAggregateQuery(t),e)}queryAggregateCount(t,e){return this._proxy.queryAggregateCount(this._cleanUpAggregateQuery(t),e)}queryAggregateJSON(t,e){return this._proxy.queryAggregates(this._cleanUpAggregateQuery(t),e)}queryFeaturesJSON(t,e){return this._proxy.queryFeatures(this._cleanUpQuery(t),e)}queryObjectIds(t,e){return this._proxy.queryObjectIds(this._cleanUpQuery(t),e)}queryFeatureCount(t,e){return this._proxy.queryFeatureCount(this._cleanUpQuery(t),e)}queryExtent(t,e){return this._proxy.queryExtent(this._cleanUpQuery(t),e).then(r=>({count:r.count,extent:Mt.Z.fromJSON(r.extent)}))}setVisibility(t,e){e?this._visibilityOverrides.delete(t):this._visibilityOverrides.add(t),this._update()}update(t){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:e,added:r,removed:i}=this._tileStrategy.update(t);(r.length||i.length)&&this._proxy.updateTiles({added:r,removed:i}),e&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new Ut({acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.addAttachHandles((0,f.YP)(()=>this.renderingConfigHash,()=>this._update(),f.nn)),"stream"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",t=>this._edit(t)))}detach(){this._commandsQueue.clear(),this._proxy?.stop(),this.container.removeAllChildren(),this.tileRenderer?.uninstall(this.container),this.tileRenderer=null,this._tileStrategy=(0,l.SC)(this._tileStrategy),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const t="renderer"in this.layer&&null!=this.layer.renderer,e=this._commandsQueue.updating,r=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,s=this._pipelineIsUpdating,n=null==this.tileRenderer||this.tileRenderer?.updating,o=t&&(e||r||i||s||this.dataUpdating||n);return(0,_.Z)("esri-2d-log-updating")&&console.log(`Updating FLV2D (${this.layer.id}): ${o}\n  -> hasRenderer ${t}\n  -> hasPendingCommand ${e}\n  -> updatingRequiredFields ${r}\n  -> updatingProxy ${i}\n  -> updatingPipeline ${s}\n  -> updatingData: ${this.dataUpdating}\n  -> updatingTileRenderer ${n}\n`),o}_createClientOptions(){return{setUpdating:t=>{this._set("_pipelineIsUpdating",t)},setDataUpdating:t=>{this._set("dataUpdating",t)},emitEvent:t=>{this.emit(t.name,t.event)}}}_detectQueryMode(t){var e=this;return(0,u.Z)(function*(){const r="path"in t,{layer:i}=e,o=!("editingInfo"in i&&i.editingInfo?.lastEditDate)&&"refreshInterval"in i&&!!i.refreshInterval,g=(0,q.S1)(i);if(r&&("feature"===i.type||"subtype-group"===i.type)&&"point"===i.geometryType&&g?.query.supportsPagination&&!g?.operations.supportsEditing&&!o&&(0,_.Z)("featurelayer-snapshot-enabled"))try{const y=yield i.queryFeatureCount();if(y<=(0,_.Z)("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:y};const m=(0,_.Z)("featurelayer-snapshot-point-max-threshold"),v=(0,_.Z)("featurelayer-snapshot-point-coverage"),U=e.view.extent,C=i.fullExtent,w=C?.clone().intersection(U),j=null!=w?w.width*w.height:0,G=C?.width*C?.height;if(y<=m&&(0===G?0:j/G)>=v)return{mode:"snapshot",featureCount:y}}catch(y){R.Z.getLogger(e).warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:y})}return{mode:"on-demand"}})()}_createServiceOptions(){var t=this;return(0,u.Z)(function*(){const e=t.layer;if("stream"===e.type)return null;const r=(0,q.S1)(e),{capabilities:i,objectIdField:s}=e,n=e.fieldsIndex.toJSON(),o=n.fields,g=null!=e.fullExtent?e.fullExtent.toJSON():null,y=function kt(t){switch(t.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":case"multipatch":return"esriGeometryPolygon";case"multipoint":return"esriGeometryMultipoint";default:return R.Z.getLogger(Me).error(new V.Z("unsupported-geometry-type",`Geometry type of ${t.geometryType} is not supported`)),null}}(e),m="timeInfo"in e&&e.timeInfo?.toJSON()||null,v=e.spatialReference?e.spatialReference.toJSON():null,U="feature"===e.type?e.globalIdField:null;let C;"ogc-feature"===e.type?C=e.source.getSource():Le(e.source)?C=yield e.source.openPorts():e.parsedUrl&&(C=(0,H.d9)(e.parsedUrl),"dynamicDataSource"in e&&e.dynamicDataSource&&(C.query={layer:JSON.stringify({source:e.dynamicDataSource})}));const w="datesInUnknownTimezone"in t.layer&&t.layer.datesInUnknownTimezone,j=("subtypeField"in t.layer?t.layer.subtypeField:null)??null,{mode:G,featureCount:ee}=yield t._detectQueryMode(C);let de=t.layer.objectIdField;if("feature"===t.layer.type&&null!=t.layer.orderBy&&t.layer.orderBy.length){const K=!t.layer.orderBy[0].valueExpression&&t.layer.orderBy[0].field;K&&(de=K)}return{type:G,typeIdField:"typeIdField"in e&&e.typeIdField||void 0,types:"types"in e&&e.types?.map(K=>K.toJSON())||void 0,timeReferenceUnknownClient:w,subtypeField:j,featureCount:ee,globalIdField:U,maxRecordCount:i.query.maxRecordCount,tileMaxRecordCount:i.query.tileMaxRecordCount,capabilities:i,effectiveCapabilities:r,fields:o,fieldsIndex:n,fullExtent:g,geometryType:y,objectIdField:s,source:C,timeInfo:m,spatialReference:v,orderByFields:de}})()}_createMemoryServiceOptions(t){var e=this;return(0,u.Z)(function*(){const r=yield t.openPorts();return{...e._createServiceOptions(),type:"memory",source:r}})()}_cleanUpQuery(t){const e=ae.Z.from(t)||this.createQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}_cleanUpAggregateQuery(t){const e=ae.Z.from(t)||this.createAggregateQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}_update(){var t=this;return(0,u.Z)(function*(){return t._commandsQueue.push({type:"update"})})()}_edit(t){var e=this;return(0,u.Z)(function*(){return e.suspended?void e._clearTiles():e._validateEdit(t)?e._commandsQueue.push({type:"edit",edits:t}):void 0})()}doRefresh(t){var e=this;return(0,u.Z)(function*(){if(e.attached&&e._tileStrategy.tileKeys().length)return e.suspended&&t?void e._clearTiles():e._commandsQueue.push({type:"refresh",dataChanged:t})})()}_clearTiles(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}_validateEdit(t){const e="globalIdField"in this.layer&&this.layer.globalIdField,r=t.deletedFeatures.some(s=>-1===s.objectId||!s.objectId),i=e&&this.availableFields.includes(e);return r&&!i?(R.Z.getLogger(this).error(new V.Z("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected on the map`)),null):t}_doUpdate(){var t=this;return(0,u.Z)(function*(){try{if(t.destroyed||!t._hasRequiredSupport(t.layer)||!t._tileStrategy)return;const{featureEffectView:e,filter:r}=t;if(yield t._updateRequiredFields(),t.destroyed)return;const{renderer:i}=t._getEffectiveRenderer();t._set("_effectiveRenderer",i);const s=t._createSchemaConfig(),n=t._createConfiguration(s,r,e.filter),o=t._lastDefinitionExpression!==n.schema.source.definitionExpression;t._lastDefinitionExpression=n.schema.source.definitionExpression;const g=n.schema.tileRenderer,y=t._createTileRendererHash(g);if("snapshot"===t._serviceOptions.type&&(n.schema.source.initialFeatureCount=t._serviceOptions.featureCount),y!==t._tileRendererHash){t._initTileRenderer(g,i);const m=t.layer,v="stream"===m.type?yield t._initServiceOptions():t._serviceOptions;t.tileRenderer.onConfigUpdate(i),"stream"!==m.type&&Le(m.source)&&(v.source=yield m.source.openPorts());const U={added:t._tileStrategy.tileKeys(),removed:[]};(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Proxy startup"),yield t._proxy.startup(t.view.featuresTilingScheme,n,v,U),(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished proxy startup"),t.hasHighlight()&&((0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Updating highlight"),yield t._proxy.setHighlight(Array.from(t._highlightIds.keys())),(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished highlight update")),(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: onConfigUpdate start"),t.tileRenderer.onConfigUpdate(i),(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: onConfigUpdate end")}else{"snapshot"===t._serviceOptions.type&&o&&(n.schema.source.changedFeatureCount=yield t.layer.queryFeatureCount()),(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Updating proxy");const m=yield t._proxy.update(n);(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished proxy update"),(m.mesh||m.targets?.aggregate)&&((0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Locking GPU Uploads"),t._lockGPUUploads());try{(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Applying update to proxy"),yield t._proxy.applyUpdate(m),(0,_.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished applying update to proxy")}catch(v){(0,d.D_)(v)||R.Z.getLogger(t).error(v)}(m.mesh||m.targets?.aggregate)&&t._unlockGPUUploads(),t.tileRenderer.onConfigUpdate(i),t._updateClusterSizeVariable(),t._forceAttributeTextureUpload()}t._tileRendererHash=y,t.tileRenderer.invalidateLabels(),t.requestUpdate()}catch{}})()}_doEdit(t){var e=this;return(0,u.Z)(function*(){try{yield e._proxy.onEdits(t)}catch(r){(0,d.D_)(r)}})()}_doRefresh(t){var e=this;return(0,u.Z)(function*(){e._lockGPUUploads();try{let r;t&&"snapshot"===e.queryMode&&"queryFeatureCount"in e.layer&&(r=yield e.layer.queryFeatureCount()),yield e._proxy.refresh({dataChanged:t,featureCount:r})}catch(r){(0,d.D_)(r)}e._unlockGPUUploads(),e._effectiveFeatureReduction&&e._updateClusterSizeVariable()})()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(t,e){return(0,f.YP)(()=>this._aggregateValueRanges,r=>{this._updateClusterEffectiveRendererSizeVariable(t,e,r),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()})}_updateClusterEffectiveRendererSizeVariable(t,e,r){var i=this;return(0,u.Z)(function*(){if(t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables){const s=(0,ie.os)(t.visualVariables);if(null!=s&&"cluster_count"===s.field){const n=t.visualVariables.indexOf(s);t.visualVariables[n]=(0,ie.aV)(e,r);const o=t.clone();o.dynamicClusterSize=!0,i._set("_effectiveRenderer",o)}}})()}_getEffectiveRenderer(){const t=this.layer,e="renderer"in t?t.renderer:null,r=this._effectiveFeatureReduction;if(this._updateClusterSizeTask=(0,l.hw)(this._updateClusterSizeTask),r&&"renderer"in r&&r.renderer&&!r.renderer.authoringInfo?.isAutoGenerated){const i=r.fields;if("cluster"===r.type){const{renderer:s,didInject:n}=(0,ie.st)(r.renderer,r,this._aggregateValueRanges);return n&&(this._updateClusterSizeTask=this._createUpdateClusterSizeTask(s,r)),{renderer:s,aggregateFields:i,featureReduction:r}}return{renderer:r.renderer,aggregateFields:i,featureReduction:r}}if(r&&"cluster"===r.type&&e&&(0,ie.yR)(e)){const i=r,s=[],n=(0,ie.S1)(s,e,i,this._aggregateValueRanges,!0);return this._updateClusterSizeTask=this._createUpdateClusterSizeTask(n,i),{renderer:n,aggregateFields:s,featureReduction:r}}return{renderer:e,aggregateFields:[],featureReduction:null}}_acquireTile(t){const e=this.tileRenderer.acquireTile(t);return e.once("attach",()=>{this.requestUpdate()}),e}_releaseTile(t){this.tileRenderer.releaseTile(t)}_initTileRenderer(t,e){const r=function dt(t,e){if(!t)return null;switch(t.type){case"symbol":return new _e(e);case"heatmap":return new fe(e)}}(t,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});return this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer=(0,l.SC)(this.tileRenderer)),this.destroyed?null:(this._proxy.tileRenderer=r,this._set("tileRenderer",r),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(e),this.requestUpdate(),this.tileRenderer)}_createTileRendererHash(t){return`${t.type}`}get hasFilter(){return!!(this.filter||"floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length||this._visibilityOverrides.size||this.timeExtent)}_injectOverrides(t){const e=null!=t?t.timeExtent:null,r=null!=this.timeExtent&&null!=e?this.timeExtent.intersection(e):this.timeExtent||e;let i=null;const s="floorInfo"in this.layer&&this.layer.floorInfo;if(s&&(i=this._addFloorFilterClause(null!=t?t.where:null)),!this._visibilityOverrides.size&&!r&&!s)return null!=t?t.toJSON():null;(t=null!=t&&t.clone()||new N.Z).timeExtent=r,i&&(t.where=i);const n=t.toJSON();return n.hiddenIds=Array.from(this._visibilityOverrides),n}_addFloorFilterClause(t){const e=this.layer;let r=t||"";if("floorInfo"in e&&e.floorInfo){let i=this.view.floors;if(!i?.length)return r;e.floorInfo.viewAllLevelIds?.length&&(i=e.floorInfo.viewAllLevelIds);const s=i.filter(g=>""!==g).map(g=>"'"+g+"'");s.push("''");const n=e.floorInfo.floorField;let o="("+n+" IN ({ids}) OR "+n+" IS NULL)";if(o=o.replace("{ids}",s.join(", ")),null!=r&&r.includes(n)){let g=new RegExp("AND \\("+n+".*NULL\\)","g");r=r.replace(g,""),g=new RegExp("\\("+n+".*NULL\\)","g"),r=r.replace(g,""),r=r.replaceAll(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+o:o}return""!==r?r:null}_createConfiguration(t,e,r){const i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,s="feature"===this.layer.type?this.layer.gdbVersion??void 0:void 0,n=new Array(ze.NS),o=this._injectOverrides(e);n[0]=o,n[1]=null!=r?r.toJSON():null;const g=(0,qe.Ew)(t);if(null==g)return null;const y=(0,Lt.hc)("2d");return{availableFields:this.availableFields,gdbVersion:s,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:n,schema:g,supportsTextureFloat:y.supportsTextureFloat,maxTextureSize:y.maxTextureSize,timeZone:this.view.timeZone}}_hasRequiredSupport(t){return!("renderer"in t)||(0,Te.TT)(t.renderer)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){const t=this.layer;return{renderer:"renderer"in t?t.renderer:null,spatialReference:t.spatialReference,timeExtent:"timeExtent"in t?t.timeExtent:null,definitionExpression:t.definitionExpression,featureReduction:this._effectiveFeatureReduction,fields:t.fields,geometryType:t.geometryType,historicMoment:"historicMoment"in t?t.historicMoment:null,labelsVisible:"labelsVisible"in t&&t.labelsVisible,labelingInfo:"labelingInfo"in t?t.labelingInfo:null,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"gdbVersion"in t?t.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in t&&t.orderBy?t.orderBy:null,customParameters:{..."customParameters"in t?t.customParameters:void 0,token:"apiKey"in t?t.apiKey??void 0:void 0},subtypeCode:"subtypeCode"in t?t.subtypeCode:void 0,subtypeField:"subtypeField"in t?t.subtypeField:void 0}}_addHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const r=this._highlightIds.get(e);this._highlightIds.set(e,r+1)}else this._highlightIds.set(e,1);this._updateHighlight().catch(e=>{(0,d.D_)(e)||R.Z.getLogger(this).error(e)})}_removeHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const r=this._highlightIds.get(e)-1;0===r?this._highlightIds.delete(e):this._highlightIds.set(e,r)}this._updateHighlight().catch(e=>{(0,d.D_)(e)||R.Z.getLogger(this).error(e)})}_setLayersForFeature(t){const e=this.layer;t.layer=e,t.sourceLayer=e}_createGraphicHit(t,e){return this._setLayersForFeature(e),null!=e.geometry&&(e.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:e,layer:this.layer,mapPoint:t}}};(0,c._)([(0,h.Cb)()],z.prototype,"_serviceOptions",void 0),(0,c._)([(0,h.Cb)()],z.prototype,"_proxy",void 0),(0,c._)([(0,h.Cb)()],z.prototype,"_pipelineIsUpdating",void 0),(0,c._)([(0,h.Cb)()],z.prototype,"_effectiveRenderer",void 0),(0,c._)([(0,h.Cb)()],z.prototype,"_effectiveFeatureReduction",null),(0,c._)([(0,h.Cb)()],z.prototype,"_aggregateValueRanges",void 0),(0,c._)([(0,h.Cb)()],z.prototype,"_commandsQueue",void 0),(0,c._)([(0,h.Cb)()],z.prototype,"featureEffectView",void 0),(0,c._)([(0,h.Cb)()],z.prototype,"labelsVisible",null),(0,c._)([(0,h.Cb)()],z.prototype,"labelingCollisionInfos",null),(0,c._)([(0,h.Cb)({readOnly:!0})],z.prototype,"queryMode",null),(0,c._)([(0,h.Cb)()],z.prototype,"renderingConfigHash",null),(0,c._)([(0,h.Cb)()],z.prototype,"tileRenderer",void 0),(0,c._)([(0,h.Cb)()],z.prototype,"updating",void 0),z=(0,c._)([(0,I.j)(Me)],z);const qt=z},32126:(Q,L,a)=>{a.d(L,{Z:()=>S});var u=a(50484),c=a(4703),b=a(79412),h=a(77675),E=a(80543),p=(a(1535),a(57678),a(14007),a(10141));const S=x=>{let O=class extends x{initialize(){this.addHandles((0,h.on)(()=>this.layer,"refresh",V=>{this.doRefresh(V.dataChanged).catch(k=>{(0,b.D_)(k)||c.Z.getLogger(this).error(k)})}),"RefreshableLayerView")}};return(0,u._)([(0,E.Cb)()],O.prototype,"layer",void 0),O=(0,u._)([(0,p.j)("esri.layers.mixins.RefreshableLayerView")],O),O}},96696:(Q,L,a)=>{a.d(L,{V5:()=>E,e7:()=>b});var u=a(15861),c=a(85295);function b(_){return h.apply(this,arguments)}function h(){return(h=(0,u.Z)(function*(_,I=_.popupTemplate){if(null==I)return[];const p=yield I.getRequiredFields(_.fieldsIndex),{lastEditInfoEnabled:S}=I,{objectIdField:x,typeIdField:O,globalIdField:V,relationships:k}=_;if(p.includes("*"))return["*"];const H=S?(0,c.CH)(_):[],R=(0,c.Q0)(_.fieldsIndex,[...p,...H]);return O&&R.push(O),R&&x&&_.fieldsIndex?.has(x)&&!R.includes(x)&&R.push(x),R&&V&&_.fieldsIndex?.has(V)&&!R.includes(V)&&R.push(V),k&&k.forEach(l=>{const{keyField:d}=l;R&&d&&_.fieldsIndex?.has(d)&&!R.includes(d)&&R.push(d)}),R})).apply(this,arguments)}function E(_,I){return _.popupTemplate?_.popupTemplate:null!=I&&I.defaultPopupTemplateEnabled&&null!=_.defaultPopupTemplate?_.defaultPopupTemplate:null}}}]);