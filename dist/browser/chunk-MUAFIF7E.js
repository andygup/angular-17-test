import{b as U,c as V,d as H}from"./chunk-LYLAJHBR.js";import{a as Q}from"./chunk-PQYE2TOR.js";import{o as z,p as E,q as _}from"./chunk-M3GEY4SR.js";import{a as L}from"./chunk-7QY3BMVN.js";import{a as B}from"./chunk-EDSVJRYE.js";import{a as K}from"./chunk-YH4Z47PR.js";import{c as A}from"./chunk-UZQ577CU.js";import{d as $}from"./chunk-AHKJJNRE.js";import{b as k}from"./chunk-A52LT7YB.js";import{A as J}from"./chunk-CZPMRK53.js";import{$ as j}from"./chunk-XF4NUYV7.js";import{p as Z,r as g}from"./chunk-465DRXTW.js";import{a as p,b,g as h}from"./chunk-ESDYQQXO.js";var D=Z.getLogger("esri.layers.graphics.sources.ogcfeature"),X="http://www.opengis.net/def/crs/",xe=`${X}OGC/1.3/CRS84`;function ve(o,s){return h(this,arguments,function*(e,t,i={},n=5){let{links:l}=e,d=y(l,"items","application/geo+json")||y(l,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(d==null)throw new g("ogc-feature-layer:missing-items-page","Missing items url");let{data:m}=yield j(d.href,{signal:i.signal,query:b(p({limit:n},i.customParameters),{token:i.apiKey}),headers:{accept:"application/geo+json"}});U(m);let c=V(m,{geometryType:t.geometryType}),f=t.fields||c.fields||[],N=t.hasZ!=null?t.hasZ:c.hasZ,x=c.geometryType,F=t.objectIdField||c.objectIdFieldName||"OBJECTID",a=t.timeInfo,v=f.find(({name:r})=>r===F);if(v)v.editable=!1,v.nullable=!1;else{if(!c.objectIdFieldType)throw new g("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");f.unshift({name:F,alias:F,type:c.objectIdFieldType==="number"?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(F!==c.objectIdFieldName){let r=f.find(({name:u})=>u===c.objectIdFieldName);r&&(r.type="esriFieldTypeInteger")}f===c.fields&&c.unknownFields.length>0&&D.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:c.unknownFields}});for(let r of f){if(r.name==null&&(r.name=r.alias),r.alias==null&&(r.alias=r.name),r.type!=="esriFieldTypeOID"&&r.type!=="esriFieldTypeGlobalID"&&(r.editable=r.editable==null||!!r.editable,r.nullable=r.nullable==null||!!r.nullable),!r.name)throw new g("ogc-feature-layer:invalid-field-name","field name is missing",{field:r});if(!K.jsonValues.includes(r.type))throw new g("ogc-feature-layer:invalid-field-type",`invalid type for field "${r.name}"`,{field:r})}if(a){let r=new B(f);if(a.startTimeField){let u=r.get(a.startTimeField);u?(a.startTimeField=u.name,u.type="esriFieldTypeDate"):a.startTimeField=null}if(a.endTimeField){let u=r.get(a.endTimeField);u?(a.endTimeField=u.name,u.type="esriFieldTypeDate"):a.endTimeField=null}if(a.trackIdField){let u=r.get(a.trackIdField);u?a.trackIdField=u.name:(a.trackIdField=null,D.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:a}}))}a.timeReference||={timeZoneIANA:A},a.startTimeField||a.endTimeField||(D.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:a}}),a=null)}return{drawingInfo:x?Q(x):null,extent:de(e),geometryType:x,fields:f,hasZ:!!N,objectIdField:F,timeInfo:a}})}function Ne(i){return h(this,arguments,function*(e,t={}){let{links:n}=e,o=y(n,"data","application/json")||y(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(o==null)throw new g("ogc-feature-layer:missing-collections-page","Missing collections url");let{apiKey:s,customParameters:l,signal:d}=t,{data:m}=yield j(o.href,{signal:d,headers:{accept:"application/json"},query:b(p({},l),{token:s})});return m})}function Oe(i){return h(this,arguments,function*(e,t={}){let{links:n}=e,o=y(n,"conformance","application/json")||y(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(o==null)throw new g("ogc-feature-layer:missing-conformance-page","Missing conformance url");let{apiKey:s,customParameters:l,signal:d}=t,{data:m}=yield j(o.href,{signal:d,headers:{accept:"application/json"},query:b(p({},l),{token:s})});return m})}function qe(i){return h(this,arguments,function*(e,t={}){let{apiKey:n,customParameters:o,signal:s}=t,{data:l}=yield j(e,{signal:s,headers:{accept:"application/json"},query:b(p({},o),{token:n})});return l})}function Ge(i){return h(this,arguments,function*(e,t={}){let n="application/vnd.oai.openapi+json;version=3.0",o=y(e.links,"service-desc",n);if(o==null)return D.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;let{apiKey:s,customParameters:l,signal:d}=t,{data:m}=yield j(o.href,{signal:d,headers:{accept:n},query:b(p({},l),{token:s})});return m})}function Ce(e){let t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),i=t?.groups;if(!i)return null;let{authority:n,code:o}=i;switch(n.toLowerCase()){case"ogc":switch(o.toLowerCase()){case"crs27":return k.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return k.WGS84.wkid;default:return null}case"esri":case"epsg":{let s=Number.parseInt(o,10);return Number.isNaN(s)?null:s}default:return null}}function De(e,t,i){return h(this,null,function*(){let n=yield oe(e,t,i);return _(n)})}function oe(e,t,i){return h(this,null,function*(){let{collection:n,layerDefinition:o,maxRecordCount:s,queryParameters:{apiKey:l,customParameters:d},spatialReference:m,supportedCrs:c}=e,{links:f}=n,N=y(f,"items","application/geo+json")||y(f,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(N==null)throw new g("ogc-feature-layer:missing-items-page","Missing items url");let{geometry:x,num:F,start:a,timeExtent:v,where:r}=t;if(t.objectIds)throw new g("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");let u=k.fromJSON(m),S=t.outSpatialReference??u,O=S.isWGS84?null:Y(S,c),ee=ue(x,c),te=le(v),ne=ce(r),ie=F??(a!=null&&a!==void 0?10:s),{data:I}=yield j(N.href,b(p({},i),{query:b(p(p({},d),ee),{crs:O,datetime:te,query:ne,limit:ie,startindex:a,token:l}),headers:{accept:"application/geo+json"}})),q=!1;I.links&&(q=!!I.links.find(C=>C.rel==="next")),!q&&Number.isInteger(I.numberMatched)&&Number.isInteger(I.numberReturned)&&(q=I.numberReturned<I.numberMatched);let{fields:re,geometryType:G,hasZ:P,objectIdField:R}=o,W=H(I,{geometryType:G,hasZ:P,objectIdField:R});if(!O&&S.isWebMercator){for(let T of W)if(T.geometry!=null&&G!=null){let C=E(T.geometry,G,P,!1);C.spatialReference=k.WGS84,T.geometry=z($(C,S))}}for(let T of W)T.objectId=T.attributes[R];let ae=O||!O&&S.isWebMercator?S.toJSON():J,w=new L;return w.exceededTransferLimit=q,w.features=W,w.fields=re,w.geometryType=G,w.hasZ=P,w.objectIdFieldName=R,w.spatialReference=ae,w})}function se(e){return e!=null&&e.type==="extent"}function Y(e,t){let{isWebMercator:i,wkid:n}=e;if(!n)return null;let o=i?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return o?`${X}${o}`:null}function M(e){if(e==null)return"";let{xmin:t,ymin:i,xmax:n,ymax:o}=e;return`${t},${i},${n},${o}`}function le(e){if(e==null)return null;let{start:t,end:i}=e;return`${t!=null?t.toISOString():".."}/${i!=null?i.toISOString():".."}`}function ce(e){return e!=null&&e&&e!=="1=1"?e:null}function ue(e,t){if(!se(e))return null;let{spatialReference:i}=e;if(!i||i.isWGS84)return{bbox:M(e)};let n=Y(i,t);return n!=null?{bbox:M(e),"bbox-crs":n}:i.isWebMercator?{bbox:M($(e,k.WGS84))}:null}function de(e){let t=e.extent?.spatial;if(!t)return null;let i=t.bbox[0],n=i.length===4,o=i[0],s=i[1],l=n?void 0:i[2];return{xmin:o,ymin:s,xmax:n?i[2]:i[3],ymax:n?i[3]:i[4],zmin:l,zmax:n?void 0:i[5],spatialReference:k.WGS84.toJSON()}}function y(e,t,i){return e.find(n=>n.rel===t&&n.type===i)||e.find(n=>n.rel===t&&!n.type)}export{X as a,xe as b,ve as c,Ne as d,Oe as e,qe as f,Ge as g,Ce as h,De as i,oe as j};
