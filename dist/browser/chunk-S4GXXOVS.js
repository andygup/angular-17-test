import{b as m}from"./chunk-HI2T2YSZ.js";import{a as d}from"./chunk-F72O5PVM.js";import{c as S}from"./chunk-B4PK7RBX.js";import{$ as f,V as g}from"./chunk-XF4NUYV7.js";import{k as u}from"./chunk-PT7S6WNL.js";import{r as c}from"./chunk-465DRXTW.js";import{a as w,b as h,g as o}from"./chunk-ESDYQQXO.js";function C(r,n){return o(this,null,function*(){let a=m(r);if(!a)throw new c("invalid-url","Invalid scene service url");let e=h(w({},n),{sceneServerUrl:a.url.path,layerId:a.sublayer??void 0});if(e.sceneLayerItem??=yield T(e),e.sceneLayerItem==null)return I(e.sceneServerUrl.replace("/SceneServer","/FeatureServer"),e);let t=yield q(e);if(!t?.url)throw new c("related-service-not-found","Could not find feature service through portal item relationship");let i=yield I(t.url,e);return i.portalItem=t,i})}function T(r){return o(this,null,function*(){let n=(yield U(r)).serviceItemId;if(!n)return null;let a=new d({id:n,apiKey:r.apiKey}),e=yield b(r);e!=null&&(a.portal=new S({url:e}));try{return a.load({signal:r.signal})}catch(t){return u(t),null}})}function U(r){return o(this,null,function*(){if(r.rootDocument)return r.rootDocument;let n={query:{f:"json",token:r.apiKey},responseType:"json",signal:r.signal};try{let a=yield f(r.sceneServerUrl,n);r.rootDocument=a.data}catch{r.rootDocument={}}return r.rootDocument})}function b(r){return o(this,null,function*(){let n=g?.findServerInfo(r.sceneServerUrl);if(n?.owningSystemUrl)return n.owningSystemUrl;let a=r.sceneServerUrl.replace(/(.*\/rest)\/.*/i,"$1")+"/info";try{let e=(yield f(a,{query:{f:"json"},responseType:"json",signal:r.signal})).data.owningSystemUrl;if(e)return e}catch(e){u(e)}return null})}function I(r,n){return o(this,null,function*(){let a=m(r);if(!a)throw new c("invalid-feature-service-url","Invalid feature service url");let e=a.url.path,t=n.layerId;if(t==null)return{serverUrl:e};let i=U(n),p=s=>{let D={query:{f:"json"},responseType:"json",authMode:s,signal:n.signal};return f(e,D)},j=p("anonymous").catch(()=>p("no-prompt")),[v,A]=yield Promise.all([j,i]),y=A?.layers,l=v.data&&v.data.layers;if(!Array.isArray(l))throw new Error("expected layers array");if(Array.isArray(y)){for(let s=0;s<Math.min(y.length,l.length);s++)if(y[s].id===t)return{serverUrl:e,layerId:l[s].id}}else if(t!=null&&t<l.length)return{serverUrl:e,layerId:l[t].id};throw new Error("could not find matching associated sublayer")})}function q(a){return o(this,arguments,function*({sceneLayerItem:r,signal:n}){if(!r)return null;try{let e=(yield r.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:n})).find(i=>i.type==="Feature Service")||null;if(!e)return null;let t=new d({portal:e.portal,id:e.id});return yield t.load(),t}catch(e){return u(e),null}})}export{C as a};
