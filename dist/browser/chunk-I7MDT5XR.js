import{a as g,b as R}from"./chunk-IGGE7N7W.js";import{b as B,c as V,d as k}from"./chunk-U6PAWXWH.js";import{a as D,b as U,c as z,d as J}from"./chunk-VHQJ2YQX.js";import"./chunk-IL3PPCCF.js";import{d as F}from"./chunk-J43N2ESR.js";import{a as O}from"./chunk-Y4SWPZQY.js";import"./chunk-DUAAYE7V.js";import"./chunk-6EFGHIXX.js";import"./chunk-DZ3DW7ED.js";import"./chunk-HPJ6EQFO.js";import"./chunk-SAOUSUZE.js";import"./chunk-WUM4JBII.js";import{i as C}from"./chunk-7PPV2CP7.js";import"./chunk-EJ3VIBAJ.js";import{G as x}from"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import{b as y}from"./chunk-A52LT7YB.js";import"./chunk-CZPMRK53.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import"./chunk-WMYPRHRR.js";import"./chunk-IAMDMFZ7.js";import"./chunk-53MWZ23O.js";import"./chunk-PT7S6WNL.js";import"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import"./chunk-465DRXTW.js";import{p as w,t as M}from"./chunk-AC62Z3FX.js";import"./chunk-ESDYQQXO.js";function T(c,t,a,o){let{rendererJSON:f,isRGBRenderer:b}=c,n=null,l=null;if(t&&b)n=t;else if(t&&f?.type==="pointCloudUniqueValueRenderer"){l=k.fromJSON(f);let e=l.colorUniqueValueInfos;n=new Uint8Array(3*o);let s=v(l.fieldTransformType);for(let r=0;r<o;r++){let u=(s?s(t[r]):t[r])+"";for(let i=0;i<e.length;i++)if(e[i].values.includes(u)){n[3*r]=e[i].color.r,n[3*r+1]=e[i].color.g,n[3*r+2]=e[i].color.b;break}}}else if(t&&f?.type==="pointCloudStretchRenderer"){l=V.fromJSON(f);let e=l.stops;n=new Uint8Array(3*o);let s=v(l.fieldTransformType);for(let r=0;r<o;r++){let u=s?s(t[r]):t[r],i=e.length-1;if(u<e[0].value)n[3*r]=e[0].color.r,n[3*r+1]=e[0].color.g,n[3*r+2]=e[0].color.b;else if(u>=e[i].value)n[3*r]=e[i].color.r,n[3*r+1]=e[i].color.g,n[3*r+2]=e[i].color.b;else for(let m=1;m<e.length;m++)if(u<e[m].value){let p=(u-e[m-1].value)/(e[m].value-e[m-1].value);n[3*r]=e[m].color.r*p+e[m-1].color.r*(1-p),n[3*r+1]=e[m].color.g*p+e[m-1].color.g*(1-p),n[3*r+2]=e[m].color.b*p+e[m-1].color.b*(1-p);break}}}else if(t&&f?.type==="pointCloudClassBreaksRenderer"){l=B.fromJSON(f);let e=l.colorClassBreakInfos;n=new Uint8Array(3*o);let s=v(l.fieldTransformType);for(let r=0;r<o;r++){let u=s?s(t[r]):t[r];for(let i=0;i<e.length;i++)if(u>=e[i].minValue&&u<=e[i].maxValue){n[3*r]=e[i].color.r,n[3*r+1]=e[i].color.g,n[3*r+2]=e[i].color.b;break}}}else n=new Uint8Array(3*o).fill(255);if(a&&l?.colorModulation){let e=l.colorModulation.minValue,s=l.colorModulation.maxValue,r=.3;for(let u=0;u<o;u++){let i=a[u],m=i>=s?1:i<=e?r:r+(1-r)*(i-e)/(s-e);n[3*u]=m*n[3*u],n[3*u+1]=m*n[3*u+1],n[3*u+2]=m*n[3*u+2]}}return n}function P(c,t){if(c.encoding==null||c.encoding===""){let a=z(t,c);if(a.vertexAttributes.position==null)return;let o=U(t,a.vertexAttributes.position),f=a.header.fields,b=[f.offsetX,f.offsetY,f.offsetZ],n=[f.scaleX,f.scaleY,f.scaleZ],l=o.length/3,e=new Float64Array(3*l);for(let s=0;s<l;s++)e[3*s]=o[3*s]*n[0]+b[0],e[3*s+1]=o[3*s+1]*n[1]+b[1],e[3*s+2]=o[3*s+2]*n[2]+b[2];return e}if(c.encoding==="lepcc-xyz")return D(t).result}function d(c,t,a){return c?.attributeInfo.useElevation?t?G(t,a):null:c?.attributeInfo.storageInfo?J(c.attributeInfo.storageInfo,c.buffer,a):null}function G(c,t){let a=new Float64Array(t);for(let o=0;o<t;o++)a[o]=c[3*o+2];return a}function _(c,t,a,o,f){let b=c.length/3,n=0;for(let l=0;l<b;l++){let e=!0;for(let s=0;s<o.length&&e;s++){let{filterJSON:r}=o[s],u=f[s].values[l];switch(r.type){case"pointCloudValueFilter":{let i=r.mode==="exclude";r.values.includes(u)===i&&(e=!1);break}case"pointCloudBitfieldFilter":{let i=N(r.requiredSetBits),m=N(r.requiredClearBits);(u&i)===i&&!(u&m)||(e=!1);break}case"pointCloudReturnFilter":{let i=15&u,m=u>>>4&15,p=m>1,E=i===1,A=i===m,S=!1;for(let h of r.includedReturns)if(h==="last"&&A||h==="firstOfMany"&&E&&p||h==="lastOfMany"&&A&&p||h==="single"&&!p){S=!0;break}S||(e=!1);break}}}e&&(a[n]=l,c[3*n]=c[3*l],c[3*n+1]=c[3*l+1],c[3*n+2]=c[3*l+2],t[3*n]=t[3*l],t[3*n+1]=t[3*l+1],t[3*n+2]=t[3*l+2],n++)}return n}function v(c){switch(c){default:case null:case"none":return t=>t;case"low-four-bit":return t=>15&t;case"high-four-bit":return t=>(240&t)>>4;case"absolute-value":return t=>Math.abs(t);case"modulo-ten":return t=>t%10}}function N(c){let t=0;for(let a of c||[])t|=1<<a;return t}var I=class{transform(t){let a=this._transform(t),o=[a.points.buffer,a.rgb.buffer];a.pointIdFilterMap!=null&&o.push(a.pointIdFilterMap.buffer);for(let f of a.attributes)"buffer"in f.values&&M(f.values.buffer)&&f.values.buffer!==a.rgb.buffer&&o.push(f.values.buffer);return Promise.resolve({result:a,transferList:o})}_transform(t){let a=P(t.schema,t.geometryBuffer),o=a.length/3,f=null,b=new Array,n=d(t.primaryAttributeData,a,o);t.primaryAttributeData!=null&&n&&b.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:n});let l=d(t.modulationAttributeData,a,o);t.modulationAttributeData!=null&&l&&b.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:l});let e=T(t.rendererInfo,n,l,o);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){let r=t.filterAttributesData.filter(w).map(u=>{let i=d(u,a,o),m={attributeInfo:u.attributeInfo,values:i};return b.push(m),m});f=new Uint32Array(o),o=_(a,e,f,t.filterInfo,r)}for(let r of t.userAttributesData){let u=d(r,a,o);b.push({attributeInfo:r.attributeInfo,values:u})}3*o<e.length&&(e=new Uint8Array(e.buffer.slice(0,3*o))),this._applyElevationOffsetInPlace(a,o,t.elevationOffset);let s=this._transformCoordinates(a,o,t.obb,y.fromJSON(t.inSR),y.fromJSON(t.outSR));return{obb:t.obb,points:s,rgb:e,attributes:b,pointIdFilterMap:f}}_transformCoordinates(t,a,o,f,b){if(!C(t,f,0,t,b,0,a))throw new Error("Can't reproject");let n=R(o.center[0],o.center[1],o.center[2]),l=g(),e=g();F(q,o.quaternion);let s=new Float32Array(3*a);for(let r=0;r<a;r++)l[0]=t[3*r]-n[0],l[1]=t[3*r+1]-n[1],l[2]=t[3*r+2]-n[2],x(e,l,q),o.halfSize[0]=Math.max(o.halfSize[0],Math.abs(e[0])),o.halfSize[1]=Math.max(o.halfSize[1],Math.abs(e[1])),o.halfSize[2]=Math.max(o.halfSize[2],Math.abs(e[2])),s[3*r]=l[0],s[3*r+1]=l[1],s[3*r+2]=l[2];return s}_applyElevationOffsetInPlace(t,a,o){if(o!==0)for(let f=0;f<a;f++)t[3*f+2]+=o}},q=O();function lt(){return new I}export{lt as default};
