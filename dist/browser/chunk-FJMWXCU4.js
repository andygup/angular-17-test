import{q as F}from"./chunk-6GLCEHEN.js";import{a as q}from"./chunk-YFMEPRZQ.js";import{d as x,e as g}from"./chunk-IOMUCP7J.js";import{e as p,f as d}from"./chunk-EKY6QR7N.js";import{a as y}from"./chunk-2UWML3DK.js";import{a as z}from"./chunk-45GFWXQC.js";import{a as I}from"./chunk-VVAIF23J.js";import{a as v}from"./chunk-AQ74ANSJ.js";import{R as _}from"./chunk-CZPMRK53.js";import{z as R}from"./chunk-PT7S6WNL.js";import{a as b,b as S,g as V}from"./chunk-ESDYQQXO.js";function f(h,e){let t=e.length;if(h<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(h<e[i].value){let s=(h-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+s*(e[i].size-e[i-1].size)}return e[t-1].size}var m=class{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=x}getSizeVVFieldStops(e){let t=this._vvSizeFieldStops;if(t)switch(t.type){case"static":return t;case"level-dependent":return t.levels[e]??(()=>{let i=1/0,s=0;for(let r in t.levels){let l=parseFloat(r),u=Math.abs(e-l);u<i&&(i=u,s=l)}if(i===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};let a=2**((e-s)/2),o=t.levels[s],n=new Float32Array(o.values);return n[2]*=a,n[3]*=a,{sizes:o.sizes,values:n}})();default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(e){this._vvInfo!=null&&this._updateVisualVariables(this._vvInfo.vvRanges,e)}setInfo(e,t,i){this._updateEffects(i),this._vvInfo=t,this._technique=g(e),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,e)}getVariation(){return S(b({},this._technique.getVariation(this.rendererSchema)),{outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:y("2d").supportsTextureFloat})}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(e){this.outsideLabelsVisible=e!=null&&e.excludedLabelsVisible}_updateVisualVariables(e,t){let i=this._vvMaterialParameters;if(i.vvOpacityEnabled=!1,i.vvSizeEnabled=!1,i.vvColorEnabled=!1,i.vvRotationEnabled=!1,!e)return;let s=e.size;if(s){if(i.vvSizeEnabled=!0,s.minMaxValue){let r=s.minMaxValue,l,u;if(p(r.minSize)&&p(r.maxSize))if(d(r.minSize)&&d(r.maxSize))l=v(r.minSize),u=v(r.maxSize);else{let c=t.scale;l=v(f(c,r.minSize.stops)),u=v(f(c,r.maxSize.stops))}this.vvSizeMinMaxValue.set([r.minDataValue,r.maxDataValue,l,u])}if(s.scaleStops&&(this.vvSizeScaleStopsValue=v(f(t.scale,s.scaleStops.stops))),s.unitValue){let r=_(t.spatialReference)/I[s.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=r/t.resolution}s.fieldStops&&(this._vvSizeFieldStops=s.fieldStops)}let a=e.color;a&&(i.vvColorEnabled=!0,this.vvColorValues.set(a.values),this.vvColors.set(a.colors));let o=e.opacity;o&&(i.vvOpacityEnabled=!0,this.vvOpacityValues.set(o.values),this.vvOpacities.set(o.opacities));let n=e.rotation;n&&(i.vvRotationEnabled=!0,i.vvRotationType=n.type)}};var w=class extends q{constructor(e){super(e),this._rendererInfo=new m,this._materialItemsRequestQueue=new z,this.attributeView=new F(()=>this.onAttributeStoreUpdate())}destroy(){this.children.forEach(e=>e.destroy()),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(e,t,i){this._rendererInfo.setInfo(e,t,i),this.requestRender()}getMaterialItems(e,t){return V(this,null,function*(){if(!e||e.length===0)return[];let i=R();return this._materialItemsRequestQueue.push({items:e,abortOptions:t,resolver:i}),this.requestRender(),i.promise})}doRender(e){if(e.context.capabilities.enable("textureFloat"),e.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let t=this._materialItemsRequestQueue.pop();for(;t;)this._processMaterialItemRequest(e,t),t=this._materialItemsRequestQueue.pop()}super.doRender(e)}renderChildren(e){for(let t of this.children)t.commit(e);this._rendererInfo.update(e.state),super.renderChildren(e)}createRenderParams(e){let t=super.createRenderParams(e);return t.rendererInfo=this._rendererInfo,t.attributeView=this.attributeView,t}onAttributeStoreUpdate(){}_processMaterialItemRequest(e,{items:t,abortOptions:i,resolver:s}){let{painter:a,pixelRatio:o}=e,n=t.map(r=>a.textureManager.rasterizeItem(r.symbol,o,r.glyphIds,i));Promise.all(n).then(r=>{if(!this.stage)return void s.reject();let l=r.map((u,c)=>({id:t[c].id,mosaicItem:u}));s.resolve(l)},s.reject)}};export{w as a};
