import{b as G}from"./chunk-4Y7EKSO4.js";import{a as xe,b as ve}from"./chunk-XKOINRUM.js";import{b as Se}from"./chunk-IFG5AX52.js";import{a as be,b as we}from"./chunk-3GBPXGQU.js";import{a as T}from"./chunk-CN5O6E6T.js";import{q}from"./chunk-MYELF7MV.js";import{a as ue}from"./chunk-LGGJOMLJ.js";import{a as de}from"./chunk-MXH75ZNY.js";import{a as ye,b as ce,c as fe}from"./chunk-YQRTHGFD.js";import{f as ge}from"./chunk-VDN3XKL2.js";import{b as me}from"./chunk-SVEGZVCP.js";import{a as he}from"./chunk-6MGDEI2H.js";import{a as pe}from"./chunk-QSGARGRB.js";import{b as ne}from"./chunk-QZ4L25WE.js";import{f as ae,g as le}from"./chunk-4ATIL3QV.js";import{c as ee}from"./chunk-CBOFHDSC.js";import{b as Y}from"./chunk-FC3MPJI4.js";import{j as E}from"./chunk-6QIKBCPR.js";import{a as se}from"./chunk-HBTOKQC5.js";import{a as re,b as ie}from"./chunk-A52LT7YB.js";import{R as V,p as oe}from"./chunk-CZPMRK53.js";import{$ as te}from"./chunk-XF4NUYV7.js";import{h as U}from"./chunk-FNDPIYNC.js";import{H as u,K as X}from"./chunk-WMYPRHRR.js";import{R as j,u as K,y as W}from"./chunk-IAMDMFZ7.js";import{a as l}from"./chunk-53MWZ23O.js";import{a as L,y as Z}from"./chunk-PT7S6WNL.js";import{r as Q}from"./chunk-465DRXTW.js";import{a as C,p as z}from"./chunk-AC62Z3FX.js";import{a as R,b as A,g as x}from"./chunk-ESDYQQXO.js";function $(t,e){return e?"xoffset"in e&&e.xoffset?Math.max(t,Math.abs(e.xoffset)):"yoffset"in e&&e.yoffset?Math.max(t,Math.abs(e.yoffset||0)):t:t}function Me(t){let e=0,o=0;for(let i=0;i<t.length;i++){let r=t[i].size;typeof r=="number"&&(e+=r,o++)}return e/o}function Fe(t,e){return typeof t=="number"?t:t?.stops?.length?Me(t.stops):e}function Ve(t,e){if(!e)return t;let o=e.filter(n=>n.type==="size").map(n=>{let{maxSize:a,minSize:m}=n;return(Fe(a,t)+Fe(m,t))/2}),i=0,r=o.length;if(r===0)return t;for(let n=0;n<r;n++)i+=o[n];let s=Math.floor(i/r);return Math.max(s,t)}function J(t){let e=t?.renderer,o=t?.event?.pointerType,i=o==="touch"?9:6;if(!e)return i;let r="visualVariables"in e?Ve(i,e.visualVariables):i;if(e.type==="simple")return $(r,e.symbol);if(e.type==="unique-value"){let s=r;return e.uniqueValueInfos?.forEach(n=>{s=$(s,n.symbol)}),s}if(e.type==="class-breaks"){let s=r;return e.classBreakInfos.forEach(n=>{s=$(s,n.symbol)}),s}return e.type==="dot-density"||e.type,r}function Re(t,e){let{dpi:o,gdbVersion:i,geometry:r,geometryPrecision:s,height:n,layerOption:a,mapExtent:m,maxAllowableOffset:c,returnFieldName:p,returnGeometry:y,returnUnformattedValues:f,returnZ:F,spatialReference:d,timeExtent:S,tolerance:v,width:g}=t.toJSON(),{dynamicLayers:w,layerDefs:P,layerIds:_}=Te(t),I=e?.geometry!=null?e.geometry:null,b={geometryPrecision:s,maxAllowableOffset:c,returnFieldName:p,returnGeometry:y,returnUnformattedValues:f,returnZ:F,tolerance:v},M=I&&I.toJSON()||r;b.imageDisplay=`${g},${n},${o}`,i&&(b.gdbVersion=i),M&&(delete M.spatialReference,b.geometry=JSON.stringify(M),b.geometryType=le(M));let B=d??M?.spatialReference??m?.spatialReference;if(B&&(b.sr=oe(B)),b.time=S?[S.start,S.end].join(","):null,m){let{xmin:Ee,ymin:Ne,xmax:Ie,ymax:je}=m;b.mapExtent=`${Ee},${Ne},${Ie},${je}`}return P&&(b.layerDefs=P),w&&!P&&(b.dynamicLayers=w),b.layers=a==="popup"?"visible":a,_&&!w&&(b.layers+=`:${_.join(",")}`),b}function Te(t){let{mapExtent:e,floors:o,width:i,sublayers:r,layerIds:s,layerOption:n,gdbVersion:a}=t,m=r?.find(d=>d.layer!=null)?.layer?.serviceSublayers,c=n==="popup",p={},y=xe({extent:e,width:i,spatialReference:e?.spatialReference}),f=[],F=d=>{let S=y===0,v=d.minScale===0||y<=d.minScale,g=d.maxScale===0||y>=d.maxScale;if(d.visible&&(S||v&&g))if(d.sublayers)d.sublayers.forEach(F);else{if(s?.includes(d.id)===!1||c&&(!d.popupTemplate||!d.popupEnabled))return;f.unshift(d)}};if(r?.forEach(F),r&&!f.length)p.layerIds=[];else{let d=Se(f,m,a),S=f.map(v=>{let g=G(o,v);return v.toExportImageJSON(g)});if(d)p.dynamicLayers=JSON.stringify(S);else{if(r){let g=f.map(({id:w})=>w);s&&(g=g.filter(w=>s.includes(w))),p.layerIds=g}else s?.length&&(p.layerIds=s);let v=Ge(o,f);if(v!=null&&v.length){let g={};for(let w of v)w.definitionExpression&&(g[w.id]=w.definitionExpression);Object.keys(g).length&&(p.layerDefs=JSON.stringify(g))}}}return p}function Ge(t,e){let o=!!t?.length,i=e.filter(r=>r.definitionExpression!=null||o&&r.floorInfo!=null);return i.length?i.map(r=>{let s=G(t,r),n=me(s,r.definitionExpression);return{id:r.id,definitionExpression:n??void 0}}):null}var D,h=D=class extends U{static from(t){return W(D,t)}constructor(t){super(t),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}};l([u({type:Number,json:{write:!0}})],h.prototype,"dpi",void 0),l([u()],h.prototype,"floors",void 0),l([u({type:String,json:{write:!0}})],h.prototype,"gdbVersion",void 0),l([u({types:pe,json:{read:ae,write:!0}})],h.prototype,"geometry",void 0),l([u({type:Number,json:{write:!0}})],h.prototype,"geometryPrecision",void 0),l([u({type:Number,json:{write:!0}})],h.prototype,"height",void 0),l([u({type:[Number],json:{write:!0}})],h.prototype,"layerIds",void 0),l([u({type:["top","visible","all","popup"],json:{write:!0}})],h.prototype,"layerOption",void 0),l([u({type:E,json:{write:!0}})],h.prototype,"mapExtent",void 0),l([u({type:Number,json:{write:!0}})],h.prototype,"maxAllowableOffset",void 0),l([u({type:Boolean,json:{write:!0}})],h.prototype,"returnFieldName",void 0),l([u({type:Boolean,json:{write:!0}})],h.prototype,"returnGeometry",void 0),l([u({type:Boolean,json:{write:!0}})],h.prototype,"returnM",void 0),l([u({type:Boolean,json:{write:!0}})],h.prototype,"returnUnformattedValues",void 0),l([u({type:Boolean,json:{write:!0}})],h.prototype,"returnZ",void 0),l([u({type:ie,json:{write:!0}})],h.prototype,"spatialReference",void 0),l([u()],h.prototype,"sublayers",void 0),l([u({type:ue,json:{write:!0}})],h.prototype,"timeExtent",void 0),l([u({type:Number,json:{write:!0}})],h.prototype,"tolerance",void 0),l([u({type:Number,json:{write:!0}})],h.prototype,"width",void 0),h=D=l([j("esri.rest.support.IdentifyParameters")],h);var H=h;var O=class extends U{constructor(t){super(t),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(t,e){return T.fromJSON({attributes:R({},e.attributes),geometry:R({},e.geometry)})}writeFeature(t,e){if(!t)return;let{attributes:o,geometry:i}=t;o&&(e.attributes=R({},o)),i!=null&&(e.geometry=i.toJSON(),e.geometryType=ne.toJSON(i.type))}};l([u({type:String,json:{write:!0}})],O.prototype,"displayFieldName",void 0),l([u({type:T})],O.prototype,"feature",void 0),l([se("feature",["attributes","geometry"])],O.prototype,"readFeature",null),l([re("feature")],O.prototype,"writeFeature",null),l([u({type:Number,json:{write:!0}})],O.prototype,"layerId",void 0),l([u({type:String,json:{write:!0}})],O.prototype,"layerName",void 0),O=l([j("esri.rest.support.IdentifyResult")],O);var Oe=O;function Pe(t,e,o){return x(this,null,function*(){let i=(e=Ae(e)).geometry?[e.geometry]:[],r=ce(t);return r.path+="/identify",de(i).then(s=>{let n=Re(e,{geometry:s?.[0]}),a=fe(R(A(R({},r.query),{f:"json"}),n)),m=ye(a,o);return te(r.path,m).then(_e).then(c=>Le(c,e.sublayers))})})}function _e(t){let e=t.data;return e.results=e.results||[],e.exceededTransferLimit=!!e.exceededTransferLimit,e.results=e.results.map(o=>Oe.fromJSON(o)),e}function Ae(t){return t=H.from(t)}function Le(t,e){if(!e?.length)return t;let o=new Map;function i(r){o.set(r.id,r),r.sublayers&&r.sublayers.forEach(i)}e.forEach(i);for(let r of t.results)r.feature.sourceLayer=o.get(r.layerId);return t}var k=null;function ir(t,e){return e.type==="tile"||e.type==="map-image"}var N=class extends X{constructor(t){super(t),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=Z(e=>x(this,null,function*(){this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))}))}initialize(){let t=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([ee(()=>this.highlightGraphics,"change",e=>t(e.added),{onListenerAdd:e=>t(e)})])}fetchPopupFeatures(t,e){return x(this,null,function*(){let{layerView:{layer:o,view:{scale:i}}}=this;if(!t)throw new Q("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:o});let r=Ue(o.sublayers,i,e);if(!r.length)return[];let s=yield He(o,r);if(!((o.capabilities?.operations?.supportsIdentify??!0)&&o.version>=10.5)&&!s)throw new Q("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:o});return s?this._fetchPopupFeaturesUsingQueries(t,r,e):this._fetchPopupFeaturesUsingIdentify(t,r,e)})}clearHighlights(){this.highlightGraphics?.removeAll()}highlight(t){let e=this.highlightGraphics;if(!e)return L();let o=null;if(t instanceof T?o=[t]:Y.isCollection(t)&&t.length>0?o=t.toArray():Array.isArray(t)&&t.length>0&&(o=t),o=o?.filter(z),!o?.length)return L();for(let i of o){let r=i.sourceLayer;r!=null&&"geometryType"in r&&r.geometryType==="point"&&(i.visible=!1)}return e.addMany(o),L(()=>e.removeMany(o??[]))}_updateHighlightedFeaturesSymbols(t){return x(this,null,function*(){let{layerView:{view:e},highlightGraphics:o,highlightGraphicUpdated:i}=this;if(o&&i)for(let r of t){let s=r.sourceLayer&&"renderer"in r.sourceLayer&&r.sourceLayer.renderer;r.sourceLayer&&"geometryType"in r.sourceLayer&&r.sourceLayer.geometryType==="point"&&s&&"getSymbolAsync"in s&&s.getSymbolAsync(r).then(n=>x(this,null,function*(){n||=new q;let a=null,m="visualVariables"in s?s.visualVariables?.find(c=>c.type==="size"):void 0;m&&(k||(k=(yield import("./chunk-FXZLSSDR.js")).getSize),a=k(m,r,{view:e.type,scale:e.scale,shape:n.type==="simple-marker"?n.style:null})),a||="width"in n&&"height"in n&&n.width!=null&&n.height!=null?Math.max(n.width,n.height):"size"in n?n.size:16,o.includes(r)&&(r.symbol=new q({style:"square",size:a,xoffset:"xoffset"in n?n.xoffset:0,yoffset:"yoffset"in n?n.yoffset:0}),i(r,"symbol"),r.visible=!0)}))}})}_updateHighlightedFeaturesGeometries(t){return x(this,null,function*(){let{layerView:{layer:e,view:o},highlightGraphics:i,highlightGraphicUpdated:r}=this;if(this._highlightGeometriesResolution=t,!r||!i?.length||!e.capabilities.operations.supportsQuery)return;let s=this._getTargetResolution(t),n=new Map;for(let c of i)if(!this._featuresResolutions.has(c)||this._featuresResolutions.get(c)>s){let p=c.sourceLayer;K(n,p,()=>new Map).set(c.getObjectId(),c)}let a=Array.from(n,([c,p])=>{let y=c.createQuery();return y.objectIds=[...p.keys()],y.outFields=[c.objectIdField],y.returnGeometry=!0,y.maxAllowableOffset=s,y.outSpatialReference=o.spatialReference,c.queryFeatures(y)}),m=yield Promise.all(a);if(!this.destroyed)for(let{features:c}of m)for(let p of c){let y=p.sourceLayer,f=n.get(y).get(p.getObjectId());f&&i.includes(f)&&(f.geometry=p.geometry,r(f,"geometry"),this._featuresResolutions.set(f,s))}})}_getTargetResolution(t){let e=t*V(this.layerView.view.spatialReference),o=e/16;return o<=10?0:t/e*o}_fetchPopupFeaturesUsingIdentify(t,e,o){return x(this,null,function*(){let i=yield this._createIdentifyParameters(t,e,o);if(i==null)return[];let{results:r}=yield Pe(this.layerView.layer.parsedUrl,i);return r.map(s=>s.feature)})}_createIdentifyParameters(t,e,o){return x(this,null,function*(){let{floors:i,layer:r,timeExtent:s,view:{spatialReference:n,scale:a}}=this.layerView,m=o!=null?o.event:null;if(!e.length)return null;yield Promise.all(e.map(({sublayer:d})=>d.load().catch(()=>{})));let c=Math.min(C("mapservice-popup-identify-max-tolerance"),r.allSublayers.reduce((d,S)=>S.renderer?J({renderer:S.renderer,event:m}):d,2)),p=this.createFetchPopupFeaturesQueryGeometry(t,c),y=ve(a,n),f=Math.round(p.width/y),F=new E({xmin:p.center.x-y*f,ymin:p.center.y-y*f,xmax:p.center.x+y*f,ymax:p.center.y+y*f,spatialReference:p.spatialReference});return new H({floors:i,gdbVersion:"gdbVersion"in r?r.gdbVersion:void 0,geometry:t,height:f,layerOption:"popup",mapExtent:F,returnGeometry:!0,spatialReference:n,sublayers:r.sublayers,timeExtent:s,tolerance:c,width:f})})}_fetchPopupFeaturesUsingQueries(t,e,o){return x(this,null,function*(){let{layerView:{floors:i,timeExtent:r}}=this,s=o!=null?o.event:null,n=e.map(c=>x(this,[c],function*({sublayer:a,popupTemplate:m}){if(yield a.load().catch(()=>{}),a.capabilities&&!a.capabilities.operations.supportsQuery)return[];let p=a.createQuery(),y=J({renderer:a.renderer,event:s}),f=this.createFetchPopupFeaturesQueryGeometry(t,y),F=new Set,[d]=yield Promise.all([be(a,m),a.renderer?.collectRequiredFields(F,a.fieldsIndex)]);ge(F,a.fieldsIndex,d);let S=Array.from(F).sort();if(p.geometry=f,p.outFields=S,p.timeExtent=r,i){let I=i.clone(),b=G(I,a);b!=null&&(p.where=p.where?`(${p.where}) AND (${b})`:b)}let v=this._getTargetResolution(f.width/y),g=yield Je(m),w=a.geometryType==="point"||g&&g.arcadeUtils.hasGeometryOperations(m);w||(p.maxAllowableOffset=v);let{features:P}=yield a.queryFeatures(p),_=w?0:v;P=yield ze(a,P);for(let I of P)this._featuresResolutions.set(I,_);return P}));return(yield Promise.allSettled(n)).reduce((a,m)=>m.status==="fulfilled"?[...a,...m.value]:a,[]).filter(z)})}};function Ue(t,e,o){let i=[];if(!t)return i;let r=s=>{let n=s.minScale===0||e<=s.minScale,a=s.maxScale===0||e>=s.maxScale;if(s.visible&&n&&a){if(s.sublayers)s.sublayers.forEach(r);else if(s.popupEnabled){let m=we(s,A(R({},o),{defaultPopupTemplateEnabled:!1}));m!=null&&i.unshift({sublayer:s,popupTemplate:m})}}};return t.map(r),i}function Je(t){return t.expressionInfos?.length||Array.isArray(t.content)&&t.content.some(e=>e.type==="expression")?he():Promise.resolve()}function He(t,e){return x(this,null,function*(){if(t.capabilities?.operations?.supportsQuery)return!0;try{return yield Promise.any(e.map(({sublayer:o})=>o.load().then(()=>o.capabilities.operations.supportsQuery)))}catch{return!1}})}function ze(t,e){return x(this,null,function*(){let o=t.renderer;return o&&"defaultSymbol"in o&&!o.defaultSymbol&&(e=o.valueExpression?yield Promise.all(e.map(i=>o.getSymbolAsync(i).then(r=>r?i:null))).then(i=>i.filter(r=>r!=null)):e.filter(i=>o.getSymbol(i)!=null)),e})}l([u({constructOnly:!0})],N.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),l([u({constructOnly:!0})],N.prototype,"layerView",void 0),l([u({constructOnly:!0})],N.prototype,"highlightGraphics",void 0),l([u({constructOnly:!0})],N.prototype,"highlightGraphicUpdated",void 0),l([u({constructOnly:!0})],N.prototype,"updatingHandles",void 0),N=l([j("esri.views.layers.support.MapService")],N);function yr(t,e,o,i=new E){let r=0;if(o.type==="2d")r=e*(o.resolution??0);else if(o.type==="3d"){let p=o.overlayPixelSizeInMapUnits(t),y=o.basemapSpatialReference;r=y==null||y.equals(o.spatialReference)?e*p:V(y)/V(o.spatialReference)}let s=t.x-r,n=t.y-r,a=t.x+r,m=t.y+r,{spatialReference:c}=o;return i.xmin=Math.min(s,a),i.ymin=Math.min(n,m),i.xmax=Math.max(s,a),i.ymax=Math.max(n,m),i.spatialReference=c,i}var cr=new E;export{ir as a,N as b,yr as c};
