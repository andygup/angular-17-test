import{s as c}from"./chunk-IAMDMFZ7.js";var m=-3,n;(function(_){_[_.ALL=0]="ALL",_[_.SOME=1]="SOME"})(n||(n={}));var d=class{constructor(s,t,e){this.name=s,this._storage=t,this.id=v+++":",this.size=0,this.maxSize=0,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),e&&(this._storage.registerRemoveFunc(this.id,e),this._removeFunc=!0)}destroy(){this._storage.clear(this),this._removeFunc&&this._storage.deregisterRemoveFunc(this.id),this._storage.deregister(this),this._storage=null}get hitRate(){return this._hit/(this._hit+this._miss)}get sizeAll(){return this._storage.size}resetHitRate(){this._hit=this._miss=0}put(s,t,e,i=0){this._storage.put(this,s,t,e,i)}get(s){let t=this._storage.get(this,s);return t===void 0?++this._miss:++this._hit,t}peek(s){return this._storage.peek(this,s)}pop(s){let t=this._storage.pop(this,s);return t===void 0?++this._miss:++this._hit,t}updateSize(s,t,e){this._storage.updateSize(this,s,t,e)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}},z=class{get size(){return this._size}constructor(s=10485760){this._maxSize=s,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new c,this._users=new c}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(s){this._users.push(s)}deregister(s){this._users.removeUnordered(s)}registerRemoveFunc(s,t){this._removeFuncs.push([s,t])}deregisterRemoveFunc(s){this._removeFuncs.filterInPlace(t=>t[0]!==s)}get maxSize(){return this._maxSize}set maxSize(s){this._maxSize=Math.max(s,0),this._checkSizeLimits()}put(s,t,e,i,o){t=s.id+t;let h=this._db.get(t);if(h&&(this._size-=h.size,s.size-=h.size,this._db.delete(t),h.entry!==e&&this._notifyRemove(t,h.entry,n.ALL)),i>this._maxSize)return void this._notifyRemove(t,e,n.ALL);if(e===void 0)return void console.warn("Refusing to cache undefined entry ");if(!i||i<0)return console.warn(`Refusing to cache entry with size ${i} for key ${t}`),void this._notifyRemove(t,e,n.ALL);let r=1+Math.max(o,m)-m;this._db.set(t,{entry:e,size:i,lifetime:r,lives:r}),this._size+=i,s.size+=i,this._checkSizeLimits()}updateSize(s,t,e,i){t=s.id+t;let o=this._db.get(t);if(o&&o.entry===e){for(this._size-=o.size,s.size-=o.size;i>this._maxSize;){let h=this._notifyRemove(t,e,n.SOME);if(!(h!=null&&h>0))return void this._db.delete(t);i=h}o.size=i,this._size+=i,s.size+=i,this._checkSizeLimits()}}pop(s,t){t=s.id+t;let e=this._db.get(t);if(e)return this._size-=e.size,s.size-=e.size,this._db.delete(t),++this._hit,e.entry;++this._miss}get(s,t){t=s.id+t;let e=this._db.get(t);if(e!==void 0)return this._db.delete(t),e.lives=e.lifetime,this._db.set(t,e),++this._hit,e.entry;++this._miss}peek(s,t){let e=this._db.get(s.id+t);return e?++this._hit:++this._miss,e?.entry}get performanceInfo(){let s={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},e=new Array;this._db.forEach((h,r)=>{let a=h.lifetime;e[a]=(e[a]||0)+h.size,this._users.forAll(l=>{let{id:f,name:u}=l;if(r.startsWith(f)){let g=t[u]||0;t[u]=g+h.size}})});let i={};this._users.forAll(h=>{let r=h.name;if("hitRate"in h&&typeof h.hitRate=="number"&&!isNaN(h.hitRate)&&h.hitRate>0){let a=t[r]||0;t[r]=a,i[r]=Math.round(100*h.hitRate)+"%"}else i[r]="0%"});let o=Object.keys(t);o.sort((h,r)=>t[r]-t[h]),o.forEach(h=>s[h]=Math.round(t[h]/2**20)+"MB / "+i[h]);for(let h=e.length-1;h>=0;--h){let r=e[h];r&&(s["Priority "+(h+m-1)]=Math.round(r/this._size*100)+"%")}return s}resetStats(){this._hit=this._miss=0,this._users.forAll(s=>s.resetHitRate())}clear(s){let t=s.id;this._db.forEach((e,i)=>{i.startsWith(t)&&(this._size-=e.size,this._db.delete(i),this._notifyRemove(i,e.entry,n.ALL))}),s.size=0}clearAll(){this._db.forEach((s,t)=>this._notifyRemove(t,s.entry,n.ALL)),this._users.forEach(s=>s.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(s,t,e){let i;return this._removeFuncs.some(o=>{if(s.startsWith(o[0])){let h=o[1](t,e);return typeof h=="number"&&(i=h),!0}return!1}),i}_checkSizeLimits(){if(this._size>this._maxSize){for(let[s,t]of this._db)if(this._purgeItem(s,t),this._size<=.9*this.maxSize)return}this._users.forEach(s=>{if(s.maxSize>0&&s.size>s.maxSize){for(let[t,e]of this._db)if(t.startsWith(s.id)&&(this._purgeItem(t,e,s),s.size<=.9*s.maxSize))return}})}_purgeItem(s,t,e=this._users.find(i=>s.startsWith(i.id))){if(this._db.delete(s),t.lives<=1){this._size-=t.size,e&&(e.size-=t.size);let i=this._notifyRemove(s,t.entry,n.SOME);i!=null&&i>0&&(this._size+=i,e&&(e.size+=i),t.lives=t.lifetime,t.size=i,this._db.set(s,t))}else--t.lives,this._db.set(s,t)}},v=0;export{d as a,z as b};
