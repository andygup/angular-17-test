import{a as _,c as R}from"./chunk-PZJU7G7R.js";import{a as v}from"./chunk-I7VAY2DR.js";import{a as G}from"./chunk-FQTXYWH5.js";import"./chunk-KLXERNY4.js";import{a as K,b as V}from"./chunk-NERKAOSY.js";import{b as U}from"./chunk-URPONBMS.js";import{a as u,b as f,d as n,g as y}from"./chunk-FBHJEXCM.js";import{k as D}from"./chunk-HI2T2YSZ.js";import"./chunk-O5K35OSE.js";import"./chunk-PQKTT6AH.js";import"./chunk-YQRTHGFD.js";import{d as M,e as k,f as C}from"./chunk-HZP7XBNB.js";import"./chunk-YUZT5LSA.js";import"./chunk-725QQXBM.js";import"./chunk-ZYPPRX53.js";import"./chunk-574KRDZU.js";import"./chunk-JOYABHZZ.js";import{c as L,d as b}from"./chunk-IEXZWAIE.js";import"./chunk-AQ74ANSJ.js";import"./chunk-SAOUSUZE.js";import"./chunk-IXIJFOEL.js";import"./chunk-4ATIL3QV.js";import"./chunk-URUYU25U.js";import"./chunk-3S2DT2SI.js";import"./chunk-7PPV2CP7.js";import"./chunk-U62SHMHB.js";import"./chunk-55ESOXMJ.js";import"./chunk-BCREO4Q5.js";import"./chunk-EJ3VIBAJ.js";import"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import"./chunk-V2KSICSA.js";import{d as w}from"./chunk-CBOFHDSC.js";import"./chunk-HB7BVTLV.js";import"./chunk-WF37UVOV.js";import"./chunk-FC3MPJI4.js";import"./chunk-5ETRXDS4.js";import"./chunk-QDNKD3H5.js";import"./chunk-ARS6KN6E.js";import{a as I}from"./chunk-F72O5PVM.js";import{c as O}from"./chunk-B4PK7RBX.js";import"./chunk-6J4Y65BV.js";import"./chunk-RXHILZH7.js";import"./chunk-6QIKBCPR.js";import{h as T}from"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import{b as P}from"./chunk-A52LT7YB.js";import{n as A}from"./chunk-CZPMRK53.js";import"./chunk-IDSF2RZ6.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import{g,l as S}from"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import"./chunk-WMYPRHRR.js";import"./chunk-IAMDMFZ7.js";import"./chunk-53MWZ23O.js";import"./chunk-PT7S6WNL.js";import"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import{r as p}from"./chunk-465DRXTW.js";import"./chunk-AC62Z3FX.js";import{g as s}from"./chunk-ESDYQQXO.js";var te=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map(a=>a.toLowerCase());function je(a,e,r){return s(this,null,function*(){r??={},oe(a,e),yield w(()=>!e.updatingFromView),yield e.load(),yield H(e),yield R(e),yield j(a,e);let t=e.portalItem,o=g(t.itemUrl),i={origin:"web-map",messages:[],writtenProperties:[],url:o,portal:t.portal||O.getDefault(),portalItem:t,verifyItemRelativeUrls:o?{rootPath:o.path,writtenUrls:[]}:null,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},l=e.write({},i);return yield Promise.all(i.resources.pendingOperations),J(a,i,r),yield q(e,t),yield Oe(a,e,t,l,i),yield Promise.all([e.updateItemThumbnail(),_(e.resourceReferences,i,null)]),t})}function He(a,e,r,t){return s(this,null,function*(){t??={};let o=ie(a,r);yield w(()=>!e.updatingFromView),yield e.load(),yield H(e),yield R(e),yield j(a,e);let i={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:o.portal,portalItem:o,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},l=e.write({},i);yield Promise.all(i.resources.pendingOperations),J(a,i,t),yield pe(e,o);let c=e.getThumbnailState();return(yield We(a,e,o,l,i,t))&&(e.resourceReferences.portalItem=o),e.restoreThumbnailFromState(c),yield Promise.all([e.updateItemThumbnail(),_(e.resourceReferences,i,null)]),o})}function oe(a,e){if(!e.portalItem)throw new p(`${a.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");v(e.portalItem),N(a,e.portalItem)}function N(a,e){if(e.type!==a.itemType)throw new p(`${a.name}:portal-item-wrong-type`,`Portal item needs to have type "${a.itemType}"`)}function j(a,e){return s(this,null,function*(){if(!e.basemap?.baseLayers.length)throw new p(`${a.name}:save`,"Map does not have a valid basemap with a base layer.");let r=null;if(yield w(()=>{let t=C(e.initialViewProperties,e.basemap);return r=t.spatialReference,!t.updating}),!A(r,e.initialViewProperties.spatialReference))throw new p(`${a.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:e.initialViewProperties.spatialReference,actual:r})})}function ie(a,e){let r=I.from(e);return r.id&&(r=r.clone(),r.id=null),r.type||(r.type=a.itemType),r.portal||(r.portal=O.getDefault()),v(r),N(a,r),r}function H(a){let e=[];return a.basemap&&e.push(a.basemap.load()),a.ground&&e.push(a.ground.load()),Promise.allSettled(e).then(()=>{})}function J(a,e,r){let t=(e.messages??[]).filter(o=>o.type==="error").map(o=>new p(o.name,o.message,o.details));if(e.blockedRelativeUrls&&(t=t.concat(e.blockedRelativeUrls.map(o=>new p("url:unsupported",`Relative url '${o}' is not supported in Web Map`)))),r.ignoreUnsupported&&(t=t.filter(o=>o.name!=="layer:unsupported"&&o.name!=="symbol:unsupported"&&o.name!=="symbol-layer:unsupported"&&o.name!=="property:unsupported"&&o.name!=="url:unsupported")),t.length>0)throw new p(`${a.name}:save`,"Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:t})}function q(a,e){return s(this,null,function*(){e.extent=yield ge(a.portalItem,a.initialViewProperties.viewpoint.targetGeometry),yield ce(a,e)})}var ne=y.JSAPI,z="CollectorDisabled",E="Collector",B="Data Editing",Q="OfflineDisabled",$="Offline",X="Workforce Project",Y="Workforce Worker",Z="Workforce Dispatcher",se="Offline Map Areas",le="FieldMapsDisabled",F=y.DEVELOPER_BASEMAP,x="UtilityNetwork";function pe(a,e){return s(this,null,function*(){n(e,z),n(e,le),n(e,y.METADATA),n(e,Q),n(e,se),n(e,Z),n(e,X),n(e,Y),yield q(a,e)})}function ce(a,e){return s(this,null,function*(){u(e,ne),yield ue(a),de(a,e),fe(a,e),we(a,e),ye(a,e),he(a,e),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((r,t,o)=>o.indexOf(r)===t))})}function ue(a){let e=W(a).map(r=>r.load()).toArray();return Promise.allSettled(e).then(()=>{})}function W(a){return a.allLayers.concat(a.allTables)}function ee(a){return W(a).some(e=>e.loaded&&b(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!=="subtype-group"||e.sublayers.some(r=>r.editingEnabled)))}function me(a){return W(a).filter(e=>e.type!=="group").every(e=>e.loaded&&_e(a,e))}function de(a,e){f(e,z)||f(e,X)||f(e,Y)||f(e,Z)||!ee(a)?n(e,E):u(e,E)}function fe(a,e){ee(a)?u(e,B):n(e,B)}function we(a,e){!f(e,Q)&&me(a)?u(e,$):n(e,$)}function ye(a,e){M(a.basemap)?u(e,F):n(e,F)}function he(a,e){a.utilityNetworks?.length?u(e,x):n(e,x)}function ge(a,e){return s(this,null,function*(){let r=e.clone().normalize(),t;if(r.length>1)for(let o of r)t?o.width>t.width&&(t=o):t=o;else t=r[0];return be(a,t)})}function be(a,e){return s(this,null,function*(){let r=e.spatialReference;if(r.isWGS84)return e.clone();if(r.isWebMercator)return T(e);let{getGeometryServiceURL:t}=yield import("./chunk-364UN34Y.js"),o=yield t(a),i=new K;return i.geometries=[e],i.outSpatialReference=P.WGS84,(yield V(o,i))[0]})}function ve(a){return L(a)||a.type==="map-notes"||a.type==="route"}function _e(a,e){return b(e)&&e.capabilities.operations.supportsSync||ve(e)&&!e.portalItem||(e.type==="tile"||e.type==="vector-tile")&&(e.capabilities.operations.supportsExportTiles||Re(e)||k(e))&&e.spatialReference.equals(a.initialViewProperties.spatialReference)}function Re(a){return a.type==="tile"&&D(a.url)&&te.some(e=>a.url?.toLowerCase().includes("/"+e+"/"))}function Oe(a,e,r,t,o){return s(this,null,function*(){yield r.update({data:t}),ae(a,e,r,t,o)})}function We(a,e,r,t,o,i){return s(this,null,function*(){let l=e.portalItem,c={item:l,authenticated:!(!l?.id||!l.portal.user)},m=r.portal;yield m.signIn();let{copyAllowed:d,itemReloaded:h}=yield Se(c,m);if(c.authenticated||=h,!d)throw new p(`${a.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");let re=yield Ae(r,c,t,i);return e.portalItem=r,ae(a,e,r,t,o),re})}function Se(a,e){return s(this,null,function*(){let{item:r,authenticated:t}=a;return r?.id&&r.typeKeywords?.includes("useOnly")?r.portal.portalHostname!==e.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(t||(yield r.reload()),{copyAllowed:r.itemControl==="admin"||r.itemControl==="update",itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}})}function Ae(a,e,r,t){return s(this,null,function*(){let o=a.portal,{item:i}=e,{folder:l,copyAllResources:c}=t,m=!1;if(c&&i?.id&&S(i.portal.url,o.url)&&parseInt(i.portal.currentVersion,10)>=2023){let{total:d}=yield i.fetchResources();m=!!d}if(m){let d=yield i.copy({copyResources:"all",folder:l});a.id=d.id,a.portal=d.portal;let h=a.toJSON();yield a.load(),a.read(h),yield a.update({data:r})}else yield o.user?.addItem({item:a,folder:l,data:r});return m})}function ae(a,e,r,t,o){U.prototype.read.call(e,{version:t.version,authoringApp:t.authoringApp,authoringAppVersion:t.authoringAppVersion},{origin:a.origin,ignoreDefaults:!0,url:r.itemUrl?g(r.itemUrl):void 0}),G(o),e.resourceInfo=t}export{je as save,He as saveAs};
