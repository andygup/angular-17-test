import{a as T}from"./chunk-MCIUWLYC.js";import{a as x}from"./chunk-EEZEB3RB.js";import{o as _}from"./chunk-CZPMRK53.js";function S(g,t){return[g,t]}function C(g,t,o){return g[0]=t,g[1]=o,g}function L(g,t,o,e,l){return g[0]=t,g[1]=o,g[2]=e,g[3]=l,g}var p=new x("0/0/0/0"),z=class g{static create(t,o,e=null){let l=_(t.spatialReference),i=o.origin||S(t.origin.x,t.origin.y),n=S(t.size[0]*o.resolution,t.size[1]*o.resolution),r=S(-1/0,-1/0),s=S(1/0,1/0),a=S(1/0,1/0);e!=null&&(C(r,Math.max(0,Math.floor((e.xmin-i[0])/n[0])),Math.max(0,Math.floor((i[1]-e.ymax)/n[1]))),C(s,Math.max(0,Math.floor((e.xmax-i[0])/n[0])),Math.max(0,Math.floor((i[1]-e.ymin)/n[1]))),C(a,s[0]-r[0]+1,s[1]-r[1]+1));let{cols:h,rows:f}=o,w,F,y,m;return!e&&h&&f&&(C(r,h[0],f[0]),C(s,h[1],f[1]),C(a,h[1]-h[0]+1,f[1]-f[0]+1)),t.isWrappable?(w=S(Math.ceil(Math.round((l.valid[1]-l.valid[0])/o.resolution)/t.size[0]),a[1]),F=S(Math.floor((l.origin[0]-i[0])/n[0]),r[1]),y=S(w[0]+F[0]-1,s[1]),m=!0):(F=r,y=s,w=a,m=!1),new g(o.level,o.resolution,o.scale,i,r,s,a,n,F,y,w,m)}constructor(t,o,e,l,i,n,r,s,a,h,f,w){this.level=t,this.resolution=o,this.scale=e,this.origin=l,this.first=i,this.last=n,this.size=r,this.norm=s,this.worldStart=a,this.worldEnd=h,this.worldSize=f,this.wrap=w}normalizeCol(t){if(!this.wrap)return t;let o=this.worldSize[0];return t<0?o-1-Math.abs((t+1)%o):t%o}denormalizeCol(t,o){return this.wrap?this.worldSize[0]*o+t:t}getWorldForColumn(t){return this.wrap?Math.floor(t/this.worldSize[0]):0}getFirstColumnForWorld(t){return t*this.worldSize[0]+this.first[0]}getLastColumnForWorld(t){return t*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(t){return(t-this.origin[0])/this.norm[0]}getXForColumn(t){return this.origin[0]+t*this.norm[0]}getRowForY(t){return(this.origin[1]-t)/this.norm[1]}getYForRow(t){return this.origin[1]-t*this.norm[1]}getTileBounds(t,o,e=!1){p.set(o);let l=e?p.col:this.denormalizeCol(p.col,p.world),i=p.row;return L(t,this.getXForColumn(l),this.getYForRow(i+1),this.getXForColumn(l+1),this.getYForRow(i)),t}getTileCoords(t,o,e=!1){p.set(o);let l=e?p.col:this.denormalizeCol(p.col,p.world);return Array.isArray(t)?C(t,this.getXForColumn(l),this.getYForRow(p.row)):(t.x=this.getXForColumn(l),t.y=this.getYForRow(p.row)),t}};var B=class{constructor(t,o,e){this.row=t,this.colFrom=o,this.colTo=e}};var c=new x("0/0/0/0"),R=class g{static create(t,o){t[1]>o[1]&&([t,o]=[o,t]);let[e,l]=t,[i,n]=o,r=i-e,s=n-l,a=s!==0?r/s:0,h=(Math.ceil(l)-l)*a,f=(Math.floor(l)-l)*a;return new g(e,Math.floor(l),Math.ceil(n),a,r<0?h:f,r<0?f:h,r<0?i:e,r<0?e:i)}constructor(t,o,e,l,i,n,r,s){this.x=t,this.ymin=o,this.ymax=e,this.invM=l,this.leftAdjust=i,this.rightAdjust=n,this.leftBound=r,this.rightBound=s}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}},M=[[0,0],[0,0],[0,0],[0,0]],X=1e-6,I=class{constructor(t,o=null,e=t.lods[0].level,l=t.lods[t.lods.length-1].level){this.tileInfo=t,this.fullExtent=o,this.scales=[],this._infoByScale={},this._infoByLevel={};let i=t.lods.filter(r=>r.level>=e&&r.level<=l);this.minScale=i[0].scale,this.maxScale=i[i.length-1].scale;let n=this._lodInfos=i.map(r=>z.create(t,r,o));i.forEach((r,s)=>{this._infoByLevel[r.level]=n[s],this._infoByScale[r.scale]=n[s],this.scales[s]=r.scale},this),this._wrap=t.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(t){return this._infoByLevel[typeof t=="number"?t:t.level]}getTileBounds(t,o,e=!1){c.set(o);let l=this._infoByLevel[c.level];return l?l.getTileBounds(t,c,e):t}getTileCoords(t,o,e=!1){c.set(o);let l=this._infoByLevel[c.level];return l?l.getTileCoords(t,c,e):t}getTileCoverage(t,o=192,e=!0,l="closest"){if(!e&&(t.scale>this.minScale||t.scale<this.maxScale))return null;let i=l==="closest"?this.getClosestInfoForScale(t.scale):this.getSmallestInfoForScale(t.scale),n=T.pool.acquire(i),r=this._wrap,s,a,h,f=1/0,w=-1/0,F=n.spans;M[0][0]=M[0][1]=M[1][1]=M[3][0]=-o,M[1][0]=M[2][0]=t.size[0]+o,M[2][1]=M[3][1]=t.size[1]+o;for(let u of M)t.toMap(u,u),u[0]=i.getColumnForX(u[0]),u[1]=i.getRowForY(u[1]);let y=[],m=3;for(let u=0;u<4;u++){if(M[u][1]===M[m][1]){m=u;continue}let d=R.create(M[u],M[m]);f=Math.min(d.ymin,f),w=Math.max(d.ymax,w),y[d.ymin]===void 0&&(y[d.ymin]=[]),y[d.ymin].push(d),m=u}if(f==null||w==null||w-f>100)return null;let v=[];for(s=f;s<w;){y[s]!=null&&(v=v.concat(y[s])),a=1/0,h=-1/0;for(let u=v.length-1;u>=0;u--){let d=v[u];a=Math.min(a,d.getLeftCol()),h=Math.max(h,d.getRightCol())}if(a=Math.floor(a),h=Math.floor(h),s>=i.first[1]&&s<=i.last[1])if(r)if(i.size[0]<i.worldSize[0]){let u=Math.floor(h/i.worldSize[0]);for(let d=Math.floor(a/i.worldSize[0]);d<=u;d++)F.push(new B(s,Math.max(i.getFirstColumnForWorld(d),a),Math.min(i.getLastColumnForWorld(d),h)))}else F.push(new B(s,a,h));else a>i.last[0]||h<i.first[0]||(a=Math.max(a,i.first[0]),h=Math.min(h,i.last[0]),F.push(new B(s,a,h)));s+=1;for(let u=v.length-1;u>=0;u--){let d=v[u];d.ymax>=s?d.incrRow():v.splice(u,1)}}return n}getTileParentId(t){c.set(t);let o=this._infoByLevel[c.level],e=this._lodInfos.indexOf(o)-1;return e<0?null:(this._getTileIdAtLOD(c,this._lodInfos[e],c),c.id)}getTileResolution(t){let o=this._infoByLevel[typeof t=="object"?t.level:t];return o?o.resolution:-1}getTileScale(t){let o=this._infoByLevel[t.level];return o?o.scale:-1}intersects(t,o){c.set(o);let e=this._infoByLevel[c.level],l=t.lodInfo;if(l.resolution>e.resolution){this._getTileIdAtLOD(c,l,c);let n=l.denormalizeCol(c.col,c.world);for(let r of t.spans)if(r.row===c.row&&r.colFrom<=n&&r.colTo>=n)return!0}if(l.resolution<e.resolution){let[n,r,s,a]=t.spans.reduce((m,v)=>(m[0]=Math.min(m[0],v.row),m[1]=Math.max(m[1],v.row),m[2]=Math.min(m[2],v.colFrom),m[3]=Math.max(m[3],v.colTo),m),[1/0,-1/0,1/0,-1/0]),h=e.denormalizeCol(c.col,c.world),f=l.getColumnForX(e.getXForColumn(h)),w=l.getRowForY(e.getYForRow(c.row)),F=l.getColumnForX(e.getXForColumn(h+1))-1,y=l.getRowForY(e.getYForRow(c.row+1))-1;return!(f>a||F<s||w>r||y<n)}let i=l.denormalizeCol(c.col,c.world);return t.spans.some(n=>n.row===c.row&&n.colFrom<=i&&n.colTo>=i)}normalizeBounds(t,o,e){if(t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=o[3],this._wrap){let l=_(this.tileInfo.spatialReference),i=-e*(l.valid[1]-l.valid[0]);t[0]+=i,t[2]+=i}return t}getSmallestInfoForScale(t){let o=this.scales;if(this._infoByScale[t])return this._infoByScale[t];if(t>o[0])return this._infoByScale[o[0]];for(let e=1;e<o.length-1;e++)if(t>o[e]+X)return this._infoByScale[o[e-1]];return this._infoByScale[o[o.length-1]]}getClosestInfoForScale(t){let o=this.scales;return this._infoByScale[t]||(t=o.reduce((e,l)=>Math.abs(l-t)<Math.abs(e-t)?l:e,o[0])),this._infoByScale[t]}scaleToLevel(t){let o=this.scales;if(this._infoByScale[t])return this._infoByScale[t].level;for(let e=o.length-1;e>=0;e--)if(t<o[e])return e===o.length-1?this._infoByScale[o[o.length-1]].level:this._infoByScale[o[e]].level+(o[e]-t)/(o[e]-o[e+1]);return this._infoByScale[o[0]].level}scaleToZoom(t){return this.tileInfo.scaleToZoom(t)}_getTileIdAtLOD(t,o,e){let l=this._infoByLevel[e.level];return t.set(e),o.resolution<l.resolution?null:(o.resolution===l.resolution||(t.level=o.level,t.col=Math.floor(e.col*l.resolution/o.resolution+.01),t.row=Math.floor(e.row*l.resolution/o.resolution+.01)),t)}};export{I as a};
