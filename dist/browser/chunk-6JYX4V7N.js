import{c as S}from"./chunk-V2KSICSA.js";import{a as A}from"./chunk-5ETRXDS4.js";import{R as j}from"./chunk-IAMDMFZ7.js";import{a as V}from"./chunk-53MWZ23O.js";import{z as w}from"./chunk-PT7S6WNL.js";import{b as c}from"./chunk-465DRXTW.js";import{g as E}from"./chunk-ESDYQQXO.js";var T=S(),L=new Map,U=new Map;function N(e,s,r=!1){return E(this,null,function*(){if(!e||!s)return!0;let n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),d=U.get(n)?.entries();if(d){for(let[i,o]of d)if(o.name===s){let a=!o.stack?.hasForwardEdits();if(!a&&r){let[{deleteForwardEdits:u},{default:m}]=yield Promise.all([import("./chunk-HBORGD26.js"),import("./chunk-SP4XSYZY.js")]);return u(n,i,new m({sessionId:T,moment:o.moment}))}return a}}return!0})}function k(e,s){if(!e)return!1;let r=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=U.get(r)?.entries();if(n){for(let[d,i]of n)if(i.name===s)return i.lockType==="edit"}return!1}var g=new A.EventEmitter;function C(e){return g.on("apply-edits",new WeakRef(e))}function W(e){return g.on("update-moment",new WeakRef(e))}function ee(e,s,r=null,n=!1){let d=w();return n=s==null||n,g.emit("apply-edits",{serviceUrl:e,layerId:s,gdbVersion:r,mayReceiveServiceEdits:n,result:d.promise}),d}var x="esri.layers.mixins.EditBusLayer",H=Symbol(x);function te(e){return e!=null&&typeof e=="object"&&H in e}function h(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function F(e,s,r){let n=new URL(e).host,d=L.get(n),i=o=>!o||o===d;return i(s)&&i(r)||s===r}var ie=e=>{var s;let r=class extends e{constructor(...n){super(...n),this[s]=!0,this._applyEditsHandler=d=>{let{serviceUrl:i,layerId:o,gdbVersion:a,mayReceiveServiceEdits:u,result:m}=d,b=i===this.url,p=o!=null&&this.layerId!=null&&o===this.layerId,R=h(this),B=h(this)&&F(i,a,this.gdbVersion);if(!b||R&&!B||!p&&!u)return;let _=m.then(t=>{if(p&&(t.addedFeatures.length||t.updatedFeatures.length||t.deletedFeatures.length||t.addedAttachments.length||t.updatedAttachments.length||t.deletedAttachments.length))return this.emit("edits",c(t)),t;let I=t.editedFeatures?.find(({layerId:f})=>f===this.layerId);if(I){let{adds:f,updates:y,deletes:M}=I.editedFeatures,v={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:f?f.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:M?M.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:y?y.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:c(t.editedFeatures),exceededTransferLimit:!1,historicMoment:c(t.historicMoment)};return this.emit("edits",v),v}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:c(t.editedFeatures),exceededTransferLimit:!1,historicMoment:c(t.historicMoment)}}).then(t=>("historicMoment"in this&&this.historicMoment!==t.historicMoment&&k(i,a)&&(this.historicMoment=t.historicMoment),t));this.emit("apply-edits",{result:_})},this._updateMomentHandler=d=>{let{serviceUrl:i,gdbVersion:o,moment:a}=d,u=i===this.url,m=h(this),b=h(this)&&F(i,o,this.gdbVersion),p=h(this)&&!F(i,this.gdbVersion,null);u&&m&&b&&p&&"historicMoment"in this&&this.historicMoment!==a&&(this.historicMoment=a)},this.when().then(()=>{this.addHandles(C(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(W(this._updateMomentHandler))},()=>{})}};return s=H,r=V([j(x)],r),r};export{T as a,N as b,k as c,C as d,W as e,ee as f,te as g,F as h,ie as i};
