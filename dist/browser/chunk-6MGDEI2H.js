import{b as R}from"./chunk-A52LT7YB.js";import{p as x,r as G}from"./chunk-465DRXTW.js";import{a as b,b as g,g as h}from"./chunk-ESDYQQXO.js";var U=x.getLogger("esri.support.arcadeOnDemand"),w;function M(){return w||(w=(()=>h(this,null,function*(){let t=yield import("./chunk-73JU7LC6.js");return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature}}))()),w}var J=(t,e,s)=>o.create(t,e,s,null,["$feature","$view"],[]),N=(t,e,s)=>o.create(t,e,s,null,["$feature","$view"],[]);var P=(t,e,s,c)=>o.create(t,e,s,c,["$feature","$view"],[]),o=class t{constructor(e,s,c,l,d,n,a){this.services=null,this.script=e,this.evaluate=l;let m=Array.isArray(n)?n:n.fields;this.fields=m,this._syntaxTree=c,this._arcade=s,this._arcadeFeature=d,this._spatialReference=a,this._referencesGeometry=s.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static create(e,s,c,l,d,n){return h(this,null,function*(){let{arcade:a,Feature:m,Dictionary:v}=yield M(),f=R.fromJSON(s),i;try{i=a.parseScript(e,n)}catch(r){return U.error(new G("arcade-bad-expression","Failed to parse arcade script",{script:e,error:r})),null}let $=d.reduce((r,y)=>g(b({},r),{[y]:null}),{}),p=null;l!=null&&(p=new v(l),p.immutable=!0,$.$config=null);let F=a.scriptUsesGeometryEngine(i),A=F&&a.enableGeometrySupport(),D=a.scriptUsesFeatureSet(i)&&a.enableFeatureSetSupport(),_=a.scriptIsAsync(i),S=_&&a.enableAsyncSupport(),E={vars:$,spatialReference:f,useAsync:!!S};yield Promise.all([A,D,S]);let T=new Set;yield a.loadDependentModules(T,i,null,_,F);let u=new v;u.immutable=!1,u.setField("scale",0);let j=a.compileScript(i,E),L=(r,y)=>{let O=r.$view?.timeZone;return"$view"in r&&r.$view&&(u.setField("scale",typeof r.$view=="object"&&"scale"in r.$view?r.$view.scale:void 0),r.$view=u),p&&(r.$config=p),j({vars:r,spatialReference:f,services:y,timeZone:O})};return new t(e,a,i,L,new m,c,f)})}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}};export{M as a,J as b,N as c,P as d,o as e};
