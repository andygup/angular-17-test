import{a as _}from"./chunk-RH6QQ4K6.js";import{a as v}from"./chunk-MCIUWLYC.js";import{a as m}from"./chunk-EEZEB3RB.js";import{a as w}from"./chunk-TJ3KO5EG.js";import{a as b}from"./chunk-55ESOXMJ.js";import{a as g}from"./chunk-5ETRXDS4.js";import{j as x}from"./chunk-6QIKBCPR.js";import{q as p}from"./chunk-WMYPRHRR.js";import{a as f}from"./chunk-AC62Z3FX.js";var h=class c{constructor(e,s){this.key=new m(0,0,0,0),this.bounds=b(),this.objectIds=new Set,this.key.set(s);let t=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=t.resolution,this.scale=t.scale,this.level=t.level}get id(){return this.key.id}get extent(){return x.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){let e=this.key.getChildKeys(),s=p.acquire();for(let t=0;t<e.length;t++)s[t]=new c(this.tileInfoView,e[t]);return s}getQuantizationParameters(){return w.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}};var o={added:[],removed:[]},u=new Set,T=new m(0,0,0,0),I=class extends g{constructor(e){super(),this._tiles=new Map,this._index=_(9,f("esri-csp-restrictions")?s=>({minX:s.bounds[0],minY:s.bounds[1],maxX:s.bounds[2],maxY:s.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=e}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(e){return this._tiles.has(e)}get(e){return this._tiles.get(e)}boundsIntersections(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}updateTiles(e){let s={added:[],removed:[]};for(let t of e.added)if(!this.has(t)){let i=new h(this.tileScheme,t);this._tiles.set(t,i),this._index.insert(i),s.added.push(i)}for(let t of e.removed)if(this.has(t)){let i=this.get(t);this._tiles.delete(t),this._index.remove(i),s.removed.push(i)}this.tiles.length=0,this._tiles.forEach(t=>this.tiles.push(t)),(s.added.length||s.removed.length)&&this.emit("update",s)}setViewState(e){let s=this.tileScheme.getTileCoverage(e,0);if(!s)return;let{spans:t,lodInfo:i}=s,{level:y}=i;if(t.length>0)for(let{row:n,colFrom:r,colTo:S}of t)for(let l=r;l<=S;l++){let d=T.set(y,n,i.normalizeCol(l),i.getWorldForColumn(l)).id;if(u.add(d),!this.has(d)){let a=new h(this.tileScheme,d);this._tiles.set(d,a),this._index.insert(a),this.tiles.push(a),o.added.push(a)}}for(let n=this.tiles.length-1;n>=0;n--){let r=this.tiles[n];u.has(r.id)||(this._tiles.delete(r.id),this.tiles.splice(n,1),this._index.remove(r),o.removed.push(r))}(o.added.length||o.removed.length)&&this.emit("update",o),v.pool.release(s),u.clear(),o.added.length=0,o.removed.length=0}};export{I as a};
