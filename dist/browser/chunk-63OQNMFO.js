import{c as je}from"./chunk-TM5COHS7.js";import"./chunk-IPNDO5RF.js";import"./chunk-FYB33PIO.js";import"./chunk-AC55GQHL.js";import{a as He,b as Ie}from"./chunk-6WWQ4Y2G.js";import"./chunk-6CRNHERM.js";import"./chunk-6GLCEHEN.js";import"./chunk-22K5GEMV.js";import"./chunk-HTQH2YLG.js";import{l as Ge,m as We}from"./chunk-IOMUCP7J.js";import{b as De}from"./chunk-UEH4FZMX.js";import{c as qe}from"./chunk-5ZJSZISC.js";import"./chunk-6XFWNJFJ.js";import"./chunk-WV4GLBNV.js";import{b as Pe,c as F}from"./chunk-FFRWZDQL.js";import"./chunk-X77FZHE2.js";import"./chunk-XKOINRUM.js";import"./chunk-RJDYQPCB.js";import"./chunk-FN72K46S.js";import{a as k}from"./chunk-EVB25YXG.js";import{i as Ae,j as B}from"./chunk-Z7J4BCLI.js";import"./chunk-GMW3QDVG.js";import"./chunk-BYXBJQAS.js";import"./chunk-AKKUUEQK.js";import"./chunk-BSIXRBVK.js";import"./chunk-H2E4J3PF.js";import"./chunk-G7TZLWYD.js";import"./chunk-N77PCW3L.js";import"./chunk-G3LBVS5W.js";import{b as Ce}from"./chunk-IGGE7N7W.js";import"./chunk-HOBRG36Z.js";import"./chunk-ZREXZJBZ.js";import"./chunk-WF6JACCV.js";import"./chunk-ICBFZ75C.js";import"./chunk-UYKZ3CEC.js";import"./chunk-Y5K4QJZR.js";import"./chunk-5WNLDCIP.js";import"./chunk-N3KNLXBG.js";import"./chunk-PLCDSZE2.js";import"./chunk-NTXQ55BD.js";import"./chunk-EKY6QR7N.js";import"./chunk-VK2CQJOC.js";import"./chunk-TTUUVT2M.js";import"./chunk-AUIMNX4Y.js";import"./chunk-N57AFEUK.js";import"./chunk-N7PHAMWX.js";import"./chunk-JV7BL2Y3.js";import"./chunk-VGW7YJZ7.js";import"./chunk-HX3FHHCG.js";import"./chunk-ZOOQQO74.js";import"./chunk-SHAZ7EU7.js";import{b as Me}from"./chunk-NKBP5F7I.js";import"./chunk-EEYJPINK.js";import{h as S}from"./chunk-BZEC7TCW.js";import"./chunk-MBI4IOAA.js";import"./chunk-GIHBFCPM.js";import"./chunk-W5OI4BJ2.js";import{l as _e,r as z}from"./chunk-TKTKGUCU.js";import{a as ge}from"./chunk-DUAAYE7V.js";import"./chunk-DTWRSK4M.js";import"./chunk-G7LWVLCX.js";import"./chunk-M3GEY4SR.js";import"./chunk-7QY3BMVN.js";import"./chunk-4HXOVZYF.js";import"./chunk-U2QVIRVP.js";import"./chunk-VXOK76QV.js";import"./chunk-FYZRIMPP.js";import"./chunk-XFKEXQXK.js";import{n as Oe}from"./chunk-6XBO2ULB.js";import"./chunk-IRJFYPO2.js";import"./chunk-2UWML3DK.js";import{a as Se}from"./chunk-WKOJXXCZ.js";import{a as Q}from"./chunk-MNLP6AEE.js";import"./chunk-ZIQX3XYG.js";import"./chunk-RH6QQ4K6.js";import"./chunk-WSUW6W66.js";import"./chunk-RZU6EEB3.js";import"./chunk-XFFNQH2H.js";import"./chunk-VL6L3PH6.js";import"./chunk-EGQHBYFL.js";import"./chunk-UULYHJV4.js";import"./chunk-LGUXUFJ7.js";import"./chunk-KZREEH45.js";import"./chunk-BGARZEEH.js";import"./chunk-B3I4XIHJ.js";import"./chunk-6EFGHIXX.js";import"./chunk-DZ3DW7ED.js";import"./chunk-3XRT3SNQ.js";import"./chunk-5OGCWDP4.js";import"./chunk-JBJTQF7V.js";import"./chunk-CN5O6E6T.js";import"./chunk-4KJ462UD.js";import"./chunk-HSB35X5B.js";import"./chunk-IFUI4HFB.js";import"./chunk-JOOJSGLF.js";import"./chunk-MYELF7MV.js";import"./chunk-MS3ZOARX.js";import"./chunk-KCKP7FIY.js";import"./chunk-BQABCLW6.js";import"./chunk-HTB4QCFJ.js";import"./chunk-7K4WIBFN.js";import{a as Ve}from"./chunk-Z77VHNI3.js";import{a as Te}from"./chunk-LMIKL5PS.js";import"./chunk-OKLB3DLR.js";import"./chunk-DWZPFSNU.js";import"./chunk-MCIUWLYC.js";import"./chunk-EEZEB3RB.js";import"./chunk-45GFWXQC.js";import"./chunk-AUVYUYNK.js";import"./chunk-PUCLHWWW.js";import"./chunk-DMYB246F.js";import{b as Ee}from"./chunk-YEFC7M4L.js";import"./chunk-C7M5MSEL.js";import"./chunk-HPJ6EQFO.js";import{a as ye}from"./chunk-ZOTIMGGE.js";import{c as ve,g as we,h as xe,i as Re,j as be}from"./chunk-7UQPY7PH.js";import{b as fe}from"./chunk-OHIIU6WS.js";import"./chunk-RCWJNG4Z.js";import"./chunk-VVAIF23J.js";import"./chunk-O5K35OSE.js";import"./chunk-D6LLE2YP.js";import"./chunk-I3S324BU.js";import"./chunk-2UDQ3IWX.js";import{d as ue}from"./chunk-MXH75ZNY.js";import"./chunk-PQKTT6AH.js";import"./chunk-OM24DGCK.js";import"./chunk-YQRTHGFD.js";import"./chunk-EDSVJRYE.js";import"./chunk-TQYOVOJO.js";import"./chunk-QAVDKCSH.js";import"./chunk-H2AOS66Z.js";import"./chunk-VGGNZXSE.js";import"./chunk-CJJRHJ2S.js";import"./chunk-574KRDZU.js";import"./chunk-ZWFVPWKA.js";import"./chunk-JOYABHZZ.js";import"./chunk-IEXZWAIE.js";import"./chunk-VDN3XKL2.js";import"./chunk-SVEGZVCP.js";import{d as de}from"./chunk-AQ74ANSJ.js";import"./chunk-SAOUSUZE.js";import"./chunk-6MGDEI2H.js";import"./chunk-QSGARGRB.js";import"./chunk-SREKDU6P.js";import"./chunk-IXIJFOEL.js";import"./chunk-QZ4L25WE.js";import"./chunk-4ATIL3QV.js";import"./chunk-WUM4JBII.js";import"./chunk-URUYU25U.js";import"./chunk-3S2DT2SI.js";import"./chunk-7PPV2CP7.js";import"./chunk-U62SHMHB.js";import{a as ce}from"./chunk-55ESOXMJ.js";import"./chunk-BCREO4Q5.js";import{c as _}from"./chunk-EJ3VIBAJ.js";import"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import{a as C,b as ae,c as U,g as y}from"./chunk-CBOFHDSC.js";import"./chunk-HB7BVTLV.js";import"./chunk-WZKL6OPG.js";import"./chunk-WF37UVOV.js";import"./chunk-UZQ577CU.js";import{b as ne}from"./chunk-FC3MPJI4.js";import"./chunk-5ETRXDS4.js";import"./chunk-QDNKD3H5.js";import"./chunk-B4PK7RBX.js";import"./chunk-6J4Y65BV.js";import"./chunk-RXHILZH7.js";import"./chunk-URPCXPAW.js";import"./chunk-KBFIYTBH.js";import"./chunk-PEPXQ7N3.js";import"./chunk-VU5W7W6Y.js";import{d as le,f as pe,j as he}from"./chunk-6QIKBCPR.js";import"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import"./chunk-A52LT7YB.js";import{o as me}from"./chunk-CZPMRK53.js";import"./chunk-IDSF2RZ6.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import{H as L}from"./chunk-WMYPRHRR.js";import{R as oe,u as se}from"./chunk-IAMDMFZ7.js";import{a as V}from"./chunk-53MWZ23O.js";import{e as re,p as ie}from"./chunk-PT7S6WNL.js";import{c as I}from"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import{p as E,r as te}from"./chunk-465DRXTW.js";import"./chunk-AC62Z3FX.js";import{a as $,b as ee,g as T}from"./chunk-ESDYQQXO.js";var g=ge(),ke={none:S.None,loop:S.Loop,oscillate:S.Oscillate};function Fe(r){return r?ee($({},r),{playAnimation:r.playing,repeatType:r.repeatType?ke[r.repeatType]:void 0}):{}}var A=class extends De{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.perspectiveTransform=ye(),this._playHandle=null,this._vertices=new Float32Array(20),this._handles=[],this._handles.push(C(()=>this.elementView.element.opacity,t=>this.opacity=t,y),C(()=>[this.elementView.coords],()=>{this.requestRender()},y),C(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._playHandle?.remove(),this.texture=I(this.texture),this.requestRender()},y),ae(()=>this.elementView.element.loaded,()=>{let t=this.elementView.element;this.ready(),t.type==="video"&&t.content!=null&&this._handles.push(re(t.content,"play",()=>this.requestRender()))},y)),e.element.load().catch(t=>{E.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new te("element-load-error","Element cannot be displayed",{element:e,error:t}))})}destroy(){this._playHandle?.remove(),this._handles.forEach(e=>e.remove()),this.texture=I(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){let{context:t}=e,i=this.elementView.element.content;if(i!=null){let n=i instanceof HTMLImageElement,o=i instanceof HTMLVideoElement,s=n?i.naturalWidth:o?i.videoWidth:i.width,l=n?i.naturalHeight:o?i.videoHeight:i.height;if(this._updatePerspectiveTransform(s,l),this.texture)o&&!i.paused&&(this.texture.setData(i),this.requestRender(),(t.type===Q.WEBGL2||_(s)&&_(l))&&this.texture.generateMipmap());else{let p=new Ae;if(p.wrapMode=_e.CLAMP_TO_EDGE,p.preMultiplyAlpha=!0,p.width=s,p.height=l,"getFrame"in i){let m=a=>{this.texture?this.texture.setData(a):this.texture=new B(t,p,a),this.requestRender()};"animationOptions"in this.elementView.element&&(this._playHandle=je(i,Fe(this.elementView.element.animationOptions),null,m))}else this.texture=new B(t,p,i);(t.type===Q.WEBGL2||_(s)&&_(l))&&this.texture.generateMipmap(),o&&!i.paused&&this.requestRender()}}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){let i=this.elementView.coords;if(i==null)return;let[n,o,s,l]=i.rings[0],p=this._vertices,{x:m,y:a}=e,d=t!==0;d?p.set([o[0]-m,o[1]-a,n[0]-m,n[1]-a,s[0]-m,s[1]-a,l[0]-m,l[1]-a,l[0]-m,l[1]-a,o[0]+t-m,o[1]-a,o[0]+t-m,o[1]-a,n[0]+t-m,n[1]-a,s[0]+t-m,s[1]-a,l[0]+t-m,l[1]-a]):p.set([o[0]-m,o[1]-a,n[0]-m,n[1]-a,s[0]-m,s[1]-a,l[0]-m,l[1]-a]),this.isWrapAround=d}getVAO(e,t,i){if(this.elementView.coords==null)return null;let n=this._vertices;if(this._vao)this._geometryVbo.setData(n);else{this._geometryVbo=k.createVertex(e,z.DYNAMIC_DRAW,n);let o=k.createVertex(e,z.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new qe(e,i,t,{geometry:this._geometryVbo,tex:o})}return this._vao}_updatePerspectiveTransform(e,t){let i=this._vertices;Pe(g,[0,0,e,0,0,t,e,t],[i[0],i[1],i[4],i[5],i[2],i[3],i[6],i[7]]),fe(this.perspectiveTransform,g[6]/g[8]*e,g[7]/g[8]*t)}};var P=class extends We{constructor(){super(...arguments),this._localOrigin=de(0,0),this._viewStateId=-1,this._dvsMat3=Se()}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(let t of this.children)t.beforeRender(e)}prepareRenderPasses(e){let t=e.registerRenderPass({name:"overlay",brushes:[Ge.overlay],target:()=>this.children,drawPhase:Me.MAP});return[...super.prepareRenderPasses(e),t]}_updateMatrices(e){let{state:t}=e,{id:i,size:n,pixelRatio:o,resolution:s,rotation:l,viewpoint:p,displayMat3:m}=t;if(this._viewStateId===i)return;let a=Math.PI/180*l,d=o*n[0],f=o*n[1],{x:O,y:x}=p.targetGeometry,q=ue(O,t.spatialReference);this._localOrigin.x=q,this._localOrigin.y=x;let D=s*d,R=s*f,h=ve(this._dvsMat3);we(h,h,m),xe(h,h,Ee(d/2,f/2)),be(h,h,Ce(d/D,-f/R,1)),Re(h,h,-a),this._viewStateId=i}_updateOverlays(e,t){let{state:i}=e,{rotation:n,spatialReference:o,worldScreenWidth:s,size:l,viewpoint:p}=i,m=this._localOrigin,a=0,d=me(o);if(d&&o.isWrappable){let f=l[0],O=l[1],x=180/Math.PI*n,q=Math.abs(Math.cos(x)),D=Math.abs(Math.sin(x)),R=Math.round(f*q+O*D),[h,G]=d.valid,u=Oe(o),{x:X,y:Ue}=p.targetGeometry,ze=[X,Ue],j=[0,0];i.toScreen(j,ze);let b=[0,0],W;W=R>s?.5*s:.5*R;let Y=Math.floor((X+.5*u)/u),Qe=h+Y*u,Be=G+Y*u,H=[j[0]+W,0];i.toMap(b,H),b[0]>Be&&(a=u),H[0]=j[0]-W,i.toMap(b,H),b[0]<Qe&&(a=-u);for(let M of t){let J=M.elementView.bounds;if(J==null)continue;let[K,,Z]=J;K<h&&Z>h?M.updateDrawCoords(m,u):Z>G&&K<G?M.updateDrawCoords(m,-u):M.updateDrawCoords(m,a)}}else for(let f of t)f.updateDrawCoords(m,a)}};var w=class extends He(Ie){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new ne}attach(){this.addAttachHandles([U(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(r=>this._updateTile(r)),this.requestUpdate()}),U(()=>this.layer.effectiveSource,"change",({element:r})=>this._elementUpdateHandler(r))]),this._overlayContainer=new P,this.container.addChild(this._overlayContainer),this._fetchQueue=new Te({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(r,e)=>this._queryElements(r,e)}),this._tileStrategy=new Ve({cachePolicy:"purge",resampling:!0,acquireTile:r=>this._acquireTile(r),releaseTile:r=>this._releaseTile(r),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(r){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(r){this._tileStrategy.update(r),this._debugGraphicsView?.update(r)}hitTest(r,e){return T(this,null,function*(){let t=[],i=r.normalize(),n=[i.x,i.y];for(let{projectedElement:{normalizedCoords:o,element:s}}of this._elementReferences.values())o!=null&&le(o.rings,n)&&t.push({type:"media",element:s,layer:this.layer,mapPoint:r,sourcePoint:s.toSource(r)});return t.reverse()})}canResume(){return this.layer.source!=null&&super.canResume()}doRefresh(){return T(this,null,function*(){this._fetchQueue.reset(),this._tileStrategy.refresh(r=>this._updateTile(r))})}_acquireTile(r){let e=new N(r.clone());return this._updateTile(e),e}_updateTile(r){this._updatingHandles.addPromise(this._fetchQueue.push(r.key).then(e=>{let[t,i]=r.setElements(e);this._referenceElements(r,t),this._dereferenceElements(r,i),this.requestUpdate()},e=>{ie(e)||E.getLogger(this).error(e)}))}_releaseTile(r){this._fetchQueue.abort(r.key.id),r.elements&&this._dereferenceElements(r,r.elements),this.requestUpdate()}_queryElements(r,e){return T(this,null,function*(){let t=this.layer.effectiveSource;if(t==null)return[];this.view.featuresTilingScheme.getTileBounds(c,r,!0);let i=new he({xmin:c[0],ymin:c[1],xmax:c[2],ymax:c[3],spatialReference:this.view.spatialReference});return t.queryElements(i,e)})}_referenceElements(r,e){if(this.layer.source!=null)for(let t of e)this._referenceElement(r,t)}_referenceElement(r,e){se(this._elementReferences,e.uid,()=>{let t=new F({element:e,spatialReference:this.view.spatialReference}),i=new A(t);return this._overlayContainer.addChild(i),this.elements.add(e),{tiles:new Set,projectedElement:t,overlay:i,debugGraphic:null}}).tiles.add(r)}_dereferenceElements(r,e){for(let t of e)this._dereferenceElement(r,t)}_dereferenceElement(r,e){let t=this._elementReferences.get(e.uid);t.tiles.delete(r),t.tiles.size||(this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),this._debugGraphicsView?.graphics.remove(t.debugGraphic))}_elementUpdateHandler(r){let e=this._elementReferences.get(r.uid);if(e){let i=e.projectedElement.normalizedCoords;if(i==null)return this._overlayContainer.removeChild(e.overlay),e.overlay.destroy(),e.projectedElement.destroy(),this._elementReferences.delete(r.uid),this.elements.remove(r),void this._debugGraphicsView?.graphics.remove(e.debugGraphic);let n=[],o=[];for(let s of this._tileStrategy.tiles){let l=Le(this.view.featuresTilingScheme,s,i);e.tiles.has(s)?l||o.push(s):l&&n.push(s)}for(let s of n)this._referenceElement(s,r);for(let s of o)this._dereferenceElement(s,r);return e=this._elementReferences.get(r.uid),void(e?.debugGraphic&&(e.debugGraphic.geometry=e.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:e.debugGraphic,property:"geometry"})))}let t=new F({element:r,spatialReference:this.view.spatialReference}).normalizedCoords;if(t!=null)for(let i of this._tileStrategy.tiles)Le(this.view.featuresTilingScheme,i,t)&&this._referenceElement(i,r)}};V([L()],w.prototype,"layer",void 0),V([L({readOnly:!0})],w.prototype,"elements",void 0),w=V([oe("esri.views.2d.layers.MediaLayerView2D")],w);var c=ce(),v={xmin:0,ymin:0,xmax:0,ymax:0};function Le(r,e,t){return r.getTileBounds(c,e.key,!0),v.xmin=c[0],v.ymin=c[1],v.xmax=c[2],v.ymax=c[3],pe(v,t)}var N=class{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){let t=[],i=new Set(this.elements);this.elements=e;for(let n of e)i.has(n)?i.delete(n):t.push(n);return this.isReady=!0,[t,Array.from(i)]}destroy(){}},wi=w;export{wi as default};
