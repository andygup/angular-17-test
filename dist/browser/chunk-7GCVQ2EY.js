import{a as St}from"./chunk-HBDWL3B4.js";import{a as Ct}from"./chunk-2ZJ3WQRV.js";import{a as Et,b as Ft}from"./chunk-6WWQ4Y2G.js";import{a as gt}from"./chunk-6CRNHERM.js";import{a as Rt}from"./chunk-FJMWXCU4.js";import{a as mt,b as _t,c as bt,d as Fe,l as vt,m as wt,o as xt}from"./chunk-6GLCEHEN.js";import{l as b}from"./chunk-IOMUCP7J.js";import{a as Ee}from"./chunk-UEH4FZMX.js";import{c as yt}from"./chunk-5ZJSZISC.js";import{a as Se}from"./chunk-4Y7EKSO4.js";import{a as re}from"./chunk-EVB25YXG.js";import{a as ft,b as te}from"./chunk-3GBPXGQU.js";import{d as nt}from"./chunk-G7TZLWYD.js";import{a as be}from"./chunk-G3LBVS5W.js";import{p as _e}from"./chunk-EKY6QR7N.js";import{a as Ke,b as W}from"./chunk-NKBP5F7I.js";import{F as je}from"./chunk-GIHBFCPM.js";import{r as me}from"./chunk-TKTKGUCU.js";import{a as pt}from"./chunk-2UWML3DK.js";import{a as X,b as Ze}from"./chunk-YH5YGPKQ.js";import{b as et,c as tt,d as rt,e as it,f as st}from"./chunk-WSUW6W66.js";import{b as at}from"./chunk-WHNNLNN4.js";import{k as ct}from"./chunk-QB3NROF7.js";import{a as z}from"./chunk-YEFTRNE3.js";import{a as T}from"./chunk-JBJTQF7V.js";import{a as D}from"./chunk-CN5O6E6T.js";import{a as We}from"./chunk-DWZPFSNU.js";import{a as Ye}from"./chunk-MCIUWLYC.js";import{a as ge}from"./chunk-EEZEB3RB.js";import{a as Xe}from"./chunk-PUCLHWWW.js";import{c as B}from"./chunk-TJ3KO5EG.js";import{a as Qe}from"./chunk-VVAIF23J.js";import{d as Je,f as $e}from"./chunk-ZWFVPWKA.js";import{f as Y}from"./chunk-IEXZWAIE.js";import{G as dt,e as ve,f as Z,g as ee,h as we,k as lt,l as ut,m as xe,n as ht,r as Re}from"./chunk-VDN3XKL2.js";import{a as Ge}from"./chunk-AQ74ANSJ.js";import{a as ot}from"./chunk-6MGDEI2H.js";import{a as He}from"./chunk-55ESOXMJ.js";import{b as ye}from"./chunk-EJ3VIBAJ.js";import{a as L,c as pe,g as Be,h as K}from"./chunk-CBOFHDSC.js";import{b as Le}from"./chunk-FC3MPJI4.js";import{b as Me}from"./chunk-RXHILZH7.js";import{j as Ne}from"./chunk-6QIKBCPR.js";import{a as ze}from"./chunk-HBTOKQC5.js";import{b as De}from"./chunk-A52LT7YB.js";import{H as c,K as P}from"./chunk-WMYPRHRR.js";import{R as _}from"./chunk-IAMDMFZ7.js";import{a as h}from"./chunk-53MWZ23O.js";import{a as fe,l as Oe,p as k,q as R,y as Pe,z as j}from"./chunk-PT7S6WNL.js";import{a as ke,b as U,d as Ae}from"./chunk-XDTDVCGP.js";import{b as Ue,p as V,r as I}from"./chunk-465DRXTW.js";import{a as m,p as qe}from"./chunk-AC62Z3FX.js";import{a as S,b as E,g as l}from"./chunk-ESDYQQXO.js";var ie=class extends D{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;let e=this.sourceLayer?.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};h([c({type:Boolean})],ie.prototype,"isAggregate",void 0),ie=h([_("esri.AggregateGraphic")],ie);var N=ie;var w=class extends P{constructor(t){super(t),this._filter=null,this.duration=m("mapview-transitions-duration"),this._excludedEffectView=new Ee(t),this._includedEffectView=new Ee(t)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(t){this._get("featureEffect")!==t&&this._transitionTo(t)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(t){this._set("scale",t),this._excludedEffectView.scale=t,this._includedEffectView.scale=t}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(t,e){this._set("scale",e),this.transitioning?(this._includedEffectView.transitionStep(t,e),this._excludedEffectView.transitionStep(t,e),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=e,this._includedEffectView.scale=e)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(t){let e=this._get("featureEffect"),r=t,i=r?.includedEffect,s=r?.excludedEffect,n=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=i,this._excludedEffectView.effect=s,this._set("featureEffect",r),this._filter=r?.filter||e?.filter||null,n||this.endTransitions()}};h([c()],w.prototype,"_filter",void 0),h([c()],w.prototype,"_excludedEffectView",void 0),h([c()],w.prototype,"_includedEffectView",void 0),h([c()],w.prototype,"duration",void 0),h([c()],w.prototype,"excludedEffects",null),h([c()],w.prototype,"featureEffect",null),h([c()],w.prototype,"filter",null),h([c()],w.prototype,"hasEffects",null),h([c()],w.prototype,"includedEffects",null),h([c({value:0})],w.prototype,"scale",null),h([c()],w.prototype,"transitioning",null),w=h([_("esri.layers.effects.FeatureEffectView")],w);var Vt=w;var H=class extends z{constructor(){super(...arguments),this.features=[]}readFeatures(t,e){let r=De.fromJSON(e.spatialReference),i=[];for(let s=0;s<t.length;s++){let n=t[s],a=N.fromJSON(n),o=n.geometry?.spatialReference;a.geometry==null||o||(a.geometry.spatialReference=r);let u=n.aggregateGeometries,d=a.aggregateGeometries;if(u&&d!=null)for(let p in d){let y=d[p],f=u[p],g=f?.spatialReference;y==null||g||(y.spatialReference=r)}i.push(a)}return i}};h([c({type:[N],json:{write:!0}})],H.prototype,"features",void 0),h([ze("features")],H.prototype,"readFeatures",null),H=h([_("esri.rest.support.AggregateFeatureSet")],H);var It=H;var A=class extends P{constructor(t){super(t),this.tiles=new Map}destroy(){this.tiles.clear(),this.layer=this.layerView=this.tileInfoView=this.tiles=null}get updating(){return this.isUpdating()}acquireTile(t){let e=this.createTile(t);return e.once("isReady",()=>this.notifyChange("updating")),this.tiles.set(t.id,e),this.notifyChange("updating"),e}forceAttributeTextureUpload(){}forEachTile(t){this.tiles.forEach(t)}releaseTile(t){this.tiles.delete(t.key.id),this.notifyChange("updating"),this.disposeTile(t)}isUpdating(){let t=!0;this.tiles.forEach(r=>{t=t&&r.isReady});let e=!t;if(m("esri-2d-log-updating")){let r="";this.tiles.forEach(i=>{let s=i.updateStatus;r+=`-> ${i.key.id}: isReady: ${i.isReady} status: ${s}
`,t=t&&i.isReady}),console.log(`Updating BaseTileRenderer ${e}
${r}`)}return e}setHighlight(){}invalidateLabels(){}requestUpdate(){this.layerView.requestUpdate()}};h([c()],A.prototype,"layer",void 0),h([c()],A.prototype,"layerView",void 0),h([c()],A.prototype,"tileInfoView",void 0),h([c()],A.prototype,"updating",null),A=h([_("esri.views.2d.layers.features.tileRenderers.BaseTileRenderer")],A);var se=A;var ne=class{constructor(){this.gradient=null,this.height=512,this.intensities=null,this.width=512}render(e){$e(e,512,this.intensities,this.gradient,this.minDensity,this.maxDensity)}};var ae=class extends se{constructor(t){super(t),this._intensityInfo={minDensity:0,maxDensity:0},this.type="heatmap",this.featuresView={attributeView:{initialize:()=>{},requestUpdate:()=>{}},requestRender:()=>{}},this._container=new St(t.tileInfoView)}createTile(t){let e=this._container.createTile(t);return this.tileInfoView.getTileCoords(e.bitmap,t),e.bitmap.resolution=this.tileInfoView.getTileResolution(t),e}onConfigUpdate(){let t=this.layer.renderer;if(t.type==="heatmap"){let{minDensity:e,maxDensity:r,colorStops:i}=t;this._intensityInfo.minDensity=e,this._intensityInfo.maxDensity=r,this._gradient=Je(i),this.tiles.forEach(s=>{let n=s.bitmap.source;n&&(n.minDensity=e,n.maxDensity=r,n.gradient=this._gradient,s.bitmap.invalidateTexture(),s.bitmap.requestRender())})}}hitTest(){return Promise.resolve([])}install(t){t.addChild(this._container)}uninstall(t){this._container.removeAllChildren(),t.removeChild(this._container)}disposeTile(t){this._container.removeChild(t),t.destroy()}supportsRenderer(t){return t&&t.type==="heatmap"}onTileData(t){let e=this.tiles.get(t.tileKey);if(!e)return;let r=t.intensityInfo,{minDensity:i,maxDensity:s}=this._intensityInfo,n=e.bitmap.source||new ne;n.intensities=r?.matrix||null,n.minDensity=i,n.maxDensity=s,n.gradient=this._gradient,e.bitmap.source=n,this._container.addChild(e),this._container.requestRender(),this.requestUpdate()}onTileError(t){console.error(t)}lockGPUUploads(){}unlockGPUUploads(){}fetchResource(t,e){return console.error(t),Promise.reject()}};ae=h([_("esri.views.2d.layers.features.tileRenderers.HeatmapTileRenderer")],ae);var oe=class t{constructor(e){this._savedCursor=null,this._savedOffset=null,this._head=e,this._cursor=e}static from(e){let r=Ce.from(new Float32Array(e));return new t(r)}get id(){return this._cursor.id}get baseZoom(){return this._cursor.baseZoom}get anchorX(){return this._cursor.anchorX}get anchorY(){return this._cursor.anchorY}get directionX(){return this._cursor.directionX}get directionY(){return this._cursor.directionY}get size(){return this._cursor.size}get materialKey(){return this._cursor.materialKey}get boundsCount(){return this._cursor.boundsCount}computedMinZoom(){return this._cursor.computedMinZoom()}setComputedMinZoom(e){return this._cursor.setComputedMinZoom(e)}boundsComputedAnchorX(e){return this._cursor.boundsComputedAnchorX(e)}boundsComputedAnchorY(e){return this._cursor.boundsComputedAnchorY(e)}setBoundsComputedAnchorX(e,r){return this._cursor.setBoundsComputedAnchorX(e,r)}setBoundsComputedAnchorY(e,r){return this._cursor.setBoundsComputedAnchorY(e,r)}boundsX(e){return this._cursor.boundsX(e)}boundsY(e){return this._cursor.boundsY(e)}boundsWidth(e){return this._cursor.boundsWidth(e)}boundsHeight(e){return this._cursor.boundsHeight(e)}link(e){if(e._head!=null)return this._cursor.link(e._head)}getCursor(){return this.copy()}copy(){let e=new t(this._head?.copy());if(!e._head)return e;let r=e._head,i=e._head._link;for(;i;)r._link=i.copy(),r=i,i=r._link;return e}peekId(){return this._cursor.peekId()??this._cursor._link.peekId()}nextId(){let e=this.id;for(;e===this.id;)if(!this.next())return!1;return!0}save(){this._savedCursor=this._cursor,this._savedOffset=this._cursor._offset}restore(){this._savedCursor&&(this._cursor=this._savedCursor),this._savedOffset!=null&&(this._cursor._offset=this._savedOffset)}next(){if(!this._cursor)return!1;if(!this._cursor.next()){if(!this._cursor._link)return!1;this._cursor=this._cursor._link,this._cursor._offset=0}return!0}lookup(e){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(e);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}delete(e){let r=this._head,i=null;for(;r;){if(r.delete(e))return r.isEmpty()&&i!=null&&(i._link=r._link),!0;i=r,r=r._link}return!1}},Ce=class t{constructor(e){this._offset=-1,this._link=null,this._count=0,this._deletedCount=0,this._offsets={instance:null},this._buffer=e}static from(e){return new t(new Float32Array(e))}isEmpty(){return this._deletedCount===this.count}get count(){return this._count||(this._count=this._computeCount()),this._count}get id(){return this._buffer[this._offset]}set id(e){this._buffer[this._offset]=e}get baseZoom(){return this._buffer[this._offset+1]}get anchorX(){return this._buffer[this._offset+2]}get anchorY(){return this._buffer[this._offset+3]}get directionX(){return this._buffer[this._offset+4]}get directionY(){return this._buffer[this._offset+5]}get size(){return this._buffer[this._offset+6]}get materialKey(){return this._buffer[this._offset+7]}computedMinZoom(){return this._buffer[this._offset+8]}setComputedMinZoom(e){this._buffer[this._offset+8]=e}get boundsCount(){return this._buffer[this._offset+9]}boundsComputedAnchorX(e){return this._buffer[this._offset+10+e*6]}boundsComputedAnchorY(e){return this._buffer[this._offset+10+e*6+1]}setBoundsComputedAnchorX(e,r){this._buffer[this._offset+10+e*6]=r}setBoundsComputedAnchorY(e,r){this._buffer[this._offset+10+e*6+1]=r}boundsX(e){return this._buffer[this._offset+10+e*6+2]}boundsY(e){return this._buffer[this._offset+10+e*6+3]}boundsWidth(e){return this._buffer[this._offset+10+e*6+4]}boundsHeight(e){return this._buffer[this._offset+10+e*6+5]}link(e){let r=this;for(;r._link;)r=r._link;r._link=e}getCursor(){return this.copy()}copy(){let e=new t(this._buffer);return e._link=this._link,e._offset=this._offset,e._deletedCount=this._deletedCount,e._offsets=this._offsets,e._count=this._count,e}peekId(){let e=this._offset+10+this.boundsCount*6+0;return e>=this._buffer.length?0:this._buffer[e]}next(){let e=0;for(;this._offset<this._buffer.length&&e++<100&&(this._offset===-1?this._offset=0:this._offset+=10+this.boundsCount*6,this.id===4294967296););return this.id!==4294967296&&this._offset<this._buffer.length}delete(e){let r=this._offset,i=this.lookup(e);if(i)for(this.id=4294967295,++this._deletedCount;this.next()&&this.id===e;)this.id=4294967295,++this._deletedCount;return this._offset=r,i}lookup(e){let r=this._offset;if(this._offsets.instance==null){this._offsets.instance=new Map;let i=this.copy();i._offset=-1;let s=0;for(;i.next();)i.id!==s&&(this._offsets.instance.set(i.id,i._offset),s=i.id)}return!!this._offsets.instance.has(e)&&(this._offset=this._offsets.instance.get(e),this.id!==4294967296||(this._offset=r,!1))}_computeCount(){let e=this._offset,r=0;for(this._offset=-1;this.next();)r++;return this._offset=e,r}};var zt=1.25,Tt=32767,Nt=Tt<<16|Tt,G=class{constructor(e,r,i,s){let n=gt.create(r*i*Uint32Array.BYTES_PER_ELEMENT,s);this.size=r,this.strideInt=i,this.bufferType=e,this.dirty={start:1/0,end:0},this._gpu=null,this._cpu=n,this.clear()}get elementSize(){return this._cpu.length/this.strideInt}get invalidated(){return this.bufferSize>0&&!this._gpu}get invalidatedComputeBuffer(){return this.bufferSize>0&&!this._gpuComputeTriangles}invalidate(){this._invalidateTriangleBuffer(),this._gpu?.dispose(),this._gpu=null}_invalidateTriangleBuffer(){this._gpuComputeTriangles?.dispose(),this._gpuComputeTriangles=null}destroy(){this._gpu?.dispose(),this._gpuComputeTriangles?.dispose(),this._cpu?.destroy(),this._cpu2?.destroy()}clear(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new mt({start:0,end:this._cpu.length/this.strideInt}),this.fillPointer=0}ensure(e){if(!(this.maxAvailableSpace()>=e)&&e*this.strideInt>this._cpu.length-this.fillPointer){this.invalidate();let r=this._cpu.length/this.strideInt,i=Math.round((r+e)*zt),s=i*this.strideInt;this._cpu.expand(s*Uint32Array.BYTES_PER_ELEMENT),this.freeList.free(r,i-r)}}set(e,r){this._cpu.array[e]!==r&&(this._cpu.array[e]=r,this.dirty.start=Math.min(e,this.dirty.start),this.dirty.end=Math.max(e,this.dirty.end))}getGPUBuffer(e,r=!1){if(!this.bufferSize)return null;if(r){if(this.bufferType!=="index")throw new Error("Tired to get triangle buffer, but target is not an index buffer");return this._gpuComputeTriangles==null&&(this._gpuComputeTriangles=this._createComputeBuffer(e)),this._gpuComputeTriangles}return this._gpu==null&&(this._gpu=this._createBuffer(e)),this._gpu}getCPUBuffer(){if(!this._cpu2){let e=this._cpu.slice();this._cpu2=e}return this._cpu2.length!==this._cpu.length&&this._cpu2.expand(this._cpu.length*this._cpu.array.BYTES_PER_ELEMENT),this._cpu2.set(this._cpu),this._cpu2}get bufferSize(){return this._cpu.length/this.strideInt}maxAvailableSpace(){return this.freeList.maxAvailableSpace()}insert(e,r,i,s){let n=i*this.strideInt;if(!n)return 0;let a=r*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,o=new Uint32Array(e,a,n),u=this.freeList.firstFit(i);ke(u,"First fit region must be defined");let d=u*this.strideInt,p=n,y=d/this.strideInt-r;if(s!==0)for(let f=0;f<o.length;f++)o[f]+=s;return this._cpu.array.set(o,d),this.dirty.start=Math.min(this.dirty.start,d),this.dirty.end=Math.max(this.dirty.end,d+p),this.fillPointer=Math.max(this.fillPointer,d+p),y}free(e,r,i){let s=e*this.strideInt,n=(e+r)*this.strideInt;if(i===!0)for(let a=e;a!==e+r;a++)this._cpu.array[a*this.strideInt]=Nt;this.dirty.start=Math.min(this.dirty.start,s),this.dirty.end=Math.max(this.dirty.end,n),this.freeList.free(e,r)}upload(){if(this.dirty.end){if(this._invalidateTriangleBuffer(),this._gpu==null)return this.dirty.start=1/0,void(this.dirty.end=0);this._gpu.setSubData(this._cpu.array,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}}_createBuffer(e){let r=me.DYNAMIC_DRAW;return this.bufferType==="index"?re.createIndex(e,r,this._cpu.array):re.createVertex(e,r,this._cpu.array)}_createComputeBuffer(e){let r=me.DYNAMIC_DRAW,i=new Uint32Array(this.fillPointer/3);for(let s=0;s<this.fillPointer;s+=3)i[s/3]=this._cpu.array[s];return re.createIndex(e,r,i)}};var Ht=0,Gt=1,le=class{constructor(e,r){this._vaos=new Map,this._indicesInvalid=!1,this.geometryType=e,this._stage=r}destroy(){for(let[e,r]of this._vaos)r?.disposeVAOOnly();this._indexBuffer=U(this._indexBuffer),this._vertexBuffer=U(this._vertexBuffer)}get records(){return this._records}insert(e,r,i){if(!e.records.byteLength)return;let s=e.stride;if(this._vertexBuffer&&this._indexBuffer){let n=e.indices.byteLength/4,a=e.vertices.byteLength/s;this._indexBuffer.ensure(n),this._vertexBuffer.ensure(a);let{vertices:o,indices:u}=e,d=Fe.from(e.records),p=this._vertexBuffer.insert(o,0,o.byteLength/s,0),y=this._indexBuffer.insert(u,0,u.byteLength/4,p);if(d.forEach(f=>{f.indexFrom+=y,f.vertexFrom+=p}),this._records.link(d),r)this._indicesInvalid=!0;else if(this._displayList){let f=d.getCursor();for(;f.next();)this._displayList.addRecord(f)}}else{let n=e.indices.byteLength/4,a=e.vertices.byteLength/s,o=s/Uint32Array.BYTES_PER_ELEMENT,u=this._stage.bufferPool;this._records=Fe.from(e.records),this._indexBuffer=new G("index",n,1,u),this._vertexBuffer=new G("vertex",a,o,u),this._indexBuffer.insert(e.indices,0,e.indices.byteLength/4,0),this._vertexBuffer.insert(e.vertices,0,e.vertices.byteLength/s,0),r&&(this._indicesInvalid=!0)}}remove(e){if(this._records!=null)for(let r of e){let i=this._records.getCursor();if(!i.lookup(r))continue;let s=i.indexFrom,n=i.vertexFrom,a=i.indexCount,o=i.vertexCount;for(;i.next()&&i.id===r;)a+=i.indexCount,o+=i.vertexCount;this._indexBuffer.free(s,a),this._vertexBuffer.free(n,o,!0),this._records.delete(r)}}getVAO(e,r,i,s){if(!this._vertexBuffer||!this._indexBuffer||this._records==null||!this._vertexBuffer.bufferSize)return null;let n=s?Gt:Ht,a=this._vaos.get(n);(this._vertexBuffer.invalidated||this._indexBuffer.invalidated||s&&this._indexBuffer.invalidatedComputeBuffer)&&(a?.disposeVAOOnly(),a=null),this._vertexBuffer.upload(),this._indexBuffer.upload();let o=this._indexBuffer.getGPUBuffer(e,n===1),u=this._vertexBuffer.getGPUBuffer(e);return a||(a=new yt(e,i,r,{geometry:u},o),this._vaos.set(n,a)),a}forEachCommand(e){if(this._records!=null){if(this._sortIndices(this._records),!this._displayList){let r=this._cursorIndexOrder;this._displayList=bt.from(this,this.geometryType,this._records.getCursor(),r)}this._displayList.forEach(e)}}_sortIndices(e){let r=!!this._indexBuffer.bufferSize;if(!this._indicesInvalid)return;this._indicesInvalid=!1;let i=0,s=e.getCursor(),n=[],a=[],o=[];for(;s.next();)a.push(s.index),o.push(s.sortKey),n.push(s.id);a.sort((p,y)=>{let f=o[y],g=o[p];return g===f?n[y]-n[p]:f-g});let u=e.getCursor(),d=r?this._indexBuffer.getCPUBuffer():this._vertexBuffer.getCPUBuffer();for(let p of a){if(!u.seekIndex(p))throw new Error("Expected to find index");if(r){let{indexFrom:y,indexCount:f}=u;u.indexFrom=i;for(let g=0;g<f;g++)this._indexBuffer.set(i++,d.array[y+g])}else{let{vertexFrom:y,vertexCount:f}=u,g=this._vertexBuffer.strideInt,x=y*g,C=x+f*g;u.vertexFrom=i/g;for(let q=x;q<C;q++)this._vertexBuffer.set(i++,d.array[q])}}this._cursorIndexOrder=a,this._displayList=null}};var Jt=50,$t=4,qt=100,Qt=0,ue=class extends _t{constructor(e,r,i,s,n,a){super(e,r,i,s),this.instanceId=Qt++,this.patchCount=0,this._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1},this._patches=new be(qt),this._bufferPatches=new be(qt),this._lastCommitTime=0,this.transforms.labelMat2d=Xe(),this._store=n,this._requestLabelUpdate=a}destroy(){super.destroy(),this._renderState.current.geometry.forEach(e=>e.destroy()),this._renderState.next!=null&&this._renderState.next.geometry.forEach(e=>e.destroy()),this._renderState.current=null,this._renderState.next=null}get labelMetrics(){return this._renderState.current.metrics}get hasData(){return!!this._renderState.current.geometry.size}get updateStatus(){return`renderState:${!!this._renderState.current}, ${!!this._renderState.next}, hasData:${this.hasData}, queue:${this._patches.size}`}getGeometry(e){return this._renderState.current.geometry.get(e)}patch(e,r){this.patchCount++,e.clear&&this._patches.size>=Jt&&this._dropPatches();let i=e,s=i.addOrUpdate&&this.key.id!==i.addOrUpdate.tileKeyOrigin;r&&s?this._bufferPatches.enqueue(i):(i.sort=i.sort&&!r,this._patches.enqueue(i)),this.requestRender()}commit(e){if(this._lastCommitTime!==e.time){this._lastCommitTime=e.time;for(let r=0;r<$t;r++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}}lock(){this._renderState.locked=!0}unlock(){this._renderState.locked=!1,this._flushUpdates(),this._swap()}_swapRenderStates(){if(this._renderState.next){if(this._renderState.locked)return this._renderState.swap=!0,void this.requestRender();this._renderState.swap=!0,this._swap()}}_swap(){this._renderState.swap&&(this._renderState.swap=!1,this._renderState.next!=null&&(this._renderState.current.geometry.forEach(e=>e.destroy()),this._renderState.current=this._renderState.next,this._renderState.next=null,this._requestLabelUpdate()))}_flushUpdates(){let e=this._patches.maxSize;for(;this._patches.size&&e--;)this._updateMesh(),this._swap()}_updateBufferMesh(){let e=this._bufferPatches.peek();if(e==null||!e.clear||this._renderState.next===null)for(;this._bufferPatches.size;){let r=this._bufferPatches.dequeue();r!=null&&this._patchBuffer(r)}}_updateMesh(){let e=this._patches.dequeue();if(e!=null){if(m("esri-2d-update-debug")){let r=e,i=r.addOrUpdate?.tileKeyOrigin,s=this.key.id===i?"SELF":i,n="";for(let a=0;a<5;a++)n+=r.addOrUpdate?.data[a]?.records?.byteLength?1:0;console.debug(this.key.id,"FeatureTile:patch",`[clear: ${r.clear} origin: ${s}, end:${r.end} data:${n}]`)}e.clear===!0&&(this._renderState.next!=null&&(this._renderState.next.geometry.forEach(r=>r.destroy()),this._renderState.next=null),this._renderState.next={geometry:new Map,metrics:null},m("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Creating new renderState")),this.requestRender(),this._patch(e),e.end&&(m("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Encountered end message"),this.ready(),this._swapRenderStates())}}_patch(e){_e(r=>{this._remove(r,e.remove),this._insert(r,e,!1)})}_patchBuffer(e){_e(r=>{this._insert(r,e,!0)})}_insert(e,r,i){try{let s=this._renderState.next??this._renderState.current,n=r.addOrUpdate?.data[e],a=s.geometry;if(n==null)return;a.has(e)||(m("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Creating geometry buffer ${e}`),a.set(e,new le(e,this.stage))),m("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Inserting into ${e}, version=${r.addOrUpdate?.version} stride=${n.stride}`),a.get(e).insert(n,r.sort,i),e===Ke.LABEL&&this._insertLabelMetrics(r.type,n.metrics,r.clear)}catch{}}_insertLabelMetrics(e,r,i){let s=this._renderState.next??this._renderState.current;if(r==null)return;let n=oe.from(r);if(s.metrics!=null){if(e==="update"){let a=n.getCursor();for(;a.next();)s.metrics.delete(a.id)}s.metrics.link(n)}else s.metrics=n}_remove(e,r){let i=(this._renderState.next??this._renderState.current).geometry.get(e);r&&r.length&&i&&(i.remove(r),this._removeLabelMetrics(r))}_removeLabelMetrics(e){let{metrics:r}=this._renderState.next??this._renderState.current;if(r!=null&&e.length)for(let i of e)for(;r.delete(i););}_dropPatches(){let e=new Array,r=!1;for(;this._patches.size;){let i=this._patches.dequeue();if(i==null)break;if(i.clear){if(r)break;r=!0}e.push(i)}this._patches.clear(),e.forEach(i=>this._patches.enqueue(i))}};var jt=m("featurelayer-order-by-server-enabled"),he=class extends Rt{constructor(e,r,i,s){super(e),this._hitTestsRequests=[],this._layer=i,this._layerView=r,this._onUpdate=s}renderChildren(e){this.attributeView.update(),this.hasAnimation&&e.painter.effects.integrate.draw(e,e.attributeView),super.renderChildren(e)}hasEmptyAttributeView(){return this.attributeView.isEmpty()}isUpdating(){return this.attributeView.isUpdating()}hitTest(e){let r=this._hitTestsRequests.find(({x:s,y:n})=>s===e.x&&n===e.y),i=j();return r?r.resolvers.push(i):(r={x:e.x,y:e.y,resolvers:[i]},this._hitTestsRequests.push(r)),this.requestRender(),i.promise}onTileData(e,r){let i=jt&&"orderBy"in this._layer&&this._layer.orderBy,s=i&&i?.length&&!i[0].valueExpression&&i[0].field,n=!!i&&this._layerView.orderByFields===s;e.patch(r,n),this.contains(e)||this.addChild(e),this.requestRender()}onTileError(e){this.contains(e)||this.addChild(e)}updateTransitionProperties(e,r){super.updateTransitionProperties(e,r),this._layerView.featureEffectView.transitionStep(e,r),this._layerView.featureEffectView.transitioning&&this.requestRender()}doRender(e){let{minScale:r,maxScale:i}=this._layer.effectiveScaleRange,s=e.state.scale;s<=(r||1/0)&&s>=i&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}onAttributeStoreUpdate(){this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._onUpdate()}get hasAnimation(){return this.hasLabels}setStencilReference(e){let{rendererSchema:r}=e.rendererInfo;if(r?.type==="dot-density"&&r?.dotSize>1||r?.type==="heatmap")for(let s of this.children)s.stencilRef=s.key.level+1;else super.setStencilReference(e)}get hasHighlight(){return this._layerView.hasHighlight()}get hasLabels(){if("sublayers"in this._layer)return this._layer.sublayers.some(i=>!!i.labelingInfo?.length&&i.labelsVisible);let e=this._layer.featureReduction,r=e&&"labelingInfo"in e&&e.labelsVisible&&e.labelingInfo&&e.labelingInfo.length;return this._layer.labelingInfo?.length&&this._layer.labelsVisible||!!r}prepareRenderPasses(e){let r=super.prepareRenderPasses(e),i=e.registerRenderPass({name:"label",brushes:[b.label],target:()=>this.hasLabels?this.children:null,drawPhase:W.LABEL|W.LABEL_ALPHA});if(m("featurelayer-force-marker-text-draw-order")){let n=e.registerRenderPass({name:"geometry",brushes:[b.fill,b.dotDensity,b.line,b.heatmap,b.pieChart],target:()=>this.children,forceDrawByDisplayOrder:!0,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:e.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:e.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:e.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]});r.push(n)}else{let n=e.registerRenderPass({name:"geometry",brushes:[b.fill,b.dotDensity,b.line,b.marker,b.heatmap,b.pieChart,b.text],target:()=>this.children,enableDefaultDraw:()=>!this._layerView.featureEffectView.hasEffects,effects:[{apply:e.effects.outsideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.excludedEffects},{apply:e.effects.insideEffect,enable:()=>this._layerView.featureEffectView.hasEffects,args:()=>this._layerView.featureEffectView.includedEffects},{apply:e.effects.hittest,enable:()=>!!this._hitTestsRequests.length,args:()=>this._hitTestsRequests}]});r.push(n)}let s=e.registerRenderPass({name:"highlight",brushes:[b.fill,b.dotDensity,b.line,b.marker,b.pieChart,b.text],target:()=>this.children,drawPhase:W.HIGHLIGHT,enableDefaultDraw:()=>!1,effects:[{apply:e.effects.highlight,enable:()=>!!this._layerView.hasHighlight()}]});return r.push(s),r.push(i),r}};var de=class extends se{constructor(){super(...arguments),this.type="symbol"}install(t){let e=()=>this.notifyChange("updating"),r=new he(this.tileInfoView,this.layerView,this.layer,e);this.featuresView=r,t.addChild(r)}uninstall(t){t.removeChild(this.featuresView),this.featuresView=U(this.featuresView)}fetchResource(t,e){let{url:r}=t,i=this.featuresView.stage;try{return i.resourceManager.fetchResource(r,{signal:e.signal})}catch(s){return k(s)?Promise.resolve({width:0,height:0}):Promise.reject(s)}}isUpdating(){let t=super.isUpdating(),e=!this.featuresView||this.featuresView.isUpdating(),r=this.featuresView?.hasEmptyAttributeView(),i=t||e||t&&r;return m("esri-2d-log-updating")&&console.log(`Updating SymbolTileRenderer ${i}
  -> updatingTiles ${t}
  -> hasFeaturesView ${!!this.featuresView}
  -> updatingFeaturesView ${e}`),i}hitTest(t){return this.featuresView.hitTest(t)}supportsRenderer(t){return t!=null&&["simple","class-breaks","unique-value","dot-density","dictionary","heatmap","pie-chart"].includes(t.type)}onConfigUpdate(t){let e=null;if(t&&"visualVariables"in t){let r=(vt(t).visualVariables||[]).map(i=>{let s=i.clone();return"normalizationField"in i&&(s.normalizationField=null),i.valueExpression&&i.valueExpression!=="$view.scale"&&(s.valueExpression=null,s.field="nop"),s});e=nt(r)}this.featuresView.setRendererInfo(t,e,this.layerView.featureEffect)}onTileData(t){let e=this.tiles.get(t.tileKey);e&&t.data&&this.featuresView.onTileData(e,t.data),this.layerView.view.labelManager.requestUpdate()}onTileError(t){let e=this.tiles.get(t.tileKey);e&&this.featuresView.onTileError(e)}forceAttributeTextureUpload(){this.featuresView.attributeView.forceTextureUpload()}lockGPUUploads(){this.featuresView.attributeView.lockTextureUpload(),this.tiles.forEach(t=>t.lock())}unlockGPUUploads(){this.featuresView.attributeView.unlockTextureUpload(),this.tiles.forEach(t=>t.unlock())}getMaterialItems(t){return l(this,null,function*(){return this.featuresView.getMaterialItems(t)})}invalidateLabels(){this.featuresView.hasLabels&&this.layerView.view.labelManager.requestUpdate()}createTile(t){let e=this.tileInfoView.getTileBounds(He(),t),r=()=>this.layerView.view.labelManager.requestUpdate(),i=this.tileInfoView.getTileResolution(t.level),s=this.featuresView.attributeView;return new ue(t,i,e[0],e[3],s,r)}disposeTile(t){this.featuresView.removeChild(t),t.destroy(),this.layerView.view.labelManager.requestUpdate()}};de=h([_("esri.views.2d.layers.features.tileRenderers.SymbolTileRenderer")],de);function Ut(t,e){if(!t)return null;switch(t.type){case"symbol":return new de(e);case"heatmap":return new ae(e)}}function Ve(t){return t.some(e=>e.globalId)}function J(t){return t.filter(e=>!e.error).map(e=>e.objectId??e.globalId).filter(e=>e!=null)}function kt(t,e){let r=new Set(t);for(let i of e.values())r.add(i);return r}function At(t,e){let r=new Set(t);for(let i of e.values())r.delete(i);return r}var $=class extends P{constructor(t){super(t),this._hasGlobalIds=!1,this._notifyUpdating=()=>{this.notifyChange("updating")}}normalizeCtorArgs(t){return this._queueProcessor=new We({concurrency:1,process:t.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(t){let e=this._queueProcessor,r=e.last();switch(t.type){case"update":case"refresh":if(r?.type===t.type)return;e.push(t).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":{let i=r?.type==="processed-edit"?r:null;i&&e.popLast();let s=this._mergeEdits(i,t);for(let n of s)n&&e.push(n).then(this._notifyUpdating,this._notifyUpdating);break}}this.notifyChange("updating")}_mergeEdits(t,e){let{addedFeatures:r,deletedFeatures:i,updatedFeatures:s}=e.edits;if(this._hasGlobalIds=this._hasGlobalIds||Ve(r)||Ve(s)||Ve(i),this._hasGlobalIds)return[t,{type:"processed-edit",edits:{addOrModified:[...r,...s],removed:i}}];let n=new Set(J(t?.edits.addOrModified??[])),a=new Set(J(t?.edits.removed??[])),o=new Set([...J(r),...J(s)]),u=new Set(J(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(kt(At(n,u),o)).map(d=>({objectId:d})),removed:Array.from(kt(At(a,o),u)).map(d=>({objectId:d}))}}]}};h([c({readOnly:!0})],$.prototype,"updating",null),h([c()],$.prototype,"process",void 0),$=h([_("esri.views.2d.layers.support.FeatureCommandQueue")],$);var Ot=$;function Kt(t){return Array.isArray(t)}var M=class extends Me{constructor(t){super(t),this._startupResolver=j(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(t){this.client.tileRenderer=t}get closed(){return this._connection.closed}startup(t,e,r,i){return l(this,null,function*(){yield this.when();let s=this._controller.signal,n=Kt(r.source)?{transferList:r.source,signal:s}:void 0,a={service:r,config:e,tileInfo:t.tileInfo.toJSON(),tiles:i};yield this._connection.invoke("startup",a,n),this._startupResolver.resolve(),this._set("isReady",!0)})}updateTiles(t){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("updateTiles",t))})}update(t){return l(this,null,function*(){let e={config:t};return yield this._startupResolver.promise,this._connection.invoke("update",e)})}applyUpdate(t){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("applyUpdate",t)})}setHighlight(t){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.setHighlight",t))})}stop(){return l(this,null,function*(){if(yield this._startupResolver.promise,!this.closed)return R(this._connection.invoke("stop"))})}refresh(t){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.refresh",t))})}querySummaryStatistics(t,e,r){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:e},r)})}queryAggregateSummaryStatistics(t,e,r){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryAggregateSummaryStatistics",{query:t.toJSON(),params:e},r)})}queryUniqueValues(t,e,r){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:e},r)})}queryAggregateUniqueValues(t,e,r){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryAggregateUniqueValues",{query:t.toJSON(),params:e},r)})}queryClassBreaks(t,e,r){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:e},r)})}queryAggregateClassBreaks(t,e,r){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryAggregateClassBreaks",{query:t.toJSON(),params:e},r)})}queryHistogram(t,e,r){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryHistogram",{query:t.toJSON(),params:e},r)})}queryAggregateHistogram(t,e,r){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryAggregateHistogram",{query:t.toJSON(),params:e},r)})}queryFeatures(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryFeatures",t?.toJSON(),e)})}queryVisibleFeatures(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryVisibleFeatures",t?.toJSON(),e)})}queryObjectIds(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryObjectIds",t?.toJSON(),e)})}queryFeatureCount(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryFeatureCount",t?.toJSON(),e)})}queryExtent(t,e){return l(this,null,function*(){return this._connection.invoke("controller.queryExtent",t.toJSON(),e)})}queryLatestObservations(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryLatestObservations",t.toJSON(),e)})}queryStatistics(t){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryStatistics",t)})}queryAggregates(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryAggregates",t?.toJSON(),e)})}queryAggregateCount(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryAggregateCount",t?.toJSON(),e)})}queryAggregateIds(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.queryAggregateIds",t?.toJSON(),e)})}getObjectId(t){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.getObjectId",t)})}getDisplayId(t){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.getDisplayId",t)})}getFeatures(t){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.getFeatures",t)})}getAggregates(){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.getAggregates")})}getAggregateValueRanges(){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.getAggregateValueRanges")})}mapValidDisplayIds(t){return l(this,null,function*(){return yield this._startupResolver.promise,this._connection.invoke("controller.mapValidDisplayIds",t)})}onEdits(t){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.onEdits",t))})}enableEvent(t,e){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.enableEvent",{name:t,value:e}))})}pauseStream(){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.pauseStream"))})}resumeStream(){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.resumeStream"))})}sendMessageToSocket(t){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.sendMessageToSocket",t))})}sendMessageToClient(t){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.sendMessageToClient",t))})}updateCustomParameters(t){return l(this,null,function*(){return yield this._startupResolver.promise,R(this._connection.invoke("controller.updateCustomParameters",t))})}_startWorker(t){return l(this,null,function*(){try{this._connection=yield at("Pipeline",{client:this.client,strategy:"dedicated",signal:t})}catch(e){Oe(e)}})}};h([c()],M.prototype,"isReady",void 0),h([c({constructOnly:!0})],M.prototype,"client",void 0),h([c()],M.prototype,"tileRenderer",null),M=h([_("esri.views.2d.layers.support.FeatureLayerProxy")],M);var Pt=M;var Yt=Math.PI;function Ie(t,e){switch(e.transformationType){case T.Additive:return Wt(t,e);case T.Constant:return Xt(e,t);case T.ClampedLinear:return Zt(t,e);case T.Proportional:return er(t,e);case T.Stops:return tr(t,e);case T.RealWorldSize:return rr(t,e);case T.Identity:return t;case T.Unknown:return null}}function F(t,e){return typeof t=="number"?t:Ie(e,t)}function Wt(t,e){return t+(F(e.minSize,t)||e.minDataValue)}function Xt(t,e){let r=t.stops,i=r?.length&&r[0].size;return i==null&&(i=t.minSize),F(i,e)}function Zt(t,e){let r=e.minDataValue,i=e.maxDataValue,s=(t-r)/(i-r),n=F(e.minSize,t),a=F(e.maxSize,t);return t<=r?n:t>=i?a:n+s*(a-n)}function er(t,e){let r=t/e.minDataValue,i=F(e.minSize,t),s=F(e.maxSize,t),n=null;return n=r*i,ye(n,i,s)}function tr(t,e){let[r,i,s]=ir(t,e.cache.ipData);if(r===i)return F(e.stops[r].size,t);{let n=F(e.stops[r].size,t);return n+(F(e.stops[i].size,t)-n)*s}}function rr(t,e){let r=Qe[e.valueUnit],i=F(e.minSize,t),s=F(e.maxSize,t),{valueRepresentation:n}=e,a=null;return a=n==="area"?2*Math.sqrt(t/Yt)/r:n==="radius"||n==="distance"?2*t/r:t/r,ye(a,i,s)}function ir(t,e){if(!e)return;let r=0,i=e.length-1;return e.some((s,n)=>t<s?(i=n,!0):(r=n,!1)),[r,i,(t-e[r])/(e[i]-e[r])]}var sr=1e-6,ce=class{constructor(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}destroy(){}clear(){this._tiles.forEach(e=>this._releaseTile(e))}tileKeys(){let e=[];return this._tiles.forEach((r,i)=>e.push(i)),e}update(e){let r=this.tileInfoView.getTileCoverage(e.state,this.buffer,!0,"closest"),{spans:i,lodInfo:s}=r,{level:n}=s,a=[],o=[],u=new Set,d=new Set;for(let{row:p,colFrom:y,colTo:f}of i)for(let g=y;g<=f;g++){let x=ge.getId(n,p,s.normalizeCol(g),s.getWorldForColumn(g)),C=this._getOrAcquireTile(a,x);u.add(x),C.isReady?C.visible=!0:d.add(C.key)}return d.forEach(p=>this._addPlaceholders(u,p)),this._tiles.forEach(p=>{u.has(p.key.id)||(o.push(p.key.id),this._releaseTile(p))}),Ye.pool.release(r),{hasMissingTiles:d.size>0,added:a,removed:o}}_getOrAcquireTile(e,r){if(!this._tiles.has(r)){let i=this.acquireTile(new ge(r));e.push(r),this._tiles.set(r,i),i.visible=!1}return this._tiles.get(r)}_getTile(e){return this._tiles.get(e)}_releaseTile(e){this._tiles.delete(e.key.id),this.releaseTile(e)}_addPlaceholders(e,r){let i=this._addPlaceholderChildren(e,r);Math.abs(1-i)<sr||this._addPlaceholderParent(e,r)||(this._getTile(r.id).visible=!0)}_addPlaceholderChildren(e,r){let i=0;return this._tiles.forEach(s=>{i+=this._addPlaceholderChild(e,s,r)}),i}_addPlaceholderChild(e,r,i){return r.key.level<=i.level||!r.hasData||!i.contains(r.key)?0:(r.visible=!0,e.add(r.key.id),1/(1<<2*(r.key.level-i.level)))}_addPlaceholderParent(e,r){let i=r.getParentKey(),s=0,n=null;for(;i!=null;){if(e.has(i.id))return!0;let a=this._getTile(i.id);if(a?.isReady){for(let o of e){let u=this._getTile(o);u&&i.contains(u.key)&&(u.visible=!1)}return a.visible=!0,e.add(a.key.id),!0}a?.hasData&&a.patchCount>s&&(s=a.patchCount,n=a),i=i.getParentKey()}return!!n&&(n.visible=!0,e.add(n.key.id),!0)}};var Lt="esri.views.layers.FeatureLayerView",Te=V.getLogger(Lt),Bt=t=>{let e=class extends t{constructor(...r){super(...r),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([L(()=>{let r=this.layer;return[r?.elevationInfo?.featureExpressionInfo,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),K),pe(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),pe(()=>{let r=this.layer;return r&&"sublayers"in r?r.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){let{layer:r,layer:{fieldsIndex:i},requiredFields:s}=this;return"outFields"in r&&r.outFields?ve(i,[...we(i,r.outFields),...s]):ve(i,s)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){Te.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(r){throw new Error("missing implementation")}createQuery(){let r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},i=this.filter!=null?this.filter.createQuery(r):new B(r);if(this.layer.type==="feature"){let s=Se(this);s!=null&&(i.where=i.where?`(${i.where}) AND (${s})`:s)}return this.timeExtent!=null&&(i.timeExtent=i.timeExtent!=null?i.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),i}createAggregateQuery(){let r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new B(r)}queryFeatures(r,i){throw new Error("missing implementation")}queryObjectIds(r,i){throw new Error("missing implementation")}queryFeatureCount(r,i){throw new Error("missing implementation")}queryExtent(r,i){throw new Error("missing implementation")}fetchPopupFeatures(r,i){return l(this,null,function*(){let s=this.validateFetchPopupFeatures(i);if(s)throw s;return this.fetchClientPopupFeatures(i)})}_loadArcadeModules(r){return r.expressionInfos?.length||Array.isArray(r.content)&&r.content.some(i=>i.type==="expression")?ot():Promise.resolve()}_handleRequiredFieldsChange(){let r=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",r),r.then(()=>{this._updatingRequiredFieldsPromise===r&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){return l(this,null,function*(){if(!this.layer||!this.view)return;let r=this.view.type==="3d",{layer:i,layer:{fieldsIndex:s,objectIdField:n}}=this,a="renderer"in i&&i.renderer,o="orderBy"in i&&i.orderBy,u="featureReduction"in i?i.featureReduction:null,d=new Set,p=yield Promise.allSettled([a?a.collectRequiredFields(d,s):null,Re(d,i),r?lt(d,i):null,this.filter!=null?xe(d,i,this.filter):null,this.featureEffect!=null?xe(d,i,this.featureEffect.filter):null,u?ut(d,i,u):null,o?ht(d,i,o):null]);if("timeInfo"in i&&i.timeInfo&&this.timeExtent&&Z(d,i.fieldsIndex,[i.timeInfo.startField,i.timeInfo.endField]),i.type==="feature"&&(i.floorInfo&&Z(d,i.fieldsIndex,[i.floorInfo.floorField]),r&&i.infoFor3D!=null&&(i.globalIdField==null&&Te.error("globalIdField missing on 3DObjectFeatureLayer"),Z(d,i.fieldsIndex,[i.globalIdField]))),i.type==="subtype-group"){ee(d,s,i.subtypeField);let f=i.sublayers.map(g=>Promise.all([g.renderer?.collectRequiredFields(d,s),Re(d,g)]));yield Promise.allSettled(f)}for(let f of p)f.status==="rejected"&&Te.error(f.reason);ee(d,s,n),r&&"displayField"in i&&i.displayField&&ee(d,s,i.displayField);let y=Array.from(d).sort();this._set("requiredFields",y)})}validateFetchPopupFeatures(r){if(r==null)return null;for(let i of r.clientGraphics??[]){let s=i.layer;if("popupEnabled"in s&&!s.popupEnabled)return new I("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(i.isAggregate){let n="featureReduction"in s?s.featureReduction:null;if(!(n&&"popupTemplate"in n&&n.popupEnabled&&n.popupTemplate))return new I("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!te(s,r))return new I("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}fetchClientPopupFeatures(r){return l(this,null,function*(){let i=r!=null?r.clientGraphics:null;if(!i||i.length===0)return[];let s=new Array(i.length),n=new Map,a=yield this.createPopupQuery(r);for(let o=0;o<i.length;o++){let u=i[o];if(u.isAggregate){s[o]=u;continue}let d=u.layer;if(!("popupEnabled"in d))continue;let p=we(this.layer.fieldsIndex,a.outFields),y=te(d,r);if(y==null)continue;let f=yield this._loadArcadeModules(y);f&&f.arcadeUtils.hasGeometryOperations(y)||!dt(p,u)?n.set(u.getObjectId(),{graphic:u,index:o}):s[o]=u}if(this.layer.type==="stream"||n.size===0)return s.filter(Boolean);a.objectIds=Array.from(n.keys());try{let o=yield this.layer.queryFeatures(a);for(let u of o.features){let{graphic:{geometry:d},index:p}=n.get(u.getObjectId());u.geometry||=d,s[p]=u}}catch{}return s.filter(Boolean)})}createPopupQuery(r){return l(this,null,function*(){let i=this.layer.createQuery(),s=new Set,n=!1,a=r?.clientGraphics?r.clientGraphics.map(o=>o.layer):[this.layer];for(let o of a){if(!("popupEnabled"in o))continue;let u=te(o,r);if(u==null)continue;let d=yield this._loadArcadeModules(u),p=d&&d.arcadeUtils.hasGeometryOperations(u);n=!(this.layer.geometryType!=="point"&&!p);let y=yield ft(this.layer,u);for(let f of y)s.add(f)}if(i.returnGeometry=n,i.returnZ=n,i.returnM=n,i.outFields=Array.from(s),i.outSpatialReference=this.view.spatialReference,this.layer.type==="feature"){let o=Se(this);o!=null&&(i.where=i.where?`(${i.where}) AND (${o})`:o)}return i})}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}};return h([c()],e.prototype,"_updatingRequiredFieldsPromise",void 0),h([c({readOnly:!0})],e.prototype,"availableFields",null),h([c({readOnly:!0})],e.prototype,"dataUpdating",void 0),h([c({type:Ze})],e.prototype,"featureEffect",null),h([c({type:X})],e.prototype,"filter",void 0),h([c(ct)],e.prototype,"timeExtent",void 0),h([c()],e.prototype,"layer",void 0),h([c({type:Number})],e.prototype,"maximumNumberOfFeatures",null),h([c({readOnly:!0,type:Boolean})],e.prototype,"maximumNumberOfFeaturesExceeded",null),h([c({readOnly:!0})],e.prototype,"requiredFields",void 0),h([c()],e.prototype,"suspended",void 0),h([c()],e.prototype,"view",void 0),e=h([_(Lt)],e),e};function Mt(t){return t&&"openPorts"in t}function nr(t){for(let e of t){let r="featureReduction"in e&&e.featureReduction&&"labelingInfo"in e.featureReduction?e.featureReduction:void 0,i=[...e.labelingInfo||[],...r?.labelingInfo||[]];if(!(!e.labelsVisible||!i.length)&&i.some(s=>s.deconflictionStrategy==="none"))return!0}return!1}function ar(t){return e=>Ge(Ie(e,t))}function or(t){let e=t!=null&&"visualVariables"in t&&t.visualVariables;if(!e)return null;for(let r of e)if(r.type==="size")return ar(r);return null}var Dt="esri.views.2d.layers.FeatureLayerView2D";function lr(t){switch(t.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":case"multipatch":return"esriGeometryPolygon";case"multipoint":return"esriGeometryMultipoint";default:return V.getLogger(Dt).error(new I("unsupported-geometry-type",`Geometry type of ${t.geometryType} is not supported`)),null}}var v=class extends Bt(Ct(Et(Ft))){constructor(){super(...arguments),this._pipelineIsUpdating=!0,this._commandsQueue=new Ot({process:t=>{switch(t.type){case"processed-edit":return this._doEdit(t);case"refresh":return this._doRefresh(t.dataChanged);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._updateHighlight=Pe(()=>l(this,null,function*(){return this._proxy.setHighlight(Array.from(this._highlightIds.keys()))})),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.featureEffectView=new Vt,this._lastDefinitionExpression=null}destroy(){this._updateClusterSizeTask?.remove(),this._proxy?.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.addHandles([this.on("valueRangesChanged",t=>{this._set("_aggregateValueRanges",t.valueRanges)}),L(()=>this.featureEffect,t=>{this.featureEffectView.featureEffect=t},K)],"constructor"),this.featureEffectView.endTransitions()}_initProxy(){return l(this,null,function*(){let t=this.layer;if("isTable"in t&&t.isTable)throw new I("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:this.layer});if((t.type==="feature"||t.type==="subtype-group")&&!Y(t)?.operations.supportsQuery)throw new I("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:t});this._proxy&&this._proxy.destroy();let e=this._createClientOptions();return this._set("_proxy",new Pt({client:e})),this._proxy.when()})}_initServiceOptions(){return l(this,null,function*(){return this._set("_serviceOptions",yield this._createServiceOptions()),this._serviceOptions})}get _effectiveFeatureReduction(){if(!("featureReduction"in this.layer))return null;let t=this.layer.featureReduction;return t&&(!("maxScale"in t)||!t.maxScale||t.maxScale<this.view.scale)?t:null}get orderByFields(){return this._serviceOptions?.type!=="stream"?this._serviceOptions?.orderByFields:void 0}get labelsVisible(){let t=this.layer.type==="subtype-group"?this.layer.sublayers.items:[this.layer];return!this.suspended&&t.some(e=>e.labelingInfo&&e.labelsVisible)}get labelingCollisionInfos(){let{tileRenderer:t,layer:e}=this;if(t==null)return null;let r=this.layer.type==="subtype-group"?this.layer.sublayers.items:[this.layer],i=e.geometryType,s=!nr(r),n={};if(e.type!=="subtype-group"){if(t?.type==="heatmap")return null;let a=or(e.renderer);n[0]=a}return[{tileRenderer:t,vvEvaluators:n,deconflictionEnabled:s,geometryType:i,visible:!this.suspended}]}get queryMode(){return this._serviceOptions?.type}get renderingConfigHash(){if(!this.layer)return null;let t=this.availableFields,e=this.layer,r=this.view.floors,{definitionExpression:i}=e,s=this.layer.type!=="subtype-group"&&this.layer.labelsVisible&&this.layer.labelingInfo,n="renderer"in e&&e.renderer,a="gdbVersion"in e?e.gdbVersion:void 0,o="historicMoment"in e?e.historicMoment?.getTime():void 0,{timeExtent:u}=this,d="customParameters"in e?JSON.stringify(e.customParameters):void 0,p="apiKey"in e?e.apiKey:void 0,y=e.type==="stream"?`${JSON.stringify(e.geometryDefinition)}${e.definitionExpression}`:null,f=JSON.stringify(this.clips),g=this._effectiveFeatureReduction?.toJSON(),x="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),C="sublayers"in this.layer&&this.layer.sublayers.items.reduce((O,Q)=>O+`${Q.visible?1:0}.${JSON.stringify(Q.renderer)}.${Q.labelsVisible}
.${JSON.stringify(Q.labelingInfo)}`,""),q="subtypeCode"in this.layer&&this.layer.subtypeCode;return JSON.stringify({orderBy:x,sublayerHash:C,subtypeCode:q,filterHash:this.filter!=null&&this.filter.toJSON(),effectHash:this.featureEffect!=null&&this.featureEffect.toJSON(),streamFilter:y,gdbVersion:a,definitionExpression:i,historicMoment:o,availableFields:t,renderer:n,labelingInfo:s,timeExtent:u,floors:r,clipsHash:f,featureReduction:g,customParameters:d,apiKey:p,timeZone:this.view.timeZone})}highlight(t){let e;t instanceof D?e=[t.getObjectId()]:typeof t=="number"||typeof t=="string"?e=[t]:Le.isCollection(t)&&t.length>0?e=t.map(i=>i?.getObjectId()).toArray():Array.isArray(t)&&t.length>0&&(e=typeof t[0]=="number"||typeof t[0]=="string"?t:t.map(i=>i?.getObjectId()));let r=e?.filter(qe);return r?.length?(this._addHighlight(r),fe(()=>this._removeHighlight(r))):fe()}hasHighlight(){return!!this._highlightIds.size}hitTest(t,e){return l(this,null,function*(){if(!this.tileRenderer)return null;let r=yield this.tileRenderer.hitTest(e);if(r.length===0)return null;m("featurelayer-force-marker-text-draw-order")&&r.sort((n,a)=>n-a);let{features:i,aggregates:s}=yield this._proxy.getFeatures(r);return[...s.map(n=>this._createGraphicHit(t,N.fromJSON(n))),...i.map(n=>this._createGraphicHit(t,D.fromJSON(n)))]})}queryStatistics(){return this._proxy.queryStatistics()}querySummaryStatistics(t,e,r){return l(this,null,function*(){let i=E(S({},e),{scale:this.view.scale});return this._proxy.querySummaryStatistics(this._cleanUpQuery(t),i,r)})}queryAggregateSummaryStatistics(t,e,r){return l(this,null,function*(){let i=E(S({},e),{scale:this.view.scale});return this._proxy.queryAggregateSummaryStatistics(this._cleanUpAggregateQuery(t),i,r)})}queryUniqueValues(t,e,r){return l(this,null,function*(){let i=E(S({},e),{scale:this.view.scale});return this._proxy.queryUniqueValues(this._cleanUpQuery(t),i,r)})}queryAggregateUniqueValues(t,e,r){return l(this,null,function*(){let i=E(S({},e),{scale:this.view.scale});return this._proxy.queryAggregateUniqueValues(this._cleanUpAggregateQuery(t),i,r)})}queryClassBreaks(t,e,r){return l(this,null,function*(){let i=E(S({},e),{scale:this.view.scale});return this._proxy.queryClassBreaks(this._cleanUpQuery(t),i,r)})}queryAggregateClassBreaks(t,e,r){return l(this,null,function*(){let i=E(S({},e),{scale:this.view.scale});return this._proxy.queryAggregateClassBreaks(this._cleanUpAggregateQuery(t),i,r)})}queryHistogram(t,e,r){return l(this,null,function*(){let i=E(S({},e),{scale:this.view.scale});return this._proxy.queryHistogram(this._cleanUpQuery(t),i,r)})}queryAggregateHistogram(t,e,r){return l(this,null,function*(){let i=E(S({},e),{scale:this.view.scale});return this._proxy.queryAggregateHistogram(this._cleanUpAggregateQuery(t),i,r)})}queryFeatures(t,e){return this.queryFeaturesJSON(t,e).then(r=>{let i=z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryVisibleFeatures(t,e){return this._proxy.queryVisibleFeatures(this._cleanUpQuery(t),e).then(r=>{let i=z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryAggregates(t,e){return l(this,null,function*(){let r=yield this._proxy.queryAggregates(this._cleanUpAggregateQuery(t),e),i=It.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryAggregateIds(t,e){return this._proxy.queryAggregateIds(this._cleanUpAggregateQuery(t),e)}queryAggregateCount(t,e){return this._proxy.queryAggregateCount(this._cleanUpAggregateQuery(t),e)}queryAggregateJSON(t,e){return this._proxy.queryAggregates(this._cleanUpAggregateQuery(t),e)}queryFeaturesJSON(t,e){return this._proxy.queryFeatures(this._cleanUpQuery(t),e)}queryObjectIds(t,e){return this._proxy.queryObjectIds(this._cleanUpQuery(t),e)}queryFeatureCount(t,e){return this._proxy.queryFeatureCount(this._cleanUpQuery(t),e)}queryExtent(t,e){return this._proxy.queryExtent(this._cleanUpQuery(t),e).then(r=>({count:r.count,extent:Ne.fromJSON(r.extent)}))}setVisibility(t,e){e?this._visibilityOverrides.delete(t):this._visibilityOverrides.add(t),this._update()}update(t){if(!this._tileStrategy||!this.tileRenderer)return;let{hasMissingTiles:e,added:r,removed:i}=this._tileStrategy.update(t);(r.length||i.length)&&this._proxy.updateTiles({added:r,removed:i}),e&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new ce({acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.addAttachHandles(L(()=>this.renderingConfigHash,()=>this._update(),Be)),this.layer.type!=="stream"&&this.addAttachHandles(this.layer.on("edits",t=>this._edit(t)))}detach(){this._commandsQueue.clear(),this._proxy?.stop(),this.container.removeAllChildren(),this.tileRenderer?.uninstall(this.container),this.tileRenderer=null,this._tileStrategy=U(this._tileStrategy),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){let t="renderer"in this.layer&&this.layer.renderer!=null,e=this._commandsQueue.updating,r=this._updatingRequiredFieldsPromise!=null,i=!this._proxy||!this._proxy.isReady,s=this._pipelineIsUpdating,n=this.tileRenderer==null||this.tileRenderer?.updating,a=t&&(e||r||i||s||this.dataUpdating||n);return m("esri-2d-log-updating")&&console.log(`Updating FLV2D (${this.layer.id}): ${a}
  -> hasRenderer ${t}
  -> hasPendingCommand ${e}
  -> updatingRequiredFields ${r}
  -> updatingProxy ${i}
  -> updatingPipeline ${s}
  -> updatingData: ${this.dataUpdating}
  -> updatingTileRenderer ${n}
`),a}_createClientOptions(){return{setUpdating:t=>{this._set("_pipelineIsUpdating",t)},setDataUpdating:t=>{this._set("dataUpdating",t)},emitEvent:t=>{this.emit(t.name,t.event)}}}_detectQueryMode(t){return l(this,null,function*(){let e="path"in t,{layer:r}=this,i="editingInfo"in r&&r.editingInfo?.lastEditDate,s="refreshInterval"in r&&!!r.refreshInterval,n=!i&&s,a=Y(r);if(e&&(r.type==="feature"||r.type==="subtype-group")&&r.geometryType==="point"&&a?.query.supportsPagination&&!a?.operations.supportsEditing&&!n&&m("featurelayer-snapshot-enabled"))try{let o=yield r.queryFeatureCount();if(o<=m("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:o};let u=m("featurelayer-snapshot-point-max-threshold"),d=m("featurelayer-snapshot-point-coverage"),p=this.view.extent,y=r.fullExtent,f=y?.clone().intersection(p),g=f!=null?f.width*f.height:0,x=y?.width*y?.height;if(o<=u&&(x===0?0:g/x)>=d)return{mode:"snapshot",featureCount:o}}catch(o){V.getLogger(this).warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:o})}return{mode:"on-demand"}})}_createServiceOptions(){return l(this,null,function*(){let t=this.layer;if(t.type==="stream")return null;let e=Y(t),{capabilities:r,objectIdField:i}=t,s=t.fieldsIndex.toJSON(),n=s.fields,a=t.fullExtent!=null?t.fullExtent.toJSON():null,o=lr(t),u="timeInfo"in t&&t.timeInfo?.toJSON()||null,d=t.spatialReference?t.spatialReference.toJSON():null,p=t.type==="feature"?t.globalIdField:null,y;t.type==="ogc-feature"?y=t.source.getSource():Mt(t.source)?y=yield t.source.openPorts():t.parsedUrl&&(y=Ue(t.parsedUrl),"dynamicDataSource"in t&&t.dynamicDataSource&&(y.query={layer:JSON.stringify({source:t.dynamicDataSource})}));let f="datesInUnknownTimezone"in this.layer&&this.layer.datesInUnknownTimezone,g=("subtypeField"in this.layer?this.layer.subtypeField:null)??null,{mode:x,featureCount:C}=yield this._detectQueryMode(y),q=this.layer.objectIdField;if(this.layer.type==="feature"&&this.layer.orderBy!=null&&this.layer.orderBy.length){let O=!this.layer.orderBy[0].valueExpression&&this.layer.orderBy[0].field;O&&(q=O)}return{type:x,typeIdField:"typeIdField"in t&&t.typeIdField||void 0,types:"types"in t&&t.types?.map(O=>O.toJSON())||void 0,timeReferenceUnknownClient:f,subtypeField:g,featureCount:C,globalIdField:p,maxRecordCount:r.query.maxRecordCount,tileMaxRecordCount:r.query.tileMaxRecordCount,capabilities:r,effectiveCapabilities:e,fields:n,fieldsIndex:s,fullExtent:a,geometryType:o,objectIdField:i,source:y,timeInfo:u,spatialReference:d,orderByFields:q}})}_createMemoryServiceOptions(t){return l(this,null,function*(){let e=yield t.openPorts();return E(S({},this._createServiceOptions()),{type:"memory",source:e})})}_cleanUpQuery(t){let e=B.from(t)||this.createQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}_cleanUpAggregateQuery(t){let e=B.from(t)||this.createAggregateQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}_update(){return l(this,null,function*(){return this._commandsQueue.push({type:"update"})})}_edit(t){return l(this,null,function*(){return this.suspended?void this._clearTiles():this._validateEdit(t)?this._commandsQueue.push({type:"edit",edits:t}):void 0})}doRefresh(t){return l(this,null,function*(){if(this.attached&&this._tileStrategy.tileKeys().length)return this.suspended&&t?void this._clearTiles():this._commandsQueue.push({type:"refresh",dataChanged:t})})}_clearTiles(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}_validateEdit(t){let e="globalIdField"in this.layer&&this.layer.globalIdField,r=t.deletedFeatures.some(s=>s.objectId===-1||!s.objectId),i=e&&this.availableFields.includes(e);return r&&!i?(V.getLogger(this).error(new I("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected on the map`)),null):t}_doUpdate(){return l(this,null,function*(){try{if(this.destroyed||!this._hasRequiredSupport(this.layer)||!this._tileStrategy)return;let{featureEffectView:t,filter:e}=this;if(yield this._updateRequiredFields(),this.destroyed)return;let{renderer:r}=this._getEffectiveRenderer();this._set("_effectiveRenderer",r);let i=this._createSchemaConfig(),s=this._createConfiguration(i,e,t.filter),n=this._lastDefinitionExpression!==s.schema.source.definitionExpression;this._lastDefinitionExpression=s.schema.source.definitionExpression;let a=s.schema.tileRenderer,o=this._createTileRendererHash(a);if(this._serviceOptions.type==="snapshot"&&(s.schema.source.initialFeatureCount=this._serviceOptions.featureCount),o!==this._tileRendererHash){this._initTileRenderer(a,r);let u=this.layer,d=u.type==="stream"?yield this._initServiceOptions():this._serviceOptions;this.tileRenderer.onConfigUpdate(r),u.type!=="stream"&&Mt(u.source)&&(d.source=yield u.source.openPorts());let p={added:this._tileStrategy.tileKeys(),removed:[]};m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Proxy startup"),yield this._proxy.startup(this.view.featuresTilingScheme,s,d,p),m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished proxy startup"),this.hasHighlight()&&(m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Updating highlight"),yield this._proxy.setHighlight(Array.from(this._highlightIds.keys())),m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished highlight update")),m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: onConfigUpdate start"),this.tileRenderer.onConfigUpdate(r),m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: onConfigUpdate end")}else{this._serviceOptions.type==="snapshot"&&n&&(s.schema.source.changedFeatureCount=yield this.layer.queryFeatureCount()),m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Updating proxy");let u=yield this._proxy.update(s);m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished proxy update"),(u.mesh||u.targets?.aggregate)&&(m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Locking GPU Uploads"),this._lockGPUUploads());try{m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Applying update to proxy"),yield this._proxy.applyUpdate(u),m("esri-2d-update-debug")&&console.debug("FeatureLayerView2D: Finished applying update to proxy")}catch(d){k(d)||V.getLogger(this).error(d)}(u.mesh||u.targets?.aggregate)&&this._unlockGPUUploads(),this.tileRenderer.onConfigUpdate(r),this._updateClusterSizeVariable(),this._forceAttributeTextureUpload()}this._tileRendererHash=o,this.tileRenderer.invalidateLabels(),this.requestUpdate()}catch{}})}_doEdit(t){return l(this,null,function*(){try{yield this._proxy.onEdits(t)}catch(e){k(e)}})}_doRefresh(t){return l(this,null,function*(){this._lockGPUUploads();try{let e;t&&this.queryMode==="snapshot"&&"queryFeatureCount"in this.layer&&(e=yield this.layer.queryFeatureCount()),yield this._proxy.refresh({dataChanged:t,featureCount:e})}catch(e){k(e)}this._unlockGPUUploads(),this._effectiveFeatureReduction&&this._updateClusterSizeVariable()})}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(t,e){return L(()=>this._aggregateValueRanges,r=>{this._updateClusterEffectiveRendererSizeVariable(t,e,r),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()})}_updateClusterEffectiveRendererSizeVariable(t,e,r){return l(this,null,function*(){if(t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables){let i=tt(t.visualVariables);if(i!=null&&i.field==="cluster_count"){let s=t.visualVariables.indexOf(i);t.visualVariables[s]=it(e,r);let n=t.clone();n.dynamicClusterSize=!0,this._set("_effectiveRenderer",n)}}})}_getEffectiveRenderer(){let t=this.layer,e="renderer"in t?t.renderer:null,r=this._effectiveFeatureReduction;if(this._updateClusterSizeTask=Ae(this._updateClusterSizeTask),r&&"renderer"in r&&r.renderer&&!r.renderer.authoringInfo?.isAutoGenerated){let i=r.fields;if(r.type==="cluster"){let{renderer:s,didInject:n}=rt(r.renderer,r,this._aggregateValueRanges);return n&&(this._updateClusterSizeTask=this._createUpdateClusterSizeTask(s,r)),{renderer:s,aggregateFields:i,featureReduction:r}}return{renderer:r.renderer,aggregateFields:i,featureReduction:r}}if(r&&r.type==="cluster"&&e&&st(e)){let i=r,s=[],n=et(s,e,i,this._aggregateValueRanges,!0);return this._updateClusterSizeTask=this._createUpdateClusterSizeTask(n,i),{renderer:n,aggregateFields:s,featureReduction:r}}return{renderer:e,aggregateFields:[],featureReduction:null}}_acquireTile(t){let e=this.tileRenderer.acquireTile(t);return e.once("attach",()=>{this.requestUpdate()}),e}_releaseTile(t){this.tileRenderer.releaseTile(t)}_initTileRenderer(t,e){let r=Ut(t,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});return this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer=U(this.tileRenderer)),this.destroyed?null:(this._proxy.tileRenderer=r,this._set("tileRenderer",r),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(e),this.requestUpdate(),this.tileRenderer)}_createTileRendererHash(t){return`${t.type}`}get hasFilter(){let t=!!("floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length);return!!this.filter||t||!!this._visibilityOverrides.size||!!this.timeExtent}_injectOverrides(t){let e=t!=null?t.timeExtent:null,r=this.timeExtent!=null&&e!=null?this.timeExtent.intersection(e):this.timeExtent||e,i=null,s="floorInfo"in this.layer&&this.layer.floorInfo;if(s){let a=t!=null?t.where:null;i=this._addFloorFilterClause(a)}if(!this._visibilityOverrides.size&&!r&&!s)return t!=null?t.toJSON():null;(t=t!=null&&t.clone()||new X).timeExtent=r,i&&(t.where=i);let n=t.toJSON();return n.hiddenIds=Array.from(this._visibilityOverrides),n}_addFloorFilterClause(t){let e=this.layer,r=t||"";if("floorInfo"in e&&e.floorInfo){let i=this.view.floors;if(!i?.length)return r;e.floorInfo.viewAllLevelIds?.length&&(i=e.floorInfo.viewAllLevelIds);let s=i.filter(o=>o!=="").map(o=>"'"+o+"'");s.push("''");let n=e.floorInfo.floorField,a="("+n+" IN ({ids}) OR "+n+" IS NULL)";if(a=a.replace("{ids}",s.join(", ")),r!=null&&r.includes(n)){let o=new RegExp("AND \\("+n+".*NULL\\)","g");r=r.replace(o,""),o=new RegExp("\\("+n+".*NULL\\)","g"),r=r.replace(o,""),r=r.replaceAll(/\s+/g," ").trim()}r=r!==""?"("+r+") AND "+a:a}return r!==""?r:null}_createConfiguration(t,e,r){let i=this.layer.type==="feature"&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,s=this.layer.type==="feature"?this.layer.gdbVersion??void 0:void 0,n=new Array(je),a=this._injectOverrides(e);n[0]=a,n[1]=r!=null?r.toJSON():null;let o=xt(t);if(o==null)return null;let u=pt("2d");return{availableFields:this.availableFields,gdbVersion:s,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:n,schema:o,supportsTextureFloat:u.supportsTextureFloat,maxTextureSize:u.maxTextureSize,timeZone:this.view.timeZone}}_hasRequiredSupport(t){return!("renderer"in t)||wt(t.renderer)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){let t=this.layer;return{renderer:"renderer"in t?t.renderer:null,spatialReference:t.spatialReference,timeExtent:"timeExtent"in t?t.timeExtent:null,definitionExpression:t.definitionExpression,featureReduction:this._effectiveFeatureReduction,fields:t.fields,geometryType:t.geometryType,historicMoment:"historicMoment"in t?t.historicMoment:null,labelsVisible:"labelsVisible"in t&&t.labelsVisible,labelingInfo:"labelingInfo"in t?t.labelingInfo:null,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"gdbVersion"in t?t.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in t&&t.orderBy?t.orderBy:null,customParameters:E(S({},"customParameters"in t?t.customParameters:void 0),{token:"apiKey"in t?t.apiKey??void 0:void 0}),subtypeCode:"subtypeCode"in t?t.subtypeCode:void 0,subtypeField:"subtypeField"in t?t.subtypeField:void 0}}_addHighlight(t){for(let e of t)if(this._highlightIds.has(e)){let r=this._highlightIds.get(e);this._highlightIds.set(e,r+1)}else this._highlightIds.set(e,1);this._updateHighlight().catch(e=>{k(e)||V.getLogger(this).error(e)})}_removeHighlight(t){for(let e of t)if(this._highlightIds.has(e)){let r=this._highlightIds.get(e)-1;r===0?this._highlightIds.delete(e):this._highlightIds.set(e,r)}this._updateHighlight().catch(e=>{k(e)||V.getLogger(this).error(e)})}_setLayersForFeature(t){let e=this.layer;t.layer=e,t.sourceLayer=e}_createGraphicHit(t,e){return this._setLayersForFeature(e),e.geometry!=null&&(e.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:e,layer:this.layer,mapPoint:t}}};h([c()],v.prototype,"_serviceOptions",void 0),h([c()],v.prototype,"_proxy",void 0),h([c()],v.prototype,"_pipelineIsUpdating",void 0),h([c()],v.prototype,"_effectiveRenderer",void 0),h([c()],v.prototype,"_effectiveFeatureReduction",null),h([c()],v.prototype,"_aggregateValueRanges",void 0),h([c()],v.prototype,"_commandsQueue",void 0),h([c()],v.prototype,"featureEffectView",void 0),h([c()],v.prototype,"labelsVisible",null),h([c()],v.prototype,"labelingCollisionInfos",null),h([c({readOnly:!0})],v.prototype,"queryMode",null),h([c()],v.prototype,"renderingConfigHash",null),h([c()],v.prototype,"tileRenderer",void 0),h([c()],v.prototype,"updating",void 0),v=h([_(Dt)],v);var zn=v;export{zn as a};
