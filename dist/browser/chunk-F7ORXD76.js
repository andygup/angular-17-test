import{a as ke}from"./chunk-AY2UBXIR.js";import{a as Fr,c as Lr,d as Nr,e as Gr,f as Ur}from"./chunk-RJDYQPCB.js";import{a as Z,c as Wr}from"./chunk-FMBL6HUJ.js";import{b as jr}from"./chunk-2SUQUOXL.js";import{D as h,E as qr,a as C,c as W,d as Ee,h as wr,i as me,k as Mr,l as Or,m as Cr,n as Sr,o as Br,p as Be,t as zr,u as He,v as kr,w as Hr}from"./chunk-YDRXZKZM.js";import{a as vr}from"./chunk-FVCUBGKZ.js";import{a as Re,d as Pr,e as Dr,f as Ir,g as Vr}from"./chunk-FN72K46S.js";import"./chunk-EVB25YXG.js";import{h as br,i as Er,j as ie}from"./chunk-Z7J4BCLI.js";import"./chunk-AOBAM4UL.js";import"./chunk-3OR7RZFV.js";import{a as Rr}from"./chunk-6I2HBXXD.js";import"./chunk-GMW3QDVG.js";import{a as yr,b as _r}from"./chunk-PR2AVY5J.js";import"./chunk-6Z54DTZZ.js";import{b as fr,e as gt,g as hr,j as pr,m as dr,o as gr,p as Tr,q as xr}from"./chunk-KT6A24IB.js";import{b as Ue}from"./chunk-GWXMNOIW.js";import{a as Ge}from"./chunk-TFSPQFEF.js";import{a as cr,b as mr}from"./chunk-OUYMSSKU.js";import"./chunk-PTXLSCMJ.js";import{b as ae}from"./chunk-YQNUGDFH.js";import"./chunk-Q4M7XPFX.js";import"./chunk-SBBOWK5S.js";import{e as dt}from"./chunk-VWU5IX5V.js";import{a as q,b as oe,d as ee,f as N,h as be}from"./chunk-ZREXZJBZ.js";import{b as ur}from"./chunk-QB2WNRL5.js";import{a as sr}from"./chunk-N2A5W4XS.js";import"./chunk-2NH7HOKA.js";import{a as I}from"./chunk-PYQFEBZL.js";import{a as _}from"./chunk-IL3PPCCF.js";import{c as ar}from"./chunk-OCBWGGCR.js";import{i as Q,j as H,k as J,l as ue,n as se,z as X}from"./chunk-TKTKGUCU.js";import"./chunk-J43N2ESR.js";import"./chunk-Y4SWPZQY.js";import{a as ut}from"./chunk-DUAAYE7V.js";import{c as or,e as ir,g as ht}from"./chunk-QJR6XTTM.js";import{a as ct}from"./chunk-6B6VO6EC.js";import{D as rr,a as Qt,b as Zt,c as Ae,d as Se,o as Jt,p as ve,s as er,t as tr}from"./chunk-PV5D5XIZ.js";import"./chunk-YW3L7OMP.js";import"./chunk-MCO7DSFO.js";import{a as Ar,c as ze}from"./chunk-WKOJXXCZ.js";import"./chunk-MNLP6AEE.js";import{a as ce}from"./chunk-XHOTVM3O.js";import{a as pt}from"./chunk-HTB4QCFJ.js";import{c as nr,d as lr}from"./chunk-YEFC7M4L.js";import"./chunk-ZOTIMGGE.js";import{g as mt,m as ft}from"./chunk-7UQPY7PH.js";import"./chunk-OHIIU6WS.js";import"./chunk-VVAIF23J.js";import"./chunk-I3S324BU.js";import"./chunk-H2AOS66Z.js";import{e as _e,j as Ne}from"./chunk-CJJRHJ2S.js";import{b as Yt}from"./chunk-SREKDU6P.js";import{d as it,o as nt,p as lt}from"./chunk-IXIJFOEL.js";import"./chunk-55ESOXMJ.js";import"./chunk-BCREO4Q5.js";import"./chunk-EJ3VIBAJ.js";import{A as Le,B as jt,D as Xt,E as ye,F as Kt,H as $t,a as O,c as Te,d as Ce,f as zt,k as G,l as kt,m as Y,n as Ht,o as xe,q as rt,r as st,s as at,t as qt,u as Wt,v as ot,w as re}from"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import"./chunk-CBOFHDSC.js";import{c as tt}from"./chunk-HB7BVTLV.js";import"./chunk-FC3MPJI4.js";import{a as Nt}from"./chunk-5ETRXDS4.js";import"./chunk-QDNKD3H5.js";import"./chunk-6QIKBCPR.js";import"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import"./chunk-A52LT7YB.js";import"./chunk-CZPMRK53.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import{a as Gt}from"./chunk-IUPUERVS.js";import{$ as Ut,_ as Lt,u as et,v as Ft}from"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import"./chunk-WMYPRHRR.js";import"./chunk-IAMDMFZ7.js";import{a as f}from"./chunk-53MWZ23O.js";import{h as It,i as Ze,k as Je,m as Vt}from"./chunk-PT7S6WNL.js";import{c as Pt,d as Dt}from"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import{p as Fe,r as ge}from"./chunk-465DRXTW.js";import{G as Bt,a as Ct,r as St,t as pe,v as de}from"./chunk-AC62Z3FX.js";import{a as j,b as Ve,g as k}from"./chunk-ESDYQQXO.js";function Pe(s,e=!1){return s<=Bt?e?new Array(s).fill(0):new Array(s):new Float32Array(s)}function we(s){if(s==null)return null;let e=s.offset!=null?s.offset:nr,t=s.rotation!=null?s.rotation:0,r=s.scale!=null?s.scale:lr,l=ze(1,0,0,0,1,0,e[0],e[1],1),i=ze(Math.cos(t),-Math.sin(t),0,Math.sin(t),Math.cos(t),0,0,0,1),o=ze(r[0],0,0,0,r[1],0,0,0,1),n=Ar();return mt(n,i,o),mt(n,l,n),n}var Tt=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},qe=class{constructor(e,t,r){this.name=e,this.lodThreshold=t,this.pivotOffset=r,this.stageResources=new Tt,this.numberOfVertices=0}};function Xr(){if(xt==null){let s=e=>Gt(`esri/libs/basisu/${e}`);xt=import("./chunk-RWME4AF5.js").then(e=>e.b).then(({default:e})=>e({locateFile:s}).then(t=>(t.initializeBasis(),delete t.then,t)))}return xt}var xt;var ne;(function(s){s[s.ETC1_RGB=0]="ETC1_RGB",s[s.ETC2_RGBA=1]="ETC2_RGBA",s[s.BC1_RGB=2]="BC1_RGB",s[s.BC3_RGBA=3]="BC3_RGBA",s[s.BC4_R=4]="BC4_R",s[s.BC5_RG=5]="BC5_RG",s[s.BC7_M6_RGB=6]="BC7_M6_RGB",s[s.BC7_M5_RGBA=7]="BC7_M5_RGBA",s[s.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",s[s.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",s[s.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",s[s.ATC_RGB=11]="ATC_RGB",s[s.ATC_RGBA=12]="ATC_RGBA",s[s.FXT1_RGB=17]="FXT1_RGB",s[s.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",s[s.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",s[s.ETC2_EAC_R11=20]="ETC2_EAC_R11",s[s.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",s[s.RGBA32=13]="RGBA32",s[s.RGB565=14]="RGB565",s[s.BGR565=15]="BGR565",s[s.RGBA4444=16]="RGBA4444"})(ne||(ne={}));var K=null,We=null;function Kr(){return k(this,null,function*(){return We==null&&(We=Xr(),K=yield We),We})}function $r(s,e){if(K==null)return s.byteLength;let t=new K.BasisFile(new Uint8Array(s)),r=Zr(t)?Qr(t.getNumLevels(0),t.getHasAlpha(),t.getImageWidth(0,0),t.getImageHeight(0,0),e):0;return t.close(),t.delete(),r}function Yr(s,e){if(K==null)return s.byteLength;let t=new K.KTX2File(new Uint8Array(s)),r=Jr(t)?Qr(t.getLevels(),t.getHasAlpha(),t.getWidth(),t.getHeight(),e):0;return t.close(),t.delete(),r}function Qr(s,e,t,r,l){let i=br(e?X.COMPRESSED_RGBA8_ETC2_EAC:X.COMPRESSED_RGB8_ETC2),o=l&&s>1?(4**s-1)/(3*4**(s-1)):1;return Math.ceil(t*r*i*o)}function Zr(s){return s.getNumImages()>=1&&!s.isUASTC()}function Jr(s){return s.getFaces()>=1&&s.isETC1S()}function es(s,e,t){return k(this,null,function*(){K==null&&(K=yield Kr());let r=new K.BasisFile(new Uint8Array(t));if(!Zr(r))return null;r.startTranscoding();let l=rs(s,e,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(i,o)=>r.getImageTranscodedSizeInBytes(0,i,o),(i,o,n)=>r.transcodeImage(n,0,i,o,0,0));return r.close(),r.delete(),l})}function ts(s,e,t){return k(this,null,function*(){K==null&&(K=yield Kr());let r=new K.KTX2File(new Uint8Array(t));if(!Jr(r))return null;r.startTranscoding();let l=rs(s,e,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(i,o)=>r.getImageTranscodedSizeInBytes(i,0,0,o),(i,o,n)=>r.transcodeImage(n,i,0,0,o,0,-1,-1));return r.close(),r.delete(),l})}function rs(s,e,t,r,l,i,o,n){let{compressedTextureETC:a,compressedTextureS3TC:u}=s.capabilities,[c,m]=a?r?[ne.ETC2_RGBA,X.COMPRESSED_RGBA8_ETC2_EAC]:[ne.ETC1_RGB,X.COMPRESSED_RGB8_ETC2]:u?r?[ne.BC3_RGBA,X.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[ne.BC1_RGB,X.COMPRESSED_RGB_S3TC_DXT1_EXT]:[ne.RGBA32,se.RGBA],g=e.hasMipmap?t:Math.min(1,t),d=[];for(let y=0;y<g;y++)d.push(new Uint8Array(o(y,c))),n(y,c,d[y]);return e.internalFormat=m,e.hasMipmap=d.length>1,e.samplingMode=e.hasMipmap?J.LINEAR_MIPMAP_LINEAR:J.LINEAR,e.width=l,e.height=i,new ie(s,e,{type:"compressed",levels:d})}var je=Fe.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Cs=542327876,Ss=131072,Bs=4;function yt(s){return s.charCodeAt(0)+(s.charCodeAt(1)<<8)+(s.charCodeAt(2)<<16)+(s.charCodeAt(3)<<24)}function Ps(s){return String.fromCharCode(255&s,s>>8&255,s>>16&255,s>>24&255)}var Ds=yt("DXT1"),Is=yt("DXT3"),Vs=yt("DXT5"),Fs=31,Ls=0,Ns=1,Gs=2,Us=3,zs=4,ks=7,Hs=20,qs=21;function ss(s,e,t){let r=Ws(t,e.hasMipmap??!1);if(r==null)throw new Error("DDS texture data is null");let{textureData:l,internalFormat:i,width:o,height:n}=r;return e.samplingMode=l.levels.length>1?J.LINEAR_MIPMAP_LINEAR:J.LINEAR,e.hasMipmap=l.levels.length>1,e.internalFormat=i,e.width=o,e.height=n,new ie(s,e,l)}function Ws(s,e){let t=new Int32Array(s,0,Fs);if(t[Ls]!==Cs)return je.error("Invalid magic number in DDS header"),null;if(!(t[Hs]&Bs))return je.error("Unsupported format, must contain a FourCC code"),null;let r=t[qs],l,i;switch(r){case Ds:l=8,i=X.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Is:l=16,i=X.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Vs:l=16,i=X.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return je.error("Unsupported FourCC code:",Ps(r)),null}let o=1,n=t[zs],a=t[Us];!(3&n)&&!(3&a)||(je.warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,a=a+3&-4);let u=n,c=a,m,g;t[Gs]&Ss&&e!==!1&&(o=Math.max(1,t[ks]));let d=t[Ns]+4,y=[];for(let R=0;R<o;++R)g=(n+3>>2)*(a+3>>2)*l,m=new Uint8Array(s,d,g),y.push(m),d+=g,n=Math.max(1,n>>1),a=Math.max(1,a>>1);return{textureData:{type:"compressed",levels:y},internalFormat:i,width:u,height:c}}function as(s,e){let i=s.width*s.height;if(i<4096)return s instanceof ImageData?is(s):s;let o=s.width,n=s.height;do o=Math.ceil(o/2),n=Math.ceil(n/2),i=o*n;while(i>1048576||e!=null&&(o>e||n>e));return _t(s,o,n)}function os(s,e){let t=Math.max(s.width,s.height);if(t<=e)return s;let r=e/t;return _t(s,Math.round(s.width*r),Math.round(s.height*r))}function _t(s,e,t){if(s instanceof ImageData)return _t(is(s),e,t);let r=document.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d").drawImage(s,0,0,r.width,r.height),r}function is(s){let e=document.createElement("canvas");e.width=s.width,e.height=s.height;let t=e.getContext("2d");if(t==null)throw new ge("Failed to create 2d context from HTMLCanvasElement");return t.putImageData(s,0,0),e}var Me=class extends mr{get parameters(){return this._parameters}constructor(e,t){super(),this._data=e,this.type=cr.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new Nt,this._parameters=j(j({},Xs),t),this._startPreload(e)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(e){e!=null&&(e instanceof HTMLVideoElement?(this.frameUpdate=t=>this._frameUpdate(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(et(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";let t=!e.paused;if(e.src=e.src,t&&e.autoplay){let r=()=>{e.removeEventListener("canplay",r),e.play()};e.addEventListener("canplay",r)}}}_startPreloadImageElement(e){Ft(e.src)||et(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){let t=new Er;return t.wrapMode=this._parameters.wrap??ue.REPEAT,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?J.LINEAR_MIPMAP_LINEAR:J.LINEAR,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.gpuMemoryUsage||js(this._data,this._parameters)}load(e){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;let t=this._data;return t==null?(this._glTexture=new ie(e,this._createDescriptor(e),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof t=="string"?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):(pe(t)||de(t))&&this._parameters.encoding===be.DDS_ENCODING?this._loadFromDDSData(e,t):(pe(t)||de(t))&&this._parameters.encoding===be.KTX2_ENCODING?this._loadFromKTX2(e,t):(pe(t)||de(t))&&this._parameters.encoding===be.BASIS_ENCODING?this._loadFromBasis(e,t):de(t)?this._loadFromPixelData(e,t):pe(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_frameUpdate(e,t){return this._glTexture==null||e.readyState<De.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=ss(e,this._createDescriptor(e),t),this._glTexture}_loadFromKTX2(e,t){return this._loadAsync(()=>ts(e,this._createDescriptor(e),t).then(r=>(this._glTexture=r,r)))}_loadFromBasis(e,t){return this._loadAsync(()=>es(e,this._createDescriptor(e),t).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(e,t){I(this._parameters.width>0&&this._parameters.height>0);let r=this._createDescriptor(e);return r.pixelFormat=this._parameters.components===1?se.LUMINANCE:this._parameters.components===3?se.RGB:se.RGBA,r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new ie(e,r,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync(r=>k(this,null,function*(){let l=yield ke(t,{signal:r});return Ze(r),this._loadFromImage(e,l)}))}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(r=>k(this,null,function*(){let l=yield Lt(t,t.src,!1,r);return Ze(r),this._loadFromImage(e,l)}))}_loadFromVideoElement(e,t){return t.readyState>=De.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(r=>new Promise((l,i)=>{let o=()=>{t.removeEventListener("loadeddata",n),t.removeEventListener("error",a),Dt(u)},n=()=>{t.readyState>=De.HAVE_CURRENT_DATA&&(o(),l(this._loadFromImage(e,t)))},a=c=>{o(),i(c||new ge("Failed to load video"))};t.addEventListener("loadeddata",n),t.addEventListener("error",a);let u=Vt(r,()=>a(It()))}))}_loadFromImage(e,t){let r=t;if(!(r instanceof HTMLVideoElement)){let{maxTextureSize:o}=e.parameters;r=this._parameters.downsampleUncompressed?as(r,o):os(r,o)}let l=ns(r);this._parameters.width=l.width,this._parameters.height=l.height;let i=this._createDescriptor(e);return i.pixelFormat=this._parameters.components===3?se.RGB:se.RGBA,i.width=l.width,i.height=l.height,this._glTexture=new ie(e,i,r),this._glTexture}_loadAsync(e){let t=new AbortController;this._loadingController=t;let r=e(t.signal);this._loadingPromise=r;let l=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(l,l),r}unload(){if(this._glTexture=Pt(this._glTexture),this._loadingController!=null){let e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}};function js(s,e){if(s==null)return 0;if(pe(s)||de(s))return e.encoding===be.KTX2_ENCODING?Yr(s,!!e.mipmap):e.encoding===be.BASIS_ENCODING?$r(s,!!e.mipmap):s.byteLength;let{width:t,height:r}=s instanceof Image||s instanceof ImageData||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement?ns(s):e;return(e.mipmap?4/3:1)*t*r*(e.components||4)||0}function ns(s){return s instanceof HTMLVideoElement?{width:s.videoWidth,height:s.videoHeight}:s}var De;(function(s){s[s.HAVE_NOTHING=0]="HAVE_NOTHING",s[s.HAVE_METADATA=1]="HAVE_METADATA",s[s.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",s[s.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",s[s.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(De||(De={}));var Xs={wrap:{s:ue.REPEAT,t:ue.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1};var At=class{constructor(e=0){this.offset=e,this.tmpVertex=O()}applyToVertex(e,t,r){let l=Y(Xe,e,t,r),i=Ht(Et,l,this.localOrigin),o=this.offset/G(i);return re(this.tmpVertex,l,i,o),this.tmpVertex}applyToAabb(e){let t=ms,r=fs,l=hs;for(let a=0;a<3;++a)t[a]=e[0+a]+this.localOrigin[a],r[a]=e[3+a]+this.localOrigin[a],l[a]=t[a];let i=this.applyToVertex(t[0],t[1],t[2]);for(let a=0;a<3;++a)e[a]=i[a],e[a+3]=i[a];let o=a=>{let u=this.applyToVertex(a[0],a[1],a[2]);for(let c=0;c<3;++c)e[c]=Math.min(e[c],u[c]),e[c+3]=Math.max(e[c+3],u[c])};for(let a=1;a<8;++a){for(let u=0;u<3;++u)l[u]=a&1<<u?r[u]:t[u];o(l)}let n=0;for(let a=0;a<3;++a)t[a]*r[a]<0&&(n|=1<<a);if(n!==0&&n!==7){for(let a=0;a<8;++a)if(!(n&a)){for(let u=0;u<3;++u)l[u]=n&1<<u?0:a&1<<u?t[u]:r[u];o(l)}}for(let a=0;a<3;++a)e[a]-=this.localOrigin[a],e[a+3]-=this.localOrigin[a];return e}},vt=class{constructor(e=0){this.componentLocalOriginLength=0,this._tmpVertex=O(),this._mbs=dt(),this._obb=yr(),this._totalOffset=0,this._offset=0,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=G(e)}applyToVertex(e,t,r){let l=Y(Xe,e,t,r),i=Y(Et,e,t,r+this.componentLocalOriginLength),o=this._totalOffset/G(i);return re(this._tmpVertex,l,i,o),this._tmpVertex}applyToAabb(e){let t=Y(Xe,e[0],e[1],e[2]+this.componentLocalOriginLength),r=Y(Et,e[3],e[4],e[5]+this.componentLocalOriginLength),l=at(ms,t),i=at(fs,r),o=st(hs,t),n=st(Ks,r),a=qt(us,o,n);a[0]=l[0]*i[0]<0?0:a[0],a[1]=l[1]*i[1]<0?0:a[1],a[2]=l[2]*i[2]<0?0:a[2];let u=G(a);if(u<this._totalOffset)return e[0]-=t[0]<0?this._totalOffset:0,e[1]-=t[1]<0?this._totalOffset:0,e[2]-=t[2]<0?this._totalOffset:0,e[3]+=r[0]>0?this._totalOffset:0,e[4]+=r[1]>0?this._totalOffset:0,e[5]+=r[2]>0?this._totalOffset:0,e;let c=Wt(us,o,n),m=G(c),g=this._totalOffset/m,d=this._totalOffset/u;return e[0]+=t[0]*(t[0]>0?g:d),e[1]+=t[1]*(t[1]>0?g:d),e[2]+=t[2]*(t[2]>0?g:d),e[3]+=r[0]*(r[0]<0?g:d),e[4]+=r[1]*(r[1]<0?g:d),e[5]+=r[2]*(r[2]<0?g:d),e}applyToMbs(e){let t=G(e),r=this._totalOffset/t;return re(this._mbs,e,e,r),this._mbs[3]=e[3]+e[3]*this._totalOffset/t,this._mbs}applyToObb(e){return _r(e,this._totalOffset,this._totalOffset,ce.Global,this._obb),this._obb}},bt=class{constructor(e=0){this.offset=e,this.sphere=dt(),this.tmpVertex=O()}applyToVertex(e,t,r){let l=this.objectTransform.transform,i=Y(Xe,e,t,r),o=ye(i,i,l),n=this.offset/G(o);re(o,o,o,n);let a=this.objectTransform.inverse;return ye(this.tmpVertex,o,a),this.tmpVertex}applyToMinMax(e,t){let r=this.offset/G(e);re(e,e,e,r);let l=this.offset/G(t);re(t,t,t,l)}applyToAabb(e){let t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;let r=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*r,e[4]+=e[4]*r,e[5]+=e[5]*r,e}applyToBoundingSphere(e){let t=G(e),r=this.offset/t;return re(this.sphere,e,e,r),this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}},ls=new bt;function cs(s){return s!=null?(ls.offset=s,ls):null}var Oo=new vt;var Co=new At;var Xe=O(),Et=O(),ms=O(),fs=O(),hs=O(),Ks=O(),us=O();function ps(s,e,t){let{data:r,indices:l}=s,i=e.typedBuffer,o=e.typedBufferStride,n=l.length;t*=o;for(let a=0;a<n;++a){let u=2*l[a];i[t]=r[u],i[t+1]=r[u+1],t+=o}}function ds(s,e,t,r){let{data:l,indices:i}=s,o=e.typedBuffer,n=e.typedBufferStride,a=i.length;if(t*=n,r==null||r===1)for(let u=0;u<a;++u){let c=3*i[u];o[t]=l[c],o[t+1]=l[c+1],o[t+2]=l[c+2],t+=n}else for(let u=0;u<a;++u){let c=3*i[u];for(let m=0;m<r;++m)o[t]=l[c],o[t+1]=l[c+1],o[t+2]=l[c+2],t+=n}}function gs(s,e,t,r=1){let{data:l,indices:i}=s,o=e.typedBuffer,n=e.typedBufferStride,a=i.length;if(t*=n,r===1)for(let u=0;u<a;++u){let c=4*i[u];o[t]=l[c],o[t+1]=l[c+1],o[t+2]=l[c+2],o[t+3]=l[c+3],t+=n}else for(let u=0;u<a;++u){let c=4*i[u];for(let m=0;m<r;++m)o[t]=l[c],o[t+1]=l[c+1],o[t+2]=l[c+2],o[t+3]=l[c+3],t+=n}}function $s(s,e,t,r,l=1){if(!e)return void ds(s,t,r,l);let{data:i,indices:o}=s,n=t.typedBuffer,a=t.typedBufferStride,u=o.length,c=e[0],m=e[1],g=e[2],d=e[4],y=e[5],R=e[6],B=e[8],L=e[9],P=e[10],V=e[12],U=e[13],F=e[14];r*=a;let S=0,A=0,v=0,b=lt(e)?E=>{S=i[E]+V,A=i[E+1]+U,v=i[E+2]+F}:E=>{let x=i[E],w=i[E+1],T=i[E+2];S=c*x+d*w+B*T+V,A=m*x+y*w+L*T+U,v=g*x+R*w+P*T+F};if(l===1)for(let E=0;E<u;++E)b(3*o[E]),n[r]=S,n[r+1]=A,n[r+2]=v,r+=a;else for(let E=0;E<u;++E){b(3*o[E]);for(let x=0;x<l;++x)n[r]=S,n[r+1]=A,n[r+2]=v,r+=a}}function Ys(s,e,t,r,l=1){if(!e)return void ds(s,t,r,l);let{data:i,indices:o}=s,n=e,a=t.typedBuffer,u=t.typedBufferStride,c=o.length,m=n[0],g=n[1],d=n[2],y=n[4],R=n[5],B=n[6],L=n[8],P=n[9],V=n[10],U=!nt(n),F=1e-6,S=1-F;r*=u;let A=0,v=0,b=0,E=lt(n)?x=>{A=i[x],v=i[x+1],b=i[x+2]}:x=>{let w=i[x],T=i[x+1],M=i[x+2];A=m*w+y*T+L*M,v=g*w+R*T+P*M,b=d*w+B*T+V*M};if(l===1)if(U)for(let x=0;x<c;++x){E(3*o[x]);let w=A*A+v*v+b*b;if(w<S&&w>F){let T=1/Math.sqrt(w);a[r]=A*T,a[r+1]=v*T,a[r+2]=b*T}else a[r]=A,a[r+1]=v,a[r+2]=b;r+=u}else for(let x=0;x<c;++x)E(3*o[x]),a[r]=A,a[r+1]=v,a[r+2]=b,r+=u;else for(let x=0;x<c;++x){if(E(3*o[x]),U){let w=A*A+v*v+b*b;if(w<S&&w>F){let T=1/Math.sqrt(w);A*=T,v*=T,b*=T}}for(let w=0;w<l;++w)a[r]=A,a[r+1]=v,a[r+2]=b,r+=u}}function Qs(s,e,t,r,l=1){if(!e)return void gs(s,t,r,l);let{data:i,indices:o}=s,n=e,a=t.typedBuffer,u=t.typedBufferStride,c=o.length,m=n[0],g=n[1],d=n[2],y=n[4],R=n[5],B=n[6],L=n[8],P=n[9],V=n[10],U=!nt(n),F=1e-6,S=1-F;if(r*=u,l===1)for(let A=0;A<c;++A){let v=4*o[A],b=i[v],E=i[v+1],x=i[v+2],w=i[v+3],T=m*b+y*E+L*x,M=g*b+R*E+P*x,D=d*b+B*E+V*x;if(U){let z=T*T+M*M+D*D;if(z<S&&z>F){let $=1/Math.sqrt(z);T*=$,M*=$,D*=$}}a[r]=T,a[r+1]=M,a[r+2]=D,a[r+3]=w,r+=u}else for(let A=0;A<c;++A){let v=4*o[A],b=i[v],E=i[v+1],x=i[v+2],w=i[v+3],T=m*b+y*E+L*x,M=g*b+R*E+P*x,D=d*b+B*E+V*x;if(U){let z=T*T+M*M+D*D;if(z<S&&z>F){let $=1/Math.sqrt(z);T*=$,M*=$,D*=$}}for(let z=0;z<l;++z)a[r]=T,a[r+1]=M,a[r+2]=D,a[r+3]=w,r+=u}}function Zs(s,e,t,r,l=1){let{data:i,indices:o}=s,n=t.typedBuffer,a=t.typedBufferStride,u=o.length;if(r*=a,e!==i.length||e!==4)if(l!==1)if(e!==4)for(let c=0;c<u;++c){let m=3*o[c];for(let g=0;g<l;++g)n[r]=i[m],n[r+1]=i[m+1],n[r+2]=i[m+2],n[r+3]=255,r+=a}else for(let c=0;c<u;++c){let m=4*o[c];for(let g=0;g<l;++g)n[r]=i[m],n[r+1]=i[m+1],n[r+2]=i[m+2],n[r+3]=i[m+3],r+=a}else{if(e===4){for(let c=0;c<u;++c){let m=4*o[c];n[r]=i[m],n[r+1]=i[m+1],n[r+2]=i[m+2],n[r+3]=i[m+3],r+=a}return}for(let c=0;c<u;++c){let m=3*o[c];n[r]=i[m],n[r+1]=i[m+1],n[r+2]=i[m+2],n[r+3]=255,r+=a}}else{n[r]=i[0],n[r+1]=i[1],n[r+2]=i[2],n[r+3]=i[3];let c=new Uint32Array(t.typedBuffer.buffer,t.start),m=a/4,g=c[r/=4];r+=m;let d=u*l;for(let y=1;y<d;++y)c[r]=g,r+=m}}function Js(s,e,t){let{data:r,indices:l}=s,i=e.typedBuffer,o=e.typedBufferStride,n=l.length,a=r[0];t*=o;for(let u=0;u<n;++u)i[t]=a,t+=o}function ea(s,e,t,r,l=1){let i=e.typedBuffer,o=e.typedBufferStride;if(r*=o,l===1)for(let n=0;n<t;++n)i[r]=s[0],i[r+1]=s[1],i[r+2]=s[2],i[r+3]=s[3],r+=o;else for(let n=0;n<t;++n)for(let a=0;a<l;++a)i[r]=s[0],i[r+1]=s[1],i[r+2]=s[2],i[r+3]=s[3],r+=o}function Ts(s,e,t,r,l,i){for(let o of e.fields.keys()){let n=s.attributes.get(o),a=n?.indices;if(n&&a)ta(o,n,t,r,l,i);else if(o===_.OBJECTANDLAYERIDCOLOR&&s.objectAndLayerIdColor!=null){let u=s.attributes.get(_.POSITION)?.indices;if(u){let c=u.length,m=l.getField(o,ve);ea(s.objectAndLayerIdColor,m,c,i)}}}}function ta(s,e,t,r,l,i){switch(s){case _.POSITION:{I(e.size===3);let o=l.getField(s,Ae);I(!!o,`No buffer view for ${s}`),o&&$s(e,t,o,i);break}case _.NORMAL:{I(e.size===3);let o=l.getField(s,Ae);I(!!o,`No buffer view for ${s}`),o&&Ys(e,r,o,i);break}case _.NORMALCOMPRESSED:{I(e.size===2);let o=l.getField(s,rr);I(!!o,`No buffer view for ${s}`),o&&ps(e,o,i);break}case _.UV0:{I(e.size===2);let o=l.getField(s,Zt);I(!!o,`No buffer view for ${s}`),o&&ps(e,o,i);break}case _.COLOR:case _.SYMBOLCOLOR:{let o=l.getField(s,ve);I(!!o,`No buffer view for ${s}`),I(e.size===3||e.size===4),!o||e.size!==3&&e.size!==4||Zs(e,e.size,o,i);break}case _.COLORFEATUREATTRIBUTE:{let o=l.getField(s,Qt);I(!!o,`No buffer view for ${s}`),I(e.size===1),o&&e.size===1&&Js(e,o,i);break}case _.TANGENT:{I(e.size===4);let o=l.getField(s,Se);I(!!o,`No buffer view for ${s}`),o&&Qs(e,r,o,i);break}case _.PROFILERIGHT:case _.PROFILEUP:case _.PROFILEVERTEXANDNORMAL:case _.FEATUREVALUE:{I(e.size===4);let o=l.getField(s,Se);I(!!o,`No buffer view for ${s}`),o&&gs(e,o,i)}}}var Ke=class{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.attributes.get(_.POSITION).indices.length}write(e,t,r,l,i){Ts(r,this.vertexBufferLayout,e,t,l,i)}};var zo={func:Q.LESS},ko={func:Q.ALWAYS},xs={mask:255};var ys={function:{func:Q.ALWAYS,ref:ee.OutlineVisualElementMask,mask:ee.OutlineVisualElementMask},operation:{fail:H.KEEP,zFail:H.KEEP,zPass:H.ZERO}},_s={function:{func:Q.ALWAYS,ref:ee.OutlineVisualElementMask,mask:ee.OutlineVisualElementMask},operation:{fail:H.KEEP,zFail:H.KEEP,zPass:H.REPLACE}},Ho={function:{func:Q.EQUAL,ref:ee.OutlineVisualElementMask,mask:ee.OutlineVisualElementMask},operation:{fail:H.KEEP,zFail:H.KEEP,zPass:H.KEEP}},qo={function:{func:Q.NOTEQUAL,ref:ee.OutlineVisualElementMask,mask:ee.OutlineVisualElementMask},operation:{fail:H.KEEP,zFail:H.KEEP,zPass:H.KEEP}};function As({normalTexture:s,metallicRoughnessTexture:e,metallicFactor:t,roughnessFactor:r,emissiveTexture:l,emissiveFactor:i,occlusionTexture:o}){return s==null&&e==null&&l==null&&(i==null||$t(i,zt))&&o==null&&(r==null||r===1)&&(t==null||t===1||t===0)}var $e=[1,1,.5],vs=[0,.6,.2],bs=[0,1,.2];var Ye=class extends zr{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=Ce($e),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=q.Back,this.isInstanced=!1,this.hasInstancedColor=!1,this.emissiveFactor=Te(0,0,0),this.instancedDoublePrecision=!1,this.normalType=W.Attribute,this.receiveShadows=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=Te(.2,.2,.2),this.diffuse=Te(.8,.8,.8),this.externalColor=Yt(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=O(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.transparent=!1,this.writeDepth=!0,this.customDepthTest=oe.Less,this.textureAlphaMode=N.Blend,this.textureAlphaCutoff=.1,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=Br.Occlude,this.isDecoration=!1}};var fe=class s extends kr{initializeConfiguration(e,t){t.spherical=e.viewingMode===ce.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result,t.textureCoordinateType=t.hasColorTexture||t.hasMetallicRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture||t.hasNormalTexture?Ee.Default:Ee.None,t.objectAndLayerIdColorInstanced=t.instanced}initializeProgram(e){return this._initializeProgram(e,s.shader)}_initializeProgram(e,t){return new Hr(e.rctx,t.get().build(this.configuration),Mr)}_convertDepthTestFunction(e){return e===oe.Lequal?Q.LEQUAL:Q.LESS}_makePipeline(e,t){let r=this.configuration,l=e===Re.NONE,i=e===Re.FrontFace;return Vr({blending:r.output!==C.Color&&r.output!==C.Alpha||!r.transparent?null:l?Fr:Lr(e),culling:sa(r)?Pr(r.cullFace):null,depthTest:{func:Ur(e,this._convertDepthTestFunction(r.customDepthTest))},depthWrite:(l||i)&&r.writeDepth?Dr:null,colorWrite:Ir,stencilWrite:r.hasOccludees?xs:null,stencilTest:r.hasOccludees?t?_s:ys:null,polygonOffset:l||i?null:Gr(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}};function sa(s){return s.cullFace!==q.None||!s.hasSlicePlane&&!s.transparent&&!s.doubleSidedMode}fe.shader=new He(Wr,()=>import("./chunk-QDJPHUJX.js"));var he=class extends qr{};f([h({constValue:!0})],he.prototype,"hasSliceHighlight",void 0),f([h({constValue:!1})],he.prototype,"hasSliceInVertexProgram",void 0),f([h({constValue:Rr.Pass})],he.prototype,"pbrTextureBindType",void 0);var p=class extends he{constructor(){super(...arguments),this.output=C.Color,this.alphaDiscardMode=N.Opaque,this.doubleSidedMode=Z.None,this.pbrMode=me.Disabled,this.cullFace=q.None,this.transparencyPassType=Re.NONE,this.normalType=W.Attribute,this.textureCoordinateType=Ee.None,this.customDepthTest=oe.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.objectAndLayerIdColorInstanced=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1}};f([h({count:C.COUNT})],p.prototype,"output",void 0),f([h({count:N.COUNT})],p.prototype,"alphaDiscardMode",void 0),f([h({count:Z.COUNT})],p.prototype,"doubleSidedMode",void 0),f([h({count:me.COUNT})],p.prototype,"pbrMode",void 0),f([h({count:q.COUNT})],p.prototype,"cullFace",void 0),f([h({count:Re.COUNT})],p.prototype,"transparencyPassType",void 0),f([h({count:W.COUNT})],p.prototype,"normalType",void 0),f([h({count:Ee.COUNT})],p.prototype,"textureCoordinateType",void 0),f([h({count:oe.COUNT})],p.prototype,"customDepthTest",void 0),f([h()],p.prototype,"spherical",void 0),f([h()],p.prototype,"hasVertexColors",void 0),f([h()],p.prototype,"hasSymbolColors",void 0),f([h()],p.prototype,"hasVerticalOffset",void 0),f([h()],p.prototype,"hasSlicePlane",void 0),f([h()],p.prototype,"hasSliceHighlight",void 0),f([h()],p.prototype,"hasColorTexture",void 0),f([h()],p.prototype,"hasMetallicRoughnessTexture",void 0),f([h()],p.prototype,"hasEmissionTexture",void 0),f([h()],p.prototype,"hasOcclusionTexture",void 0),f([h()],p.prototype,"hasNormalTexture",void 0),f([h()],p.prototype,"hasScreenSizePerspective",void 0),f([h()],p.prototype,"hasVertexTangents",void 0),f([h()],p.prototype,"hasOccludees",void 0),f([h()],p.prototype,"multipassEnabled",void 0),f([h()],p.prototype,"hasModelTransformation",void 0),f([h()],p.prototype,"offsetBackfaces",void 0),f([h()],p.prototype,"vvSize",void 0),f([h()],p.prototype,"vvColor",void 0),f([h()],p.prototype,"receiveShadows",void 0),f([h()],p.prototype,"receiveAmbientOcclusion",void 0),f([h()],p.prototype,"textureAlphaPremultiplied",void 0),f([h()],p.prototype,"instanced",void 0),f([h()],p.prototype,"instancedColor",void 0),f([h()],p.prototype,"objectAndLayerIdColorInstanced",void 0),f([h()],p.prototype,"instancedDoublePrecision",void 0),f([h()],p.prototype,"doublePrecisionRequiresObfuscation",void 0),f([h()],p.prototype,"writeDepth",void 0),f([h()],p.prototype,"transparent",void 0),f([h()],p.prototype,"enableOffset",void 0),f([h()],p.prototype,"cullAboveGround",void 0),f([h()],p.prototype,"snowCover",void 0),f([h()],p.prototype,"hasColorTextureTransform",void 0),f([h()],p.prototype,"hasEmissionTextureTransform",void 0),f([h()],p.prototype,"hasNormalTextureTransform",void 0),f([h()],p.prototype,"hasOcclusionTextureTransform",void 0),f([h()],p.prototype,"hasMetallicRoughnessTextureTransform",void 0),f([h({constValue:!1})],p.prototype,"occlusionPass",void 0),f([h({constValue:!0})],p.prototype,"hasVvInstancing",void 0),f([h({constValue:!1})],p.prototype,"useCustomDTRExponentForWater",void 0),f([h({constValue:!1})],p.prototype,"supportsTextureAtlas",void 0),f([h({constValue:!0})],p.prototype,"useFillLights",void 0);var Ie=class s extends fe{initializeConfiguration(e,t){super.initializeConfiguration(e,t),t.hasMetallicRoughnessTexture=!1,t.hasEmissionTexture=!1,t.hasOcclusionTexture=!1,t.hasNormalTexture=!1,t.hasModelTransformation=!1,t.normalType=W.Attribute,t.doubleSidedMode=Z.WindingOrder,t.hasVertexTangents=!1}initializeProgram(e){return this._initializeProgram(e,s.shader)}};Ie.shader=new He(jr,()=>import("./chunk-L4L5OGLN.js"));var le=class extends Sr{constructor(e){super(e,aa),this.supportsEdges=!0,this._configuration=new p,this._vertexBufferLayout=oa(this.parameters)}isVisibleForOutput(e){return e!==C.Shadow&&e!==C.ShadowExcludeHighlight&&e!==C.ShadowHighlight||this.parameters.castShadows}isVisible(){let e=this.parameters;if(!super.isVisible()||e.layerOpacity===0)return!1;let{hasInstancedColor:t,hasVertexColors:r,hasSymbolColors:l,vvColor:i}=e,o=e.colorMixMode==="replace",n=e.opacity>0,a=e.externalColor&&e.externalColor[3]>0,u=t||i||l;return r&&u?o||n:r?o?a:n:u?o||n:o?a:n}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=this.parameters.isInstanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this.parameters.customDepthTest!=null&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?q.None:this.parameters.cullFace,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=this.parameters.modelTransformation!=null,e!==C.Color&&e!==C.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=Z.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?Z.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?Z.WindingOrder:Z.None,this._configuration.instancedColor=this.parameters.hasInstancedColor,this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=t.ssao!=null,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?me.Schematic:me.Normal:me.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Nr,this._configuration.snowCover=this.hasSnowCover(t),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}intersect(e,t,r,l,i,o){if(this.parameters.verticalOffset!=null){let n=r.camera;Y(wt,t[12],t[13],t[14]);let a=null;switch(r.viewingMode){case ce.Global:a=Le(Es,wt);break;case ce.Local:a=kt(Es,la)}let u=0,c=xe(ua,wt,n.eye),m=G(c),g=ot(c,c,1/m),d=null;this.parameters.screenSizePerspective&&(d=jt(a,g)),u+=Cr(n,m,this.parameters.verticalOffset,d??0,this.parameters.screenSizePerspective),ot(a,a,u),Kt(Rt,a,r.transform.inverseRotation),l=xe(ia,l,Rt),i=xe(na,i,Rt)}Or(e,r,l,i,cs(r.verticalOffset),o)}produces(e,t){return t===C.Color||t===C.Alpha||t===C.Depth||t===C.Normal||t===C.Shadow||t===C.ShadowHighlight||t===C.ShadowExcludeHighlight||t===C.Highlight||t===C.ObjectAndLayerIdColor?e===(this.parameters.transparent?this.parameters.writeDepth?Be.TRANSPARENT_MATERIAL:Be.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Be.OPAQUE_MATERIAL)||e===Be.DRAPED_MATERIAL:!1}createGLMaterial(e){return new Mt(e)}createBufferWriter(){return new Ke(this._vertexBufferLayout)}},Mt=class extends wr{constructor(e){super(j(j({},e),e.material.parameters))}_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==C.Color&&this._output!==C.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e));let t=this._material.parameters;this.updateTexture(t.textureId);let r=e.camera.viewInverseTransposeMatrix;return Y(t.origin,r[3],r[7],r[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(t.treeRendering?Ie:fe,e)}},Ot=class extends Ye{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}},aa=new Ot;function oa(s){let e=sr().vec3f(_.POSITION);return s.normalType===W.Compressed?e.vec2i16(_.NORMALCOMPRESSED,{glNormalized:!0}):e.vec3f(_.NORMAL),s.hasVertexTangents&&e.vec4f(_.TANGENT),(s.textureId||s.normalTextureId||s.metallicRoughnessTextureId||s.emissiveTextureId||s.occlusionTextureId)&&e.vec2f(_.UV0),s.hasVertexColors&&e.vec4u8(_.COLOR),s.hasSymbolColors&&e.vec4u8(_.SYMBOLCOLOR),Ct("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(_.OBJECTANDLAYERIDCOLOR),e}var ia=O(),na=O(),la=Te(0,0,1),Es=O(),Rt=O(),wt=O(),ua=O();var te=Fe.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");function Rs(s,e){return k(this,null,function*(){let t=yield ca(s,e),r=yield pa(t.textureDefinitions??{},e),l=0;for(let i in r)if(r.hasOwnProperty(i)){let o=r[i];l+=o?.image?o.image.width*o.image.height*4:0}return{resource:t,textures:r,size:l+St(t)}})}function ca(s,e){return k(this,null,function*(){let t=e?.streamDataRequester;if(t)return ma(s,t,e);let r=yield tt(Ut(s,e));if(r.ok===!0)return r.value.data;Je(r.error),ws(r.error)})}function ma(s,e,t){return k(this,null,function*(){let r=yield tt(e.request(s,"json",t));if(r.ok===!0)return r.value;Je(r.error),ws(r.error.details.url)})}function ws(s){throw new ge("",`Request for object resource failed: ${s}`)}function fa(s){let e=s.params,t=e.topology,r=!0;switch(e.vertexAttributes||(te.warn("Geometry must specify vertex attributes"),r=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{let i=e.faces;if(i){if(e.vertexAttributes)for(let o in e.vertexAttributes){let n=i[o];n?.values?(n.valueType!=null&&n.valueType!=="UInt32"&&(te.warn(`Unsupported indexed geometry indices type '${n.valueType}', only UInt32 is currently supported`),r=!1),n.valuesPerElement!=null&&n.valuesPerElement!==1&&(te.warn(`Unsupported indexed geometry values per element '${n.valuesPerElement}', only 1 is currently supported`),r=!1)):(te.warn(`Indexed geometry does not specify face indices for '${o}' attribute`),r=!1)}}else te.warn("Indexed geometries must specify faces"),r=!1;break}default:te.warn(`Unsupported topology '${t}'`),r=!1}s.params.material||(te.warn("Geometry requires material"),r=!1);let l=s.params.vertexAttributes;for(let i in l)l[i].values||(te.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function Ms(s,e){let t=new Array,r=new Array,l=new Array,i=new vr,o=s.resource,n=pt.parse(o.version||"1.0","wosr");ga.validate(n);let a=o.model.name,u=o.model.geometries,c=o.materialDefinitions??{},m=s.textures,g=0,d=new Map;for(let y=0;y<u.length;y++){let R=u[y];if(!fa(R))continue;let B=da(R),L=R.params.vertexAttributes,P=[],V=T=>{if(R.params.topology==="PerAttributeArray")return null;let M=R.params.faces;for(let D in M)if(D===T)return M[D].values;return null},U=L[_.POSITION],F=U.values.length/U.valuesPerElement;for(let T in L){let M=L[T],D=M.values,z=V(T)??ar(F);P.push([T,new ae(D,z,M.valuesPerElement,!0)])}let S=B.texture,A=m&&m[S];if(A&&!d.has(S)){let{image:T,parameters:M}=A,D=new Me(T,M);r.push(D),d.set(S,D)}let v=d.get(S),b=v?v.id:void 0,E=B.material,x=i.get(E,S);if(x==null){let T=c[E.substring(E.lastIndexOf("/")+1)].params;T.transparency===1&&(T.transparency=0);let M=A&&A.alphaChannelUsage,D=T.transparency>0||M==="transparency"||M==="maskAndTransparency",z=A?Os(A.alphaChannelUsage):void 0,$={ambient:Ce(T.diffuse),diffuse:Ce(T.diffuse),opacity:1-(T.transparency||0),transparent:D,textureAlphaMode:z,textureAlphaCutoff:.33,textureId:b,initTextureTransparent:!0,doubleSided:!0,cullFace:q.None,colorMixMode:T.externalColorMixMode||"tint",textureAlphaPremultiplied:A?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign($,e.materialParameters),x=new le($),i.set(E,S,x)}l.push(x);let w=new Ge(x,P);g+=P.find(T=>T[0]===_.POSITION)?.[1]?.indices.length??0,t.push(w)}return{engineResources:[{name:a,stageResources:{textures:r,materials:l,geometries:t},pivotOffset:o.model.pivotOffset,numberOfVertices:g,lodThreshold:null}],referenceBoundingBox:ha(t)}}function ha(s){let e=Ne();return s.forEach(t=>{let r=t.boundingInfo;r!=null&&(_e(e,r.bbMin),_e(e,r.bbMax))}),e}function pa(s,e){return k(this,null,function*(){let t=new Array;for(let i in s){let o=s[i],n=o.images[0].data;if(!n){te.warn("Externally referenced texture data is not yet supported");continue}let a=o.encoding+";base64,"+n,u="/textureDefinitions/"+i,c=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",m={noUnpackFlip:!0,wrap:{s:ue.REPEAT,t:ue.REPEAT},preMultiplyAlpha:Os(c)!==N.Opaque},g=e!=null&&e.disableTextures?Promise.resolve(null):ke(a,e);t.push(g.then(d=>({refId:u,image:d,parameters:m,alphaChannelUsage:c})))}let r=yield Promise.all(t),l={};for(let i of r)l[i.refId]=i;return l})}function Os(s){switch(s){case"mask":return N.Mask;case"maskAndTransparency":return N.MaskBlend;case"none":return N.Opaque;default:return N.Blend}}function da(s){let e=s.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}var ga=new pt(1,2,"wosr");function ll(s,e){return k(this,null,function*(){let t=Ta(ur(s));if(t.fileType==="wosr"){let m=yield e.cache?e.cache.loadWOSR(t.url,e):Rs(t.url,e),{engineResources:g,referenceBoundingBox:d}=Ms(m,e);return{lods:g,referenceBoundingBox:d,isEsriSymbolResource:!1,isWosr:!0}}let r=yield e.cache?e.cache.loadGLTF(t.url,e,!!e.usePBR):Tr(new gr(e.streamDataRequester),t.url,e,e.usePBR),l=r.model.meta?.ESRI_proxyEllipsoid,i=r.meta.isEsriSymbolResource&&l!=null&&r.meta.uri.includes("/RealisticTrees/");i&&!r.customMeta.esriTreeRendering&&(r.customMeta.esriTreeRendering=!0,va(r,l));let o=!!e.usePBR,n=r.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:i,mrrFactors:[...bs]}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:[...$e]},a=Ve(j({},e.materialParameters),{treeRendering:i}),{engineResources:u,referenceBoundingBox:c}=xa(r,n,a,e.skipHighLods&&t.specifiedLodIndex==null?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:t.specifiedLodIndex});return{lods:u,referenceBoundingBox:c,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1}})}function Ta(s){let e=s.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:s.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:s,specifiedLodIndex:null}:{fileType:"unknown",url:s,specifiedLodIndex:null}}function xa(s,e,t,r){let l=s.model,i=new Array,o=new Map,n=new Map,a=l.lods.length,u=Ne();return l.lods.forEach((c,m)=>{let g=r.skipHighLods===!0&&(a>1&&m===0||a>3&&m===1)||r.skipHighLods===!1&&r.singleLodIndex!=null&&m!==r.singleLodIndex;if(g&&m!==0)return;let d=new qe(c.name,c.lodThreshold,[0,0,0]);c.parts.forEach(y=>{let R=g?new le({}):ya(l,y,d,e,t,o,n),{geometry:B,vertexCount:L}=_a(y,R??new le({})),P=B.boundingInfo;P!=null&&m===0&&(_e(u,P.bbMin),_e(u,P.bbMax)),R!=null&&(d.stageResources.geometries.push(B),d.numberOfVertices+=L)}),g||i.push(d)}),{engineResources:i,referenceBoundingBox:u}}function ya(s,e,t,r,l,i,o){let n=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),a=s.materials.get(e.material),u=e.attributes.texCoord0!=null,c=e.attributes.normal!=null;if(a==null)return null;let m=Aa(a.alphaMode);if(!i.has(n)){if(u){let F=(S,A=!1)=>{if(S!=null&&!o.has(S)){let v=s.textures.get(S);if(v!=null){let b=v.data;o.set(S,new Me(Ue(b)?b.data:b,Ve(j({},v.parameters),{preMultiplyAlpha:!Ue(b)&&A,encoding:Ue(b)&&b.encoding!=null?b.encoding:void 0})))}}};F(a.textureColor,m!==N.Opaque),F(a.textureNormal),F(a.textureOcclusion),F(a.textureEmissive),F(a.textureMetallicRoughness)}let d=a.color[0]**(1/2.1),y=a.color[1]**(1/2.1),R=a.color[2]**(1/2.1),B=a.emissiveFactor[0]**(1/2.1),L=a.emissiveFactor[1]**(1/2.1),P=a.emissiveFactor[2]**(1/2.1),V=a.textureColor!=null&&u?o.get(a.textureColor):null,U=As({normalTexture:a.textureNormal,metallicRoughnessTexture:a.textureMetallicRoughness,metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,emissiveTexture:a.textureEmissive,emissiveFactor:a.emissiveFactor,occlusionTexture:a.textureOcclusion});i.set(n,new le(j(Ve(j({},r),{transparent:m===N.Blend,customDepthTest:oe.Lequal,textureAlphaMode:m,textureAlphaCutoff:a.alphaCutoff,diffuse:[d,y,R],ambient:[d,y,R],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",cullFace:a.doubleSided?q.None:q.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:c?W.Attribute:W.ScreenDerivative,castShadows:!0,textureId:V?.id,colorMixMode:a.colorMixMode,normalTextureId:a.textureNormal!=null&&u?o.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:V!=null&&!!V.parameters.preMultiplyAlpha,occlusionTextureId:a.textureOcclusion!=null&&u?o.get(a.textureOcclusion).id:void 0,emissiveTextureId:a.textureEmissive!=null&&u?o.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:a.textureMetallicRoughness!=null&&u?o.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[B,L,P],mrrFactors:U?[...vs]:[a.metallicFactor,a.roughnessFactor,r.mrrFactors[2]],isSchematic:U,colorTextureTransformMatrix:we(a.colorTextureTransform),normalTextureTransformMatrix:we(a.normalTextureTransform),occlusionTextureTransformMatrix:we(a.occlusionTextureTransform),emissiveTextureTransformMatrix:we(a.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:we(a.metallicRoughnessTextureTransform)}),l)))}let g=i.get(n);if(t.stageResources.materials.push(g),u){let d=y=>{y!=null&&t.stageResources.textures.push(o.get(y))};d(a.textureColor),d(a.textureNormal),d(a.textureOcclusion),d(a.textureEmissive),d(a.textureMetallicRoughness)}return g}function _a(s,e){let t=s.attributes.position.count,r=xr(s.indices||t,s.primitiveType),l=Pe(3*t),{typedBuffer:i,typedBufferStride:o}=s.attributes.position;or(l,i,s.transform,3,o);let n=[[_.POSITION,new ae(l,r,3,!0)]];if(s.attributes.normal!=null){let a=Pe(3*t),{typedBuffer:u,typedBufferStride:c}=s.attributes.normal;ft(Qe,s.transform),ir(a,u,Qe,3,c),n.push([_.NORMAL,new ae(a,r,3,!0)])}if(s.attributes.tangent!=null){let a=Pe(4*t),{typedBuffer:u,typedBufferStride:c}=s.attributes.tangent;ft(Qe,s.transform),fr(a,u,Qe,4,c),n.push([_.TANGENT,new ae(a,r,4,!0)])}if(s.attributes.texCoord0!=null){let a=Pe(2*t),{typedBuffer:u,typedBufferStride:c}=s.attributes.texCoord0;hr(a,u,2,c),n.push([_.UV0,new ae(a,r,2,!0)])}if(s.attributes.color!=null){let a=new Uint8Array(4*t);s.attributes.color.elementCount===4?s.attributes.color instanceof Se?gt(a,s.attributes.color,255):s.attributes.color instanceof ve?dr(a,s.attributes.color):s.attributes.color instanceof tr&&gt(a,s.attributes.color,1/256):(a.fill(255),s.attributes.color instanceof Ae?ht(a,s.attributes.color,255,4):s.attributes.color instanceof Jt?pr(a,s.attributes.color.typedBuffer,4,s.attributes.color.typedBufferStride):s.attributes.color instanceof er&&ht(a,s.attributes.color,1/256,4)),n.push([_.COLOR,new ae(a,r,4,!0)])}return{geometry:new Ge(e,n),vertexCount:t}}var Qe=ut();function Aa(s){switch(s){case"BLEND":return N.Blend;case"MASK":return N.Mask;case"OPAQUE":case null:case void 0:return N.Opaque}}function va(s,e){for(let t=0;t<s.model.lods.length;++t){let r=s.model.lods[t];for(let l of r.parts){let i=l.attributes.normal;if(i==null)return;let o=l.attributes.position,n=o.count,a=O(),u=O(),c=O(),m=new Uint8Array(4*n),g=new Float64Array(3*n),d=it(ct(),l.transform),y=0,R=0;for(let B=0;B<n;B++){o.getVec(B,u),i.getVec(B,a),ye(u,u,l.transform),xe(c,u,e.center),rt(c,c,e.radius);let L=c[2],P=G(c),V=Math.min(.45+.55*P*P,1);rt(c,c,e.radius),d!==null&&ye(c,c,d),Le(c,c),t+1!==s.model.lods.length&&s.model.lods.length>1&&Xt(c,c,a,L>-1?.2:Math.min(-4*L-3.8,1)),g[y]=c[0],g[y+1]=c[1],g[y+2]=c[2],y+=3,m[R]=255*V,m[R+1]=255*V,m[R+2]=255*V,m[R+3]=255,R+=4}l.attributes.normal=new Ae(g),l.attributes.color=new ve(m)}}}export{ll as fetch,xa as gltfToEngineResources,Ta as parseUrl};
