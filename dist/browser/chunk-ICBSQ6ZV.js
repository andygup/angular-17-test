import{a as J}from"./chunk-YW3L7OMP.js";import{a as N}from"./chunk-V2JYXY4D.js";import{a as R}from"./chunk-QAVDKCSH.js";import{a as F,g as H}from"./chunk-CBOFHDSC.js";import{$ as _,i as j}from"./chunk-XF4NUYV7.js";import{H as w,K as k,v as P}from"./chunk-WMYPRHRR.js";import{R as E,s as U}from"./chunk-IAMDMFZ7.js";import{a as d}from"./chunk-53MWZ23O.js";import{a as x,h as C,j as I,m as M,p as T}from"./chunk-PT7S6WNL.js";import{b as q,r as m}from"./chunk-465DRXTW.js";import{E as z,G as L,i as S}from"./chunk-AC62Z3FX.js";import{a as v,b as g,g as $}from"./chunk-ESDYQQXO.js";function K(e,i=!1){return e<=L?i?new Array(e).fill(0):new Array(e):new Uint32Array(e)}var b=class e{constructor(i){this._validateJSON(i);let{location:a,data:t}=i;this.location=Object.freeze(q(a));let r=this.location.width,o=this.location.height,s=!0,n=!0,c=Math.ceil(r*o/32),l=K(c),h=0;for(let f=0;f<t.length;f++){let u=f%32;t[f]?(n=!1,l[h]|=1<<u):s=!1,u===31&&++h}n?(this._availability="unavailable",this.byteSize=40):s?(this._availability="available",this.byteSize=40):(this._availability=l,this.byteSize=40+z(l))}getAvailability(i,a){if(this._availability==="unavailable"||this._availability==="available")return this._availability;let t=(i-this.location.top)*this.location.width+(a-this.location.left),r=t%32,o=t>>5,s=this._availability;return o<0||o>s.length?"unknown":s[o]&1<<r?"available":"unavailable"}static fromDefinition(i,a){let t=i.service.request||_,{row:r,col:o,width:s,height:n}=i,c={query:{f:"json"}};return a=a?v(v({},c),a):c,t(G(i),a).then(l=>l.data).catch(l=>{if(l&&l.details&&l.details.httpStatus===422)return{location:{top:r,left:o,width:s,height:n},valid:!0,data:S(s*n,0)};throw l}).then(l=>{if(l.location&&(l.location.top!==r||l.location.left!==o||l.location.width!==s||l.location.height!==n))throw new m("tilemap:location-mismatch","Tilemap response for different location than requested",{response:l,definition:{top:r,left:o,width:s,height:n}});return e.fromJSON(l)})}static fromJSON(i){return Object.freeze(new e(i))}_validateJSON(i){if(!i?.location)throw new m("tilemap:missing-location","Location missing from tilemap response");if(i.valid===!1)throw new m("tilemap:invalid","Tilemap response was marked as invalid");if(!i.data)throw new m("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(i.data))throw new m("tilemap:data-mismatch","Data must be an array of numbers");if(i.data.length!==i.location.width*i.location.height)throw new m("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}};function D(e){return`${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}function G(e){let i;if(e.service.tileServers?.length){let t=e.service.tileServers;i=`${t&&t.length?t[e.row%t.length]:e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}else i=`${e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`;let a=e.service.query;return a&&(i=`${i}?${a}`),i}var y,p=y=class extends k{constructor(e){super(e),this._pendingTilemapRequests={},this.request=_,this.size=32,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new R(2*J.MEGABYTES),this.addHandles([F(()=>{let{layer:e}=this;return[e?.parsedUrl,e?.tileServers,e?.apiKey,e?.customParameters]},()=>this._initializeTilemapDefinition(),H)])}get effectiveMinLOD(){return this.minLOD??this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}fetchTilemap(e,i,a,t){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return Promise.reject(new m("tilemap-cache:level-unavailable",`Level ${e} is unavailable in the service`));let r=this._tmpTilemapDefinition,o=this._tilemapFromCache(e,i,a,r);if(o)return Promise.resolve(o);let s=t?.signal;return t=g(v({},t),{signal:null}),new Promise((n,c)=>{M(s,()=>c(C()));let l=D(r),h=this._pendingTilemapRequests[l];if(!h){h=b.fromDefinition(r,t).then(u=>(this._tilemapCache.put(l,u,u.byteSize),u));let f=()=>{delete this._pendingTilemapRequests[l]};this._pendingTilemapRequests[l]=h,h.then(f,f)}h.then(n,c)})}getAvailability(e,i,a){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return"unavailable";let t=this._tilemapFromCache(e,i,a,this._tmpTilemapDefinition);return t?t.getAvailability(i,a):"unknown"}fetchAvailability(e,i,a,t){return!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(new m("tile-map:tile-unavailable","Tile is not available",{level:e,row:i,col:a})):this.fetchTilemap(e,i,a,t).catch(r=>r).then(r=>{if(r instanceof b){let o=r.getAvailability(i,a);if(o==="unavailable")throw new m("tile-map:tile-unavailable","Tile is not available",{level:e,row:i,col:a});return o}if(T(r))throw r;return"unknown"})}fetchAvailabilityUpsample(e,i,a,t,r){t.level=e,t.row=i,t.col=a;let o=this.layer.tileInfo;o.updateTileInfo(t);let s=this.fetchAvailability(e,i,a,r).catch(n=>{if(T(n))throw n;if(o.upsampleTile(t))return this.fetchAvailabilityUpsample(t.level,t.row,t.col,t,r);throw n});return this._fetchAvailabilityUpsamplePrefetch(t.id,e,i,a,r,s),s}_fetchAvailabilityUpsamplePrefetch(e,i,a,t,r,o){return $(this,null,function*(){if(!this._prefetchingEnabled||e==null)return;let s=`prefetch-${e}`;if(this.hasHandles(s))return;let n=new AbortController;o.then(()=>n.abort(),()=>n.abort());let c=!1,l=x(()=>{c||(c=!0,n.abort())});if(this.addHandles(l,s),yield P(10,n.signal).catch(()=>{}),c||(c=!0,this.removeHandles(s)),I(n))return;let h=new N(e,i,a,t),f=g(v({},r),{signal:n.signal}),u=this.layer.tileInfo;for(let B=0;y._prefetches.length<y._maxPrefetch&&u.upsampleTile(h);++B){let A=this.fetchAvailability(h.level,h.row,h.col,f);y._prefetches.push(A);let O=()=>{y._prefetches.removeUnordered(A)};A.then(O,O)}})}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;let{parsedUrl:e,apiKey:i,customParameters:a}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:j(g(v(v({},e.query),a),{token:i??e.query?.token})),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,i,a,t){t.level=e,t.row=i-i%this.size,t.col=a-a%this.size;let r=D(t);return this._tilemapCache.get(r)}get test(){let e=this;return{get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(i){e._prefetchingEnabled=i},hasTilemap:(i,a,t)=>!!e._tilemapFromCache(i,a,t,e._tmpTilemapDefinition)}}};p._maxPrefetch=4,p._prefetches=new U({initialSize:y._maxPrefetch}),d([w({constructOnly:!0})],p.prototype,"layer",void 0),d([w({constructOnly:!0})],p.prototype,"minLOD",void 0),d([w({constructOnly:!0})],p.prototype,"maxLOD",void 0),d([w({constructOnly:!0})],p.prototype,"request",void 0),d([w({constructOnly:!0})],p.prototype,"size",void 0),p=y=d([E("esri.layers.support.TilemapCache")],p);export{p as a};
