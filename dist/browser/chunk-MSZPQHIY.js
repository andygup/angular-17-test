import{a as U,b as ts,c as rs}from"./chunk-H2E4J3PF.js";import"./chunk-G7TZLWYD.js";import{j as lt}from"./chunk-MUAFIF7E.js";import{a as ss,b as xe,c as we}from"./chunk-DY5KXHAV.js";import{a as es}from"./chunk-74AE6XLP.js";import{a as Je,b as Wt,c as Ze,d as Kt}from"./chunk-RC3TET2J.js";import{b as dt}from"./chunk-N77PCW3L.js";import{a as ge}from"./chunk-G3LBVS5W.js";import{e as Jt}from"./chunk-NTXQ55BD.js";import"./chunk-EKY6QR7N.js";import"./chunk-NKBP5F7I.js";import"./chunk-EEYJPINK.js";import"./chunk-BZEC7TCW.js";import"./chunk-MBI4IOAA.js";import{c as N}from"./chunk-GIHBFCPM.js";import"./chunk-W5OI4BJ2.js";import"./chunk-TKTKGUCU.js";import{a as ut,c as Xt}from"./chunk-BSQ5TFLX.js";import"./chunk-DDZ3KR2Q.js";import"./chunk-LYLAJHBR.js";import{b as Ht,c as Vt}from"./chunk-JHWJLQOC.js";import{a as Nt}from"./chunk-DTWRSK4M.js";import"./chunk-VFGTXZIM.js";import"./chunk-PQYE2TOR.js";import{a as ht}from"./chunk-C3SRECOD.js";import"./chunk-MCO7DSFO.js";import"./chunk-3CZHUHY5.js";import{a as Xe,b as te}from"./chunk-G7LWVLCX.js";import"./chunk-HHJJPMV6.js";import{a as Ne,b as He,d as Qt,i as be,k as Bt,p as Se,r as zt,t as ot,u as Re,w as Ve,x as Dt}from"./chunk-M3GEY4SR.js";import"./chunk-7QY3BMVN.js";import{a as ve,c as Gt}from"./chunk-4HXOVZYF.js";import{a as L}from"./chunk-U2QVIRVP.js";import"./chunk-ATSTMTT4.js";import"./chunk-OVKL2WYY.js";import"./chunk-JKNGMCUA.js";import{a as nt}from"./chunk-VXOK76QV.js";import"./chunk-FYZRIMPP.js";import{a as is}from"./chunk-AM2AYMN3.js";import{a as $t}from"./chunk-RH6QQ4K6.js";import{h as as}from"./chunk-DR5NPQZL.js";import{a as Zt}from"./chunk-OKLB3DLR.js";import{a as Ee}from"./chunk-DWZPFSNU.js";import"./chunk-MCIUWLYC.js";import"./chunk-EEZEB3RB.js";import"./chunk-45GFWXQC.js";import{a as le,b as Yt,c as ce}from"./chunk-AUVYUYNK.js";import{a as Ye}from"./chunk-RCWJNG4Z.js";import{b as Pt}from"./chunk-HUZLTBDZ.js";import"./chunk-V2JYXY4D.js";import{c as jt}from"./chunk-TJ3KO5EG.js";import"./chunk-FC6HKZZX.js";import{a as Lt}from"./chunk-LGGJOMLJ.js";import"./chunk-6N5DPLFH.js";import{f as De}from"./chunk-HI2T2YSZ.js";import"./chunk-O5K35OSE.js";import"./chunk-D6LLE2YP.js";import"./chunk-O5IGEGOS.js";import"./chunk-2UDQ3IWX.js";import"./chunk-MXH75ZNY.js";import"./chunk-PQKTT6AH.js";import"./chunk-OM24DGCK.js";import"./chunk-YQRTHGFD.js";import{a as V}from"./chunk-EDSVJRYE.js";import"./chunk-TQYOVOJO.js";import"./chunk-QAVDKCSH.js";import"./chunk-H2AOS66Z.js";import"./chunk-VGGNZXSE.js";import"./chunk-YH4Z47PR.js";import{a as je}from"./chunk-CJJRHJ2S.js";import"./chunk-HZP7XBNB.js";import"./chunk-YUZT5LSA.js";import"./chunk-725QQXBM.js";import"./chunk-ZYPPRX53.js";import"./chunk-574KRDZU.js";import"./chunk-2APWMENK.js";import"./chunk-ZWFVPWKA.js";import"./chunk-JOYABHZZ.js";import"./chunk-IEXZWAIE.js";import"./chunk-VDN3XKL2.js";import"./chunk-SVEGZVCP.js";import"./chunk-AQ74ANSJ.js";import"./chunk-SAOUSUZE.js";import"./chunk-6MGDEI2H.js";import"./chunk-QSGARGRB.js";import"./chunk-SREKDU6P.js";import"./chunk-IXIJFOEL.js";import"./chunk-QZ4L25WE.js";import"./chunk-4ATIL3QV.js";import"./chunk-WUM4JBII.js";import"./chunk-URUYU25U.js";import"./chunk-3S2DT2SI.js";import"./chunk-7PPV2CP7.js";import{s as ze}from"./chunk-U62SHMHB.js";import"./chunk-55ESOXMJ.js";import"./chunk-BCREO4Q5.js";import{b as Ut}from"./chunk-EJ3VIBAJ.js";import"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import{a as Ie,b as qt,d as qe}from"./chunk-CBOFHDSC.js";import"./chunk-HB7BVTLV.js";import"./chunk-WZKL6OPG.js";import"./chunk-WF37UVOV.js";import{c as Rt}from"./chunk-UZQ577CU.js";import"./chunk-FC3MPJI4.js";import{a as ye}from"./chunk-5ETRXDS4.js";import"./chunk-QDNKD3H5.js";import"./chunk-F72O5PVM.js";import"./chunk-B4PK7RBX.js";import"./chunk-6J4Y65BV.js";import"./chunk-RXHILZH7.js";import"./chunk-REI3KXR7.js";import"./chunk-URPCXPAW.js";import"./chunk-KBFIYTBH.js";import"./chunk-PEPXQ7N3.js";import"./chunk-VU5W7W6Y.js";import{j as Be}from"./chunk-6QIKBCPR.js";import"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import{b as J}from"./chunk-A52LT7YB.js";import{a as W,n as Ot,o as Qe}from"./chunk-CZPMRK53.js";import"./chunk-IDSF2RZ6.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import{$ as Et}from"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import{H as P,K as _e}from"./chunk-WMYPRHRR.js";import{R as ne}from"./chunk-IAMDMFZ7.js";import{a as q}from"./chunk-53MWZ23O.js";import{b as Mt,h as kt,i as B,l as de,p as oe,q as me,s as At,v as Le,z as Ge}from"./chunk-PT7S6WNL.js";import{a as Ae}from"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import{p as $,r as ae}from"./chunk-465DRXTW.js";import{a as C,b as Ct,p as Pe}from"./chunk-AC62Z3FX.js";import{a as F,b as A,f as Ue,g}from"./chunk-ESDYQQXO.js";function os(i){return i==="heatmap"?import("./chunk-EAA2BU67.js"):import("./chunk-UV56CVOK.js")}var ct=268435455,gt=class{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}};function ns(i,e,t=!1){let h=i.asUnsafe(),l=h.pos(),d=new gt,c=0,m=0,_=1,p=2,f=4,b=3,I=null,x=null,y=null,v=!1,S=[];for(;h.next();)switch(h.tag()){case 1:I=h.getString();break;case 3:x=h.getString();break;case 12:y=h.processMessage(Vt);break;case 9:if(d.exceededTransferLimit=h.getBool(),d.exceededTransferLimit){d.offsets.geometry=t?new Float64Array(8e3):new Int32Array(8e3),d.centroid=t?new Float64Array(16e3):new Int32Array(16e3);for(let k=0;k<d.centroid.length;k++)d.centroid[k]=ct}break;case 13:{let k=h.processMessage(Ht);k.index=c++,S.push(k);break}case 15:{let k=h.getLength(),O=h.pos()+k;if(!d.exceededTransferLimit){let T=d.offsets.geometry,R=d.centroid;T.push(0),R.push(ct),R.push(ct)}!v&&d.exceededTransferLimit&&(v=!0,d.offsets.attributes=t?new Float64Array(8e3*c):new Uint32Array(8e3*c));let M=m*c;for(;h.pos()<O&&h.next();)switch(h.tag()){case _:{v?d.offsets.attributes[M++]=h.pos():d.offsets.attributes.push(h.pos());let T=h.getLength();h.skipLen(T);break}case p:if(e){let T=h.getLength(),R=h.pos()+T;for(;h.pos()<R&&h.next();)switch(h.tag()){case b:{h.getUInt32();let G=h.getSInt64(),Q=h.getSInt64();d.centroid[2*m]=G,d.centroid[2*m+1]=Q;break}default:h.skip()}}else{d.offsets.geometry[m]=h.pos();let T=h.getLength();d.vertexCount+=T,h.skipLen(T)}break;case f:{let T=h.getLength(),R=h.pos()+T;for(;h.pos()<R&&h.next();)switch(h.tag()){case b:{h.getUInt32();let G=h.getSInt64(),Q=h.getSInt64();d.centroid[2*m]=G,d.centroid[2*m+1]=Q;break}default:h.skip()}break}default:h.skip()}m++,d.hasFeatures=!0;break}default:h.skip()}let w=I||x;if(!w)throw new ae("FeatureSet has no objectId or globalId field name");return d.fields=new V(S),d.featureCount=m,d.fieldCount=c,d.objectIdFieldIndex=d.fields.get(w)?.index,d.transform=y,d.displayIds=new Uint32Array(d.featureCount),d.groupIds=new Uint16Array(d.featureCount),h.move(l),d}var ws=!0,pt=268435455,hs=128,us=128e3,Fe={small:{delta:new Int32Array(hs),decoded:new Int32Array(hs)},large:{delta:new Int32Array(us),decoded:new Int32Array(us)}};function ds(i){return i<=Fe.small.delta.length?Fe.small:(i<=Fe.large.delta.length||(Fe.large.delta=new Int32Array(Math.round(1.25*i)),Fe.large.decoded=new Int32Array(Math.round(1.25*i))),Fe.large)}function Fs(i){try{let t=new Nt(new Uint8Array(i),new DataView(i));for(;t.next();){if(t.tag()===2)return Ts(t.getMessage());t.skip()}}catch(e){let t=new ae("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});$.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(t)}return null}function Ts(i){for(;i.next();){if(i.tag()===1)return i.getMessage();i.skip()}return null}function Cs(i){let l=i.getLength(),d=i.pos()+l;for(;i.pos()<d&&i.next();)switch(i.tag()){case 1:return i.getString();case 2:return i.getFloat();case 3:return i.getDouble();case 4:return i.getSInt32();case 5:return i.getUInt32();case 6:return i.getInt64();case 7:return i.getUInt64();case 8:return i.getSInt64();case 9:return i.getBool();default:return i.skip(),null}return null}function Ms(i,e,t,s,r,a){return .5*Math.abs(i*s+t*a+r*e-i*a-t*e-r*s)}function ft(i,e,t,s){return i*s-t*e===0&&i*t+e*s>0}var $e=class i extends dt{static fromBuffer(e,t,s=!1){let r=t.geometryType,a=Fs(e),o=ns(a,r==="esriGeometryPoint",s),n=dt.createInstance();return new i(n,a,o,t)}constructor(e,t,s,r){super(e,r),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=r.geometryType,this._reader=t,this._header=s,this._hasNext=s.hasFeatures,this._isPoints=r.geometryType==="esriGeometryPoint"}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get _size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}getAttributeHash(){let e="";for(let t of this._header.fields.fields)e+=this._readAttributeAtIndex(t.index)+".";return e}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(e){this._header.groupIds[this._featureIndex]=e}readLegacyFeature(){if(this._cache.legacyFeature===void 0){let e=this.readCentroid(),t={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null};return this._cache.legacyFeature=t,t}return this._cache.legacyFeature}readOptimizedFeature(){if(this._cache.optFeature===void 0){let e=new ve(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature}getXHydrated(){let e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return t==null?e:e*t.scale[0]+t.translate[0]}getYHydrated(){let e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return t==null?e:t.translate[1]-e*t.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(e){let t=this.readUnquantizedGeometry(e);return Se(t,this.geometryType,!1,!1)}readLegacyCentroid(){let e=this.readCentroid();if(!e)return null;let[t,s]=e.coords;return{x:t,y:s}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(e=!1){if(this._cache.unquantGeometry===void 0){let t=this.readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;let s=ds(t.coords.length).decoded,r=t.clone(s),a=r.coords,o=0;for(let n of r.lengths){for(let u=1;u<n;u++){let h=2*(o+u),l=2*(o+u-1);a[h]+=a[l],a[h+1]+=a[l+1]}o+=n}return this._cache.unquantGeometry=r,r}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===pt)return null;let r=this.getXHydrated(),a=this.getYHydrated();return new L([],[r,a])}let e=this.readGeometry();if(!e)return null;let t=e.clone(),s=this.getQuantizationTransform();return s!=null&&Dt(t,t,this.hasZ,this.hasM,s),t}readGeometry(e=!1){if(this._cache.geometry===void 0){let t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===pt)return null;let s=this.getX(),r=this.getY();t=new L([],[s,r])}else{let s=this._header.offsets.geometry[this._featureIndex],r=this._reader;if(s===0){let a=this._readServerCentroid();if(!a)return null;let[o,n]=a.coords;return this.createQuantizedExtrudedGeometry(o,n)}r.move(s);try{if(t=e?this._parseGeometryForDisplay(r):this._parseGeometry(r),!t){let a=this._readServerCentroid();if(!a)return null;let[o,n]=a.coords;return this.createQuantizedExtrudedGeometry(o,n)}}catch(a){return console.error("Failed to parse geometry!",a),null}}return this._cache.geometry=t,t}return this._cache.geometry}readCentroid(){if(this._cache.centroid===void 0){let e;return e=this._computeCentroid(),e||(e=this._readServerCentroid()),this._cache.centroid=e??void 0,e??null}return this._cache.centroid}copy(){let e=this._reader.clone(),t=new i(this.instance,e,this._header,this.fullSchema());return this.copyInto(t),t}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readAttribute(e,t){let s=this._header.fields.get(e);if(s==null)return;let r=this._readAttributeAtIndex(s.index);this.fields.get(e)?.type==="esriFieldTypeTimestampOffset"&&(r=this.parseTimestampOffset(r));let a=this._header.fields.isDateField(s.name);return t?r==null?r:a?new Date(r):r:r}_readAttributes(){let e={};for(let t of this._header.fields.fields)e[t.name]=this._readAttributeAtIndex(t.index);return e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}_readAttributeAtIndex(e){let t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],s=this._reader;return s.move(t),Cs(s)}_readServerCentroid(){let e=this._header.centroid[2*this._featureIndex]+this._tx,t=this._header.centroid[2*this._featureIndex+1]+this._ty;return e===pt?null:new L([],[e,t])}_parseGeometry(e){let r=e.asUnsafe(),a=r.getLength(),o=r.pos()+a,n=[],u=[];for(;r.pos()<o&&r.next();)switch(r.tag()){case 2:{let h=r.getUInt32(),l=r.pos()+h;for(;r.pos()<l;)u.push(r.getUInt32());break}case 3:{let h=r.getUInt32(),l=r.pos()+h;for(n.push(r.getSInt32()+this._tx),n.push(r.getSInt32()+this._ty),this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();r.pos()<l;)n.push(r.getSInt32()),n.push(r.getSInt32()),this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();break}default:r.skip()}return n.length?new L(u,n):null}_parseGeometryForDisplay(e){let r=e.asUnsafe(),a=r.getLength(),o=r.pos()+a,n=[],u=[],h=0,l=0,d=null,c=0,m=this.geometryType==="esriGeometryPolygon";for(;r.pos()<o&&r.next();)switch(r.tag()){case 2:{let _=r.getUInt32(),p=r.pos()+_;for(;r.pos()<p;){let f=r.getUInt32();n.push(f),h+=f}d=ds(2*h).delta;break}case 3:{r.getUInt32();let _=2+(this.hasZ?1:0)+(this.hasM?1:0);Ae(d);for(let p of n)if(l+_*p>d.length)for(let f=0;f<p;f++)r.getSInt32(),r.getSInt32(),this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();else if(m&&ws){let f=this.getAreaSimplificationThreshold(p,this._header.vertexCount),b=2,I=1,x=!1,y=r.getSInt32(),v=r.getSInt32();d[l++]=y,d[l++]=v,this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();let S=r.getSInt32(),w=r.getSInt32();for(this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();b<p;){let k=r.getSInt32(),O=r.getSInt32();this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32();let M=y+S,T=v+w;Ms(y,v,M,T,M+k,T+O)>=f?(c+=-.5*(M-y)*(T+v),I>1&&ft(d[l-2],d[l-1],S,w)?(d[l-2]+=S,d[l-1]+=w):(d[l++]=S,d[l++]=w,I++),y=M,v=T):(k+=S,O+=w),S=k,w=O,b++}I<3||x?l-=2*I:(c+=-.5*(y+S-y)*(v+w+v),ft(d[l-2],d[l-1],S,w)?(d[l-2]+=S,d[l-1]+=w,u.push(I)):(d[l++]=S,d[l++]=w,u.push(++I)))}else{let f=0,b=r.getSInt32(),I=r.getSInt32();this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32(),d[l++]=b,d[l++]=I,f+=1;for(let x=1;x<p;x++){let y=r.getSInt32(),v=r.getSInt32(),S=b+y,w=I+v;c+=-.5*(S-b)*(w+I),this.hasZ&&r.getSInt32(),this.hasM&&r.getSInt32(),x>2&&ft(d[l-2],d[l-1],y,v)?(d[l-2]+=y,d[l-1]+=v):(d[l++]=y,d[l++]=v,f+=1),b=S,I=w}u.push(f)}break}default:r.skip()}if(this._cache.area=c,!u.length)return null;if(this._tx||this._ty){let _=0;Ae(d);for(let p of u)d[2*_]+=this._tx,d[2*_+1]+=this._ty,_+=p}return new L(u,d)}};var Te=class{constructor(e){this.service=e,this._arcadeLayerSchema=A(F({},e),{fieldsIndex:V.fromJSON(e.fieldsIndex)})}destroy(){}};function ks(i){return Array.isArray(i.source)}function As(i){return i?.type==="ogc-source"}function ls(i){let{capabilities:e}=i;return As(i.source)?new It(i):ks(i)?new mt(i):e.query.supportsFormatPBF&&C("featurelayer-pbf")?new _t(i):new yt(i)}function qs(i){return g(this,null,function*(){let e=new as;return yield e.open(i,{}),e})}var mt=class extends Te{constructor(e){super(e),this._portsOpen=qs(e.source).then(t=>this.client=t)}destroy(){this.client.close(),this.client=null}executeQuery(e,t){return g(this,null,function*(){yield this._portsOpen;let s=yield this.client.invoke("queryFeatures",e.toJSON(),t);return U.fromFeatureSet(s,this._arcadeLayerSchema)})}},_t=class extends Te{executeQuery(e,t){return g(this,null,function*(){let{data:s}=yield Xt(this.service.source,e,t),r=!e.quantizationParameters;return $e.fromBuffer(s,this._arcadeLayerSchema,r)})}},yt=class extends Te{executeQuery(e,t){return g(this,null,function*(){let{source:s,capabilities:r,spatialReference:a,objectIdField:o,geometryType:n}=this.service;if(e.quantizationParameters!=null&&!r.query.supportsQuantization){let h=e.clone(),l=nt(h.quantizationParameters);h.quantizationParameters=null;let{data:d}=yield ut(s,h,a,t),c=zt(d,o);return ot(l,c),U.fromOptimizedFeatureSet(c,this._arcadeLayerSchema)}let{data:u}=yield ut(s,e,this.service.spatialReference,t);return n==="esriGeometryPoint"&&(u.features=u.features?.filter(h=>{if(h.geometry!=null){let l=h.geometry;return Number.isFinite(l.x)&&Number.isFinite(l.y)}return!0})),U.fromFeatureSet(u,this._arcadeLayerSchema)})}},It=class extends Te{executeQuery(e,t){return g(this,null,function*(){let{capabilities:s}=this.service;if(e.quantizationParameters&&!s.query.supportsQuantization){let a=e.clone(),o=nt(a.quantizationParameters);a.quantizationParameters=null;let n=yield lt(this.service.source,e,t);return ot(o,n),U.fromOptimizedFeatureSet(n,this._arcadeLayerSchema)}let r=yield lt(this.service.source,e,t);return U.fromOptimizedFeatureSet(r,this._arcadeLayerSchema)})}};var E=class i{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(e){let t=new i,s;for(s in e){let r=e[s];if(typeof r=="object")for(let a in r){let o=a,n=r[o];t[s][o]=n}t[s]=r}return t}static empty(){return i.create({})}static all(){return i.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(e){this.version=e.version,e.source&&(this.source=!1),e.targets.feature&&(this.targets.feature=!1),e.targets.aggregate&&(this.targets.aggregate=!1),e.storage.filters&&(this.storage.filters=!1),e.storage.data&&(this.storage.data=!1),e.mesh&&(this.mesh=!1),e.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let e=0,t="";if(this.mesh){e+=20,t+=`-> (20) Mesh needs update
`;for(let r of this.why.mesh)t+=`    + ${r}
`}if(this.source){e+=10,t+=`-> (10) The source needs update
`;for(let r of this.why.source)t+=`    + ${r}
`}this.targets.feature&&(e+=5,t+=`-> (5) Feature target parameters changed
`),this.storage.filters&&(e+=5,t+=`-> (5) Feature filter parameters changed
`),this.targets.aggregate&&(e+=4,t+=`-> (4) Aggregate target parameters changed
`),this.storage.data&&(e+=1,t+="-> (1) Texture storage parameters changed");let s=e<5?"Fastest":e<10?"Fast":e<15?"Moderate":e<20?"Slow":"Very Slow";console.debug(`Applying ${s} update of cost ${e}/45 `),console.debug(t)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}};var We=class{constructor(e,t){this.requests={done:new Array,stream:new ge(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._isDone=!1,this.didSend=!1,this.tile=e,this._version=t,this._resolver=Ge(),this._resolver.promise.catch(s=>de(s))}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length&&this.edits==null}get edits(){return this._edits}get done(){return this._resolver.promise}get isDone(){return this._isDone}resolve(){this._isDone=!0,this._resolver.resolve()}clear(){this.requests.done=[]}applyUpdate(e){this.requests.done.forEach(t=>t.message.status.unset(e)),this._version=e.version,this._edits!=null&&this._edits.status.unset(e)}add(e){e.message.status=e.message.status??E.empty(),e.message.status.version=this._version,C("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),e.message.end&&(this.requests.done.forEach(t=>{t.message!=null&&t.message.end&&(t.message.end=!1)}),this._resolver.resolve(),this._isDone=!0),this.requests.done.push(e)}edit(e,t){let s=e.getQuantizationTransform(),r=e.fullSchema(),a=Array.from(e.features()).filter(Pe),o=[...t,...a.map(n=>n.objectId)];if(this.removeIds(o),this._invalidate(),this._edits==null)return void(this._edits={type:"append",addOrUpdate:U.fromOptimizedFeatures(a,r,s),id:this.tile.id,status:E.empty(),end:!0});this.requests.done.forEach(n=>n.message.end=!1),this._edits.addOrUpdate.append(e.features())}*readers(){for(let{message:e}of this.requests.done)e.addOrUpdate!=null&&(yield e.addOrUpdate);this._edits?.addOrUpdate!=null&&(yield this._edits.addOrUpdate)}_invalidate(){for(let e of this.requests.done)e.message.status=E.empty();this._edits!=null&&(this._edits.status=E.empty())}removeIds(e){this._invalidate();for(let{message:t}of this.requests.done){let s=t.addOrUpdate;s!=null&&(s.removeIds(e),s.isEmpty&&(C("esri-2d-update-debug")&&console.debug("Removing FeatureSetReader"),t.addOrUpdate=null))}this._edits?.addOrUpdate!=null&&this._edits.addOrUpdate.removeIds(e),this.requests.done=this.requests.done.filter(t=>t.message.addOrUpdate||t.message.end)}abort(){this._abortController.abort(),this._resolver.reject(kt())}};function Rs(i,e){let t=new Set;return i&&i.forEach(s=>t.add(s)),e&&e.forEach(s=>t.add(s)),t.has("*")?["*"]:Array.from(t)}var Ce=class{constructor(e){this.updatingHandles=new Ye,this.events=new ye,this._resolver=Ge(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=e.outSR,this._serviceInfo=e.serviceInfo,this._onTileUpdateMessage=e.onMessage,this._arcadeLayerSchema=e.arcadeLayerSchema}destroy(){for(let e of this._subscriptions.values())e.abort();this.updatingHandles.destroy()}get subscriptions(){return this._subscriptions.values()}_onMessage(e){return g(this,null,function*(){let t=this._subscriptions.get(e.id);if(!t)return;let s=A(F({},e),{remove:e.remove??[],status:e.status??E.empty()});return me(this._onTileUpdateMessage(s,t.options))})}update(e,t){let s=t.fields.length;t.outFields=Rs(this._schema?.outFields,t.outFields),t.outFields=t.outFields.length>=.75*s?["*"]:t.outFields,t.outFields.sort();let r=ce(this._schema,t);if(!r)return;C("esri-2d-update-debug")&&console.debug("Applying Update - Source:",r);let a="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",o=this._serviceInfo.source,n={returnCentroid:!(o!==null&&typeof o=="object"&&"path"in o&&De(o.path))&&this._serviceInfo.geometryType==="esriGeometryPolygon",returnGeometry:!0,timeReferenceUnknownClient:this._serviceInfo.type!=="stream"&&this._serviceInfo.timeReferenceUnknownClient,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:[a],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment,timeExtent:t.timeExtent?Lt.fromJSON(t.timeExtent):null},u=this._schema&&le(r,"outFields");this._schema&&Yt(r,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(e.why.mesh.push("Layer filter and/or custom parameters changed"),e.why.source.push("Layer filter and/or custom parameters changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0),u&&(e.why.source.push("Layer required fields changed"),e.source=!0),ce(n,this._queryInfo)&&(this._queryInfo=n),this._schema=t,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(e){return g(this,null,function*(){if(e.queryFilter||e.source&&this._didEdit)return this.refresh(e.version),void(this._didEdit=!1);this._subscriptions.forEach(t=>t.applyUpdate(e)),yield this.resend()})}refresh(e,t){for(let s of this._tiles())this.unsubscribe(s),this.subscribe(s,e)}subscribe(e,t){let s=new We(e,t);return this._subscriptions.set(e.id,s),s}unsubscribe(e){let t=this.getSubscription(e.id);t?.abort(),this._subscriptions.delete(e.id)}createQuery(e={}){let t=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new jt(F(A(F({},this._queryInfo),{historicMoment:t}),e))}getSubscription(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}queryLastEditDate(){return g(this,null,function*(){throw new Error("Service does not support query type")})}query(e,t){return g(this,null,function*(){throw new Error("Service does not support query")})}*_tiles(){let e=Array.from(this._subscriptions.values());for(let t of e)yield t.tile}edit(e,t){return g(this,null,function*(){return this.updatingHandles.addPromise(this._edit(e,t))})}_edit(e,t){return g(this,null,function*(){let s=Array.from(this._subscriptions.values()),r=s.map(({tile:a})=>a);for(let a of s)a.removeIds(t);if(e.length){let a=r.map(n=>{let u=this.createTileQuery(n);return u.objectIds=e,{tile:n,query:u}}).map(h=>g(this,[h],function*({tile:n,query:u}){return{tile:n,result:yield this.query(u,{query:{tile:C("esri-tiles-debug")?n.id.replaceAll("/","."):void 0}}),query:u}})),o=(yield At(a)).map(h=>g(this,[h],function*({tile:n,result:u}){if(!u.hasFeatures&&!t.length&&!e.length)return;let l=this._subscriptions.get(n.key.id);l&&l.edit(u,e)}));yield Promise.allSettled(o)}this._didEdit=!0})}};var Es=4,he=class extends Ce{constructor(e){super(e),this.type="feature",this.mode="on-demand",this._adapter=ls(e.serviceInfo),this._queue=new Ee({concurrency:8,process:t=>g(this,null,function*(){if(B(t),t.tile!=null){let s=t.tile.key.id,{signal:r}=t,a=C("esri-tiles-debug")?{tile:s.replaceAll("/","."),depth:t.depth}:void 0,o=yield this._adapter.executeQuery(t.query,{signal:r,query:F(F({},a),this._schema?.customParameters)});return o.level=t.tile.key.level,o}return this._adapter.executeQuery(t.query,A(F({},t),{query:this._schema?.customParameters}))})}),this._patchQueue=new Ee({concurrency:8,process:t=>g(this,null,function*(){if(B(t),t.tile!=null){let s=t.tile.key.id,{signal:r}=t,a=C("esri-tiles-debug")?{tile:s.replaceAll("/","."),depth:t.depth}:void 0,o=yield this._adapter.executeQuery(t.query,{signal:r,query:F(F({},a),this._schema?.customParameters)});return o.level=t.tile.key.level,o}return this._adapter.executeQuery(t.query,A(F({},t),{query:this._schema?.customParameters}))})})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}enqueueQuery(e,t){return this.updatingHandles.addPromise(this._queue.push(e,t))}enqueuePatchQuery(e,t){return this.updatingHandles.addPromise(this._patchQueue.push(e,t))}get maxRecordCountFactor(){let{query:e}=this._serviceInfo.capabilities;return e.supportsMaxRecordCountFactor?Es:null}get maxPageSize(){let{query:e}=this._serviceInfo.capabilities;return(e.maxRecordCount??8e3)*(this.maxRecordCountFactor??1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(e,t){}subscribe(e,t){let s=super.subscribe(e,t);return this._fetchDataTile(e).catch(r=>{oe(r)||$.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource").error(new ae("mapview-query-error","Encountered error when fetching tile",{tile:e,error:r}))}),s}unsubscribe(e){super.unsubscribe(e)}readers(e){return this._subscriptions.get(e).readers()}query(s){return g(this,arguments,function*(e,t={}){let r=t.query??{};return this._adapter.executeQuery(e,A(F({},t),{query:F(F({},r),this._schema?.customParameters)}))})}queryLastEditDate(){return g(this,null,function*(){let e=this._serviceInfo.source,t=A(F({},e.query),{f:"json"});return(yield Et(e.path,{query:t,responseType:"json"})).data.editingInfo.lastEditDate})}createTileQuery(e,t={}){let s=this._serviceInfo.geometryType,r=this.createQuery(t);r.quantizationParameters=t.quantizationParameters??e.getQuantizationParameters(),r.resultType="tile",r.geometry=e.extent,this._serviceInfo.capabilities.query.supportsQuantization?s==="esriGeometryPolyline"&&(r.maxAllowableOffset=e.resolution*C("feature-polyline-generalization-factor")):s!=="esriGeometryPolyline"&&s!=="esriGeometryPolygon"||(r.maxAllowableOffset=e.resolution,s==="esriGeometryPolyline"&&(r.maxAllowableOffset*=C("feature-polyline-generalization-factor")));let a=this._serviceInfo.capabilities.query;return r.defaultSpatialReferenceEnabled=a.supportsDefaultSpatialReference,r.compactGeometryEnabled=a.supportsCompactGeometry,r}_executePatchQuery(e,t,s,r){return g(this,null,function*(){let a=t.clone();a.outFields=[this._serviceInfo.objectIdField,...s],a.returnCentroid=!1,a.returnGeometry=!1;let o=a.start!=null?a.start/8e3:0,n=r.signal;return yield this.enqueuePatchQuery({tile:e,query:a,signal:n,depth:o})})}_resend(e,t){return g(this,null,function*(){let{query:s,message:r}=e,a=s.outFields!=null?s.outFields:[],o=this._queryInfo.outFields,n=o.filter(u=>!a.includes(u));if(r.addOrUpdate!=null)if(n.length)try{let u=this._subscriptions.get(r.id).tile,h=yield this._executePatchQuery(u,s,n,t);B(t),s.outFields=o,r.addOrUpdate.joinAttributes(h),this._onMessage(A(F({},r),{end:r.end,type:"append"}))}catch{}else this._onMessage(A(F({},r),{type:"append"}));else this._onMessage(A(F({},r),{type:"append"}))})}_resendSubscription(e){return g(this,null,function*(){if(C("esri-2d-update-debug")&&console.debug(e.tile.id,"Resend Subscription"),e.empty)return this._onMessage({id:e.tile.id,addOrUpdate:null,end:!1,type:"append"});let t=e.signal;for(let s of e.requests.done)yield this._resend(s,{signal:t});return e.edits!=null?this._onMessage(e.edits):void 0})}resend(){return g(this,null,function*(){let e=Array.from(this._subscriptions.values());yield Promise.all(e.map(t=>this._resendSubscription(t)))})}};var cs=C("esri-mobile"),gs={maxDrillLevel:cs?1:4,maxRecordCountFactor:cs?1:3},Ke=class extends he{constructor(e){super(e)}_fetchDataTile(e){return g(this,null,function*(){let t=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,s=this._subscriptions.get(e.key.id),r=s.signal,a=e.getQuantizationParameters(),o=0,n=(u,h)=>g(this,null,function*(){let l=this._queryInfo,d=this.createTileQuery(u,{maxRecordCountFactor:t?gs.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:a});o++;try{let c=yield this.enqueueQuery({tile:e,query:d,signal:r,depth:h});if(o--,B(r),!c)return;if(l!==this._queryInfo)return void n(u,h);if(c.exceededTransferLimit&&h<gs.maxDrillLevel){for(let _ of u.createChildTiles())n(_,h+1);return}let m={id:e.id,addOrUpdate:c,end:o===0,type:"append"};s.add({query:d,message:m}),this._onMessage(m)}catch(c){if(!oe(c)){let m={id:e.id,addOrUpdate:null,end:!0,type:"append"};s.add({query:d,message:m}),this._onMessage(m)}}});n(e,0)})}};var et=class extends he{constructor(e){super(e)}_fetchDataTile(e){return g(this,null,function*(){let r=this._subscriptions.get(e.key.id),a=!1,o=0,n=0,u=(d,c)=>{n--,B(r);let m=e.id,_=d.reader,p=d.query;if(!_.exceededTransferLimit){if(a=!0,c!==0&&!_.hasFeatures){let I={id:m,addOrUpdate:_,end:n===0,type:"append"};return r.add({message:I,query:p}),void this._onMessage(I)}let b={id:m,addOrUpdate:_,end:n===0,type:"append"};return r.add({message:b,query:p}),void this._onMessage(b)}let f={id:m,addOrUpdate:_,end:a&&n===0,type:"append"};r.add({message:f,query:p}),this._onMessage(f)},h=0,l=0;for(;!a&&l++<20;){let d;for(let c=0;c<h+1;c++){let m=o++;n++,d=this._fetchDataTilePage(e,m,r).then(_=>_&&u(_,m)).catch(_=>{if(a=!0,!oe(_)){$.getLogger("esri.views.2d.layers.features.sources.PagedFeatureSource").error(new ae("mapview-query-error","Encountered error when fetching tile",{tile:e,error:_}));let p={id:e.id,addOrUpdate:null,end:a,type:"append"},f={start:this.pageSize*o,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};this.maxRecordCountFactor!=null&&(f.maxRecordCountFactor=this.maxRecordCountFactor);let b=this.createTileQuery(e,f);r.add({message:p,query:b}),this._onMessage(p)}})}yield d,B(r),h=Math.min(h+2,6)}})}_fetchDataTilePage(e,t,s){return g(this,null,function*(){B(s);let r=this._queryInfo,a={start:this.pageSize*t,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};this.maxRecordCountFactor!=null&&(a.maxRecordCountFactor=this.maxRecordCountFactor);let o=this.createTileQuery(e,a);try{let n=s.signal,u=yield this.enqueueQuery({tile:e,query:o,signal:n,depth:t});return B(s),u?r!==this._queryInfo?this._fetchDataTilePage(e,t,s):{reader:u,query:o}:null}catch(n){return de(n),null}})}};function Os(i,e,t){let s=i.getXHydrated(),r=i.getYHydrated(),a=e.getColumnForX(s),o=Math.floor(e.normalizeCol(a));return`${t}/${Math.floor(e.getRowForY(r))}/${o}`}function vt(i,e){if(i==null)return null;let t=e.transform,s=i.getQuantizationTransform();if(s==null){let[f,b]=t.scale,[I,x]=t.translate,y=-I/f,v=1/f,S=x/b,w=1/-b;return i.transform(y,S,v,w)}let[r,a]=s.scale,[o,n]=s.translate,[u,h]=t.scale,[l,d]=t.translate,c=r/u,m=(o-l)/u,_=a/h,p=(-n+d)/h;return i.transform(m,p,c,_)}var tt=class extends he{constructor(i){super(i),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new Ct(1e3),this._store=i.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(i,e){super.update(i,e),this._featureCount??=e.initialFeatureCount,e.changedFeatureCount!=null&&(this._featureCount=e.changedFeatureCount),this._hasAggregates=!!i.targets?.aggregate}resend(i=!1){return g(this,null,function*(){if(yield this._downloadPromise,this._invalidated||i){let t=this._featureCount;return Ae(t,"Expected featureCount to be defined"),this._invalidated=!1,this._subscriptions.forEach(s=>s.clear()),this._downloadPromise=this._download(t),void(yield this._downloadPromise)}let e=this._queries.map(({query:t,reader:s})=>this._sendPatchQuery(t,s));yield Promise.all(e),this._subscriptions.forEach(t=>{t.requests.done.forEach(s=>this._onMessage(s.message))})})}refresh(i,e){return g(this,null,function*(){e&&(this._featureCount=e.featureCount),yield this.resend(!0)})}_sendPatchQuery(i,e){return g(this,null,function*(){let t=i.outFields!=null?i.outFields:[],s=this._queryInfo.outFields,r=s.filter(u=>!t.includes(u));if(!r.length)return;let a=i.clone(),o=this._signal;a.returnGeometry=!1,a.returnCentroid=!1,a.outFields=r,i.outFields=s;let n=yield this.enqueueQuery({query:a,depth:0,signal:o});B({signal:o}),e.joinAttributes(n)})}_fetchDataTile(i){return g(this,null,function*(){this._downloadPromise??=this._download(this._featureCount);let e=this._store.search(i),t=this._subscriptions.get(i.key.id),s=e.length-1;for(let n=0;n<s;n++){let u=vt(e[n],i),h={type:"append",id:i.id,addOrUpdate:u,end:!1,status:E.empty()};t.add({query:null,message:h}),this._hasAggregates||(yield Le(1)),this._onMessage(h)}let r=vt(s>=0?e[s]:null,i),a=this._didSendEnd,o={type:"append",id:i.id,addOrUpdate:r,end:a,status:E.empty()};t.add({query:null,message:o}),this._onMessage(o)})}_download(i){return g(this,null,function*(){try{yield this.whenInitialized();let e=this._store.storage.getBitset(this._markedIdsBufId),t=new Set;e.clear();let s=Math.ceil(i/this.pageSize),r=Array.from({length:s},(a,o)=>o).sort((a,o)=>this._random.getInt()-this._random.getInt()).map(a=>this._downloadPage(a,e,t));yield Promise.all(r),this._store.sweepFeatures(e,this._store.storage),this._store.sweepFeatureSets(t)}catch(e){$.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",e)}this._sendEnd(),this._loading=!1})}_downloadPage(i,e,t){return g(this,null,function*(){let s=this.pageSize,r={start:i*s,num:s,cacheHint:!0};this.maxRecordCountFactor!=null&&(r.maxRecordCountFactor=this.maxRecordCountFactor);let a=this.createQuery(r),o=this._signal,n=yield this.enqueueQuery({query:a,depth:i,signal:o});B({signal:o}),this._queries.push({query:a,reader:n}),this._store.insert(n),t.add(n.instance);let u=n.getCursor();for(;u.next();)e.set(u.getDisplayId());this._send(n)})}_send(i){if(!this._subscriptions.size)return;let e=null,t=new Map,s=new Set,r=new Map;this._subscriptions.forEach(a=>{let o=a.tile;t.set(o.key.id,null),e=o.tileInfoView,s.add(o.level);let{row:n,col:u}=o.key,h=`${o.level}/${n}/${u}`,l=r.get(h)??[];l.push(a),r.set(h,l)});for(let a of s){let o=e.getLODInfoAt(a),n=i.getCursor();for(;n.next();){let u=Os(n,o,a),h=n.getIndex();if(r.has(u))for(let l of r.get(u)){let d=l.tile.id,c=t.get(d);c==null&&(c=[],t.set(d,c)),c.push(h)}}}t.forEach((a,o)=>{if(a!=null){let n=this._subscriptions.get(o),u={type:"append",id:o,addOrUpdate:vt(Wt.from(i,a),n.tile),end:!1,status:E.empty()};n.add({query:null,message:u}),this._onMessage(u)}})}_sendEnd(){this._subscriptions.forEach(i=>{let e={type:"append",id:i.tile.id,addOrUpdate:null,end:!0,status:E.empty()};i.add({query:null,message:e}),this._onMessage(e)}),this._didSendEnd=!0}};tt=q([ne("esri.view.2d.layers.features.sources.SnapshotFeatureSource")],tt);var Us="__esri_stream_id__",ps="__esri_timestamp__",fs=1e3,st=class{constructor(e,t,s,r,a=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=r,this.store=e,this.objectIdField=t,this.purgeInterval=a,this._useGeneratedIds=this.objectIdField===Us}removeById(e){this._removed.push(e)}removeByTrackId(e){let t=this._trackIdToObservations.get(e);if(t)for(let s of t.entries)this._removed.push(s)}add(e){if(this._useGeneratedIds){let o=this._nextId();e.attributes[this.objectIdField]=o,e.objectId=o}else e.objectId=e.attributes[this.objectIdField];let t=e.objectId;if(this._addOrUpdated.set(t,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return this._trackIdLessObservations==null&&(this._trackIdLessObservations=new ge(1e5)),void this._trackIdLessObservations.enqueue(t);let s=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(s)){let o=this._purgeOptions?.maxObservations!=null?this._purgeOptions.maxObservations:fs,n=Ut(o,0,fs);this._trackIdToObservations.set(s,new ge(n))}let r=this._trackIdToObservations.get(s),a=r?.enqueue(t);a!=null&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}checkForUpdates(){let e=this._getToAdd(),t=this._getToRemove(),s=performance.now();s-this._lastPurge>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);let r=[];if(t!=null)for(let o of t){let n=this.store.removeById(o);n!=null&&r.push(n)}let a=[];if(e!=null){let o=new Set(t??[]);for(let n of e)o.has(n.objectId)||(n.attributes[ps]=s,this.store.add(n),a.push(n))}(a.length||r?.length)&&this.store.update(a,r)}_getToAdd(){if(!this._addOrUpdated.size)return null;let e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach(s=>e[t++]=s),this._addOrUpdated.clear(),e}_getToRemove(){let e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){let e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){let t=this._purgeOptions;t!=null&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){for(let s of this._trackIdToObservations.values())if(t>e.displayCount&&s.size){let r=s.dequeue();this._removed.push(r),t--}}if(this._trackIdLessObservations!=null){let s=t-e.displayCount;for(;s-- >0;){let r=this._trackIdLessObservations.dequeue();r!=null&&this._removed.push(r)}}}}_purgeByAge(e){let t=this._timeInfo?.startTimeField;if(!e.age||!t)return;let s=60*e.age*1e3,r=this._maxAge-s;this.store.forEach(a=>{a.attributes[t]<r&&this._removed.push(a.objectId)})}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;let s=e-60*t.ageReceived*1e3;this.store.forEach(r=>{r.attributes[ps]<s&&this._removed.push(r.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((e,t)=>{e.size===0&&this._trackIdToObservations.delete(t)})}};var pe=class extends _e{constructor(i){super(i)}get connectionStatus(){return this.connection?.connectionStatus}get errorString(){return this.connection?.errorString}};q([P()],pe.prototype,"connection",void 0),q([P()],pe.prototype,"connectionStatus",null),q([P()],pe.prototype,"errorString",null),pe=q([ne("esri.views.2d.layers.features.sources.StreamConnectionState")],pe);var Ps=2500;function Ls(i,e){let t=i.weakClone();if(i.geometry!=null){let s=Ne(e,i.geometry.coords[0]),r=He(e,i.geometry.coords[1]);t.geometry=new L([],[s,r])}return t}function Gs(i){return i==="esriGeometryPoint"?Ls:(e,t)=>{let s=e.weakClone(),r=new L,a=!1,o=!1,n=Re(r,e.geometry,a,o,i,t,!1,!1);return s.geometry=n,s}}function Qs(i){return i==="esriGeometryPoint"?e=>e.geometry!=null?{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:e=>{let t=1/0,s=1/0,r=-1/0,a=-1/0;return e.geometry!=null&&e.geometry.forEachVertex((o,n)=>{t=Math.min(t,o),s=Math.min(s,n),r=Math.max(r,o),a=Math.max(a,n)}),{minX:t,minY:s,maxX:r,maxY:a}}}function Bs(i,e){let t=$t(9,Qs(e));return t.load(i),t}function zs(i,e){return i.search({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]})}var bt=class{constructor(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map,this._index=null}get _features(){let e=[];return this._objectIdToFeature.forEach(t=>e.push(t)),e}add(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}get(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}forEach(e){this._objectIdToFeature.forEach(e)}search(e){return this._index||(this._index=Bs(this._features,this._geometryType)),zs(this._index,e)}clear(){this._index=null,this._objectIdToFeature.clear()}removeById(e){let t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._objectIdToFeature.size}},rt=class extends Ce{constructor(e){super(e),this.type="stream",this._updateIntervalId=0,this._level=0,this._isPaused=!1,this._updateInfo={websocket:0,client:0},this._inUpdate=!1;let{outSR:t}=e,{geometryType:s,objectIdField:r,timeInfo:a,purgeOptions:o,source:n,spatialReference:u,serviceFilter:h,maxReconnectionAttempts:l,maxReconnectionInterval:d,updateInterval:c,customParameters:m,enabledEventTypes:_}=e.serviceInfo,p=new bt(this._onUpdate.bind(this),s),f=new st(p,r,a,o),b=es(n,u,t,s,h,l,d,m??{});this._connectionState=new pe({connection:b}),this._store=p,this._manager=f,this._connection=b,this._quantize=Gs(s),this._enabledEventTypes=new Set(_),this._handlesGroup=Mt([this._connection.on("data-received",I=>this._onFeature(I)),this._connection.on("message-received",I=>this._onWebSocketMessage(I))]),this._initUpdateInterval=()=>{let I=performance.now();this._updateIntervalId=setInterval(()=>{let x=performance.now(),y=x-I;if(y>Ps){I=x;let v=Math.round(this._updateInfo.client/(y/1e3)),S=Math.round(this._updateInfo.websocket/(y/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:v,websocket:S})}e.canAcceptRequest()&&!this._inUpdate&&this._manager.checkForUpdates()},c)},this._isPaused=e.serviceInfo.isPaused,this._isPaused||this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._connection.destroy(),this._handlesGroup?.remove()}_fetchDataTile(){}get connectionStatus(){return this._connectionState.connectionStatus}get errorString(){return this._connectionState.errorString}updateCustomParameters(e){this._connection.updateCustomParameters(e)}pauseStream(){this._isPaused||(this._isPaused=!0,this._clearUpdateInterval())}resumeStream(){this._isPaused&&(this._isPaused=!1,this._initUpdateInterval())}sendMessageToSocket(e){this._connection.sendMessageToSocket(e)}sendMessageToClient(e){this._isPaused&&"type"in e&&e.type==="clear"?(this._store.clear(),this._subscriptions.forEach((t,s)=>{t.didSend&&t.tile.level===this._level&&this._onMessage({type:"append",id:s,addOrUpdate:null,clear:!0,end:!0})})):this._connection.sendMessageToClient(e)}enableEvent(e,t){t?this._enabledEventTypes.add(e):this._enabledEventTypes.delete(e)}subscribe(e,t){let s=super.subscribe(e,t);this._level=e.level;let r=this._getTileFeatures(e);return this._onMessage({type:"append",id:e.key.id,addOrUpdate:r,end:!0}),s.didSend=!0,s}unsubscribe(e){super.unsubscribe(e)}*readers(e){let t=this._subscriptions.get(e),{tile:s}=t;yield this._getTileFeatures(s)}createTileQuery(e){throw new Error("Service does not support tile  queries")}resend(){return g(this,null,function*(){this._subscriptions.forEach(e=>{let{tile:t}=e,s={type:"append",id:t.id,addOrUpdate:this._getTileFeatures(t),end:!0};this._onMessage(s)})})}_getTileFeatures(e){let t=this._store.search(e).map(s=>this._quantize(s,e.transform));return U.fromOptimizedFeatures(t,this._arcadeLayerSchema,e.transform)}_onWebSocketMessage(e){if(this._enabledEventTypes.has("message-received")&&this.events.emit("message-received",e),"type"in e)switch(e.type){case"delete":if(e.objectIds)for(let t of e.objectIds)this._manager.removeById(t);if(e.trackIds)for(let t of e.trackIds)this._manager.removeByTrackId(t);break;case"clear":this._store.forEach(t=>this._manager.removeById(t.objectId))}}_onFeature(e){this._updateInfo.websocket++;try{this._enabledEventTypes.has("data-received")&&this.events.emit("data-received",e);let t=Bt(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch{}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(e,t){return g(this,null,function*(){this._inUpdate=!0;try{e!=null&&(this._updateInfo.client+=e.length),this._subscriptions.forEach((r,a)=>{r.didSend&&r.tile.level===this._level&&this._onMessage({type:"append",id:a,addOrUpdate:null,clear:!0,end:!1})});let s=[];this._subscriptions.forEach((r,a)=>{if(!r.didSend||r.tile.level!==this._level)return;let o=r.tile,n={type:"append",id:a,addOrUpdate:this._getTileFeatures(o),remove:[],end:!1,status:E.empty()};r.requests.stream.enqueue(n),s.push(this._onMessage(n))}),yield Promise.all(s),this._subscriptions.forEach((r,a)=>{r.didSend&&r.tile.level===this._level&&this._onMessage({type:"append",id:a,addOrUpdate:null,end:!0})})}catch{}this._inUpdate=!1})}};function ms(i,e,t,s,r,a,o){let n=Ds(i,e,t,s,r,a,o);switch(n.type){case"feature":switch(n.origin){case"hosted":case"local":return new et(n);case"snapshot":return new tt(n);default:return new Ke(n)}case"stream":return new rt(n)}}function Ds(i,e,t,s,r,a,o){switch(i.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:i.featureCount??0,serviceInfo:i,onMessage:r,outSR:t,tileInfoView:s,canAcceptRequest:a,store:o,arcadeLayerSchema:e};case"stream":return{type:"stream",serviceInfo:i,onMessage:r,outSR:t,canAcceptRequest:a,arcadeLayerSchema:e};case"memory":case"on-demand":return{type:"feature",serviceInfo:i,onMessage:r,outSR:t,origin:n(i.source),tileInfoView:s,canAcceptRequest:a,arcadeLayerSchema:e}}function n(u){return Array.isArray(u)?"local":"path"in u&&De(u.path)?"hosted":"unknown"}}var Me=class{constructor(e=[],t,s=8096){this.onRelease=r=>{},this._nodes=0,this._root=new Oe(this,0,0,0),this._statisticFields=e,this._pool=s?new ge(8096):null,this._serviceInfo=t}destroy(){this.clear()}_acquire(e,t,s){this._nodes++;let r=null;return this._pool!=null&&(r=this._pool.dequeue()),r!=null?r.realloc(e,t,s):r=new Oe(this,e,t,s),r}_release(e){this.onRelease(e),this._nodes--,this._pool!=null&&this._pool.enqueue(e)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return this._pool?.size??0}get depth(){let e=0;return this.forEach(t=>e=Math.max(e,t.depth)),e}dropLevels(e){this.forEach(t=>{if(t.depth>=e)for(let s=0;s<t.children.length;s++){let r=t.children[s];r&&this._release(r)}}),this.forEach(t=>{if(t.depth>=e)for(let s=0;s<t.children.length;s++)t.children[s]=null})}clear(){this.forEach(e=>this._release(e)),this._root=new Oe(this,0,0,0)}insert(e,t,s=0){let r=U.fromOptimizedFeatures([e],this._serviceInfo).getCursor();r.next();let a=r.readGeometry();if(!a)return;let[o,n]=a.coords,u=e.geohashX,h=e.geohashY;this.insertCursor(r,e.displayId,o,n,u,h,t,s)}insertCursor(e,t,s,r,a,o,n,u=0){let h=this._root,l=0,d=0,c=0;for(;h!==null;){if(h.depth>=u&&(h.count+=1,h.xTotal+=s,h.yTotal+=r,h.xGeohashTotal+=a,h.yGeohashTotal+=o,h.referenceId=t,this._updateStatisticsCursor(e,h,1)),l>=n)return void h.add(t);let m=Math.ceil((l+1)/2),_=Math.floor((l+1)/2),p=1-l%2,f=30-(3*m+2*_),b=30-(2*m+3*_),I=(a&7*p+3*(1-p)<<f)>>f,x=(o&3*p+7*(1-p)<<b)>>b,y=I+x*(8*p+4*(1-p));d=d<<3*p+2*(1-p)|I,c=c<<2*p+3*(1-p)|x,h.children[y]==null&&(h.children[y]=this._acquire(d,c,l+1)),l+=1,h=h.children[y]}}remove(e,t){let s=U.fromOptimizedFeatures([e],this._serviceInfo).getCursor();s.next();let r=s.readGeometry();if(!r)return;let[a,o]=r.coords,n=e.geohashX,u=e.geohashY;this.removeCursor(s,a,o,n,u,t)}removeCursor(e,t,s,r,a,o){let n=this._root,u=0;for(;n!==null;){if(n.count-=1,n.xTotal-=t,n.yTotal-=s,n.xGeohashTotal-=r,n.yGeohashTotal-=a,this._updateStatisticsCursor(e,n,-1),u>=o)return void n.remove(e.getDisplayId());let h=Math.ceil((u+1)/2),l=Math.floor((u+1)/2),d=1-u%2,c=30-(3*h+2*l),m=30-(2*h+3*l),_=((r&7*d+3*(1-d)<<c)>>c)+((a&3*d+7*(1-d)<<m)>>m)*(8*d+4*(1-d)),p=n.children[_];p?.count===1&&(this._release(p),n.children[_]=null),u+=1,n=p}}forEach(e){let t=this._root;for(;t!==null;){let s=this._linkChildren(t)||t.next;e(t),t=s}}find(e,t,s){return this._root.find(e,t,s,0,0,0)}findIf(e){let t=null;return this.forEach(s=>{e(s)&&(t=s)}),t}findAllIf(e){let t=[];return this.forEach(s=>{e(s)&&t.push(s)}),t}findSingleOccupancyNode(e,t,s,r,a){let o=this._root;for(;o!==null;){let n=o.depth,u=o.xNode,h=o.yNode,l=1-n%2,d=o.xGeohashTotal/o.count,c=o.yGeohashTotal/o.count;if(o.count===1&&e<d&&d<=s&&t<c&&c<=r)return o;if(n>=a){o=o.next;continue}let m=Math.ceil((n+1)/2),_=Math.floor((n+1)/2),p=30-(3*m+2*_),f=30-(2*m+3*_),b=~((1<<p)-1),I=~((1<<f)-1),x=(e&b)>>p,y=(t&I)>>f,v=(s&b)>>p,S=(r&I)>>f,w=u<<3*l+2*(1-l),k=h<<2*l+3*(1-l),O=w+8*l+4*(1-l),M=k+4*l+8*(1-l),T=Math.max(w,x),R=Math.max(k,y),G=Math.min(O,v),Q=Math.min(M,S),H=null,K=null;for(let z=R;z<=Q;z++)for(let Z=T;Z<=G;Z++){let Y=Z-w+(z-k)*(8*l+4*(1-l)),D=o.children[Y];D&&(H||(H=D,H.next=o.next),K&&(K.next=D),K=D,D.next=o.next)}o=H||o.next}return null}getRegionDisplayIds(e){let t=this._root,{bounds:s,geohashBounds:r,level:a}=e,[o,n,u,h]=s,l=[];for(;t!==null;){let d=t.depth,c=t.xNode,m=t.yNode;if(d>=a){let Y=t.xTotal/t.count,D=t.yTotal/t.count;Y>=o&&Y<=u&&D>=n&&D<=h&&t.displayIds.forEach(se=>l.push(se)),t=t.next;continue}let _=Math.ceil((d+1)/2),p=Math.floor((d+1)/2),f=1-d%2,b=30-(3*_+2*p),I=30-(2*_+3*p),x=~((1<<b)-1),y=~((1<<I)-1),v=(r.xLL&x)>>b,S=(r.yLL&y)>>I,w=(r.xTR&x)>>b,k=(r.yTR&y)>>I,O=c<<3*f+2*(1-f),M=m<<2*f+3*(1-f),T=O+8*f+4*(1-f),R=M+4*f+8*(1-f),G=Math.max(O,v),Q=Math.max(M,S),H=Math.min(T,w),K=Math.min(R,k),z=null,Z=null;for(let Y=Q;Y<=K;Y++)for(let D=G;D<=H;D++){let se=D-O+(Y-M)*(8*f+4*(1-f)),ee=t.children[se];ee&&(z||(z=ee,z.next=t.next),Z&&(Z.next=ee),Z=ee,ee.next=t.next)}t=z||t.next}return l}getRegionStatistics(e){let t=this._root,s=0,r=0,a=0,o={},{bounds:n,geohashBounds:u,level:h}=e,[l,d,c,m]=n,_=0;for(;t!==null;){let p=t.depth,f=t.xNode,b=t.yNode;if(p>=h){let re=t.xTotal/t.count,ie=t.yTotal/t.count;re>l&&re<=c&&ie>d&&ie<=m&&(s+=t.count,r+=t.xTotal,a+=t.yTotal,t.count===1&&(_=t.referenceId),this._aggregateStatistics(o,t.statistics)),t=t.next;continue}let I=Math.ceil((p+1)/2),x=Math.floor((p+1)/2),y=1-p%2,v=30-(3*I+2*x),S=30-(2*I+3*x),w=~((1<<v)-1),k=~((1<<S)-1),O=(u.xLL&w)>>v,M=(u.yLL&k)>>S,T=(u.xTR&w)>>v,R=(u.yTR&k)>>S,G=f<<3*y+2*(1-y),Q=b<<2*y+3*(1-y),H=G+8*y+4*(1-y),K=Q+4*y+8*(1-y),z=Math.max(G,O),Z=Math.max(Q,M),Y=Math.min(H,T),D=Math.min(K,R),se=null,ee=null;for(let re=Z;re<=D;re++)for(let ie=z;ie<=Y;ie++){let xs=ie-G+(re-Q)*(8*y+4*(1-y)),j=t.children[xs];if(j){if(re!==Z&&re!==D&&ie!==z&&ie!==Y){let Ft=j.xTotal/j.count,Tt=j.yTotal/j.count;Ft>l&&Ft<=c&&Tt>d&&Tt<=m&&(s+=j.count,r+=j.xTotal,a+=j.yTotal,j.count===1&&(_=j.referenceId),this._aggregateStatistics(o,j.statistics));continue}se||(se=j,se.next=t.next),ee&&(ee.next=j),ee=j,j.next=t.next}}t=se||t.next}return{count:s,attributes:this.normalizeStatistics(o,s),xTotal:r,yTotal:a,referenceId:_}}getBins(e){let t=[],{geohashBounds:s,level:r}=e,a=this._root;for(;a!==null;){let o=a.depth,n=a.xNode,u=a.yNode;if(o>=r){t.push(a),a=a.next;continue}let h=Math.ceil((o+1)/2),l=Math.floor((o+1)/2),d=1-o%2,c=30-(3*h+2*l),m=30-(2*h+3*l),_=~((1<<c)-1),p=~((1<<m)-1),f=(s.xLL&_)>>c,b=(s.yLL&p)>>m,I=(s.xTR&_)>>c,x=(s.yTR&p)>>m,y=n<<3*d+2*(1-d),v=u<<2*d+3*(1-d),S=y+8*d+4*(1-d),w=v+4*d+8*(1-d),k=Math.max(y,f),O=Math.max(v,b),M=Math.min(S,I),T=Math.min(w,x),R=null,G=null;for(let Q=O;Q<=T;Q++)for(let H=k;H<=M;H++){let K=H-y+(Q-v)*(8*d+4*(1-d)),z=a.children[K];z&&(R||(R=z,R.next=a.next),G&&(G.next=z),G=z,z.next=a.next)}a=R||a.next}return t}_linkChildren(e){let t=null,s=null;for(let r=0;r<=e.children.length;r++){let a=e.children[r];a&&(t||(t=a,t.next=e.next),s&&(s.next=a),s=a,a.next=e.next)}return t}_updateStatisticsCursor(e,t,s){for(let r of this._statisticFields){let a=r.name,o=r.inField?e.readAttribute(r.inField):e.getComputedNumericAtIndex(r.inFieldIndex);switch(r.statisticType){case"min":{if(isNaN(o))break;if(!t.statistics[a]){t.statistics[a]={value:o};break}let n=t.statistics[a].value;t.statistics[a].value=Math.min(n,o);break}case"max":{if(isNaN(o))break;if(!t.statistics[a]){t.statistics[a]={value:o};break}let n=t.statistics[a].value;t.statistics[a].value=Math.max(n,o);break}case"count":break;case"sum":case"avg":{t.statistics[a]||(t.statistics[a]={value:0,nanCount:0});let n=t.statistics[a].value,u=t.statistics[a].nanCount??0;o==null||isNaN(o)?t.statistics[a].nanCount=u+s:t.statistics[a].value=n+s*o;break}case"avg_angle":{t.statistics[a]||(t.statistics[a]={x:0,y:0,nanCount:0});let n=t.statistics[a].x,u=t.statistics[a].y,h=t.statistics[a].nanCount??0,l=Math.PI/180;o==null||isNaN(o)?t.statistics[a].nanCount=h+s:(t.statistics[a].x=n+s*Math.cos(o*l),t.statistics[a].y=u+s*Math.sin(o*l));break}case"mode":{t.statistics[a]||(t.statistics[a]={});let n=t.statistics[a][o]||0;t.statistics[a][o]=n+s;break}}}}_aggregateStatistics(e,t){for(let s of this._statisticFields){let r=s.name;switch(s.statisticType){case"min":{if(!e[r]){e[r]={value:t[r].value};break}let a=e[r].value;e[r].value=Math.min(a,t[r].value);break}case"max":{if(!e[r]){e[r]={value:t[r].value};break}let a=e[r].value;e[r].value=Math.max(a,t[r].value);break}case"count":break;case"sum":case"avg":case"avg_angle":case"mode":e[r]||(e[r]={});for(let a in t[r]){let o=e[r][a]||0;e[r][a]=o+t[r][a]}}}}normalizeStatistics(e,t){let s={};for(let r of this._statisticFields){let a=r.name;switch(r.statisticType){case"min":case"max":{let o=e[a];if(!t||!o)break;s[a]=o.value;break}case"count":if(!t)break;s[a]=t;break;case"sum":{if(!t)break;let{value:o,nanCount:n}=e[a];if(!(t-n))break;s[a]=o;break}case"avg":{if(!t)break;let{value:o,nanCount:n}=e[a];if(!(t-n))break;s[a]=o/(t-n);break}case"avg_angle":{if(!t)break;let{x:o,y:n,nanCount:u}=e[a];if(!(t-u))break;let h=o/(t-u),l=n/(t-u),d=180/Math.PI,c=Math.atan2(l,h)*d;s[a]=c;break}case"mode":{let o=e[a],n=0,u=0,h=null;for(let l in o){let d=o[l];d===n?u+=1:d>n&&(n=d,u=1,h=l)}s[a]=h==="null"||u>1?null:h;break}}}return s}},Oe=class{constructor(e,t,s,r){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=e,this.children=new Array(32);for(let a=0;a<this.children.length;a++)this.children[a]=null;this.xNode=t,this.yNode=s,this.depth=r}realloc(e,t,s){for(let r=0;r<this.children.length;r++)this.children[r]=null;return this.xNode=e,this.yNode=t,this.depth=s,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(e){this.displayIds.add(e)}remove(e){this.displayIds.delete(e)}getAttributes(){let e=this._tree.normalizeStatistics(this.statistics,this.count);return e.referenceId=null,e.aggregateId=this.id,e.aggregateCount=this.count,e}getGeometry(e,t){let s=this.getLngLatBounds(),[r,a,o,n]=s,u=te({rings:[[[r,a],[r,n],[o,n],[o,a],[r,a]]]},J.WGS84,e),h=be(new L,u,!1,!1);return t!=null?Re(new L,h,!1,!1,"esriGeometryPolygon",t,!1,!1):h}getGeometryCentroid(e,t){let s=this.getLngLatBounds(),[r,a,o,n]=s,u=te({x:(r+o)/2,y:(a+n)/2},J.WGS84,e),h=Qt(new L,u);return t!=null?Re(new L,h,!1,!1,"esriGeometryPoint",t,!1,!1):h}getLngLatBounds(){let e=this.depth,t=Math.ceil(e/2),s=Math.floor(e/2),r=30-(3*t+2*s),a=30-(2*t+3*s),o=this.xNode<<r,n=this.yNode<<a;return ss({geohashX:o,geohashY:n},this.depth)}find(e,t,s,r,a,o){if(r>=s)return this;let n=1-r%2,u=3*n+2*(1-n),h=2*n+3*(1-n),l=30-a-u,d=30-o-h,c=((e&7*n+3*(1-n)<<l)>>l)+((t&3*n+7*(1-n)<<d)>>d)*(8*n+4*(1-n)),m=this.children[c];return m==null?null:m.find(e,t,s,r+1,a+u,o+h)}};var St=$.getLogger("esri.view.2d.layers.features.support.BinStore"),_s=12,js=64,Ns=je(),Hs=5;function ys(i){return 57.29577951308232*i}var it=class i extends Je{constructor(e,t,s,r){super(e,s),this.type="bin",this.events=new ye,this.objectIdField="aggregateId",this.featureAdapter=Ze,this._geohashLevel=Hs,this._geohashBuf=[],this._serviceInfo=r,this.geometryInfo=e.geometryInfo,this._spatialReference=t,this._projectionSupportCheck=Xe(t,J.WGS84),this._bitsets.geohash=s.getBitset(s.createBitset()),this._bitsets.inserted=s.getBitset(s.createBitset())}destroy(){this._tree&&this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(e,t){return g(this,null,function*(){let s=this._schema;try{yield Ue(i.prototype,this,"updateSchema").call(this,e,t),yield this._projectionSupportCheck}catch{}this._fields=this._schema.params.fields,this._fieldsIndex=new V(this._fields);let r=ce(s,t);t&&(r!=null||e.source||e.storage.filters)?((le(r,"params.fields")||le(r,"params")||!this._tree||e.source)&&(this._tree&&this._tree.destroy(),this._tree=new Me(this._statisticFields,this._serviceInfo),this._tree.onRelease=a=>a.displayId&&this._storage.releaseDisplayId(a.displayId),this._geohashLevel=this._schema.params.fixedBinLevel,this._rebuildTree(),C("esri-2d-update-debug")&&St.info("Aggregate mesh needs update due to tree changing")),C("esri-2d-update-debug")&&St.info("Aggregate mesh needs update due to tree changing"),e.targets[t.name]=!0,e.mesh=!1):s&&(e.mesh=!0)})}clear(){this._rebuildTree()}sweepFeatures(e,t){this._bitsets.inserted.forEachSet(s=>{if(!e.has(s)){let r=t.lookupByDisplayIdUnsafe(s);this._remove(r)}})}sweepAggregates(e,t,s){}onTileData(e,t,s,r,a,o=!0){if(!this._schema||t.addOrUpdate==null)return t;this.events.emit("changed");let n=this._getTransforms(e,this._spatialReference);{let h=t.addOrUpdate.getCursor();for(;h.next();)this._update(h,r)}if(t.status.mesh||!o)return t;let u=new Array;this._getBinsForTile(u,e,n,s),t.addOrUpdate=U.fromOptimizedFeatures(u,{fields:this.fields,fieldsIndex:this._fieldsIndex,geometryType:"esriGeometryPolygon",objectIdField:this.objectIdField}),t.addOrUpdate.attachStorage(s),t.end=!0,t.isRepush||(t.clear=!0);{let h=t.addOrUpdate.getCursor();for(;h.next();){let l=h.getDisplayId();this._bitsets.computed.unset(l),this.setComputedAttributes(s,h,l,e.scale,a)}}return t}forEachBin(e){this._tree.forEach(e)}forEach(e){this._tree.forEach(t=>{if(t.depth!==this._geohashLevel)return;let s=this._toFeatureJSON(t),r=U.fromFeatures([s],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields,fieldsIndex:this._fieldsIndex}).getCursor();r.next(),e(r)})}forEachInBounds(e,t){}forEachBounds(e,t){let{hasM:s,hasZ:r}=this.geometryInfo;for(let a of e){let o=Ve(Ns,a.readGeometry(),r,s);o!=null&&t(o)}}onTileUpdate(e){}getAggregate(e){let t=Jt(e,!0),s=this._tree.findIf(r=>r.displayId===t);return s?this._toFeatureJSON(s):null}getAggregates(){return this._tree.findAllIf(e=>e.depth===this._geohashLevel).map(this._toFeatureJSON.bind(this))}getDisplayId(e){return this._tree.findIf(t=>t.id===e)?.displayId}getFeatureDisplayIdsForAggregate(e){let t=this._tree.findIf(s=>s.id===e);return t!=null?Array.from(t.displayIds):[]}getDisplayIdForReferenceId(e){return this._tree.findIf(t=>t.displayIds.size===1&&t.displayIds.has(e))?.displayId}_toFeatureJSON(e){let t=this._spatialReference;return{displayId:e.displayId,attributes:e.getAttributes(),geometry:Se(e.getGeometry(t),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(e){let t=e.getDisplayId(),s=e.getXHydrated(),r=e.getYHydrated(),a=this._geohashBuf[2*t],o=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,a,o,this._geohashLevel))}_update(e,t){let s=e.getDisplayId(),r=this._bitsets.inserted,a=t.isVisible(s);if(a===r.has(s))return;if(!a)return void this._remove(e);let o=e.getXHydrated(),n=e.getYHydrated();if(!this._setGeohash(s,o,n))return;let u=this._geohashBuf[2*s],h=this._geohashBuf[2*s+1];this._tree.insertCursor(e,s,o,n,u,h,this._geohashLevel),r.set(s)}_setGeohash(e,t,s){if(this._bitsets.geohash.has(e))return!0;let r=this._geohashBuf;if(this._spatialReference.isWebMercator){let a=ys(t/W.radius),o=a-360*Math.floor((a+180)/360),n=ys(Math.PI/2-2*Math.atan(Math.exp(-s/W.radius)));we(r,e,n,o,_s)}else{let a=te({x:t,y:s},this._spatialReference,J.WGS84);if(!a)return!1;we(r,e,a.y,a.x,_s)}return this._bitsets.geohash.set(e),!0}_getBinsForTile(e,t,s,r){try{let a=this._getGeohashBounds(t),o=this._tree.getBins(a);for(let n of o){n.displayId||(n.displayId=r.createDisplayId(!0));let u=null,h=n.getGeometry(this._spatialReference,s.tile);h||(u=n.getGeometryCentroid(this._spatialReference,s.tile));let l=new ve(h,n.getAttributes(),u);l.objectId=n.id,l.displayId=n.displayId,e.push(l)}}catch{return void St.error("Unable to get bins for tile",t.key.id)}}_getGeohash(e,t,s){let r={geohashX:0,geohashY:0};return xe(r,t,e,s),r}_getGeohashBounds(e){let t=this._getGeohashLevel(e.key.level),s=[e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax],r=ze.fromExtent(Be.fromBounds(s,this._spatialReference)),a=te(r,this._spatialReference,J.WGS84,{densificationStep:e.resolution*js}),o=be(new L,a,!1,!1),n=o.coords.filter((p,f)=>!(f%2)),u=o.coords.filter((p,f)=>f%2),h=Math.min(...n),l=Math.min(...u),d=Math.max(...n),c=Math.max(...u),m=this._getGeohash(h,l,t),_=this._getGeohash(d,c,t);return{bounds:s,geohashBounds:{xLL:m.geohashX,yLL:m.geohashY,xTR:_.geohashX,yTR:_.geohashY},level:t}}_getGeohashLevel(e){return this._schema.params.fixedBinLevel}_getTransforms(e,t){let s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=Qe(t);if(!r)return{tile:s,left:null,right:null};let[a,o]=r.valid;return{tile:s,left:A(F({},s),{translate:[o,e.bounds[3]]}),right:A(F({},s),{translate:[a-o+e.bounds[0],e.bounds[3]]})}}};var xt=12,Vs=64,vs=1,Xs=je(),wt=class i extends Gt{constructor(e,t,s,r,a){super(new L([],[t,s]),r,null,e),this.geohashBoundsInfo=a}get count(){return this.attributes.cluster_count}static create(e,t,s,r,a,o,n,u){let h=new i(t,s,r,o,n);return h.displayId=e.createDisplayId(!0),h.referenceId=u,h.tileLevel=a,h}update(e,t,s,r,a,o){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=s,this.attributes=r,this.geohashBoundsInfo=a,this.referenceId=null,this.referenceId=o,this}toJSON(){return{attributes:A(F({},this.attributes),{aggregateId:this.objectId,referenceId:this.attributes.cluster_count===1?this.referenceId:null}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}};function ke(i){return 57.29577951308232*i}var at=class i extends Je{constructor(e,t,s,r){super(e,s),this.type="cluster",this.events=new ye,this.objectIdField="aggregateId",this.featureAdapter=Ze,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=r,this.geometryInfo=e.geometryInfo,this._spatialReference=t,this._projectionSupportCheck=Xe(t,J.WGS84),this._bitsets.geohash=s.getBitset(s.createBitset()),this._bitsets.inserted=s.getBitset(s.createBitset())}destroy(){this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(e,t){return g(this,null,function*(){let s=this._schema;try{yield Ue(i.prototype,this,"updateSchema").call(this,e,t),yield this._projectionSupportCheck}catch{}this._fields=[...this._schema.params.fields,{name:"referenceId",alias:"referenceId",type:"esriFieldTypeInteger"}],this._fields.some(a=>a.name==="cluster_count")||this._fields.push({name:"cluster_count",alias:"cluster_count",type:"esriFieldTypeInteger"}),this._fieldsIndex=new V(this._fields);let r=ce(s,t);t&&(r!=null||e.source||e.storage.filters)?((le(r,"params.fields")||!this._tree||e.source)&&(this._tree&&this._tree.destroy(),this._tree=new Me(this._statisticFields,this._serviceInfo),this._rebuildTree(),C("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),C("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",r),e.targets[t.name]=!0,e.mesh=!1,this._aggregateValueRanges={}):s&&(e.mesh=!0)})}clear(){this._rebuildTree()}sweepFeatures(e,t){this._bitsets.inserted.forEachSet(s=>{if(!e.has(s)){let r=t.lookupByDisplayIdUnsafe(s);this._remove(r)}})}sweepAggregates(e,t,s){this._clusters.forEach((r,a)=>{r&&r.tileLevel!==s&&(e.releaseDisplayId(r.displayId),t.unsetAttributeData(r.displayId),this._clusters.delete(a))})}onTileData(e,t,s,r,a,o=!0){if(!this._schema||t.addOrUpdate==null)return t;this.events.emit("changed");let n=this._getTransforms(e,this._spatialReference);{let l=t.addOrUpdate.getCursor();for(;l.next();)this._update(l,r)}if(t.status.mesh||!o)return t;let u=new Array,h=this._schema.params.clusterRadius;this._getClustersForTile(u,e,h,s,n),t.addOrUpdate=U.fromOptimizedFeatures(u,{fields:this.fields,fieldsIndex:this._fieldsIndex,geometryType:"esriGeometryPoint",objectIdField:this.objectIdField}),t.addOrUpdate.attachStorage(s),t.clear=!0,t.end=!0;{let l=t.addOrUpdate.getCursor();for(;l.next();){let d=l.getDisplayId();this._bitsets.computed.unset(d),this.setComputedAttributes(s,l,d,e.scale,a)}}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t}onTileUpdate({added:e,removed:t}){if(e.length){let r=e[0].level;this._tileLevel=r,this._setGeohashLevel(r)}if(!this._schema)return;let s=this._schema.params.clusterRadius;t.forEach(r=>{this._tiles.delete(r.key.id),this._markTileClustersForDeletion(r,s)})}getAggregate(e){for(let t of this._clusters.values())if((t?.displayId&8388607)==(e&8388607))return t.toJSON();return null}getAggregates(){let e=[];for(let t of this._clusters.values())t?.tileLevel===this._tileLevel&&e.push(t.toJSON());return e}getDisplayId(e){let t=this._clusters.get(e);return t?t.displayId:null}getFeatureDisplayIdsForAggregate(e){let t=this._clusters.get(e);return t?this._tree.getRegionDisplayIds(t.geohashBoundsInfo):[]}getDisplayIdForReferenceId(e){for(let t of this._clusters.values())if(t?.referenceId===e)return t.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(e){this._clusters.forEach(t=>{if(!t)return;let s=t.toJSON(),r=U.fromFeatures([s],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields,fieldsIndex:this._fieldsIndex}).getCursor();r.next(),e(r)})}forEachInBounds(e,t){}forEachBounds(e,t){let{hasM:s,hasZ:r}=this.geometryInfo;for(let a of e){let o=Ve(Xs,a.readGeometry(),r,s);o!=null&&t(o)}}size(){let e=0;return this.forEach(t=>e++),e}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(e){let t=e.getDisplayId(),s=e.getXHydrated(),r=e.getYHydrated(),a=this._geohashBuf[2*t],o=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,s,r,a,o,this._geohashLevel))}_update(e,t){let s=e.getDisplayId(),r=this._bitsets.inserted,a=t.isVisible(s);if(a===r.has(s))return;if(!a)return void this._remove(e);let o=e.getXHydrated(),n=e.getYHydrated();if(!this._setGeohash(s,o,n))return;let u=this._geohashBuf[2*s],h=this._geohashBuf[2*s+1];this._tree.insertCursor(e,s,o,n,u,h,this._geohashLevel),r.set(s)}_setGeohash(e,t,s){if(this._bitsets.geohash.has(e))return!0;let r=this._geohashBuf;if(this._spatialReference.isWebMercator){let a=ke(t/W.radius),o=a-360*Math.floor((a+180)/360),n=ke(Math.PI/2-2*Math.atan(Math.exp(-s/W.radius)));we(r,e,n,o,xt)}else{let a=te({x:t,y:s},this._spatialReference,J.WGS84);if(!a)return!1;we(r,e,a.y,a.x,xt)}return this._bitsets.geohash.set(e),!0}_getClustersForTile(e,t,s,r,a,o=!0){let n=this._schema.params.clusterPixelBuffer,u=2*s,h=Math.ceil(2**t.key.level*N/u)+1,l=Math.ceil(n/u)+0,d=Math.ceil(N/u),{row:c,col:m}=t.key,_=m*N,p=c*N,f=Math.floor(_/u)-l,b=Math.floor(p/u)-l,I=f+d+2*l,x=b+d+2*l,y=t.tileInfoView.getLODInfoAt(t.key.level);for(let v=f;v<=I;v++)for(let S=b;S<=x;S++){let w=v;y.wrap&&(w=v<0?v+h:v%h);let k=y.wrap&&v<0,O=y.wrap&&v%h!==v,M=this._lookupCluster(r,y,t.key.level,w,S,t);if(M!=null){let T=null;if(a&&(T=k?a.left:O?a.right:a.tile),o&&T==null||!M.count)continue;if(T!=null&&o){let R=M.geometry.clone(),G=M.attributes;R.coords[0]=Ne(T,R.coords[0]),R.coords[1]=He(T,R.coords[1]),M.count===1&&M.referenceId!=null&&(G=A(F({},M.attributes),{referenceId:M.referenceId}));let Q=new ve(R,G);Q.displayId=M.displayId,e.push(Q)}}}}_getGeohashLevel(e){return Math.min(Math.ceil(e/2+2),xt)}_setGeohashLevel(e){let t=this._getGeohashLevel(e),s=(Math.floor(t/vs)+1)*vs-1;if(this._geohashLevel!==s)return this._geohashLevel=s,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(e,t){let s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},r=Qe(t);if(!r)return{tile:s,left:null,right:null};let[a,o]=r.valid;return{tile:s,left:A(F({},s),{translate:[o,e.bounds[3]]}),right:A(F({},s),{translate:[a-o+e.bounds[0],e.bounds[3]]})}}_getClusterId(e,t,s){return(15&e)<<28|(16383&t)<<14|16383&s}_markForDeletion(e,t,s){let r=this._getClusterId(e,t,s);this._clusters.delete(r)}_getClusterBounds(e,t,s){let r=this._schema.params.clusterRadius,a=2*r,o=s%2?t*a:t*a-r,n=s*a,u=o+a,h=n-a,l=2**e.level*N;e.wrap&&o<0&&(o=0),e.wrap&&u>l&&(u=l);let d=o/N,c=n/N,m=u/N,_=h/N;return[e.getXForColumn(d),e.getYForRow(c),e.getXForColumn(m),e.getYForRow(_)]}_getGeohash(e,t,s){let r={geohashX:0,geohashY:0};return xe(r,t,e,s),r}_getGeohashBounds(e,t){let s=this._getGeohashLevel(e.key.level);if(this._spatialReference.isWebMercator){let[p,f,b,I]=t,x={x:p,y:f},y={x:b,y:I},v=0,S=0,w=0,k=0;{let T=ke(x.x/W.radius);v=T-360*Math.floor((T+180)/360),S=ke(Math.PI/2-2*Math.atan(Math.exp(-x.y/W.radius)))}{let T=ke(y.x/W.radius);w=T-360*Math.floor((T+180)/360),k=ke(Math.PI/2-2*Math.atan(Math.exp(-y.y/W.radius)))}let O={geohashX:0,geohashY:0},M={geohashX:0,geohashY:0};return xe(O,S,v,s),xe(M,k,w,s),{bounds:[p,f,b,I],geohashBounds:{xLL:O.geohashX,yLL:O.geohashY,xTR:M.geohashX,yTR:M.geohashY},level:s}}let r=ze.fromExtent(Be.fromBounds(t,this._spatialReference)),a=te(r,this._spatialReference,J.WGS84,{densificationStep:e.resolution*Vs});if(!a)return null;let o=be(new L,a,!1,!1),n=o.coords.filter((p,f)=>!(f%2)),u=o.coords.filter((p,f)=>f%2),h=Math.min(...n),l=Math.min(...u),d=Math.max(...n),c=Math.max(...u),m=this._getGeohash(h,l,s),_=this._getGeohash(d,c,s);return{bounds:t,geohashBounds:{xLL:m.geohashX,yLL:m.geohashY,xTR:_.geohashX,yTR:_.geohashY},level:s}}_lookupCluster(e,t,s,r,a,o){let n=this._getClusterId(s,r,a),u=this._clusters.get(n),h=this._getClusterBounds(t,r,a),l=this._getGeohashBounds(o,h);if(l==null)return null;let d=this._tree.getRegionStatistics(l),{count:c,xTotal:m,yTotal:_,referenceId:p}=d,f=c?m/c:0,b=c?_/c:0;if(c===0)return this._clusters.set(n,null),null;let I=F({cluster_count:c},d.attributes),x=u!=null?u.update(f,b,s,I,l,p):wt.create(e,n,f,b,s,I,l,p);if(c===0){let[y,v,S,w]=h;x.geometry.coords[0]=(y+S)/2,x.geometry.coords[1]=(v+w)/2}return this._clusters.set(n,x),this._updateAggregateValueRangeForCluster(x,x.tileLevel),x}_updateAggregateValueRangeForCluster(e,t){let s=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},r=s.minValue,a=s.maxValue;s.minValue=Math.min(r,e.count),s.maxValue=Math.max(a,e.count),this._aggregateValueRanges[t]=s,r===s.minValue&&a===s.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(e,t){let s=2*t,r=Math.ceil(N/s),{row:a,col:o}=e.key,n=o*N,u=a*N,h=Math.floor(n/s),l=Math.floor(u/s);for(let d=h;d<h+r;d++)for(let c=l;c<l+r;c++)this._markForDeletion(e.key.level,d,c)}};var Ys=5e3,Js="tileRenderer.featuresView.attributeView.initialize",Zs="tileRenderer.featuresView.attributeView.requestUpdate",$s="tileRenderer.featuresView.requestRender";function Ws(i){return i.name==="worker:port-closed"}function ue(i){if(!oe(i)&&!Ws(i))throw i}function bs(i){return i.type==="feature"&&i.mode==="snapshot"}var X=class extends _e{constructor(){super(...arguments),this._storage=new rs,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this._updatingHandles=new Ye,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new Ee({concurrency:this._source.type==="stream"?1:4,process:(i,e)=>this._onTileMessage(i,{signal:e})}),this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this)),qt(()=>!this.updating,()=>this.onIdle())])}_initSource(){let i=this.tileStore.tileScheme,e=()=>this._updateQueue&&this._updateQueue.length<50,t=(s,r)=>(this._invalidated=!0,this._patchTile(s,r));this._source=ms(this.service,A(F({},this.service),{fieldsIndex:this.fieldsIndex}),this.spatialReference,i,t,e,this.featureStore),this._proxyEvents()}_setStreamClientProperty(i,e){this.remoteClient.invoke("setProperty",{propertyName:i,value:e}).catch(ue)}_proxyEvents(){if(this._source.type==="stream"){let i=this._source.events,e=this._source;this.addHandles([Ie(()=>e.connectionStatus,t=>this._setStreamClientProperty("pipelineConnectionStatus",t),{initial:!0}),Ie(()=>e.errorString,t=>this._setStreamClientProperty("pipelineErrorString",t),{initial:!0}),i.on("data-received",t=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(ue)),i.on("message-received",t=>this.remoteClient.invoke("emitEvent",{name:"message-received",event:t}).catch(ue)),i.on("updateRate",t=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:F({},t)}).catch(ue))])}}_initAttributeStore(i){this.attributeStore||(this.attributeStore=new ts({type:"remote",initialize:(e,t)=>me(this.remoteClient.invoke(Js,e,{signal:t}).catch(ue)),update:(e,t)=>me(this.remoteClient.invoke(Zs,e,{signal:t}).catch(ue)),render:e=>me(this.remoteClient.invoke($s,void 0,{signal:e}).catch(ue))},i))}_initStores(){let i=this.service.type==="snapshot"?"snapshot":"on-demand",e={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex};this.featureStore=new Kt(e,this._storage,i)}_initQueryEngine(i){let e=this;this.featureQueryEngine?.destroy(),this.featureQueryEngine=new ht({availableFields:i.availableFields,definitionExpression:i.schema.source.definitionExpression??void 0,fieldsIndex:V.fromJSON(this.service.fieldsIndex),geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds(t){return e.aggregateStore==null?[]:e.aggregateStore.getFeatureDisplayIdsForAggregate(t).map(s=>e.getObjectId(s))}},timeInfo:this.service.timeInfo})}_initAggregateQueryEngine(i,e){if(this.aggregateQueryEngine?.destroy(),i==null)return;let t=e.targets.aggregate.params.fields.slice();this.aggregateQueryEngine=new ht({definitionExpression:void 0,fieldsIndex:V.fromLayerJSON({fields:t,dateFieldsTimeReference:{timeZoneIANA:Rt}}),geometryType:i.geometryInfo.geometryType,objectIdField:i.objectIdField,hasM:i.geometryInfo.hasM,hasZ:i.geometryInfo.hasZ,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!1,featureStore:i,aggregateAdapter:{getFeatureObjectIds:s=>[]}})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.featureQueryEngine?.destroy(),this.aggregateQueryEngine?.destroy(),this.attributeStore?.destroy();for(let i of this.tileStore.tiles)this._source.unsubscribe(i);clearInterval(this._checkUpdating),this._updatingHandles.destroy()}get fieldsIndex(){return V.fromJSON(this.service.fieldsIndex)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get dataUpdating(){return this._source.updatingHandles.updating}get updating(){return this.isUpdating()}isUpdating(){let i=this._source.updatingHandles.updating,e=!this.attributeStore||this.attributeStore.updatingHandles.updating,t=i||e||this._updatingHandles.updating;if(C("esri-2d-log-updating")){let s=`Updating FeatureController2D: ${t}
`;s+=`  -> updatingSource ${i}
`;for(let r of this._source.subscriptions)s+=`     ${r.tile.id} ${r.isDone}
`;s+=`  -> updatingAttributeStore ${e}
`,s+=`  -> updatingHandles ${this._updatingHandles.updating} (queue: ${this._updateQueue.length})
`,console.log(s)}return t}updateCustomParameters(i){this._source.type==="stream"&&this._source.updateCustomParameters(i)}enableEvent(i){this._source.enableEvent(i.name,i.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){this._source.type==="stream"&&this._source.pauseStream()}resumeStream(){this._source.type==="stream"&&this._source.resumeStream()}sendMessageToSocket(i){this._source.type==="stream"&&this._source.sendMessageToSocket(i)}sendMessageToClient(i){this._source.type==="stream"&&this._source.sendMessageToClient(i)}_initAggregateStore(i){let e=i.schema.targets?.aggregate?.type??null;if((this.config?.schema.targets?.aggregate?.type??null)!==e&&(this.aggregateStore!=null&&(this.removeHandles("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),e)){switch(e){case"cluster":{let t={geometryInfo:{geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.aggregateStore=new at(t,this.spatialReference,this._storage,A(F({},this.service),{fieldsIndex:this.fieldsIndex})),this.addHandles(this.aggregateStore.events.on("valueRangesChanged",s=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:s.valueRanges}}).catch(ue)}),"valueRangesChanged");break}case"bin":{let t={geometryInfo:{geometryType:"esriGeometryPolygon",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.aggregateStore=new it(t,this.spatialReference,this._storage,A(F({},this.service),{fieldsIndex:this.fieldsIndex}));break}}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(i,e){return g(this,null,function*(){this._updateVersion++,C("esri-2d-update-debug")&&console.debug(`FeatureController2D::update: Token version ${this._updateVersion}`),this._initQueryEngine(e),this._initAttributeStore(e),this.pause(),this.config?.timeZone!==e.timeZone&&(i.mesh=!0,i.storage.data=!0,i.storage.filters=!0,i.targets.aggregate=!0,i.targets.feature=!0,this.featureStore.invalidate()),yield Promise.all([this._source.update(i,e.schema.source),this.featureStore.updateSchema(i,e.schema.targets.feature),this.attributeStore.update(i,e),this.attributeStore.updateFilters(i,e,this)]),this._initAggregateStore(e),this.aggregateStore!=null&&(yield this.aggregateStore.updateSchema(i,e.schema.targets.aggregate)),this._initAggregateQueryEngine(this.aggregateStore,e.schema),C("esri-2d-update-debug")&&i.describe(),this._set("config",e)})}applyUpdate(i){return g(this,null,function*(){i.version=this._updateVersion,C("esri-2d-update-debug")&&console.debug(`FeatureController2D::applyUpdate: Token version ${i.version}`),i.mesh&&this.clearTiles(),this._updateQueue.resume(),yield this._source.applyUpdate(i),C("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Waiting for source update to finish"),this.notifyChange("updating"),yield qe(()=>!this.updating),C("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Source update finsihed"),this.aggregateStore!=null&&(yield Le(10),C("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Waiting for aggregate idle call"),yield qe(()=>!this.updating),C("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Aggregate idle called")),C("esri-2d-update-debug")&&console.debug("FeatureController2D::applyUpdate Update finished")})}onEdits(e){return g(this,arguments,function*({edits:i}){C("esri-2d-update-debug")&&console.debug("Applying Edit:",i),this._didEdit=!0;try{let t=i.removed.map(r=>r.objectId&&r.objectId!==-1?r.objectId:this._lookupObjectIdByGlobalId(r.globalId)),s=i.addOrModified.map(({objectId:r})=>r);this.featureStore.invalidate(),yield this._source.edit(s,t),this.clearTiles(),this.notifyChange("updating"),this.aggregateStore!=null&&this.aggregateStore.clear(),yield this._source.resend(),yield qe(()=>!this.updating)}catch{}})}refresh(i){return g(this,null,function*(){if(!i.dataChanged){let e=E.empty();return e.storage.filters=!0,this.applyUpdate(e)}this.featureStore.invalidate(),this.clearTiles(),this._source.refresh(this._updateVersion,i),this._cleanupNeeded=!0,this.notifyChange("updating"),yield qe(()=>!this.updating)})}clearTiles(){for(let i of this.tileStore.tiles)this.processor.onTileClear(i,!1)}onTileUpdate(i){this.aggregateStore!=null&&this.aggregateStore.onTileUpdate(i);for(let e of i.added){let t=this._source.subscribe(e,this._updateVersion);this._source.type!=="stream"&&this._updatingHandles.addPromise(t.done),this._level=e.level}for(let e of i.removed)this._source.unsubscribe(e),this._cleanupNeeded=!0,this._tileToResolver.has(e.id)&&(this._tileToResolver.get(e.id).resolve(),this._tileToResolver.delete(e.id));this.notifyChange("updating")}onIdle(){return g(this,null,function*(){this._invalidated&&(this._invalidated=!1,this.aggregateStore==null&&this.processor.type!=="heatmap"||(yield this._repushCurrentLevelTiles())),this._markAndSweep()})}querySummaryStatistics(t){return g(this,arguments,function*({query:i,params:e}){return this.featureQueryEngine.executeQueryForSummaryStatistics(i,e)})}queryAggregateSummaryStatistics(t){return g(this,arguments,function*({query:i,params:e}){return this.aggregateQueryEngine.executeQueryForSummaryStatistics(this._normalizeAggregateQuery(i),e)})}queryUniqueValues(t){return g(this,arguments,function*({query:i,params:e}){return this.featureQueryEngine.executeQueryForUniqueValues(i,e)})}queryAggregateUniqueValues(t){return g(this,arguments,function*({query:i,params:e}){return this.aggregateQueryEngine.executeQueryForUniqueValues(this._normalizeAggregateQuery(i),e)})}queryClassBreaks(t){return g(this,arguments,function*({query:i,params:e}){return this.featureQueryEngine.executeQueryForClassBreaks(i,e)})}queryAggregateClassBreaks(t){return g(this,arguments,function*({query:i,params:e}){return this.aggregateQueryEngine.executeQueryForClassBreaks(this._normalizeAggregateQuery(i),e)})}queryHistogram(t){return g(this,arguments,function*({query:i,params:e}){return this.featureQueryEngine.executeQueryForHistogram(i,e)})}queryAggregateHistogram(t){return g(this,arguments,function*({query:i,params:e}){return this.aggregateQueryEngine.executeQueryForHistogram(this._normalizeAggregateQuery(i),e)})}queryExtent(i){return this.featureQueryEngine.executeQueryForExtent(i)}queryAggregates(i){return this.aggregateQueryEngine.executeQuery(this._normalizeAggregateQuery(i))}queryAggregateCount(i){return this.aggregateQueryEngine.executeQueryForCount(this._normalizeAggregateQuery(i))}queryAggregateIds(i){return this.aggregateQueryEngine.executeQueryForIds(this._normalizeAggregateQuery(i))}queryFeatures(i){return this.featureQueryEngine.executeQuery(i)}queryVisibleFeatures(i){return g(this,null,function*(){let e=yield this.featureQueryEngine.executeQuery(i),t=e.objectIdFieldName;return e.features=e.features.filter(s=>{let r=s.attributes[t],a=this.getDisplayId(r);return a!=null&&this.attributeStore.isVisible(a)}),e})}queryFeatureCount(i){return this.featureQueryEngine.executeQueryForCount(i)}queryLatestObservations(i){return this.featureQueryEngine.executeQueryForLatestObservations(i)}queryObjectIds(i){return this.featureQueryEngine.executeQueryForIds(i)}queryStatistics(){return g(this,null,function*(){return this.featureStore.storeStatistics})}getObjectId(i){return this.featureStore.lookupObjectId(i,this._storage)}getDisplayId(i){if(this.aggregateStore!=null){let e=this.aggregateStore.getDisplayId(i);if(e==null){let t=this.featureStore.lookupDisplayId(i);return this.aggregateStore.getDisplayIdForReferenceId(t)}return e}return this.featureStore.lookupDisplayId(i)}getFeatures(i){let e=[],t=[];for(let s of i){let r=this.aggregateStore!=null?this.getAggregate(s):null;if(r!=null)if(r.attributes.referenceId!=null){let a=this.getFeature(r.attributes.referenceId);a!=null&&e.push(a)}else t.push(r);else{let a=this.getFeature(s);a!=null&&e.push(a)}}return{features:e,aggregates:t}}getFeature(i){let e=this.featureStore.lookupFeatureByDisplayId(i,this._storage);if(e==null)return null;let t=e.readHydratedGeometry(),s=Se(t,e.geometryType,e.hasZ,e.hasM);return{attributes:e.readAttributes(),geometry:s}}getAggregate(i){return this.aggregateStore==null?null:this.aggregateStore.getAggregate(i)}getAggregates(){return this.aggregateStore==null?[]:this.aggregateStore.getAggregates()}setHighlight(i){return g(this,null,function*(){let e=i.map(t=>this.getDisplayId(t)).filter(Pe);return this.attributeStore.setHighlight(i,e)})}_normalizeAggregateQuery(i){let e=i.objectIds??[];for(let t of i.aggregateIds??[])e.push(t);return i.objectIds=e,i.aggregateIds=[],i}_lookupObjectIdByGlobalId(i){let e=this.service.globalIdField;if(e==null)throw new Error("Expected globalIdField to be defined");let t=null;if(this.featureStore.forEach(s=>{i===s.readAttribute(e)&&(t=s.getObjectId())}),t==null)throw new Error(`Expected to find a feature with globalId ${i}`);return t}_repushCurrentLevelTiles(){return g(this,null,function*(){let i=this.tileStore.tiles.filter(t=>t.level===this._level);i.map(t=>g(this,null,function*(){return this._patchTile({type:"append",id:t.key.id,clear:!0,addOrUpdate:null,end:!1})}));let e=i.map(t=>g(this,null,function*(){return this._patchTile({type:"append",id:t.key.id,addOrUpdate:U.fromOptimizedFeatures([],A(F({},this.service),{fieldsIndex:this.fieldsIndex})),remove:[],end:!0,isRepush:!0,status:E.empty()})}));yield Promise.all(e)})}_maybeForceCleanup(){performance.now()-this._lastCleanup>Ys&&this._markAndSweep()}_patchTile(i,e){let t=this._updateQueue.push(i,e).catch(s=>{});return this._updatingHandles.addPromise(t)}_onTileMessage(i,e){return g(this,null,function*(){if(B(e),C("esri-2d-update-debug")){let a=i.addOrUpdate?.hasFeatures;console.debug(i.id,`FeatureController:onTileMessage: [clear:${i.clear}, end:${i.end}, features: ${a}]`)}let t=this.tileStore.get(i.id);if(!t)return;if(i.clear)return this.processor.onTileClear(t,i.end);let s=i.status;this._cleanupNeeded=!0;let r=[];for(let a of i.remove??[]){let o=this.featureStore.lookupDisplayId(a);o&&r.push(o)}i.remove=r;try{if(i.addOrUpdate==null)return void this.processor.onTileMessage(t,A(F({},i),{addOrUpdate:null}),this.aggregateStore!=null,e).catch(de);if(i.addOrUpdate.setArcadeSpatialReference(this.spatialReference),this.featureStore.hasInstance(i.addOrUpdate.instance)&&s.targets.feature||(s.targets.feature=!0,this.featureStore.onTileData(t,i,this.config?.timeZone)),(!s.storage.data||!s.storage.filters)&&(s.storage.data=!0,s.storage.filters=!0,this.attributeStore.onTileData(t,i),this._source.type==="stream"||this._didEdit?(yield this.attributeStore.sendUpdates(),B(e)):this.attributeStore.sendUpdates()),this.aggregateStore!=null&&!s.targets.aggregate){s.targets.aggregate=!0;let a=bs(this._source)&&this._source.loading,o=!bs(this._source)||a||i.end;if(this.aggregateStore.onTileData(t,i,this._storage,this.attributeStore,this.config?.timeZone,o),!o)return;s.mesh||(this.attributeStore.onTileData(t,i),yield this.attributeStore.sendUpdates())}if(!s.mesh){s.mesh=!0;let a=this.aggregateStore!=null&&this.aggregateStore.type==="cluster";yield this.processor.onTileMessage(t,i,a,e),B(e)}this._maybeForceCleanup()}catch(a){de(a)}})}_mark(i,e,t){let s=(4294901760&this._storage.getInstanceId(i))>>>16;i&&(e.add(s),t.set(i))}_markAndSweep(){if(this._lastCleanup=performance.now(),!(!(this._source.type==="feature"&&this._source.mode==="snapshot")&&(this._source.type==="stream"||this._cleanupNeeded)))return;this._cleanupNeeded=!1;let i=this._storage.getBitset(this._markedIdsBufId),e=new Set;i.clear();for(let t of this.tileStore.tiles)for(let s of this._source.readers(t.id)){let r=s.getCursor();for(;r.next();){let a=r.getDisplayId();if(!a){let o=r.getObjectId();a=this.featureStore.lookupDisplayId(o)}this._mark(a,e,i)}}this.processor.type==="symbol"&&this.processor.forEachBufferId(t=>{this._mark(t,e,i)}),this._updateQueue.forEach(t=>{for(let s of t.remove??[]){let r=this.featureStore.lookupDisplayId(s);this._mark(r,e,i)}}),this.aggregateStore!=null&&(this.aggregateStore.sweepFeatures(i,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(i,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(e)}};q([P({constructOnly:!0})],X.prototype,"tileStore",void 0),q([P()],X.prototype,"config",void 0),q([P({readOnly:!0})],X.prototype,"fieldsIndex",null),q([P()],X.prototype,"processor",void 0),q([P({constructOnly:!0})],X.prototype,"remoteClient",void 0),q([P({constructOnly:!0})],X.prototype,"service",void 0),q([P()],X.prototype,"spatialReference",null),q([P()],X.prototype,"dataUpdating",null),q([P()],X.prototype,"updating",null),X=q([ne("esri.views.2d.layers.features.controllers.FeatureController2D")],X);var Ss=X;var fe=class extends _e{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.addHandles([Ie(()=>this.updating,i=>{this.remoteClient.invoke("setUpdating",i).catch(e=>{})})])}destroy(){this.stop(),this.controller?.destroy(),this.processor?.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){this._paused=!0,Array.isArray(this.service?.source)&&(this.service.source.forEach(i=>i.close()),this.service.source.length=0),this.tileStore?.updateTiles({added:[],removed:this.tileStore.tiles.map(i=>i.id)}),this.tileStore?.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup(r){return g(this,arguments,function*({service:i,config:e,tileInfo:t,tiles:s}){if(this._paused=!0,Array.isArray(this.service?.source)&&(this.service.source.forEach(a=>a.close()),this.service.source.length=0),this.service=i,!this.tileStore||!Ot(this.tileStore.tileScheme.spatialReference,t.spatialReference)){let a=new Zt(Pt.fromJSON(t));s.added.length=s.removed.length=0,this.tileStore?.updateTiles({added:[],removed:this.tileStore.tiles.map(o=>o.id)}),this.tileStore?.destroy(),this.tileStore=new is(a),this._pendingTileUpdates.length=0}for(yield this._createProcessorAndController(e),yield this.update({config:e}),this.controller.resume(),this.tileStore.clear(),this.tileStore.updateTiles(s),this._paused=!1;this._pendingTileUpdates.length;)this.tileStore.updateTiles(this._pendingTileUpdates.pop())})}updateTiles(i){return g(this,null,function*(){this._paused?this._pendingTileUpdates.push(i):this.tileStore?.updateTiles(i)})}update(e){return g(this,arguments,function*({config:i}){let t=E.empty();return yield Promise.all([this.processor.update(t,i),this.controller.update(t,i)]),t.toJSON()})}applyUpdate(i){return g(this,null,function*(){return this.controller.applyUpdate(E.create(i))})}_createProcessorAndController(i){return g(this,null,function*(){yield Promise.all([this._handleControllerConfig(i),this._handleProcessorConfig(i)]),this.controller.processor=this.processor})}_handleControllerConfig(i){return g(this,null,function*(){return this._createController(this.service,i)})}_handleProcessorConfig(i){return g(this,null,function*(){return this._createProcessor(this.service,i)})}_createController(i,e){return g(this,null,function*(){this.controller&&(this.controller.destroy(),this.removeHandles("controller"));let{tileStore:t,remoteClient:s}=this,r=new Ss({service:i,tileStore:t,remoteClient:s}),a=Ie(()=>r.dataUpdating,o=>{this.remoteClient.invoke("setDataUpdating",o).catch(n=>{})});return this.addHandles(a,"controller"),this.controller=r,r})}_createProcessor(i,e){return g(this,null,function*(){let t=e.schema.processors[0].type,s=(yield os(t)).default,{remoteClient:r,tileStore:a}=this,o=new s({service:i,config:e,tileStore:a,remoteClient:r});return this.processor&&this.processor.destroy(),this.processor=o,o})}};q([P()],fe.prototype,"controller",void 0),q([P()],fe.prototype,"processor",void 0),q([P()],fe.prototype,"updating",null),q([P()],fe.prototype,"viewState",void 0),fe=q([ne("esri.views.2d.layers.features.Pipeline")],fe);var jo=fe;export{jo as default};
