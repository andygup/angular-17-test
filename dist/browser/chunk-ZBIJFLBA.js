import{a as ce}from"./chunk-RAWWKCRC.js";import{a as he}from"./chunk-6XFWNJFJ.js";import"./chunk-WV4GLBNV.js";import{a as le}from"./chunk-Q7TY7XC3.js";import{a as G}from"./chunk-XZCX6BPD.js";import{a as se}from"./chunk-MYYAF3XU.js";import"./chunk-DWAHQUVA.js";import{f as ie,g as oe}from"./chunk-5WNLDCIP.js";import"./chunk-N3KNLXBG.js";import{g as ee,m as ae,o as re,t as F,u as Y}from"./chunk-N57AFEUK.js";import"./chunk-N7PHAMWX.js";import"./chunk-JV7BL2Y3.js";import{C as X,b as I,c as L,f as te}from"./chunk-VGW7YJZ7.js";import"./chunk-HX3FHHCG.js";import"./chunk-ZOOQQO74.js";import"./chunk-SHAZ7EU7.js";import"./chunk-EEYJPINK.js";import"./chunk-BZEC7TCW.js";import"./chunk-MBI4IOAA.js";import"./chunk-GIHBFCPM.js";import"./chunk-U2QVIRVP.js";import"./chunk-VXOK76QV.js";import"./chunk-UW2TVJUN.js";import"./chunk-LGUXUFJ7.js";import"./chunk-TQXEOG45.js";import{e as ne}from"./chunk-MYELF7MV.js";import"./chunk-MS3ZOARX.js";import"./chunk-KCKP7FIY.js";import"./chunk-7K4WIBFN.js";import"./chunk-PUCLHWWW.js";import"./chunk-DMYB246F.js";import"./chunk-YEFC7M4L.js";import"./chunk-C7M5MSEL.js";import{a as Z}from"./chunk-HPJ6EQFO.js";import"./chunk-OHIIU6WS.js";import"./chunk-O5K35OSE.js";import"./chunk-D6LLE2YP.js";import"./chunk-QAVDKCSH.js";import"./chunk-H2AOS66Z.js";import"./chunk-CJJRHJ2S.js";import"./chunk-574KRDZU.js";import"./chunk-JOYABHZZ.js";import"./chunk-VDN3XKL2.js";import"./chunk-SVEGZVCP.js";import{a as x,b as H}from"./chunk-AQ74ANSJ.js";import"./chunk-SAOUSUZE.js";import"./chunk-6MGDEI2H.js";import"./chunk-QSGARGRB.js";import"./chunk-SREKDU6P.js";import"./chunk-IXIJFOEL.js";import"./chunk-QZ4L25WE.js";import"./chunk-4ATIL3QV.js";import"./chunk-WUM4JBII.js";import"./chunk-U62SHMHB.js";import"./chunk-55ESOXMJ.js";import"./chunk-BCREO4Q5.js";import"./chunk-EJ3VIBAJ.js";import"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import"./chunk-OOYAVZJN.js";import"./chunk-CBOFHDSC.js";import"./chunk-HB7BVTLV.js";import"./chunk-WZKL6OPG.js";import"./chunk-WF37UVOV.js";import"./chunk-UZQ577CU.js";import"./chunk-FC3MPJI4.js";import"./chunk-5ETRXDS4.js";import"./chunk-QDNKD3H5.js";import"./chunk-B4PK7RBX.js";import"./chunk-6J4Y65BV.js";import"./chunk-RXHILZH7.js";import"./chunk-PEPXQ7N3.js";import"./chunk-VU5W7W6Y.js";import"./chunk-6QIKBCPR.js";import"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import"./chunk-A52LT7YB.js";import"./chunk-CZPMRK53.js";import"./chunk-IDSF2RZ6.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import{$ as Q}from"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import"./chunk-WMYPRHRR.js";import"./chunk-IAMDMFZ7.js";import"./chunk-53MWZ23O.js";import{i as K}from"./chunk-PT7S6WNL.js";import"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import"./chunk-465DRXTW.js";import"./chunk-AC62Z3FX.js";import{g as A}from"./chunk-ESDYQQXO.js";var N=w=>w?.scaleFactor?w.scaleFactor:1,ue=96/72,W=class{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._lazyImageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new ee,this._cimResourceManager=new ce,this._rasterizer=new he(this._cimResourceManager)}get _imageDataCanvas(){return this._lazyImageDataCanvas??=document.createElement("canvas"),this._lazyImageDataCanvas}get _imageDataContext(){return this._imageDataCanvas.getContext("2d",{willReadFrequently:!0})}get resourceManager(){return this._cimResourceManager}rasterizeCIMSymbolAsync(e,t,o,r,a,i,l,s,g){return A(this,null,function*(){if(!e)return null;let{data:u}=e;if(!u||u.type!=="CIMSymbolReference"||!u.symbol)return null;let{symbol:f}=u;i||(i=X(f));let y=yield Y.resolveSymbolOverrides(u,t,this._spatialReference,a,i,l,s),c=this._imageDataCanvas,d=this._cimResourceManager,C=[];F.fetchResources(y,d,C),F.fetchFonts(y,d,C),C.length>0&&(yield Promise.all(C));let{width:h,height:m}=o,b=fe(i,h,m,r),n=F.getEnvelope(y,b,d);if(!n)return null;let z=(window.devicePixelRatio||1)*ue,p=1,_=0,S=0;switch(f.type){case"CIMPointSymbol":case"CIMTextSymbol":{let D=1;n.width>h&&(D=h/n.width);let M=1;n.height>m&&(M=m/n.height),r==="preview"&&(n.width<h&&(D=h/n.width),n.height<m&&(M=m/n.height)),p=Math.min(D,M),_=n.x+n.width/2,S=n.y+n.height/2}break;case"CIMLineSymbol":{(g||n.height>m)&&(p=m/n.height),S=n.y+n.height/2;let D=n.x*p+h/2,M=(n.x+n.width)*p+h/2,{paths:v}=b;v[0][0][0]-=D/p,v[0][2][0]-=(M-h)/p}break;case"CIMPolygonSymbol":{_=n.x+n.width/2,S=n.y+n.height/2;let D=n.x*p+h/2,M=(n.x+n.width)*p+h/2,v=n.y*p+m/2,O=(n.y+n.height)*p+m/2,{rings:R}=b;D<0&&(R[0][0][0]-=D,R[0][3][0]-=D,R[0][4][0]-=D),v<0&&(R[0][0][1]+=v,R[0][1][1]+=v,R[0][4][1]+=v),M>h&&(R[0][1][0]-=M-h,R[0][2][0]-=M-h),O>m&&(R[0][2][1]+=O-m,R[0][3][1]+=O-m)}}c.width=h*z,c.height=m*z;let P=1;c.width+=2*P,c.height+=2*P;let k=this._imageDataContext,T=ae.createIdentity();return T.translate(-_,-S),T.scale(p*z,-p*z),T.translate(h*z/2+P,m*z/2+P),k.clearRect(0,0,c.width,c.height),new re(k,d,T,!0).drawSymbol(y,b),k.getImageData(0,0,c.width,c.height)})}analyzeCIMSymbol3D(e,t,o,r,a){return A(this,null,function*(){let i=[],l=t?{geometryType:r,spatialReference:this._spatialReference,fields:t}:null,s=[];F.fetchFonts(e.data.symbol,this._cimResourceManager,s),yield Promise.all(s);let g=new ie(this._cimResourceManager,l),u;yield g.analyzeSymbolReference(e.data,this._avoidSDF,i),K(a);for(let f of i)f.cim.type!=="CIMPictureMarker"&&f.cim.type!=="CIMPictureFill"&&f.cim.type!=="CIMPictureStroke"||(u||(u=[]),u.push(this._fetchPictureMarkerResource(f,a))),o&&f.type==="text"&&typeof f.text=="string"&&f.text.includes("[")&&(f.text=te(o,f.text,f.cim.textCase));return u&&(yield Promise.all(u)),i})}rasterizeCIMSymbol3D(e,t,o,r,a,i){let l=[];for(let s of e){r&&typeof r.scaleFactor=="function"&&(r.scaleFactor=r.scaleFactor(t,a,i));let g=this._getRasterizedResource(s,t,o,r,a,i);if(!g)continue;let u=0,f=g.anchorX||0,y=g.anchorY||0,c=!1,d=0,C=0;if(o==="esriGeometryPoint"){let h=N(r);if(d=I(s.offsetX,t,a,i)*h||0,C=I(s.offsetY,t,a,i)*h||0,s.type==="marker")u=I(s.rotation,t,a,i)||0,c=s.rotateClockwise??!1;else if(s.type==="text"){if(u=I(s.angle,t,a,i)||0,s.horizontalAlignment!==void 0)switch(s.horizontalAlignment){case"left":f=-.5;break;case"right":f=.5;break;default:f=0}if(s.verticalAlignment!==void 0)switch(s.verticalAlignment){case"top":y=.5;break;case"bottom":y=-.5;break;case"baseline":y=-.25;break;default:y=0}}}g!=null&&l.push({angle:u,rotateClockWise:c,anchorX:f,anchorY:y,offsetX:d,offsetY:C,rasterizedResource:g})}return this.getSymbolImage(l)}getSymbolImage(e){let t=document.createElement("canvas"),o=t.getContext("2d"),r=0,a=0,i=0,l=0,s=[];for(let y=0;y<e.length;y++){let c=e[y],d=c.rasterizedResource;if(!d)continue;let C=d.size,h=c.offsetX,m=c.offsetY,b=c.anchorX,n=c.anchorY,z=c.rotateClockWise||!1,p=c.angle,_=x(h)-C[0]*(.5+b),S=x(m)-C[1]*(.5+n),P=_+C[0],k=S+C[1];if(p){z&&(p=-p);let M=Math.sin(p*Math.PI/180),v=Math.cos(p*Math.PI/180),O=_*v-S*M,R=_*M+S*v,U=_*v-k*M,V=_*M+k*v,q=P*v-k*M,J=P*M+k*v,$=P*v-S*M,B=P*M+S*v;_=Math.min(O,U,q,$),S=Math.min(R,V,J,B),P=Math.max(O,U,q,$),k=Math.max(R,V,J,B)}r=_<r?_:r,a=S<a?S:a,i=P>i?P:i,l=k>l?k:l;let T=o.createImageData(d.size[0],d.size[1]);T.data.set(new Uint8ClampedArray(d.image.buffer));let D={offsetX:h,offsetY:m,rotateClockwise:z,angle:p,rasterizedImage:T,anchorX:b,anchorY:n};s.push(D)}t.width=i-r,t.height=l-a;let g=-r,u=l;for(let y=0;y<s.length;y++){let c=s[y],d=this._imageDataToCanvas(c.rasterizedImage),C=c.rasterizedImage.width,h=c.rasterizedImage.height,m=g-C*(.5+c.anchorX),b=u-h*(.5-c.anchorY);if(c.angle){let n=(360-c.angle)*Math.PI/180;o.save(),o.translate(x(c.offsetX),-x(c.offsetY)),o.translate(g,u),o.rotate(n),o.translate(-g,-u),o.drawImage(d,m,b),o.restore()}else o.drawImage(d,m+x(c.offsetX),b-x(c.offsetY))}let f=new ne({x:g/t.width-.5,y:u/t.height-.5});return{imageData:t.width!==0&&t.height!==0?o.getImageData(0,0,t.width,t.height):o.createImageData(1,1),anchorPosition:f}}_fetchPictureMarkerResource(e,t){return A(this,null,function*(){let o=e.materialHash;if(!this._pictureMarkerCache.get(o)){let r=(yield Q(e.cim.url,{responseType:"image",signal:t?.signal})).data;this._pictureMarkerCache.set(o,r)}})}_imageDataToCanvas(e){let t=this._imageDataCanvas,o=this._imageDataContext;return t.width=e.width,t.height=e.height,o.putImageData(e,0,0),t}_imageTo32Array(e,t,o,r){let a=this._imageDataCanvas,i=this._imageDataContext;if(a.width=t,a.height=o,i.drawImage(e,0,0,t,o),r){i.save();let l=new Z(r);i.fillStyle=l.toHex(),i.globalCompositeOperation="multiply",i.fillRect(0,0,t,o),i.globalCompositeOperation="destination-atop",i.drawImage(e,0,0,t,o),i.restore()}return new Uint32Array(i.getImageData(0,0,t,o).data.buffer)}_getRasterizedResource(e,t,o,r,a,i){let l,s,g;if(e.type==="text")return this._rasterizeTextResource(e,t,r,a,i);({analyzedCIM:l,hash:s}=ye(e,t,a,i));let y=N(r);if(e.cim.type==="CIMPictureMarker"){let C=I(e.size,t,a,i)*y,{image:h,width:m,height:b}=this._getPictureResource(e,C,I(e.color,t,a,i));return g={image:h,size:[m,b],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},g}se(l,y,{preserveOutlineWidth:!1});let c=l;s+=o,r&&(s+=JSON.stringify(r));let d=this._resourceCache;return d.has(s)?d.get(s):(g=this._rasterizer.rasterizeJSONResource({cim:c,type:e.type,url:e.url,mosaicHash:s,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),d.set(s,g),g)}_rasterizeTextResource(e,t,o,r,a){let i=N(o),l=I(e.text,t,r,a);if(!l||l.length===0)return null;let s=e.cim,g=I(s?.fontFamilyName||e.fontName,t,r,a),u=I(s?.font?.style||e.style,t,r,a),f=I(s?.font?.weight||e.weight,t,r,a),y=I(s?.font?.decoration||e.decoration,t,r,a),c=I(e.size,t,r,a)*i,d=I(e.horizontalAlignment,t,r,a),C=I(e.verticalAlignment,t,r,a),h=L(I(e.color,t,r,a)),m=L(I(e.outlineColor,t,r,a)),b=I(e.outlineSize,t,r,a),n=e.backgroundColor!=null?L(e.backgroundColor):null,z=e.borderLineColor!=null?L(e.borderLineColor):null,p=e.borderLineWidth!=null?e.borderLineWidth:null,_={color:h,size:c,horizontalAlignment:d,verticalAlignment:C,font:{family:g,style:u,weight:f,decoration:y},halo:{size:b||0,color:m,style:u},backgroundColor:n,borderLine:z!=null&&p!=null?{color:z,size:p}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(l,_)}_getPictureResource(e,t,o){let r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;let a=r.height/r.width,i=t?a>1?x(t):x(t)/a:r.width,l=t?a>1?x(t)*a:x(t):r.height;return{image:this._imageTo32Array(r,i,l,o),width:i,height:l}}};function fe(w,e,t,o){let a=-e/2+1,i=e/2-1,l=t/2-1,s=-t/2+1;switch(w){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[a,0],[0,0],[i,0]]]};default:return o==="legend"?{rings:[[[a,l],[i,0],[i,s],[a,s],[a,l]]]}:{rings:[[[a,l],[i,l],[i,s],[a,s],[a,l]]]}}}function ye(w,e,t,o){let r,a;return typeof w.materialHash=="function"?(r=(0,w.materialHash)(e,t,o),a=oe(w.cim,w.materialOverrides)):(r=w.materialHash,a=w.cim),{analyzedCIM:a,hash:r}}var j=new W(null,!0),E=H(G.size),me=H(G.maxSize),ge=H(G.lineWidth),de=1;function pe(w,e,t){return A(this,null,function*(){let o=e?.size,r=o!=null&&typeof o=="object"&&"width"in o?o.width:o,a=o!=null&&typeof o=="object"&&"height"in o?o.height:o;if(r==null||a==null)if(t==="esriGeometryPolygon")r=E,a=E;else{let i=yield we(w,e,t);i&&(r=i.width,a=i.height),t==="esriGeometryPolyline"&&(r=ge),r=r!=null&&isFinite(r)?Math.min(r,me):E,a=a!=null&&isFinite(a)?Math.max(Math.min(a,me),de):E}return e.style==="legend"&&t==="esriGeometryPolyline"&&(r=ge),{width:r,height:a}})}function we(w,e,t){return A(this,null,function*(){let{feature:o,fieldMap:r,viewParams:a}=e.cimOptions||e,i=yield Y.resolveSymbolOverrides(w.data,o,null,r,t,null,a);if(!i)return null;(w=w.clone()).data={type:"CIMSymbolReference",symbol:i},w.data.primitiveOverrides=void 0;let l=[];return F.fetchResources(i,j.resourceManager,l),F.fetchFonts(i,j.resourceManager,l),l.length>0&&(yield Promise.all(l)),F.getEnvelope(i,null,j.resourceManager)})}function Ge(t){return A(this,arguments,function*(w,e={}){let{node:o,opacity:r,symbolConfig:a}=e,i=a!=null&&typeof a=="object"&&"isSquareFill"in a&&a.isSquareFill,l=e.cimOptions||e,s=l.geometryType||X(w?.data?.symbol),g=yield pe(w,e,s),{feature:u,fieldMap:f}=l,y=i||s!=="esriGeometryPolygon"?"preview":"legend",c=yield j.rasterizeCIMSymbolAsync(w,u,g,y,f,s,null,l.viewParams,l.allowScalingUp);if(!c)return null;let{width:d,height:C}=c,h=document.createElement("canvas");h.width=d,h.height=C,h.getContext("2d").putImageData(c,0,0);let m=x(g.width),b=x(g.height),n=new Image(m,b);n.src=h.toDataURL(),n.ariaLabel=e.ariaLabel??null,n.alt=e.ariaLabel??"",r!=null&&(n.style.opacity=`${r}`);let z=n;if(e.effectView!=null){let p={shape:{type:"image",x:0,y:0,width:m,height:b,src:n.src},fill:null,stroke:null,offset:[0,0]};z=le([[p]],[m,b],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return o&&z&&o.appendChild(z),z})}export{Ge as previewCIMSymbol};
