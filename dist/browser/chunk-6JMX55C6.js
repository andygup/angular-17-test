import{a as D}from"./chunk-Y24K26DO.js";import{a as x,c as O}from"./chunk-WAZIXELF.js";import{b as k}from"./chunk-BUZ66EGV.js";import{a as m,b as h,c as R,d as P,e as w,f as I,g as C,h as E}from"./chunk-MYGXRPBM.js";import"./chunk-S4GXXOVS.js";import{a as F}from"./chunk-4TZNIQOB.js";import{a as N}from"./chunk-UV6MZLVE.js";import{a as G}from"./chunk-7BGNDY2B.js";import{b as M}from"./chunk-FBHJEXCM.js";import{b as v}from"./chunk-HI2T2YSZ.js";import"./chunk-O5K35OSE.js";import"./chunk-IEXZWAIE.js";import"./chunk-URUYU25U.js";import"./chunk-3S2DT2SI.js";import"./chunk-7PPV2CP7.js";import"./chunk-U62SHMHB.js";import"./chunk-55ESOXMJ.js";import"./chunk-BCREO4Q5.js";import"./chunk-EJ3VIBAJ.js";import"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import"./chunk-HB7BVTLV.js";import"./chunk-FC3MPJI4.js";import"./chunk-5ETRXDS4.js";import"./chunk-QDNKD3H5.js";import"./chunk-F72O5PVM.js";import{c as j}from"./chunk-B4PK7RBX.js";import"./chunk-6J4Y65BV.js";import"./chunk-RXHILZH7.js";import"./chunk-6QIKBCPR.js";import"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import"./chunk-A52LT7YB.js";import"./chunk-CZPMRK53.js";import"./chunk-IDSF2RZ6.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import"./chunk-WMYPRHRR.js";import"./chunk-IAMDMFZ7.js";import"./chunk-53MWZ23O.js";import"./chunk-PT7S6WNL.js";import"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import{r as f}from"./chunk-465DRXTW.js";import"./chunk-AC62Z3FX.js";import{g as p}from"./chunk-ESDYQQXO.js";function ce(e,a){return p(this,null,function*(){let r=e.instance.portalItem;if(r?.id)return yield r.load(a),q(e),z(e,a)})}function q(e){let a=e.instance.portalItem;if(!a?.type||!e.supportedTypes.includes(a.type))throw new f("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:e.supportedTypes.join(", ")})}function z(e,a){return p(this,null,function*(){let r=e.instance,t=r.portalItem;if(!t)return;let{url:o,title:s}=t,n=x(t);if(r.type==="group")return B(r,n,e);o&&r.read({url:o},n);let i=new m,l=yield $(e,i,a);return l&&r.read(l,n),r.resourceReferences={portalItem:t,paths:n.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:s},n),G(r,n)})}function B(e,a,r){return p(this,null,function*(){let t=e.portalItem;if(!e.sourceIsPortalItem)return;let{title:o,type:s}=t;if(s==="Group Layer"){if(!M(t,"Map"))throw new f("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return H(e)}return e.read({title:o},a),Q(e,r)})}function H(e){return p(this,null,function*(){let a=e.portalItem,r=yield a.fetchData("json");if(!r)return;let t=O(a);e.read(r,t),yield k(e,r,{context:t}),e.resourceReferences={portalItem:a,paths:t.readResourcePaths??[]}})}function Q(e,a){return p(this,null,function*(){let r,{portalItem:t}=e;if(!t)return;let o=t.type,s=a.layerModuleTypeMap;switch(o){case"Feature Service":case"Feature Collection":r=s.FeatureLayer;break;case"Stream Service":r=s.StreamLayer;break;case"Scene Service":r=s.SceneLayer;break;default:throw new f("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}let n=new m,[i,l]=yield Promise.all([r(),$(a,n)]),u=()=>i;if(o==="Feature Service"){l=t.url?yield R(l,t.url,n):{};let g=I(l),S=C(l),y=[];if(g.length||S?.length){g.length&&y.push("SubtypeGroupLayer"),S?.length&&y.push("OrientedImageryLayer");let L=[];for(let c of y){let d=s[c];L.push(d())}let K=yield Promise.all(L),T=new Map;y.forEach((c,d)=>{T.set(c,K[d])}),u=c=>c.layerType?T.get(c.layerType)??i:i}let A=yield Z(t.url);return yield b(e,u,l,A)}return o==="Scene Service"&&t.url&&(l=yield E(t,l,n)),w(l)>0?yield b(e,u,l):yield U(e,u)})}function U(e,a){return p(this,null,function*(){let{portalItem:r}=e;if(!r?.url)return;let t=yield F(r.url);t&&b(e,a,{layers:t.layers?.map(h),tables:t.tables?.map(h)})})}function b(e,a,r,t){return p(this,null,function*(){let o=r.layers||[],s=r.tables||[];if(e.portalItem?.type==="Feature Collection"?(o.forEach((n,i)=>{n.id=i,n?.layerDefinition?.type==="Table"&&s.push(n)}),o=o.filter(n=>n?.layerDefinition?.type!=="Table")):(o.reverse(),s.reverse()),o.forEach(n=>{let i=t?.(n);if(i||!t){let l=J(e,a(n),r,n,i);e.add(l)}}),s.length){let n=yield N.FeatureLayer();s.forEach(i=>{let l=t?.(i);if(l||!t){let u=J(e,n,r,i,l);e.tables.add(u)}})}})}function J(e,a,r,t,o){let s=e.portalItem,n={portalItem:s.clone(),layerId:t.id};t.url!=null&&(n.url=t.url);let i=new a(n);if("sourceJSON"in i&&(i.sourceJSON=o),i.type!=="subtype-group"&&(i.sublayerTitleMode="service-name"),s.type==="Feature Collection"){let l={origin:"portal-item",portal:s.portal||j.getDefault()};i.read(t,l);let u=r.showLegend;u!=null&&i.read({showLegend:u},l)}return i}function $(e,a,r){return p(this,null,function*(){if(e.supportsData===!1)return;let t=e.instance,o=t.portalItem;if(!o)return;let s=null;try{s=yield o.fetchData("json",r)}catch{}if(X(t)){let n=null,i=yield V(o,s,a);if((s?.layers||s?.tables)&&i>0){if(t.layerId==null){let l=I(s);t.layerId=t.type==="subtype-group"?l?.[0]:P(s)}n=W(s,t),n&&s.showLegend!=null&&(n.showLegend=s.showLegend)}return i>1&&"sublayerTitleMode"in t&&t.sublayerTitleMode!=="service-name"&&(t.sublayerTitleMode="item-title-and-service-name"),n}return s})}function V(e,a,r){return p(this,null,function*(){if(a?.layers&&a?.tables)return w(a);let t=v(e.url);if(!t)return 1;let o=yield r.fetchServiceMetadata(t.url.path).catch(()=>null);return(a?.layers?.length??o?.layers?.length??0)+(a?.tables?.length??o?.tables?.length??0)})}function W(e,a){let{layerId:r}=a,t=e.layers?.find(o=>o.id===r)||e.tables?.find(o=>o.id===r);return t&&Y(t,a)?t:null}function X(e){return e.type!=="stream"&&"layerId"in e}function Y(e,a){return!(a.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||a.type==="subtype-group"&&!("layerType"in e))}function Z(e){return p(this,null,function*(){let{layersJSON:a}=yield D(e);if(!a)return null;let r=[...a.layers,...a.tables];return t=>r.find(o=>o.id===t.id)})}export{ce as load};
