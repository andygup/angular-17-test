import{a as A,b as E,c as J,d as K,e as $,f as N,g as R,h as D,i as U}from"./chunk-QSZTU4I5.js";import"./chunk-I7VAY2DR.js";import{a as P}from"./chunk-FQTXYWH5.js";import"./chunk-KLXERNY4.js";import{a as M}from"./chunk-Y24K26DO.js";import{b as g}from"./chunk-WAZIXELF.js";import"./chunk-4TZNIQOB.js";import{a as G}from"./chunk-UV6MZLVE.js";import{a as L,d as h,e as v,f as b,g as y}from"./chunk-FBHJEXCM.js";import{b as m}from"./chunk-HI2T2YSZ.js";import"./chunk-O5K35OSE.js";import{d as F}from"./chunk-IEXZWAIE.js";import"./chunk-URUYU25U.js";import"./chunk-3S2DT2SI.js";import"./chunk-7PPV2CP7.js";import"./chunk-U62SHMHB.js";import"./chunk-55ESOXMJ.js";import"./chunk-BCREO4Q5.js";import"./chunk-EJ3VIBAJ.js";import"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import"./chunk-QDNKD3H5.js";import"./chunk-F72O5PVM.js";import"./chunk-B4PK7RBX.js";import"./chunk-6J4Y65BV.js";import"./chunk-RXHILZH7.js";import"./chunk-6QIKBCPR.js";import"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import"./chunk-A52LT7YB.js";import"./chunk-CZPMRK53.js";import"./chunk-IDSF2RZ6.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import"./chunk-WMYPRHRR.js";import"./chunk-IAMDMFZ7.js";import"./chunk-53MWZ23O.js";import"./chunk-PT7S6WNL.js";import"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import{r as p}from"./chunk-465DRXTW.js";import{g as x,p as O}from"./chunk-AC62Z3FX.js";import{g as i}from"./chunk-ESDYQQXO.js";var I="Feature Service",T="feature-layer-utils",H=`${T}-save`,Q=`${T}-save-as`,f=`${T}-saveall`,d=`${T}-saveall-as`;function S(e){return{isValid:F(e)&&(e.type!=="feature"||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function C(e){let a=[],r=[];for(let{layer:o,layerJSON:n}of e)o.isTable?r.push(n):a.push(n);return{layers:a,tables:r}}function W(e){return C([e])}function k(e,a){return i(this,null,function*(){return/\/\d+\/?$/.test(e.url)?W(a[0]):z(a,e)})}function z(e,a){return i(this,null,function*(){if(!a)return e.reverse(),C(e);let{layer:{url:r,customParameters:o,apiKey:n}}=e[0],s=yield a.fetchData("json");s?.layers!=null&&s?.tables!=null||(s=yield X(s,{url:r??"",customParameters:o,apiKey:n},e.map(t=>t.layer.layerId)));for(let t of e)B(t.layer,t.layerJSON,s);return s})}function X(e,a,r){return i(this,null,function*(){e||={},e.layers||=[],e.tables||=[];let{url:o,customParameters:n,apiKey:s}=a,{serviceJSON:t,layersJSON:l}=yield M(o,{customParameters:n,apiKey:s}),c=Y(e.layers,t.layers,r),u=Y(e.tables,t.tables,r);e.layers=c.itemResources,e.tables=u.itemResources;let w=[...c.added,...u.added],q=l?[...l.layers,...l.tables]:[];return yield Z(e,w,o,q),e})}function Y(e,a,r){let o=x(e,a,(s,t)=>s.id===t.id);e=e.filter(s=>!o.removed.some(t=>t.id===s.id));let n=o.added;return n.forEach(({id:s})=>{e.push({id:s})}),{itemResources:e,added:n.filter(({id:s})=>!r.includes(s))}}function Z(e,a,r,o){return i(this,null,function*(){let n=yield ee(a),s=a.map(({id:t,type:l})=>new(n.get(l))({url:r,layerId:t,sourceJSON:o.find(({id:c})=>c===t)}));yield Promise.allSettled(s.map(t=>t.load())),s.forEach(t=>{let{layerId:l,loaded:c,defaultPopupTemplate:u}=t;if(!c||u==null)return;let w={id:l,popupInfo:u.toJSON()};t.operationalLayerType!=="ArcGISFeatureLayer"&&(w.layerType=t.operationalLayerType),B(t,w,e)})})}function ee(e){return i(this,null,function*(){let a=[];e.forEach(({type:n})=>{let s=ae(n),t=G[s];a.push(t())});let r=yield Promise.all(a),o=new Map;return e.forEach(({type:n},s)=>{o.set(n,r[s])}),o})}function ae(e){let a;switch(e){case"Feature Layer":case"Table":a="FeatureLayer";break;case"Oriented Imagery Layer":a="OrientedImageryLayer"}return a}function B(e,a,r){e.isTable?_(r.tables,a):_(r.layers,a)}function _(e,a){let r=e.findIndex(({id:o})=>o===a.id);r===-1?e.push(a):e[r]=a}function j(e,a){if(!e.length)throw new p(`${a}:missing-parameters`,"'layers' array should contain at least one feature layer")}function re(e,a){let r=e.map(o=>o.portalItem.id);if(new Set(r).size>1)throw new p(`${a}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function V(e,a){let r=e.map(o=>o.layerId);if(new Set(r).size!==r.length)throw new p(`${a}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}function te(e){return i(this,null,function*(){j(e,f),yield Promise.all(e.map(a=>a.load()));for(let a of e)A(a,f,S),J({layer:a,itemType:I,errorNamePrefix:f});re(e,f),V(e,f)})}function se(e,a){return i(this,null,function*(){let{url:r,layerId:o,title:n,fullExtent:s,isTable:t}=e,l=m(r);a.url=l?.serverType==="FeatureServer"?r:`${r}/${o}`,a.title||=n,a.extent=null,t||s==null||(a.extent=yield b(s)),h(a,y.METADATA),h(a,y.MULTI_LAYER),L(a,y.SINGLE_LAYER),t&&L(a,y.TABLE)})}function oe(e,a){for(let s of e){let t=s.parsedUrl.path,l=m(t);if(!l?.url.path)throw new p(`${a}:invalid-parameters`,E(s,`has unsupported url pattern: ${t}`),{layer:s});let u=l?.serverType;if(u!=="FeatureServer"&&u!=="MapServer")throw new p(`${a}:invalid-parameters`,E(s,`has unsupported server type: ${u}`),{layer:s});if(u==="MapServer"&&e.length>1)throw new p(`${a}:invalid-parameters`,"Only one layer or table in a map service can be saved")}let r=m(e[0].parsedUrl.path),o=r?.url.path;if(!e.every(s=>m(s.parsedUrl.path)?.url.path===o))throw new p(`${a}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}function ne(e){return i(this,null,function*(){j(e,d),yield Promise.all(e.map(a=>a.load()));for(let a of e)A(a,d,S);oe(e,d),V(e,d)})}function le(e,a){return i(this,null,function*(){let r=0,o=0;for(let{isTable:t}of a)t?o++:r++;let n=a[0].parsedUrl.path,s=m(n);if(e.url=s?.serverType==="FeatureServer"?s.url.path:n,e.title||=s.title,e.extent=null,r>0){let t=a.map(l=>l.fullExtent).filter(O).reduce((l,c)=>l.clone().union(c));t&&(e.extent=yield b(t))}h(e,y.METADATA),v(e,y.MULTI_LAYER,a.length>1),v(e,y.SINGLE_LAYER,a.length===1),v(e,y.TABLE,o>0&&r===0),N(e)})}function ve(e,a){return i(this,null,function*(){return D({layer:e,itemType:I,validateLayer:S,createItemData:(r,o)=>k(o,[r]),errorNamePrefix:H},a)})}function Ie(e,a){return i(this,null,function*(){yield te(e);let r=e[0].portalItem,o=g(r),n=yield Promise.all(e.map(t=>$(t,o,a))),s=yield k(r,e.map((t,l)=>({layer:t,layerJSON:n[l]})));return N(r),yield r.update({data:s}),yield Promise.all(e.slice(1).map(t=>t.portalItem.reload())),P(o),r.clone()})}function Te(e,a,r){return i(this,null,function*(){return U({layer:e,itemType:I,validateLayer:S,createItemData:(o,n)=>Promise.resolve(W(o)),errorNamePrefix:Q,newItem:a,setItemProperties:se},r)})}function Se(e,a,r){return i(this,null,function*(){yield ne(e);let o=K({itemType:I,errorNamePrefix:d,newItem:a}),n=g(o),s=yield Promise.all(e.map(l=>$(l,n,r))),t=yield z(e.map((l,c)=>({layer:l,layerJSON:s[c]})));yield le(o,e),yield R(o,t,r);for(let l of e)l.portalItem=o.clone();return P(n),o})}export{ve as save,Ie as saveAll,Se as saveAllAs,Te as saveAs};
