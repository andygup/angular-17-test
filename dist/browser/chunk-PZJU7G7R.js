import{a as y}from"./chunk-V2KSICSA.js";import{c as p}from"./chunk-HB7BVTLV.js";import{f as i,h as v}from"./chunk-ARS6KN6E.js";import{i as d,r as I,u as S}from"./chunk-PT7S6WNL.js";import{r as w}from"./chunk-465DRXTW.js";import{a as l,b as m,g as a}from"./chunk-ESDYQQXO.js";function K(e,t,r=null){return a(this,null,function*(){let o=yield g(e,t,r);yield R(o,t,r)})}function L(e,t,r,o,n=null){return a(this,null,function*(){let c=yield g(r,o,n);yield e.update({data:t}),yield R(c,o,n)})}function g(e,t,r=null){return a(this,null,function*(){if(!t?.resources)return;let o=t.portalItem===e.portalItem?new Set(e.paths):new Set;e.paths.length=0,e.portalItem=t.portalItem;let n=new Set(t.resources.toKeep.map(s=>s.resource.path)),c=new Set,u=[];n.forEach(s=>{o.delete(s),e.paths.push(s)});for(let s of t.resources.toUpdate)if(o.delete(s.resource.path),n.has(s.resource.path)||c.has(s.resource.path)){let{resource:A,content:U,finish:k,error:E}=s,f=v(A,y());e.paths.push(f.path),u.push(b({resource:f,content:U,compress:s.compress,finish:k,error:E},r))}else e.paths.push(s.resource.path),u.push(F(s,r)),c.add(s.resource.path);for(let s of t.resources.toAdd)e.paths.push(s.resource.path),o.has(s.resource.path)?o.delete(s.resource.path):u.push(b(s,r));if(u.length===0)return o;let h=yield S(u);if(d(r),h.length>0)throw new w("save:resources","Failed to save one or more resources",{errors:h});return o})}function R(e,t,r=null){return a(this,null,function*(){if(!e||!t.portalItem)return;let o=[];for(let n of e){let c=t.portalItem.resourceFromPath(n);o.push(c.portalItem.removeResource(c,r))}yield I(o)})}function b(e,t){return a(this,null,function*(){let r=m(l({},t??{}),{compress:e.compress}),o=yield p(e.resource.portalItem.addResource(e.resource,yield i(e.content),r));if(o.ok!==!0)throw e.error?.(o.error),o.error;e.finish?.(e.resource)})}function F(e,t){return a(this,null,function*(){let r=yield p(e.resource.update(yield i(e.content),t));if(r.ok!==!0)throw e.error?.(r.error),r.error;e.finish?.(e.resource)})}function O(e){return a(this,null,function*(){let t=[];for(let r of e.allLayers)if("beforeSave"in r&&typeof r.beforeSave=="function"){let o=r.beforeSave();o&&t.push(o)}yield Promise.allSettled(t)})}export{K as a,L as b,O as c};
