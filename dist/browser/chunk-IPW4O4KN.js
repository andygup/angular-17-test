import{a as P}from"./chunk-Y24K26DO.js";import{a as g}from"./chunk-S4GXXOVS.js";import{a as m}from"./chunk-4TZNIQOB.js";import{a as F}from"./chunk-UV6MZLVE.js";import{b as L,c as O}from"./chunk-HI2T2YSZ.js";import"./chunk-O5K35OSE.js";import{a as w}from"./chunk-IEXZWAIE.js";import"./chunk-F72O5PVM.js";import"./chunk-B4PK7RBX.js";import"./chunk-6J4Y65BV.js";import"./chunk-RXHILZH7.js";import"./chunk-6QIKBCPR.js";import"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import"./chunk-A52LT7YB.js";import"./chunk-CZPMRK53.js";import"./chunk-IDSF2RZ6.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import{H as I,g as h}from"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import"./chunk-WMYPRHRR.js";import"./chunk-IAMDMFZ7.js";import"./chunk-53MWZ23O.js";import"./chunk-PT7S6WNL.js";import"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import{r as b}from"./chunk-465DRXTW.js";import"./chunk-AC62Z3FX.js";import{a as S,b as v,g as y}from"./chunk-ESDYQQXO.js";var N={FeatureLayer:!0,SceneLayer:!0};function B(r){return y(this,null,function*(){let s=r.properties?.customParameters,e=yield J(r.url,s),t=v(S({},r.properties),{url:r.url});if(e.layers.length+e.tables.length===0)return e.layerId!=null&&(t.layerId=e.layerId),e.sourceJSON!=null&&(t.sourceJSON=e.sourceJSON),new e.Constructor(t);let n=new(yield import("./chunk-MCPM2GBW.js")).default({title:e.parsedUrl.title});return yield C(n,e,t),n})}function T(r,s){return r?r.find(e=>e.id===s):null}function C(r,s,e){return y(this,null,function*(){function t(a,o,u,i){let c=v(S({},e),{layerId:o,sublayerTitleMode:"service-name"});return a!=null&&(c.url=a),u!=null&&(c.sourceJSON=u),i(c)}let n=s.sublayerConstructorProvider;for(let{id:a,serverUrl:o}of s.layers){let u=T(s.sublayerInfos,a),i=(u&&n?.(u))??s.Constructor,c=t(o,a,u,l=>new i(l));r.add(c)}if(s.tables.length){let a=yield d("FeatureLayer");s.tables.forEach(({id:o,serverUrl:u})=>{let i=t(u,o,T(s.tableInfos,o),c=>new a(c));r.tables.add(i)})}})}function J(r,s){return y(this,null,function*(){let e=L(r);if(e==null&&(e=yield k(r,s)),e==null)throw new b("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:r});let{serverType:t,sublayer:n}=e,a,o={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"},u=t==="FeatureServer",i=t==="SceneServer",c={parsedUrl:e,Constructor:null,layerId:u||i?n??void 0:void 0,layers:[],tables:[]};switch(t){case"MapServer":n!=null?a="FeatureLayer":a=(yield V(r,s))?"TileLayer":"MapImageLayer";break;case"ImageServer":{let l=yield m(r,{customParameters:s}),{tileInfo:f,cacheType:p}=l;a=f?f?.format?.toUpperCase()!=="LERC"||p&&p.toLowerCase()!=="elevation"?"ImageryTileLayer":"ElevationLayer":"ImageryLayer";break}case"SceneServer":{let l=yield m(e.url.path,{customParameters:s});if(a="SceneLayer",l){let f=l?.layers;if(l?.layerType==="Voxel")a="VoxelLayer";else if(f?.length){let p=f[0]?.layerType;p!=null&&w[p]!=null&&(a=w[p])}}break}case"FeatureServer":if(a="FeatureLayer",n!=null){let l=yield m(r,{customParameters:s});c.sourceJSON=l,l.type==="Oriented Imagery Layer"&&(a="OrientedImageryLayer")}break;default:a=o[t]}if(N[a]&&n==null){let l=yield x(r,t,s);if(u&&(c.sublayerInfos=l.layerInfos,c.tableInfos=l.tableInfos),l.layers.length+l.tables.length!==1)c.layers=l.layers,c.tables=l.tables,u&&l.layerInfos?.length&&(c.sublayerConstructorProvider=yield E(l.layerInfos));else if(u||i){let f=l.layerInfos?.[0]??l.tableInfos?.[0];c.layerId=l.layers[0]?.id??l.tables[0]?.id,c.sourceJSON=f,u&&f?.type==="Oriented Imagery Layer"&&(a="OrientedImageryLayer")}}return c.Constructor=yield d(a),c})}function k(r,s){return y(this,null,function*(){let e=yield m(r,{customParameters:s}),t=null,n=null,a=e.type;if(a==="Feature Layer"||a==="Table"?(t="FeatureServer",n=e.id??null):a==="indexedVector"?t="VectorTileServer":e.hasOwnProperty("mapName")?t="MapServer":e.hasOwnProperty("bandCount")&&e.hasOwnProperty("pixelSizeX")?t="ImageServer":e.hasOwnProperty("maxRecordCount")&&e.hasOwnProperty("allowGeometryUpdates")?t="FeatureServer":e.hasOwnProperty("streamUrls")?t="StreamServer":U(e)?(t="SceneServer",n=e.id):e.hasOwnProperty("layers")&&U(e.layers?.[0])&&(t="SceneServer"),!t)return null;let o=n!=null?O(r):null;return{title:o!=null&&e.name||I(r),serverType:t,sublayer:n,url:{path:o!=null?o.serviceUrl:h(r).path}}})}function U(r){return r!=null&&r.hasOwnProperty("store")&&r.hasOwnProperty("id")&&typeof r.id=="number"}function x(r,s,e){return y(this,null,function*(){let t,n,a=!1;switch(s){case"FeatureServer":{let i=yield P(r,{customParameters:e});a=!!i.layersJSON,t=i.layersJSON||i.serviceJSON;break}case"SceneServer":{let i=yield M(r,e);t=i.serviceInfo,n=i.tableServerUrl;break}default:t=yield m(r,{customParameters:e})}let o=t?.layers,u=t?.tables;return{layers:o?.map(i=>({id:i.id})).reverse()||[],tables:u?.map(i=>({serverUrl:n,id:i.id})).reverse()||[],layerInfos:a?o:[],tableInfos:a?u:[]}})}function M(r,s){return y(this,null,function*(){let e=yield m(r,{customParameters:s});if(!e.layers?.[0])return{serviceInfo:e};try{let{serverUrl:n}=yield g(r),a=yield m(n,{customParameters:s}).catch(()=>null);return a&&(e.tables=a.tables),{serviceInfo:e,tableServerUrl:n}}catch{return{serviceInfo:e}}})}function d(r){return y(this,null,function*(){return(0,F[r])()})}function V(r,s){return y(this,null,function*(){return(yield m(r,{customParameters:s})).tileInfo})}function E(r){return y(this,null,function*(){let s=[],e=[];if(r.forEach(a=>{let{type:o}=a;o==="Oriented Imagery Layer"?(s.push(o),e.push(d("OrientedImageryLayer"))):(s.push(o),e.push(d("FeatureLayer")))}),!e.length)return;let t=yield Promise.all(e),n=new Map;return s.forEach((a,o)=>{n.set(a,t[o])}),a=>n.get(a.type)})}export{B as fromUrl};
