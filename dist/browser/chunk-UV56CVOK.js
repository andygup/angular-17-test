import{b as O,d as U,e as z,f as B,g as w}from"./chunk-ICBFZ75C.js";import"./chunk-UYKZ3CEC.js";import"./chunk-Y5K4QJZR.js";import"./chunk-5WNLDCIP.js";import"./chunk-N3KNLXBG.js";import"./chunk-PLCDSZE2.js";import{d as L}from"./chunk-NTXQ55BD.js";import"./chunk-EKY6QR7N.js";import"./chunk-VK2CQJOC.js";import{a as E}from"./chunk-3HXNXWXE.js";import"./chunk-TTUUVT2M.js";import"./chunk-AUIMNX4Y.js";import{a as A}from"./chunk-N57AFEUK.js";import"./chunk-N7PHAMWX.js";import"./chunk-JV7BL2Y3.js";import"./chunk-VGW7YJZ7.js";import"./chunk-HX3FHHCG.js";import"./chunk-ZOOQQO74.js";import"./chunk-SHAZ7EU7.js";import{g as P}from"./chunk-NKBP5F7I.js";import"./chunk-EEYJPINK.js";import"./chunk-BZEC7TCW.js";import"./chunk-MBI4IOAA.js";import"./chunk-GIHBFCPM.js";import"./chunk-W5OI4BJ2.js";import"./chunk-TKTKGUCU.js";import"./chunk-U2QVIRVP.js";import"./chunk-VXOK76QV.js";import"./chunk-Z77VHNI3.js";import"./chunk-LMIKL5PS.js";import"./chunk-OKLB3DLR.js";import"./chunk-DWZPFSNU.js";import"./chunk-MCIUWLYC.js";import"./chunk-EEZEB3RB.js";import"./chunk-45GFWXQC.js";import{a as v,c as K}from"./chunk-AUVYUYNK.js";import"./chunk-PUCLHWWW.js";import"./chunk-DMYB246F.js";import"./chunk-YEFC7M4L.js";import"./chunk-C7M5MSEL.js";import"./chunk-HPJ6EQFO.js";import"./chunk-OHIIU6WS.js";import"./chunk-2UDQ3IWX.js";import"./chunk-TQYOVOJO.js";import"./chunk-QAVDKCSH.js";import"./chunk-H2AOS66Z.js";import"./chunk-AQ74ANSJ.js";import"./chunk-SAOUSUZE.js";import"./chunk-6MGDEI2H.js";import"./chunk-QSGARGRB.js";import"./chunk-QZ4L25WE.js";import"./chunk-4ATIL3QV.js";import"./chunk-U62SHMHB.js";import"./chunk-55ESOXMJ.js";import"./chunk-BCREO4Q5.js";import"./chunk-EJ3VIBAJ.js";import"./chunk-4LHUJTP5.js";import"./chunk-NBRBW7H5.js";import"./chunk-FC3MPJI4.js";import"./chunk-5ETRXDS4.js";import"./chunk-QDNKD3H5.js";import"./chunk-VU5W7W6Y.js";import"./chunk-6QIKBCPR.js";import"./chunk-AHKJJNRE.js";import"./chunk-HBTOKQC5.js";import{b as R}from"./chunk-A52LT7YB.js";import"./chunk-CZPMRK53.js";import"./chunk-2BBIRZVO.js";import"./chunk-WQAXQD4X.js";import"./chunk-IUPUERVS.js";import"./chunk-XF4NUYV7.js";import"./chunk-FNDPIYNC.js";import"./chunk-WMYPRHRR.js";import{R as C}from"./chunk-IAMDMFZ7.js";import{a as k}from"./chunk-53MWZ23O.js";import{i as _,p as I}from"./chunk-PT7S6WNL.js";import{a as F}from"./chunk-XDTDVCGP.js";import"./chunk-JPDAKIWT.js";import"./chunk-465DRXTW.js";import"./chunk-AC62Z3FX.js";import{a as D,g as p}from"./chunk-ESDYQQXO.js";var S=class{constructor(e){this._remoteClient=e,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){}fetchResource(e,s){return p(this,null,function*(){let r=this._resourceMap,a=r.get(e);if(a)return a;let i=this._inFlightResourceMap.get(e);if(i)return i;try{i=this._remoteClient.invoke("tileRenderer.fetchResource",{url:e},D({},s)),this._inFlightResourceMap.set(e,i),i.then(o=>(this._inFlightResourceMap.delete(e),r.set(e,o),o))}catch(o){return I(o)?null:{width:0,height:0}}return i})}getResource(e){return this._resourceMap.get(e)??null}loadFont(e){return Promise.resolve(null)}};function W(t,e){let s=e-e/4,r=e+e/2;return(!t.minScale||t.minScale>=s)&&(!t.maxScale||t.maxScale<=r)}function G(t){let e=t.message,s={message:{data:{},tileKey:e.tileKey,tileKeyOrigin:e.tileKeyOrigin,version:e.version},transferList:new Array};for(let r in e.data){let a=r,i=e.data[a];if(s.message.data[a]=null,i!=null){let o=i.stride,n=i.indices.slice(0),l=i.vertices.slice(0),d=i.records.slice(0),c=i.metrics?.slice(0),h={stride:o,indices:n,vertices:l,records:d,metrics:c};s.transferList.push(n,l,d),s.message.data[a]=h}}return s}var T=class extends E{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new S(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(t){this._bufferIds.forEach(e=>{e.forEach(t)})}update(t,e){return p(this,null,function*(){let s=e.schema.processors[0];if(s.type!=="symbol")return;let r=K(this._schema,s);(v(r,"mesh")||v(r,"target"))&&(t.mesh=!0,t.why?.mesh.push("Symbology changed"),this._schema=s,this._factory=this._createFactory(s),this._factory.update(s,this.tileStore.tileScheme.tileInfo))})}onTileMessage(t,e,s,r){return _(r),this._onTileData(t,e,s,r)}onTileClear(t,e){let s={clear:!0,end:e};return this._bufferData.delete(t.key.id),this._bufferIds.delete(t.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:s})}onTileError(t,e,s){let r=s.signal,a={tileKey:t.id,error:e};return this.remoteClient.invoke("tileRenderer.onTileError",a,{signal:r})}onTileUpdate(t){for(let e of t.removed)this._bufferData.has(e.key.id)&&this._bufferData.delete(e.key.id),this._bufferIds.has(e.key.id)&&this._bufferIds.delete(e.key.id);for(let e of t.added)this._bufferData.forEach(s=>{for(let r of s)r.message.tileKey===e.id&&this._updateTileMesh("append",e,G(r),[],!1,!1,null)})}_addBufferData(t,e){this._bufferData.has(t)||this._bufferData.set(t,[]),this._bufferData.get(t)?.push(G(e))}_createFactory(t){let{geometryType:e,objectIdField:s,fields:r}=this.service,a=(d,c)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",d,c),i={geometryType:e,fields:r,spatialReference:R.fromJSON(this.spatialReference)},o=new z(a,this.tileStore.tileScheme.tileInfo),{matcher:n,aggregateMatcher:l}=t.mesh;return this._store=o,this._matchers.feature=w(n,o,i,this._resourceManagerProxy),this._matchers.aggregate=l?w(l,o,i,this._resourceManagerProxy):null,new B(e,s,o)}_onTileData(t,e,s,r){return p(this,null,function*(){_(r);let{type:a,addOrUpdate:i,remove:o,clear:n,end:l}=e,d=!!this._schema.mesh.sortKey;if(!i){let h={type:a,addOrUpdate:null,remove:o,clear:n,end:l,sort:d};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:h},r)}let c=this._processFeatures(t,i,s,r,e.status?.version);try{let h=yield c;if(h==null){let u={type:a,addOrUpdate:null,remove:o,clear:n,end:l,sort:d};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:u},r)}let f=[];for(let u of h){let m=!1,y=u.message.bufferIds,g=t.key.id,M=u.message.tileKey;if(g!==M&&y!=null){if(!this.tileStore.get(M)){this._addBufferData(g,u),f.push(u);continue}let b=this._bufferIds.get(M);b||(b=new Set,this._bufferIds.set(M,b));let H=Array.from(y);for(let x of H){if(b.has(x)){m=!0;break}b.add(x)}}m||(this._addBufferData(g,u),f.push(u))}yield Promise.all(f.map(u=>{let m=t.key.id===u.message.tileKey,y=m?e.remove:[],g=m&&e.end;return this._updateTileMesh(a,t,u,y,g,!!e.clear,r.signal)}))}catch(h){this._handleError(t,h,r)}})}_updateTileMesh(t,e,s,r,a,i,o){return p(this,null,function*(){let n=t,l=s.message.tileKey,d=!!this._schema.mesh.sortKey;l!==e.key.id&&(a=!1);let c=s?.message,h={type:n,addOrUpdate:c,remove:r,clear:i,end:a,sort:d},f={transferList:s?.transferList??[],signal:o};return _(f),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l,data:h},f)})}_processFeatures(t,e,s,r,a){return p(this,null,function*(){if(e==null||!e.hasFeatures)return null;let i={transform:t.transform,hasZ:!1,hasM:!1},o=this._factory,n={viewingMode:"",scale:t.scale},l=yield this._matchers.feature,d=yield this._matchers.aggregate;_(r);let c=this._getLabelInfos(t,e);return yield o.analyze(e.getCursor(),this._resourceManagerProxy,l,d,i,n),_(r),this._writeFeatureSet(t,e,i,c,o,s,a)})}_writeFeatureSet(t,e,s,r,a,i,o){let n=e.getSize(),l=this._schema.mesh.matcher.symbologyType,d=new O(t.key.id,{features:n,records:n,metrics:0},l,i,l!==P.HEATMAP,o),c={viewingMode:"",scale:t.scale},h=e.getCursor();for(;h.next();)try{let u=h.getDisplayId(),m=r!=null?r.get(u):null;a.writeCursor(d,h,s,c,t.level,m,this._resourceManagerProxy)}catch{}let f=t.tileInfoView.tileInfo.isWrappable;return d.serialize(f)}_handleError(t,e,s){if(!I(e)){let r={tileKey:t.id,error:e.message};return this.remoteClient.invoke("tileRenderer.onTileError",r,{signal:s.signal})}return Promise.resolve()}_getLabelingSchemaForScale(t){let e=this._schema.mesh.labels;if(e==null)return null;if(e.type==="subtype"){let r={type:"subtype",classes:{}},a=!1;for(let i in e.classes){let o=e.classes[i].filter(n=>W(n,t.scale));a=a||!!o.length,r.classes[i]=o}return a?r:null}let s=e.classes.filter(r=>W(r,t.scale));return s.length?{type:"simple",classes:s}:null}_getLabels(t,e){if(e.type==="subtype"){let s=this.service.subtypeField;F(s,"Expected to find subtype Field");let r=t.readAttribute(s);return r==null?[]:e.classes[r]??[]}return e.classes}_getLabelInfos(t,e){let s=this._getLabelingSchemaForScale(t);if(s==null)return null;let r=new Map,a=e.getCursor();for(;a.next();){let i=a.getDisplayId(),o=[],n=L(i),l=n&&a.readAttribute("cluster_count")!==1?"aggregate":"feature",d=this._getLabels(a,s);for(let c of d){if(c.target!==l)continue;let h=a.getStorage(),f=n&&l==="feature"?h.getComputedStringAtIndex(a.readAttribute("referenceId"),c.fieldIndex):h.getComputedStringAtIndex(i,c.fieldIndex);if(!f)continue;let u=A(f.toString()),m=u[0],y=u[1];this._store.getMosaicItem(c.symbol,U(m)).then(g=>{o[c.index]={glyphs:g.glyphMosaicItems??[],rtl:y,index:c.index}})}r.set(i,o)}return r}};T=k([C("esri.views.2d.layers.features.processors.SymbolProcessor")],T);var me=T;export{me as default};
