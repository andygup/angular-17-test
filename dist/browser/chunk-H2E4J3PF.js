import{a as tt,c as et}from"./chunk-G7TZLWYD.js";import{a as W,b as E}from"./chunk-N77PCW3L.js";import{a as q,b as g,c as J,e as T}from"./chunk-NTXQ55BD.js";import{n as K}from"./chunk-EKY6QR7N.js";import{B as V,C as $,D as Q,F as X,G as Z,a as C}from"./chunk-GIHBFCPM.js";import{p as _}from"./chunk-TKTKGUCU.js";import{l as v,n as O,p as H,r as R,x as P,z as L}from"./chunk-M3GEY4SR.js";import{b as p}from"./chunk-4HXOVZYF.js";import{c as j}from"./chunk-AUVYUYNK.js";import{a as Y}from"./chunk-RCWJNG4Z.js";import{a as x}from"./chunk-EDSVJRYE.js";import{b as G}from"./chunk-EJ3VIBAJ.js";import{p as U,z as B}from"./chunk-PT7S6WNL.js";import{p as N,r as S}from"./chunk-465DRXTW.js";import{a as c}from"./chunk-AC62Z3FX.js";import{g as y}from"./chunk-ESDYQQXO.js";function ot({coords:u,lengths:t}){let e=0;for(let s of t){for(let r=1;r<s;r++)u[2*(e+r)]+=u[2*(e+r)-2],u[2*(e+r)+1]+=u[2*(e+r)-1];e+=s}}var st=class u extends E{static fromFeatures(t,e){let{objectIdField:s,geometryType:r}=e,i=v([],t,r,!1,!1,s);for(let n=0;n<i.length;n++)i[n].displayId=t[n].displayId;return u.fromOptimizedFeatures(i,e)}static fromFeatureSet(t,e){let s=R(t,e.objectIdField);return u.fromOptimizedFeatureSet(s,e)}static fromOptimizedFeatureSet(t,e){let{features:s}=t,r=u.fromOptimizedFeatures(s,e);return r._exceededTransferLimit=t.exceededTransferLimit,r._transform=t.transform,r._fieldsIndex=new x(e.fields),r}static fromOptimizedFeatures(t,e,s){let r=E.createInstance(),i=new u(r,t,e);return i._fieldsIndex=new x(e.fields),i._transform=s,i}constructor(t,e,s){super(t,s),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=s?.geometryType,this._features=e}get fields(){return this._fieldsIndex}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(t){let e=new Set(t);this._features=this._features.filter(s=>!(s.objectId!=null&&e.has(s.objectId)))}append(t){for(let e of t)this._features.push(e)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let t="";for(let e in this._current.attributes)t+=this._current.attributes[e];return t}getIndex(){return this._featureIndex}setIndex(t){this._featureIndex=t}getObjectId(){return this._current?.objectId}getDisplayId(){return this._current.displayId}setDisplayId(t){this._current.displayId=t}getGroupId(){return this._current.groupId}setGroupId(t){this._current.groupId=t}copy(){let t=new u(this.instance,this._features,this.fullSchema());return this.copyInto(t),t}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return O(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){let t=this.readUnquantizedGeometry();return H(t,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){let t=this.readCentroid();return t==null?null:{x:t.coords[0]*this._sx+this._tx,y:t.coords[1]*this._sy+this._ty}}readGeometryArea(){return p(this._current)?L(this._current.geometry,2):0}readUnquantizedGeometry(){let t=this.readGeometry();if(this.geometryType==="esriGeometryPoint"||!t)return t;let e=t.clone();return ot(e),e}readHydratedGeometry(){let t=this._current.geometry;if(t==null)return null;let e=t.clone();return this._transform!=null&&P(e,e,this.hasZ,this.hasM,this._transform),e}getXHydrated(){if(!p(this._current))return 0;let t=this._current.geometry.coords[0],e=this.getQuantizationTransform();return e==null?t:t*e.scale[0]+e.translate[0]}getYHydrated(){if(!p(this._current))return 0;let t=this._current.geometry.coords[1],e=this.getQuantizationTransform();return e==null?t:e.translate[1]-t*e.scale[1]}getX(){return p(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return p(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!p(this._current)){if(this._current.centroid!=null){let[s,r]=this._current.centroid.coords;return this.createQuantizedExtrudedGeometry(s,r)}return null}let t=this._current.geometry.clone();if(t.isPoint)return t.coords[0]=t.coords[0]*this._sx+this._tx,t.coords[1]=t.coords[1]*this._sy+this._ty,t;let e=0;for(let s of t.lengths)t.coords[2*e]=t.coords[2*e]*this._sx+this._tx,t.coords[2*e+1]=t.coords[2*e+1]*this._sy+this._ty,e+=s;return t}readCentroid(){return p(this._current)?this._computeCentroid():this._current.centroid}_readAttribute(t,e){let s=this._fieldsIndex.get(t);if(!s)return;let r=this._current.attributes[s.name];return r==null?r:(this.fields.get(t)?.type==="esriFieldTypeTimestampOffset"&&(r=this.parseTimestampOffset(r)),e&&this.fields.isDateField(t)?new Date(r):r)}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._transform=this._transform,t._fieldsIndex=this._fieldsIndex}_readAttributes(){return this._current.attributes}};var f=N.getLogger("esri.views.layers.2d.features.support.AttributeStore"),z=tt(!1,f),b={sharedArrayBuffer:c("esri-shared-array-buffer"),atomics:c("esri-atomics")};function w(u,t){return e=>t(u(e))}var M=class{constructor(t,e,s,r){this.size=0,this.texelSize=4,this.dirtyStart=0,this.dirtyEnd=0;let{pixelType:i,layout:n,textureOnly:a}=r;this.textureOnly=a||!1,this.pixelType=i,this._ctype=e,this.layout=n,this._resetRange(),this._shared=t,this.size=s,a||(this.data=this._initData(i,s,t,e))}get buffer(){return this.data?.buffer}unsetComponentAllTexels(t,e){let s=this.data;for(let r=0;r<this.size*this.size;r++)s[r*this.texelSize+t]&=~e;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(t,e){let s=this.data;for(let r=0;r<this.size*this.size;r++)s[r*this.texelSize+t]|=255&e;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(t,e,s){let r=this.data;for(let i of s)r[i*this.texelSize+t]|=e,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}setComponentTexel(t,e,s){this.data[s*this.texelSize+t]|=e,this.dirtyStart=Math.min(this.dirtyStart,s),this.dirtyEnd=Math.max(this.dirtyEnd,s)}unsetComponentTexel(t,e,s){this.data[s*this.texelSize+t]&=~e,this.dirtyStart=Math.min(this.dirtyStart,s),this.dirtyEnd=Math.max(this.dirtyEnd,s)}getData(t,e){let s=g(t);return this.data[s*this.texelSize+e]}setData(t,e,s){let r=g(t),i=1<<e;this.layout&i?this.data!=null&&(this.data[r*this.texelSize+e]=s,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)):f.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){this.pixelType===_.UNSIGNED_BYTE&&this._shared&&b.atomics&&this._ctype!=="local"&&Atomics.store(this.data,0,1)}unlock(){this.pixelType===_.UNSIGNED_BYTE&&this._shared&&b.atomics&&this._ctype!=="local"&&Atomics.store(this.data,0,0)}expand(t){if(this.size=t,!this.textureOnly){let e=this._initData(this.pixelType,t,this._shared,this._ctype),s=this.data;e.set(s),this.data=e}}toMessage(){let t=this.dirtyStart,e=this.dirtyEnd,s=this.texelSize;if(t>e)return null;this._resetRange();let r=!(this._shared||this._ctype==="local"),i=this.pixelType,n=this.layout,a=this.data;return{start:t,end:e,data:r&&a.slice(t*s,(e+1)*s)||null,pixelType:i,layout:n}}_initData(t,e,s,r){let i=s&&r!=="local"?SharedArrayBuffer:ArrayBuffer,n=K(t),a=new n(new i(e*e*4*n.BYTES_PER_ELEMENT));for(let h=0;h<a.length;h+=4)a[h+1]=255;return a}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}},rt=class{constructor(t,e){this._client=t,this.config=e,this.updatingHandles=new Y,this._blocks=new Array,this._filters=new Array(X),this._attributeComputeInfo=null,this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._nextUpdate=null,this._currUpdate=null,this._idsToHighlight=new Set;let s=e.supportsTextureFloat?_.FLOAT:_.UNSIGNED_BYTE;z(`Creating AttributeStore ${b.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:_.UNSIGNED_BYTE,layout:1},{pixelType:_.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:_.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:s,layout:15},{pixelType:s,layout:15},{pixelType:s,layout:15},{pixelType:s,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}destroy(){this._abortController.abort(),this.updatingHandles.destroy()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}isUpdating(){let t=this.updatingHandles.updating||!!this._nextUpdate;return c("esri-2d-log-updating")&&console.log(`Updating AttributeStore: ${t}
  -> updatingHandles ${this.updatingHandles.updating} (currUpdate: ${!!this._currUpdate})
  -> nextUpdate: ${!!this._nextUpdate}
`),t}update(t,e){this.config=e;let s=e.schema.processors[0].storage,r=j(this._schema,s);if((t.targets.feature||t.targets.aggregate)&&(t.storage.data=!0),r&&(c("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",r),t.storage.data=!0,this._schema=s,this._attributeComputeInfo=null,s!=null)){switch(s.target){case"feature":this._targetType=0;break;case"aggregate":this._targetType=1}if(s.type==="subtype"){this._attributeComputeInfo={isSubtype:!0,subtypeField:s.subtypeField,map:new Map};for(let i in s.mapping){let n=s.mapping[i];if(n?.vvMapping!=null)for(let a of n.vvMapping)this._bindAttribute(a,parseInt(i,10))}}else{if(this._attributeComputeInfo={isSubtype:!1,map:new Map},s.vvMapping!=null)for(let i of s.vvMapping)this._bindAttribute(i);if(s.attributeMapping!=null)for(let i of s.attributeMapping)this._bindAttribute(i)}}}onTileData(t,e){if(e.addOrUpdate==null)return;let s=e.addOrUpdate.getCursor();for(;s.next();){let r=s.getDisplayId();this.setAttributeData(r,s)}}setHighlight(t,e){return y(this,null,function*(){let r=this._getBlock(0),i=e.map(n=>g(n));r.lock(),r.unsetComponentAllTexels(0,1),r.setComponent(0,1,i),r.unlock(),this._idsToHighlight.clear();for(let n of t)this._idsToHighlight.add(n);yield this.sendUpdates()})}updateFilters(t,e,s){return y(this,null,function*(){c("esri-2d-update-debug")&&console.debug("AttributeStore::updateFilters");let{service:r,spatialReference:i}=s,{filters:n}=e,a=n.map((o,l)=>this._updateFilter(o,l,r,i)),h=(yield Promise.all(a)).some(o=>o);c("esri-2d-update-debug")&&console.debug("AttributeStore::updateFilters - finsihed"),h&&(t.storage.filters=!0,c("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))})}setData(t,e,s,r){let i=g(t);this._ensureSizeForTexel(i),this._getBlock(e).setData(t,s,r)}getData(t,e,s){return this._getBlock(e).getData(t,s)}getHighlightFlag(t){return this._idsToHighlight.has(t)?Z:0}unsetAttributeData(t){let e=g(t);this._getBlock(0).setData(e,0,0)}setAttributeData(t,e){let s=g(t);if(this._ensureSizeForTexel(s),this._getBlock(0).setData(s,0,this.getFilterFlags(e)),this._targetType!==q(t))return;let r=this._attributeComputeInfo,i=this.config.supportsTextureFloat?1:2,n=4,a=null;r&&(a=r.isSubtype?r.map.get(e.readAttribute(r.subtypeField)):r.map,a?.size&&a.forEach((h,o)=>{let l=o*i%n,I=Math.floor(o*i/n),m=this._getBlock(I+Q),D=h(e);if(this.config.supportsTextureFloat)m.setData(s,l,D);else if(D===C)m.setData(s,l,255),m.setData(s,l+1,255);else{let k=G(Math.round(D),-32767,32766)+32768,nt=255&k,at=(65280&k)>>8;m.setData(s,l,nt),m.setData(s,l+1,at)}}))}sendUpdates(){if(c("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=B(),this.updatingHandles.addPromise(this._nextUpdate.promise),this._nextUpdate.promise;let t={blocks:this._blocks.map(e=>e!=null?e.toMessage():null)};return this._currUpdate=this._createResources().then(()=>{let e=()=>{if(this._currUpdate=null,this._nextUpdate){let r=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then(()=>r.resolve())}else c("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued")};c("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");let s=this.updatingHandles.addPromise(this._client.update(t,this._signal).then(e).catch(e));return this._client.render(this._signal),s}).catch(e=>{if(U(e))return this._createResourcesPromise=null,this._createResources();f.error(new S("mapview-attribute-store","Encountered an error during client update",e))}),this._currUpdate}_ensureSizeForTexel(t){for(;t>=this._size*this._size;)if(this._expand())return}_bindAttribute(t,e){function s(){let{normalizationField:o}=t;return o?l=>{let I=l.readAttribute(o);return I?l.readAttribute(t.field)/I:null}:l=>l.readAttribute(t.field)}function r(){return t.normalizationField&&f.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),o=>o.getComputedNumericAtIndex(t.fieldIndex)}let i;if(t.fieldIndex!=null)i=r();else{if(!t.field)return;i=s()}let{valueRepresentation:n}=t;n&&(i=w(i,o=>et(o,n)));let a=o=>o===null||isNaN(o)||o===1/0||o===-1/0?C:o,h=this._attributeComputeInfo;if(h.isSubtype){let o=h.map.get(e)??new Map;o.set(t.binding,w(i,a)),h.map.set(e,o)}else h.map.set(t.binding,w(i,a))}_createResources(){if(this._createResourcesPromise!=null)return this._createResourcesPromise;this._getBlock(V),this._getBlock($),z("Initializing AttributeStore");let t={shared:b.sharedArrayBuffer&&this._client.type!=="local",size:this._size,blocks:this._blocks.map(s=>s!=null?{textureOnly:s.textureOnly,buffer:s.buffer,pixelType:s.pixelType}:null)},e=this._client.initialize(t,this._signal).catch(s=>{U(s)?this._createResourcesPromise=null:f.error(new S("mapview-attribute-store","Encountered an error during client initialization",s))});return this._createResourcesPromise=e,e.then(()=>this._createResourcesPromise==null?this._createResources():void 0),e}_getBlock(t){let e=this._blocks[t];if(e!=null)return e;z(`Initializing AttributeBlock at index ${t}`);let s=b.sharedArrayBuffer,r=this._client.type,i=new M(s,r,this._size,this._blockDescriptors[t]);return this._blocks[t]=i,this._createResourcesPromise=null,i}_expand(){if(this._size<this.config.maxTextureSize){let t=this._size<<=1;z("Expanding block size to",t,this._blocks);for(let e of this._blocks)e?.expand(t);return this._createResourcesPromise=null,this._size=t,0}return f.error(new S("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}_updateFilter(t,e,s,r){return y(this,null,function*(){let i=this._filters[e],n=i!=null&&i.hash;if(!i&&!t||n===JSON.stringify(t))return!1;if(t==null){if(!i)return!1;let h=1<<e+1,o=this._getBlock(0);return this._filters[e]=null,o.setComponentAllTexels(0,h),this.sendUpdates(),!0}return yield(yield this._getFilter(e,s)).update(t,r),!0})}_getFilter(t,e){return y(this,null,function*(){let s=this._filters[t];if(s!=null)return s;let{default:r}=yield import("./chunk-APT3TTFF.js"),i=new r({geometryType:e.geometryType,hasM:!1,hasZ:!1,timeInfo:e.timeInfo,fieldsIndex:x.fromJSON(e.fieldsIndex)});return this._filters[t]=i,i})}isVisible(t){return!!(2&this._getBlock(0).getData(t,0))}getFilterFlags(t){let e=0,s=J(t.getDisplayId());for(let i=0;i<this._filters.length;i++){let n=!!(s&1<<i),a=this._filters[i];e|=(!n||a==null||a.check(t)?1:0)<<i}let r=0;if(this._idsToHighlight.size){let i=t.getObjectId();r=this.getHighlightFlag(i)}return e<<1|r}};var A=class{constructor(){this._freeIds=[],this._idCounter=1}createId(t=!1){return T(this._getFreeId(),t)}releaseId(t){this._freeIds.push(t)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}};function F(u,t,e){if(!(u.length>t))for(;u.length<=t;)u.push(e)}var it=class{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new A,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){let t=this._bitsets.length;return this._bitsets.push(W.create(this._allocatedSize,8388607)),t+1}getBitset(t){return this._bitsets[t-1]}_expand(){this._allocatedSize<<=1;for(let t of this._bitsets)t.resize(this._allocatedSize)}_ensureNumeric(t,e){this._numerics[t]||(this._numerics[t]=[]),F(this._numerics[t],e,0)}_ensureInstanceId(t){F(this._instanceIds,t,0)}_ensureString(t,e){this._strings[t]||(this._strings[t]=[]),F(this._strings[t],e,null)}createDisplayId(t=!1){let e=this._idGenerator.createId();return e>this._allocatedSize&&this._expand(),T(e,t)}releaseDisplayId(t){for(let e of this._bitsets)e.unset(t);return this._idGenerator.releaseId(t&8388607)}getComputedNumeric(t,e){return this.getComputedNumericAtIndex(t&8388607,0)}setComputedNumeric(t,e,s){return this.setComputedNumericAtIndex(t&8388607,s,0)}getComputedString(t,e){return this.getComputedStringAtIndex(t&8388607,0)}setComputedString(t,e,s){return this.setComputedStringAtIndex(t&8388607,0,s)}getComputedNumericAtIndex(t,e){let s=t&8388607;return this._ensureNumeric(e,s),this._numerics[e][s]}setComputedNumericAtIndex(t,e,s){let r=t&8388607;this._ensureNumeric(e,r),this._numerics[e][r]=s}getInstanceId(t){let e=t&8388607;return this._ensureInstanceId(e),this._instanceIds[e]}setInstanceId(t,e){let s=t&8388607;this._ensureInstanceId(s),this._instanceIds[s]=e}getComputedStringAtIndex(t,e){let s=t&8388607;return this._ensureString(e,s),this._strings[e][s]}setComputedStringAtIndex(t,e,s){let r=t&8388607;this._ensureString(e,r),this._strings[e][r]=s}getXMin(t){return this._bounds[4*(t&8388607)]}getYMin(t){return this._bounds[4*(t&8388607)+1]}getXMax(t){return this._bounds[4*(t&8388607)+2]}getYMax(t){return this._bounds[4*(t&8388607)+3]}setBounds(t,e){let s=e.readHydratedGeometry();if(!s?.coords.length)return!1;let r=1/0,i=1/0,n=-1/0,a=-1/0;s.forEachVertex((o,l)=>{r=Math.min(r,o),i=Math.min(i,l),n=Math.max(n,o),a=Math.max(a,l)});let h=t&8388607;return F(this._bounds,4*h+4,0),this._bounds[4*h]=r,this._bounds[4*h+1]=i,this._bounds[4*h+2]=n,this._bounds[4*h+3]=a,!0}};export{st as a,rt as b,it as c};
